<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script id="versionArea" type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 8, revision: 1, date: new Date("June 23, 2013"), extensions: {}};

//]]>
</script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="copyright" content="
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) Jeremy Ruston 2004-2007
Copyright (c) UnaMesa Association 2007-2012

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the UnaMesa Association nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.

" />
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' />
<!--}}}-->

<!--PRE-HEAD-END-->
<title> M8 - Curso 2013-14 </title>
<style id="styleArea" type="text/css">
#saveTest {display:none;}
#messageArea {display:none;}
#copyright {display:none;}
#storeArea {display:none;}
#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}
#shadowArea {display:none;}
#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}

</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.unload) unload();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki created by Jeremy Ruston; Copyright &copy; 2004-2007 Jeremy Ruston, Copyright &copy; 2007-2011 UnaMesa Association
</div>
<noscript>
<div id="javascriptWarning">
This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.
</div>

</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88
</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::EditToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser excludeLists'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="GettingStarted">
<pre>To get started with this blank [[TiddlyWiki]], you'll need to modify the following tiddlers:
* [[SiteTitle]] &amp; [[SiteSubtitle]]: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)
* [[MainMenu]]: The menu (usually on the left)
* [[DefaultTiddlers]]: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened
You'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;
</pre>
</div>
<div title="ImportTiddlers">
<pre>&lt;&lt;importTiddlers&gt;&gt;
</pre>
</div>
<div title="MarkupPreHead">
<pre>&lt;!--{{{--&gt;
&lt;link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' /&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="OptionsPanel">
<pre>These [[InterfaceOptions]] for customising [[TiddlyWiki]] are saved in your browser

Your username for signing your edits. Write it as a [[WikiWord]] (eg [[JoeBloggs]])

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; [[SaveBackups]]
&lt;&lt;option chkAutoSave&gt;&gt; [[AutoSave]]
&lt;&lt;option chkRegExpSearch&gt;&gt; [[RegExpSearch]]
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; [[CaseSensitiveSearch]]
&lt;&lt;option chkAnimate&gt;&gt; [[EnableAnimations]]

----
Also see [[AdvancedOptions]]
</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' role='banner' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='headerForeground'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' role='navigation' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' role='navigation' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' role='complementary' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea' role='main'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1,h2,h3,h4,h5,h6 {color:[[ColorPalette::SecondaryDark]]; background:transparent;}
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {background:[[ColorPalette::PrimaryMid]];}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected {color:[[ColorPalette::PrimaryDark]];
	background:[[ColorPalette::TertiaryPale]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::TertiaryPale]]; border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard {background:[[ColorPalette::PrimaryPale]]; border:1px solid [[ColorPalette::PrimaryMid]];}
.wizard h1 {color:[[ColorPalette::PrimaryDark]]; border:none;}
.wizard h2 {color:[[ColorPalette::Foreground]]; border:none;}
.wizardStep {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];
	border:1px solid [[ColorPalette::PrimaryMid]];}
.wizardStep.wizardStepDone {background:[[ColorPalette::TertiaryLight]];}
.wizardFooter {background:[[ColorPalette::PrimaryPale]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizard .button {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryPale]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryPale]];}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
	border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];}

.wizard .notChanged {background:transparent;}
.wizard .changedLocally {background:#80ff80;}
.wizard .changedServer {background:#8080ff;}
.wizard .changedBoth {background:#ff8080;}
.wizard .notFound {background:#ffff80;}
.wizard .putToServer {background:#ff80ff;}
.wizard .gotFromServer {background:#80ffff;}

#messageArea {border:1px solid [[ColorPalette::SecondaryMid]]; background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]];}
#messageArea .button {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none;}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.popup {background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryDark]]; border-left:1px solid [[ColorPalette::TertiaryMid]]; border-top:1px solid [[ColorPalette::TertiaryMid]]; border-right:2px solid [[ColorPalette::TertiaryDark]]; border-bottom:2px solid [[ColorPalette::TertiaryDark]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.popup li.disabled {color:[[ColorPalette::TertiaryMid]];}
.popup li a, .popup li a:visited {color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:active {background:[[ColorPalette::SecondaryPale]]; color:[[ColorPalette::Foreground]]; border: none;}
.popupHighlight {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged {border:1px solid [[ColorPalette::TertiaryPale]]; background-color:[[ColorPalette::TertiaryPale]];}
.selected .tagging, .selected .tagged {background-color:[[ColorPalette::TertiaryLight]]; border:1px solid [[ColorPalette::TertiaryMid]];}
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button {border:none;}

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border:2px solid [[ColorPalette::SecondaryMid]];}

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

.viewer table, table.twtable {border:2px solid [[ColorPalette::TertiaryDark]];}
.viewer th, .viewer thead td, .twtable th, .twtable thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::Background]];}
.viewer td, .viewer tr, .twtable td, .twtable tr {border:1px solid [[ColorPalette::TertiaryDark]];}

.viewer pre {border:1px solid [[ColorPalette::SecondaryLight]]; background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%;}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}
.readOnly {background:[[ColorPalette::TertiaryPale]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:alpha(opacity=60);}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
* html .tiddler {height:1%;}

body {font-size:.75em; font-family:arial,helvetica; margin:0; padding:0;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

a {text-decoration:none;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em;}

#contentWrapper .chkOptionInput {border:0;}

.externalLink {text-decoration:underline;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
	#mainMenu .tiddlyLinkNonExisting,
	#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}

.header {position:relative;}
.header a:hover {background:transparent;}
.headerShadow {position:relative; padding:4.5em 0 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:4.5em 0 1em 1em; left:0; top:0;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 0.3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}

.wizard {padding:0.1em 1em 0 2em;}
.wizard h1 {font-size:2em; font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em;}
.wizard h2 {font-size:1.2em; font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em;}
.wizardStep {padding:1em 1em 1em 1em;}
.wizard .button {margin:0.5em 0 0; font-size:1.2em;}
.wizardFooter {padding:0.8em 0.4em 0.8em 0;}
.wizardFooter .status {padding:0 0.4em; margin-left:1em;}
.wizard .button {padding:0.1em 0.2em;}

#messageArea {position:fixed; top:2em; right:0; margin:0.5em; padding:0.5em; z-index:2000; _position:absolute;}
.messageToolbar {display:block; text-align:right; padding:0.2em;}
#messageArea a {text-decoration:underline;}

.tiddlerPopupButton {padding:0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em; margin:0;}

.popup {position:absolute; z-index:300; font-size:.9em; padding:0; list-style:none; margin:0;}
.popup .popupMessage {padding:0.4em;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0;}
.popup li.disabled {padding:0.4em;}
.popup li a {display:block; padding:0.4em; font-weight:normal; cursor:pointer;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tabset {padding:1em 0 0 0.5em;}
.tab {margin:0 0 0 0.25em; padding:2px;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler {padding:1em 1em 0;}

.missing .viewer,.missing .title {font-style:italic;}

.title {font-size:1.6em; font-weight:bold;}

.missing .subtitle {display:none;}
.subtitle {font-size:1.1em;}

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation {padding:0.5em; margin:0.5em;}

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0 0.25em; padding:0 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

.viewer table, table.twtable {border-collapse:collapse; margin:0.8em 1.0em;}
.viewer th, .viewer td, .viewer tr,.viewer caption,.twtable th, .twtable td, .twtable tr,.twtable caption {padding:3px;}
table.listView {font-size:0.85em; margin:0.8em 1.0em;}
table.listView th, table.listView td, table.listView tr {padding:0 3px 0 3px;}

.viewer pre {padding:0.5em; margin-left:0.5em; font-size:1.2em; line-height:1.4em; overflow:auto;}
.viewer code {font-size:1.2em; line-height:1.4em;}

.editor {font-size:1.1em;}
.editor input, .editor textarea {display:block; width:100%; font:inherit;}
.editorFooter {padding:0.25em 0; font-size:.9em;}
.editorFooter .button {padding-top:0; padding-bottom:0;}

.fieldsetFix {border:0; padding:0; margin:1px 0px;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0; right:0;}
#backstageButton a {padding:0.1em 0.4em; margin:0.1em;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel {display:none; z-index:100; position:absolute; width:90%; margin-left:3em; padding:1em;}
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em;}
#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which need larger font sizes.
***/
/*{{{*/
body {font-size:0.8em;}
#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}
.subtitle {font-size:0.8em;}
.viewer table.listView {font-size:0.95em;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
#mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton, #backstageArea {display: none !important;}
#displayArea {margin: 1em 1em 0em;}
noscript {display:none;} /* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */
}
/*}}}*/
</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' role='navigation' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>

</div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="Act_DHCP" creator="YourName" modifier="YourName" created="201310022201" modified="201310292308" changecount="15">
<pre>!!!~Actividad_DHCP_1: DHCP en Windows 2008
Instala y configura el servidor DHCP de w2008XX con las siguientes opciones:
*Servirá el rango de direcciones IP comprendidas entre 10.33.XX.60 y 10.33.XX.70 en la red 10.33.XX.0/24
*Proporcionará los siguientes parámetros a los clientes:
**Tiempo de concesión: 8 días.
**Máscara de red: 255.255.255.0
**Puerta de enlace: 10.33.XX.1
**Servidor DNS: 8.8.8.8 (en red interna todavía no tenemos DNS)
*Al equipo w7XX se le asignará siempre la dirección IP 10.33.XX.4
*Al equipo ubuntuXX se le asignará una dirección IP dinámica.
----
''Ayuda''
*Inicia w2008XX con permisos de administrador. Accede a Inicio/Herramientas Administrativas/Administración del servidor. Ahora ves a Roles {{{--&gt;}}} Agregar Roles {{{--&gt;}}} Instalar servidor DHCP. NOTA: esta herramienta administrativa (administración del servidor) es el centro &quot;neurálgico&quot; del SO. Desde esta utilidad podemos: añadir/eliminar funciones al servidor, acceder a los diferentes asistentes de configuración de cada función (o rol), añadir características (pequeñas funcionalidades que se pueden agregar al servidor (.NET, powershell, seguridad, etc.)), diagnosticar y auditar el uso y rendimiento del servidor y, por último, gestionar los diferentes elementos o discos de datos (discos de red, compartición, control de accesos, cuotas,etc.)
*Una vez seleccionada la instalación del DHCP lee toda la información que va apareciendo en los sucesivos pasos del asistente (no dejes de echar un vistazo a la definición de ámbito). 
**''Seleccionar enlaces de conexión de red'': selecciona la dirección IP para dar servicio. Si tuviéramos varias subredes diferentes a las que dar servicio habríamos de agregarlas aquí.
**''Configuración DNS ~IPv4'': debes especificar el nombre de dominio primario (asix.net) que utilizarán los clientes para la resolución de nombres. Debes indicar también la dirección del servidor DNS (8.8.8.8). También podrías indicar un servidor DNS alternativo. 
**''Configuración WINS'': podríamos utilizar este servicio para la resolución de nombres pero nosotros no lo utilizaremos.
*Ahora pasamos a la configuración del servidor DHCP:
**El siguiente paso es definir un ámbito DHCP donde indicaremos el intervalo (rango) de direcciones IP a asignar. A cada ámbito se le asigna un nombre; nosotros pondremos ámbitoXX y dispondrá del intervalo 10.33.XX.60 a 10.33.XX.70. Además definiremos la puerta de enlace 10.33.XX.1 y la máscara de red 255.255.255.0.
**Indica que no vamos a utilizar el servicio ~DHCPv6.
**__Lee__ el resumen de la configuración e instala.
*Puedes comprobar el funcionamiento del servidor de dos formas: utilizando la herramienta &quot;Administración del servidor&quot;/Roles/Servidor DHCP (de hecho, desde aquí puedes controlar la parada y el inicio del servicio) y desde consola haciendo {{{netstat -a -n}}}. Comprueba que escucha en el puerto 67 UDP. Comprueba también que en el //Firewall//  se ha creado una excepción para el servidor DHCP
*En todo momento puedes acceder a los ficheros de //logs// del servidor en: {{{%windir%\system32\dhcp}}}
*Por supuesto, no dejes de comprobar que el servidor otorga direcciones IP a cualquier máquina de la red que se lo solicite.
*Acude a la consola de administración del servidor DHCP ( se habrá creado acceso en &quot;Herramientas Administrativas&quot;). Desde ahí:
**Añade una reserva en el ámbito &quot;ámbitoXX&quot; creado previamente para la máquina w7XX. Habrás de indicar la IP que deseas que el servidor asigne y la MAC de la máquina.
**Consulta en &quot;opciones de servidor&quot; (o, también en &quot;opciones de ámbito&quot;) los diferentes parámetros que el servidor puede enviar a los clientes.
**Consulta en &quot;concesiones de direcciones&quot; las diferentes concesiones que el servidor va asignando.
*Busca información sobre {{{Netsh}}}: ¿qué es? ¿Para que sirve? ¿Cómo se utiliza?
!!!~Actividad_DHCP_2
Configura una máquina ubuntuXX (13.04) para que reciba la configuración de red de forma dinámica.
----
''Ayuda''
Se puede hacer de dos maneras:
*Interfaz gráfica. Utilizando el Network Manager
*Editando el fichero {{{etc/network/interfaces}}}  y reiniciando la interfaz {{{/etc/init.d/networking restart}}}. El fichero debe quedar más o menos así:
{{{
auto lo ethX
iface ethX inet dhcp
iface lo inet loopback
}}}
!!!~Actividad_DHCP_3
¿Qué información obtienes en un sistema Windows con el adaptador de red configurado para obtener una dirección IP de forma automática al ejecutar el comando {{{ipconfig /all}}}?¿Para que sirven {{{ipconfig /release}}} y {{{ipconfig /renew}}}? Comprueba cómo funcionan.
!!!~Actividad_DHCP_4
//Esta práctica consiste en instalar y configurar con las opciones básicas el servidor ISC DHCP. Este servidor es el más utilizado sobre sistemas //Linux// y se encuentra disponible en los repositorios de las principales distribuciones.//
Configura el servidor DHCP en debianXX con las siguientes opciones:
*Servirá el rango de direcciones IP comprendidas entre 10.33.XX.20 y 10.33.XX.30 en la red 10.33.XX.0/24
*Proporcionará los siguientes parámetros a los clientes:
**Tiempo de concesión: 1 días.
**Máximo tiempo de concesión: 8 días.
**Mínimo tiempo de concesión: 1 hora
**Máscara de red: 255.255.255.0
**Puerta de enlace: 10.33.XX.1
**Servidor DNS: 8.8.8.8
*Al equipo w7XX se le asignará siempre la dirección IP 10.33.XX.4
*Al equipo ubuntuXX se le asignará una dirección IP dinámica.
----
''Ayuda''
*Primero: apaga el servidor de win2008 para evitar conflictos.
*Segundo: accede a la [[web|https://www.isc.org/software/dhcp]] y averigua qué es ISC.
*Tercero: instala el servidor {{{apt-get install isc-dhcp-server}}}
*Fija la IP de la máquina
*Indica en qué interfaz de red se van a escuchar las peticiones DHCP. Para ello edita {{{ /etc/default/isc-dhcp-server}}} y en INTERFACES indicaremos la interfaz de red por donde escucharemos las peticiones. {{{INTERFACES=&quot;ethX&quot;}}} (si quisiésemos dar servicio a varias redes lo indicaríamos aquí)
*Realiza una copia de seguridad de la configuración del servidor antes de modificarla:
{{{cp /etc/dhcp3/dhcpd.conf /etc/dhcp3/dhcpd.conf.bak}}}
*Edita el archivo de configuración con la configuración deseada:
{{{
#opciones de servidor
option domain-name &quot;asix.net&quot;;
option domain-name-servers 8.8.8.8;
option subnet-mask 255.255.255.0;
option routers 10.33.1.1;
default-lease-time 86400;
max-lease-time 691200;
min-lease-time 3600;

subnet 10.33.1.0 netmask 255.255.255.0 {
 range 10.33.1.20 10.33.1.30;
}
}}}
*Reinicia el servidor para que los cambios surtan efecto: {{{/etc/init.d/dhcp3-server stop}}} y {{{/etc/init.d/dhcp3-server start}}}
*Consulta el fichero de //logs// del sistema para comprobar que no hay errores {{{cat /var/log/syslog}}}
*Verifica que el proceso servidor está ejecutándose: {{{ps -ef | grep dhcp}}}
*Comprueba que el servidor está a la escucha {{{netstat -ltun}}} en el puerto 67 UDP.
*Consulta el fichero de concesiones y verifica que todavía no hay ninguna concesión {{{cat /var/lib/dhcp3/dhcpd.leases}}}
*Comprueba que la máquina ubuntuXX obtiene IP de forma dinámica.
*Para realizar una reserva de una dirección IP tendrás que editar de nuevo el archivo de configuración y añadir dentro del bloque //subnet//:
{{{
host Windows7 {
 hardware ethernet 08:00:27:DA:60:0F;
 fixed-address 10.33.1.4;
}
}}}
*Reinicia el servidor y comprueba que w7XX obtiene la IP deseada.
!!!~Actividad_DHCP_5 (No obligatoria. Documentar)
Emplea la utilidad Wireshark para analizar el formato y el contenido de los mensajes DHCP que circulan por la red. Identifica los tipos de mensajes. También puedes utilizar la utiliza tcpdump (investiga)

!!!~Actividad_DHCP_6 (No obligatoria. Documentar)
Configura Server2008 para que actúe de NAT y, a la vez, de servidor DHCP. Para ello, tendrás que darle a la máquina dos adaptadores de red y compartir la conexión (ICS). Además, ¿qué debes cambiar en la configuración del DHCP para que las máquinas de la red interna puedan navegar?

!!!~Actividad_DHCP_7 (No obligatoria. Documentar)
Apaga el servidor DHCP del server2008 y configura el servidor DHCP de la máquina Debian para que asigne una configuración tal a las máquinas de la red interna que puedan acceder a internet a través del server2008.
</pre>
</div>
<div title="Act_DNS" creator="YourName" modifier="YourName" created="201310142223" modified="201310292314" changecount="12">
<pre>!!!~Actividad_DNS_1
Abre un terminal en, por ejemplo, la máquina ubuntuXX y ejecuta {{{nslookup www.google.es}}}.
Este comando realiza una pregunta al servidor DNS que esté configurado en la interfaz de red y muestra por pantalla la información obtenida.
Entre la información que devuelve puedes observar:
*Cuál es el servidor DNS que responde.
*Qué direcciones IP se asocia con el nombre de dominio www.google.es
*Qué otros nombres de dominio son equivalentes a éste (''alias'')
!!!~Actividad_DNS_2 (No obligatoria. Para documentar)
*[[Visita|http://www.iana.org/domains/root/db/]] y observa dominios existentes y su clasificación según ICANN. ¿Quién es el operador de registro de &quot;com&quot;?¿Y de &quot;net&quot;?
*[[Consulta|http://www.rfc-es.org/rfc/rfc2606-es.txt]] donde se explica el uso recomendado de los dominios reservados. Por cierto, ¿qué es RFC?
*Echa un vistazo a la web de red.es. ¿Qué información ofrece sobre el dominio &quot;es&quot;?
!!!~Actividad_DNS_3 (No obligatoria. Para documentar)
*Consulta en la página de ICANN (en FAQ): ¿cuáles son las normas de registro de los dominios gTLD? ¿Y las normas de los ccTLD?
*Consulta la web de Red.es para consultar la lista de agentes registradores acreditados para el dominio &quot;es&quot;. Y, a continuación:
**Elige un nombre de dominio (minombre.es) y accede a la web de tres agentes registradores acreditados por Red.es.
**Comprueba que tu dominio no está registrado.
**Realiza una comparativa de precios entre los 3 agentes registradores.
**Elige un agente registrador y completa el proceso de registro hasta el punto donde te pide que realices el pago.
!!!~Actividad_DNS_4: (No obligatoria. Para documentar)
*Ejecuta el comando {{{nslookup www.google.es 8.8.8.8}}} para preguntar al servidor DNS 8.8.8.8 por el nombre de dominio www.google.es. Observa que la respuesta es no autorizada.
*Ejecuta el comando {{{nslookup www.google.es ns1.google.com}}} para preguntar al servidor DNS ns1.google.com por el nombre www.google.es. Observa que la respuesta es autorizada.
*Repite el proceso pero ahora en vez de preguntar por el nombre www.google.es pregunta por iesjoandaustria.org. ¿Qué sucede?¿Cuál es la diferencia entre el 8.8.8.8 y ns1.google.com?
!!!~Actividad_DNS_5: (No obligatoria. Para documentar)
*Ejecuta el comando {{{dig @8.8.8.8 www.iesjoandaustria.org   +trace}}} Con este comando se envía una consulta recursiva al servidor 8.8.8.8 preguntando por iesjoandaustria.org. Con +trace se le indica que muestre todo el rastreo de la operación.
*Repite la consulta para www.rediris.es.
!!!~Actividad_DNS_6: Comandos //nslookup//, //dig//, //host//
__''Comando //nslookup//''__
*Accede a nslookup en modo interactivo y consulta al servidor 8.8.8.8 los servidores DNS autorizados para el dominio mec.es.:
{{{
nslookup
&gt;server 8.8.8.8
&gt;set type=NS
&gt;mes.es
}}}
*Lo mismo pero ahora pregunta por los servidores de correo autorizados para mec.es.
*¿Y los servidores autorizados para  el dominio raíz?
*Pregunta al servidor a.nic.es. por el dominio www.mec.es
{{{
nslookup
&gt;server a.nic.es
&gt;www.mec.es
}}}
*Pregunta al servidor a.nic.es por el dominio www.google.com. ¿Qué pasa?
__''Comando //host//''__
*Obtén la IP de www.mec.es: {{{host www.mec.es}}}
*Obtén el nombre asociado con 8.8.8.8  {{{host 8.8.8.8}}}
*Consulta al servidor 8.8.8.8 por los servidores DNS autorizados para el dominio es.
{{{host -t NS es 8.8.8.8}}}
*Consulta al servidor 8.8.8.8 por el registro SOA del dominio es
{{{host -t SOA es 8.8.8.8}}}
__''Comando //dig//''__
*Obtén IP de www.mec.es {{{dig www.mec.es}}} Observa que la información es mucho más completa. Todo lo que sigue a &quot;;&quot; se trata de comentarios añadidos por //dig//. 
*Obtén el nombre asociado a 8.8.4.4 {{{dig  -x 8.8.4.4}}}
*Consulta al servidor 8.8.8.8 por todos los registros de recursos de dominios mec.es {{{dig @8.8.8.8 mec.es ANY}}}
*¿Cómo podríamos obtener el registro SOA del dominio google.es.?¿Y los registros de tipo A de a.root-servers.net?
!!!~Actividad_DNS_7 (No obligatoria. Para documentar)
Busca información y responde a las siguientes preguntas:
*¿Qué servicio ofrece [[dyndns|http://www.no-ip.com/]]
*¿Cuáles son los campos de un mensaje DNS?
*¿Qué es el ataque //Pharming//?¿Cómo funciona?¿Algún caso real?
*¿Qué son las técnicas de Footprinting basadas en DNS? Explica tres o cuatro.
*¿Qué es DNSSEC?¿En qué se basa?¿Qué objetivos tiene?
*¿Qué es //Whois//?¿Para qué sirve?
!!!~Actividad_DNS_8 (No obligatoria. Para documentar)
#Inicia una sesión en w7XX con privilegios de administrador. Inicia una captura del tráfico de red con Wireshark. 
#Abre un terminal y realiza un ping a //www.google.es//.
#Observa los mensaje del DNS. Fíjate en quién realiza la consulta, a qué servidor la realiza, en qué se encapsula el protocolo DNS, qué se pregunta en la petición DNS, cuáles son las respuestas, etc.
#Haz ipconfig /displaydns. ¿Qué sucede?¿A qué has invocado?
#Repite el proceso: inicia una captura y haz un ping a //google//. ¿Qué sucede?
!!!~Actividad_DNS_9: Configuración cliente Windows
*Inicia w7XX con privilegios de administrador.
*Accede a las propiedades TCP/IP del adaptador de red y observa que se pueden definir dos servidores DNS: servidor preferido y el alternativo (por si falla el primero)
*Observa que en Opciones Avanzadas se pueden añadir más servidores DNS Alternativos y anexar sufijos a las consultas.
!!!~Actividad_DNS_10: Configuración cliente Linux
*Inicia sesión en debianXX con el usuario //root//.
*Ĉonsulta el contenido del fichero /etc/nsswitch.conf. En este fichero se define el orden que usa el resolver a la hora de buscar información sobre nombres de dominio. Encontrarás algo como esto: {{{hosts:   files  dns}}}. Observa, por tanto, que el orden definido es, en primer lugar //files//(se busca en el archivo /etc/hosts) y en segundo lugar //dns// (se busca en los servidores DNS definidos en el fichero /etc/resolv.conf).
*Edita el fichero /etc/resolv.conf. En este fichero se pueden configurar múltiples opciones de funcionamiento del resolver. Consta de un conjunto de atributos a los que se les puede asociar valores: {{{&lt;atributo&gt; &lt;valor1&gt; &lt;valor2&gt; &lt;valor3&gt; ... &lt;valorN&gt;}}}. El atributo más importante es //nameserver// que permite especificar los servidores DNS que consultará el resolver. Se consulta en el orden que aparecen definidos. Otros atributos son //domain// (indica el dominio por defecto que se añadirá a las búsquedas de nombres no cualificados) o //search// (especifica una lista de dominios que se añadirán en las búsquedas no cualificadas). 
*Usa la directiva //nameserver// para configurar como servidor DNS preferido el del instituto y como secundario el servidor caché de google.
*Haz un ping a //www.google.es// para comprobar que funciona adecuadamente.
!!!~Actividad_DNS_11_Configuración DNS Windows como solo //cache//
*Iniciamos sesión en w2008XX como administrador. Agregamos el rol de Servidor DNS. Lee las opciones de instalación y opta por las opciones que vienen por defecto.Comprueba, una vez hayas acabado la instalación, que el servidor escucha en los puertos bien conocidos de DNS. Puedes comprobar también que se ha creado una excepción en el //firewall// de windows.
*En Herramientas Administrativas accede a la consola de administración del servidor DNS.
__Configuración del servidor como solo //cache//__
Por defecto el servidor viene configurado como solo //cache// (no es autorizado en ninguna zona) y responde a consultas recursivas.
*Comprueba que el servidor resuelve nombres utilizando el cliente instalado en la máquina local. 
*En la terminología Windows, los servidores raíz se denominan Sugerencias de raíz. Accede a la consola de administración del servidor DNS y haz clic sobre el nombre del servidor en la zona izquierda de la ventana. Haz doble clic en la entrada Sugerencias de raíz de la zona derecha. Observa.
*Inicia sesión en debian. Configura el resolver para que utilice el servidor de Windows. Usa el comando dig para resolver algunos nombres. Comprueba los tiempos de respuesta. Observa como el TTL de los registros va disminuyendo.
!!!~Actividad_DNS_12_Configuracion Servidor DNS Windows como servidor maestro.
Configura el servidor DNS de w2008XX para que:
*El servidor solo servirá a la red local (no sirve a equipos de Internet).
*Actuará como maestro y tendrá autoridad sobre el dominio asix.net.
**No se permitirán actualizaciones dinámicas.
**El servidor DNS maestro será w2008XX.asix.net. (registro NS).
**Los nombres de los equipos serán los de la red virtual (Actividades virtualización). (registro A)
**Se añadirán los siguientes alias (registro CNAME)
***ns1.asix.net será un alias de w2008XX.asix.net
***www.asix.net alias de ubuntuXX.asix.net.
***ftp.asix.net alias de w2008XX.asix.net.
***mail.asix.net alias de debianXX.asix.net.
**El equipo debianXX.asix.net actuará como servidor de correo del dominio (registro MX)
**El tiempo en caché de las respuestas negativas de la zona será de 3 horas.
*Actuará como maestro y tendrá autoridad sobre la zona de resolución inversa de la red 10.33.XX.0/24.
**No se permitirán actualizaciones dinámicas.
**El servidor DNS maestro del dominio será w2008XX.asix.net (registro NS).
**Las direcciones IP de los equipos corresponderán con los que se han definido en la zona de resolución directa.
**El tiempo en cache de las respuestas negativas de la zona será de 3 horas.
Habrá que configurar también los equipos de la red para que utilicen el DNS instalado.
__Configuración del sufijo DNS del equipo__
*Inicia sesión en w2008XX como administrador. Accede a Equipo, botón derecho propiedades.En Configuración avanzada {{{--&gt;}}} Nombre de equipo{{{--&gt;}}}Cambiar.
*Pincha en Más y en Sufijo DNS principal del equipo introduce asix.net.
*Aceptar cambios y reiniciar.
__Configuración de la zona de resolución directa__
*Inicia sesión como administrador
*Inicio{{{--&gt;}}}Herramientas Administrativas{{{--&gt;}}}DNS.
*En &quot;Zonas de búsqueda directa&quot; haz clic con el botón derecho y selecciona &quot;Zona nueva&quot;.
*Lee toda la información que vaya aportando el asistente.
*Selecciona &quot;Zona principal&quot; y luego &quot;Siguiente&quot;.
*Introduce &quot;asix.net&quot; y &quot;Siguiente&quot;.
*Deja la opción &quot;Crear un archivo nuevo con este nombre&quot; y mantén el nombre que sugiere el asistente.
*Selecciona la opción &quot;no admitir actualizaciones dinámicas&quot;.
*Lee el resumen y &quot;Finalizar&quot;.
*Observa que se ha creado una entrada en &quot;Zonas de búsqueda directa&quot;.
*Pincha sobre el nombre de la zona y observa los registros de recursos que se han creado automáticamente: SOA, NS. Haz clic en el SOA y observa sus propiedades. Configura el TTL como mínimo a 3 horas. Haz clic en el registro NS y observa sus propiedades.
*Ahora crea los registros A para los nombres de la red virtual. (botón derecho sobre la zona y elegir &quot;Host nuevo&quot;).
*Crea los registros CNAME para los alias. (botón drch sobre la zona y &quot;Alias nuevo&quot;.
*Crea el registro MX para el servidor de correo.
*Utilizando nslookup comprueba que el servidor funciona correctamente y resuelve los nombres de la red local.
__Configuración de la zona de resolución inversa__
*Crea una nueva zona en &quot;Zonas de búsqueda inversa&quot;
*Lee la información del asistente.
*Selecciona las opciones pertinentes y finaliza.
*Observa que se ha creado una nueva zona en &quot;Zonas de búsqueda inversa&quot;. Observa los registros que ya están creados.
*Configura el TTL del SOA a 3 horas.
*Añade los registros PTR para los nombres de los equipos de la red virtual. (botón drch{{{--&gt;}}}Nuevo puntero) Nota: puedes utilizar la opción &quot;Examinar&quot; para seleccionar los registros A que creaste prevíamente.
*Comprueba que efectivamente el servidor realiza las resoluciones inversas.
!!!~Actividad_DNS_13: Servidor DNS BIND en Linux. Como caché y reenviador.
Antes que nada, localiza el [[manual|http://www.bind9.net//]]
__Instalación__
{{{
sudo apt-get update
sudo apt-get install bind9

Comprobaciones:

#El servidor se ha iniciado
ps -ef | grep named

#El servidor está a la escucha en los puertos 53 de UDP y TCP
netstat -ltun
}}}
__Ficheros de configuración__
*/etc/bind/named.conf
**Fichero de configuración prinicipal
**No se suele modificar
**Almacena la configuración de las diferentes zonas generadas por defecto en el momento de la instalación .
**Incluye el resto de ficheros de configuración (mediante la directiva //include//).
*/etc/bind/named.conf.options:
**Configuración de opciones generales de funcionamiento del servidor.
*/etc/bind/named.conf.local
**Fichero de configuración de zonas.
**Se declaran las zonas de resolución directa y de resolución inversa del servidor.
*/etc/bind/named.conf.default-zones
**Contiene la declaración de las zonas por defecto que tiene creadas BIND.
*Ficheros de zonas
**Ficheros que definen los registros de recursos de cada zona.
**Son referenciados desde las declaraciones de zonas en /etc/bind/named.conf.local.
**Al instalar el servidor se crean un conjunto de archivos de zonas por defecto:
***/etc/bind/db.root: servidores raíz.
***/etc/bind/db.local: resolución directa del bucle local.
***/etc/bind/db.127: resolución inversa del bucle local.
***/etc/bind/db.0: resolución inversa //broadcast//
***/etc/bind/db.255: resolución inversa de //broadcast//.
NOTA: Conviene hacer copia de todos aquellos archivos de configuración que vayas a modificar antes de modificarlo.
__Configuración del servidor como solo cache__
Por defecto el servidor está configurado como solo cache (no es autorizado para ninguna zona) que responde a consultas recursivas (tiene la recursividad activada).
#Comprueba que el servidor resuelve nombres de dominio de Internet configurando el cliente para que utilice el servidor DNS instalado. Usa nslookup para resolver un nombre.
#Para que el servidor puede iniciar consultas recursivas tiene que conocer cuáles son los servidores DNS raíz. Consulta el fichero /etc/bind/db.root. Échale un vistazo.
#Inicia otra máquina. (Si has instalado bind en ubuntu, inicia debian).
#Configura el resolver para que utilice el servidor recién instalado.
#Usa el comando dig para preguntar por algún dominio. Comprueba el tiempo de respuesta.
#Vuelve  usar el comando dig para preguntar por el mismo dominio. Comprueba que el tiempo de respuesta decrece considerablemente. ¿Por qué?
#Ejecuta sucesivamente el mismo comando y observa como el campo TTL va decrementando.
__Configuración del servidor para que reenvíe consultas a reenviadores (//forwaders//)__
#Edita el fichero named.conf.options y configura como reenviador el servidor DNS del instituto eliminando el comentario de la directiva //forwarders//:
{{{
forwarders {
    192.168.0.207;
}
#Reiniciamos
sudo /etc/init.d/bind9 stop
sudo /etc/init.d/bind9 start
}}}
Accede a otra máquina e inicia una captura con el Wireshark en modo promiscuo. Utiliza nslookup para resolver algún  nombre. Analiza la captura.
!!!~Actividad_DNS_13: Servidor DNS en Linux.
Configura el servidor BIND de ubuntuXX:
*El servidor solo servirá a la red local (no sirve a equipos de Internet).
*Actuará como maestro y tendrá autoridad sobre el dominio asix.net.
**No se permitirán actualizaciones dinámicas.
**El servidor DNS maestro será ubuntuXX.asix.net. (registro NS).
**Los nombres de los equipos serán los de la red virtual (Actividades virtualización). (registro A)
**Se añadirán los siguientes alias (registro CNAME)
***ns1.asix.net será un alias de ubuntuXX.asix.net
***www.asix.net alias de ubuntuXX.asix.net.
***ftp.asix.net alias de w2008XX.asix.net.
***mail.asix.net alias de debianXX.asix.net.
**El equipo debianXX.asix.net actuará como servidor de correo del dominio (registro MX)
**El tiempo en caché de las respuestas negativas de la zona será de 3 horas.
*Actuará como maestro y tendrá autoridad sobre la zona de resolución inversa de la red 10.33.XX.0/24.
**No se permitirán actualizaciones dinámicas.
**El servidor DNS maestro del dominio será ubuntuXX.asix.net (registro NS).
**Las direcciones IP de los equipos corresponderán con los que se han definido en la zona de resolución directa.
**El tiempo en cache de las respuestas negativas de la zona será de 3 horas.
Habrá que configurar también los equipos de la red para que utilicen el DNS instalado.

__Ayuda__
*Edita el fichero de configuración named.conf.local y declara la zona de resolución directa para el dominio asix.net:
{{{
zone &quot;asix.net&quot;{
     type master;
     file &quot;/etc/bind/db.asix.net&quot;;
};
}}}
*Crea el fichero de resolución directa db.asix.net:
{{{
;la arroba equivale al nombre de la zona
$TTL 1D
@   IN     SOA     asix.net. administrador.asix.net. (
                             1                                        
                            43200                                 
                            36800                                 
                            2419200                            
                            10800   )                            ; 3 horas de TTL negativo
;El espacio en blanco equivale al valor del registro anterior. En este caso asix.net
        IN   NS    ubuntuXX.asix.net.
;A continuación vendrían resto de registros
;Nota: todos los registros sin punto final se les añade el nombre de zona.
}}}
*BIND incluye dos herramientas de chequeo:
**Comando //named-checkconf//: comprueba el fichero de configuración principal named.conf. La salida muestra los errores.
**Comando //named-checkzone// {{{ named-checkzone asix.net /etc/bind/db.asix.net}}}
*Reiniciar el servidor
*Usar los comandos dig  o nslookup para comprobar que todo funciona correctamente.
*Para configurar la zona inversa:
**Editamos el fichero de configuración named.conf.local y declaramos la zona de configuración inversa para la red:
{{{
zone &quot;1.33.10.in-addr.arpa&quot; {
        type master;
        file &quot;/etc/bind/db.10.33.1&quot;;
};
}}}
**Creamos el fichero de resolución inversa db.10.33.1 añadiéndole los registros adecuados:
{{{
$TTL 1D
@   IN     SOA     1.33.10.in-addr.arpa. administrador.asix.net. (
                             1                                        
                            43200                                 
                            36800                                 
                            2419200                            
                            10800   )                            ; 3 horas de TTL negativo
        IN   NS    ubuntuXX.asix.net.

2        IN  PTR  debianXX.asix.net.
;A continuación vendrían resto de registros
}}}
**Comprobamos los archivos con //named-checkconf// y //named-checkzone 1.33.10.in-addr.arpa  /etc/bind/db.10.33.1//
**Reiniciamos el servidor y comprobamos con nslookup.
</pre>
</div>
<div title="Actividad 1: Clientes de Correo" creator="YourName" modifier="YourName" created="201401290041" modified="201401290042" changecount="2">
<pre>*Cliente (MUA) de correo en //Windows//:
**Crea una cuenta en //gmail//. Configúralo para que permita la descarga de correo POP y acceso IMAP.
**Instala el //Mozilla Thunderbird// en w7XX con las opciones por defecto. Inicia el programa y completa la información que solicita el asistente.
**Mozilla dispone de una base de datos con los nombres DNS de los servidores de correo (MTA y servidores POP/IMAP) de los principales proveedores de Internet y por eso detecta automáticamente los nombres, puertos y métodos de autenticación/seguridad que hay que configurar para //Gmail//. Pero nosotros lo vamos a hacer de forma manual (//Configuración Manual de Thunderbird//) y consultando la ayuda de //Gmail//.
**Pincha en &quot;crear cuenta&quot; para continuar. Se sincronizará el buzón de correo.
**Repite los pasos con una cuenta de //Hotmail// (Archivo - Nuevo - Cuenta de correo)
*Cliente (MUA) de correo en //Linux//:
**Inicia sesión en ubuntuXX.
**Accede al menú Aplicaciones{{{--&gt;}}} Oficina {{{--&gt;}}} correo y calendario Evolution.
**Sigue los pasos del asistente para crear una cuenta asociada a la cuenta de //Gmail//</pre>
</div>
<div title="Actividad 1: Codecs" creator="YourName" modifier="YourName" created="201403131458" modified="201403190001" changecount="2">
<pre>#Descarga el codec [[FLAC|http://flac.sourceforge.net/index.html]] y prueba a comprimir diferentes ficheros de audio para comprobar el ratio de compresión que es capaz de alcanzar. Restaura a continuación los ficheros comprimidos y comprueba si el fichero restaurado coincide exactamente con el original. 
#La aplicación [[dbPowerAmp|http://www.dbpoweramp.com/]] nos permite conversiones entre los diversos formatos de audio y la aplicación de multitud de codecs. Aplícala para pasar un fichero .waw o .cd a mp3 y viceversa de forma repetida. Comprueba si va reduciéndose el tamaño del fichero mp3 y si se aprecia la pérdida de calidad al reproducir el mismo.
#¿Para que sirven las herramientas //Gspot// o //~MediaInfo// o //~AVICodec//? Instala alguna de ellas y realiza alguna prueba para ver cómo funcionan..</pre>
</div>
<div title="Actividad 2.1 (Opcional): Monta una radio" creator="YourName" modifier="YourName" created="201403270053" changecount="1">
<pre>Monta tu propia [[radio|http://www.radionomy.com/ES]]. Espectacular estos belgas...</pre>
</div>
<div title="Actividad 2: Configuración postfix" creator="YourName" modifier="YourName" created="201401300147" modified="201401300156" changecount="3">
<pre>*Configura el servidor de correo para que pueda reenviar correos de cualquier máquina de la red 192.168.1.0/24. Comprueba que funciona. Para ello, levanta otra máquina virtual y trata de enviar algún correo a filemon@asix.net. __Ayuda__: Necesitarás un MUA más potente que &quot;mail&quot;. Un posibilidad excelente: Alpine. 
*Trata de conseguir la misma comprobación utilizando un MUA con interfaz gráfica.</pre>
</div>
<div title="Actividad 2: Servidor Streaming Audio" creator="YourName" modifier="YourName" created="201403190111" modified="201403271606" changecount="7">
<pre>!!!Servidor streaming
En esta práctica instalaremos el software //Icecast2//, servidor de streaming libre y gratuito y comprobaremos su funcionamiento desde el lado del cliente.
*Iniciamos sesión con permisos de root en Ubuntu.
*Instalamos el paquete icecast2: {{{sudo apt-get install icecast2}}}
*Podemos seguir las indicaciones de la instalación o hacerlo manualmente:
**Editamos el archivo de configuración {{{/etc/icecast2/icecast.xml}}}:
***Usuario &quot;source&quot; es el productor del contenido multimedia.
***Usuario &quot;relay&quot; se usuará para emitir contenido de otros servidores multimedia.
***Usuario &quot;admin&quot; para administración del servidor.
***El puerto del servicio será el 8000.
***Configuramos los directorios que empleará el servidor para guardar logs, los ficheros para streaming y los ficheros de administración.
{{{
&lt;source-password&gt;sourcepwd&lt;/source-password&gt;
&lt;admin-user&gt;admin&lt;/admin-password&gt;
&lt;admin-password&gt;tentenpie&lt;/admin-password&gt;
&lt;logdir&gt;/var/log/icecast2&lt;/logdir&gt;
&lt;webroot&gt;/usr/share/icecast2/web&lt;/webroot&gt;
&lt;adminroot&gt;/usr/share/icecast2/admin&lt;/adminroot&gt;
}}}
**Guardamos cambios.
**Editamos el fichero /etc/default/icecast2 para habilitar el script de init.d:
{{{
ENABLE=true
}}}
**Iniciamos el servicio: {{{$/etc/init.d/icecast start}}}

Comprobamos que todo va bien:
En el navegador indicamos la IP y el puerto configurados previamente en el archivo de configuración (127.0.0.1:8000 por defecto). Nos debe aparecer la pagina de administración del servidor. La página de inicio nos solicitará el nombre de usuario y la contraseña que establecimos en el fichero de configuración.

NOTA: No dejes de mirar la documentación del icecast. La sección de preguntas frecuentes está francamente bien.

!!!Configuración de un servidor de streaming en directo con playlists en ~IceCast
En esta práctica se configura primero un reproductor de contenido multimedia (ices2) como productor en directo conectándolo al servidor de streaming Icecast2. Icecast2 realiza entonces una emisión de difusión de ese contenido al que los clientes se conectarán.
*Instalamos el codec vorbis (para poder emplear el formato ogg) y el reproductor ices2: {{{sudo apt-get install ices2 vorbis-tools}}}
*Configuracióhn de una playlist:
**Creamos un fichero de configuración para playlist: modificamos el fichero de ejemplo /usr/share/doc/ices2/examples/ices-playlist.xml y lo renombramos como /etc/ices2/ices-playlist.xml
**Editamos el fichero de configuración /etc/ices2/ices-playlist.xml  establecemos los parámetros de nuestra emisora mediante:
**Indicaremos: el nombre del fichero que contiene la playlist, el nombre del servidor, el puerto de escucha, la contraseña para poder conectarnos desde el productor hacia el servidor (sourcepwd) y el punto de montaje de la playlist que indica la referencia a poner en la URL (se accederá al contenido desde {{{http://servidor:8000/playlist.ogg}}}
{{{
&lt;input&gt;
&lt;module&gt;playlist&lt;/module&gt;
&lt;param name=&quot;type&quot;&gt;basic&lt;/param&gt;
&lt;param name=&quot;file&quot;&gt;/playlist.ogg&lt;/param&gt;
&lt;/input&gt;

&lt;hostname&gt;localhost&lt;/hostname&gt;
&lt;port&gt;8000&lt;/port&gt;

&lt;password&gt;sourcepwd&lt;/password&gt;

&lt;mount&gt;/playlist.ogg&lt;/mount&gt;
}}}
*Creamos el fichero playlist.ogg conteniendo la ruta absoluta de los ficheros .ogg que van a formar parte de la playlist: 
{{{
/media/sd5/Musica/cancion1.ogg
/media/sda5/Musica/cancion2.ogg
...
}}}

*Ejecutamos el codificador: {{{sudo ices2 /etc/ices2/ices-playlist.xml}}}

Comprobación final: accedemos del nuevo desde el navegador y comprobamos que todo está en orden desde la página de //Active Mountpoints//. Después podemos probar a acceder desde algún cliente estilo Amarok, Banshee, Totem, etc. Simplemente habrá que añadir la URL de nuestra radio: 
{{{http: //127.0.0.1:8000/playlist.ogg.m3u}}}
</pre>
</div>
<div title="Actividad 3: Postfix y DNS" creator="YourName" modifier="YourName" created="201402061357" modified="201402120126" changecount="4">
<pre>__Primera Parte__
*Monta en una misma red dos ~MTAs (dos postfix). El primero tendrá las siguientes características:
**Tendrá la IP 192.168.1.2 (por ejemplo) y por nombre smtpserver1@asix.net (por ejemplo)
**Dará servicio al dominio asix.net. 
**Gestionará todos los correos que lleguen para usuarios del dominio asix.net
**Reenviará los correos de todos aquellos que se encuentren en la subred 192.168.1.0/28
*El segundo MTA tendrá las siguientes características:
**Tendrá la IP 192.168.1.17 y por nombre smtpserver2@aula.net (por ejemplo)
**Dará servicio al dominio aula.net. 
**Gestionará todos los correos que lleguen para usuarios del dominio aula.net
**Reenviará los correos de todos aquellos que se encuentren en la subred 192.168.1.16/28
__Segunda Parte__
*Cuando tengas todo el tinglado montado -incluyendo DNS -, envía un mensaje desde una máquina distinta (llamémosla maquinaFilemon) a la que está rodando smtpserver1@asix.net. de filemon@asix.net a estudiante@aula.net. Comprueba que todo ha ido correctamente.
*Ahora cambía el parámetro //networks// de tal forma que excluya a la máquinaFilemon y comprueba que, efectivamente, filemon ya no puede enviar correos.</pre>
</div>
<div title="Actividad 3: Servidor Streaming a la carta" creator="YourName" modifier="YourName" created="201403270140" modified="201403270141" changecount="4">
<pre>Fundamentalmente hay dos tipos de servidores de streaming: a la carta y por difusión. ¿Qué diferencias hay entre uno y otro?

En esta actividad vamos a instalar un servidor a la carta. Se trata de [[gnump3d|http://www.gnu.org/software/gnump3d/download.html]].

__Instalación__
*Levantamos una máquina Debian o similar
*Descargamos el software: {{{wget http://savannah.gnu.org/download/gnump3d/gnump3d-3.0.tar.gz}}}
*Descomprimimos y nos movemos a la carpeta generada 
*Instalamos: {{{make install}}}

__Configuración__
*Echa un vistazo al archivo de configuración: {{{nano /etc/gnump3d/gnump3d.conf}}}
*En principio no hay que cambiar nada en el archivo, solo tienes que averiguar la ruta al contenido multimedia. Para ello no hay más que ir leyendo el archivo. De momento, con una lectura rápida bastará.

__Puesta en marcha__
*{{{gnump3d &amp;}}}
*A continuación, desde cualquier navegador: &lt;~IP_debian&gt;: 8888</pre>
</div>
<div title="Actividad 4: Protocolo SMTP" creator="YourName" modifier="YourName" created="201402130033" changecount="1">
<pre>Envía un correo en local de filemon@asix.net a mortadelo@asix.net utilizando una conexión telnet. Busca los comandos. [[Una posibilidad|http://www.concepto.com.uy/PETROCSHARP/hwnver03.aspx?1,N,0,0,217]]</pre>
</div>
<div title="Actividad 4: Servidor Streaming vídeo y audio" creator="YourName" modifier="YourName" created="201404020113" changecount="1">
<pre>http://dev.tnlsoft.com/2013/01/09/compiling-darwin-streaming-server-6-0-3-under-debian-updated/</pre>
</div>
<div title="Actividad 5: Instalación Dovecot" creator="YourName" modifier="YourName" created="201402130145" modified="201402271519" changecount="8">
<pre>Configura el servidor //Dovecot POP/IMAP//:
*Permitirá a los usuarios de la red virtual acceder a sus buzones de correo.
*Solo se permitirán conexiones seguras ~POP3S e ~IMAP4S.
*Los métodos de autenticación permitidos serán PLAIN y LOGIN.
--------------------------------------
!!!Ayuda
__Instalación y configuración__
*Busca documentación oficial de Dovecot y échale una [[ojeada|http://wiki2.dovecot.org/]].
*Instalación {{{apt-get install dovecot-imapd dovecot-pop3d}}}. Se crearán archivos de configuración y certificados digitales autofirmados.
*Comprueba que el servidor funciona y mira si está escuchando en los puertos: TCP (110(POP), 143(IMAP), 995 (POPS), 993 (IMAPS).
*Haz {{{doveconf -n}}} para ver qué opciones están configuradas. Debes de tener entre otras muchas directivas (que en principio no hay que tocar) algo así:
{{{
protocols = pop3 imap
mail_location = maildir: ~/Maildir
}}}
*Para cambiar algún parametro debes mirar {{{/etc/dovecot/dovecot.conf}}} y también a {{{ls /etc/dovecot/conf.d/}}}. Por ejemplo, es probable que tengas que cambiar el parámetro //mail_location//. Observa que en el archivo de configuración ya te indican cómo. Solo hay que descomentar la línea.
*Realiza los cambios que necesites y, después, vuelve a cargar la configuración {{{service dovecot reload}}}
*Comprueba que ahora sí el servidor está a la escucha en los puertos correspondientes.
__Configuración del servidor DNS__
*Crea el alias (registro CNAME) pop.asix.net de debian.asix.net.
*Y otro para imap.asix.net de debian.asix.net.
NOTA: para probar las cosas mejor intentarlas primero sin hacer uso del DNS, es decir, utilizar las ~IPs directamente.

__Comprobar__
*Primera comprobación: en local. Para ello, utilizaremos telnet. [[Aquí|http://systemadmin.es/2009/05/conectar-a-un-servidor-imap-mediante-telnet]] tenéis los pasos.
*Segunda comprobación: desde otra máquina.
**Inicia sesión en w7 (o en Ubuntu con Evolution)
**Crea una cuenta en //Thunderbird// para el usuario  filemon:
***Como servidor imap usa imap.asix.net:143 (primero prueba con la IP)
***Nombre usuario: filemon@asix.net
***Usa contraseña normal como método de identificación.
**Como servidor SMTP (correo saliente) usa smtp.asix.net: 25
***No hay que configurar ningún método de autenticación de SMTP.
*Recupera el correo del buzón de filemon. (Nos pedirá que validemos un certificado desconocido)
*Envía un mensaje (también nos pedirá que validemos el certificado del MTA) de filemon a mortadelo y observa en la máquina debian (o en la que tengas tu MTA) cuáles son y cómo son las cabeceras del mensaje. 
*Configura la cuenta mortadelo para que recupere el correo de su buzón usando POPS.</pre>
</div>
<div title="Actividad 6: Autenticación de usuarios con SASL" creator="YourName" modifier="YourName" created="201402271418" modified="201402271429" changecount="4">
<pre>[[Fuente|http://www.postfix.org/SASL_README.html]]
!Postfix SASL HowTo
!!!Cómo utiliza Postfix SASL
*Postfix no implementa SASL. Necesita de software adicional
*SASL autenticación no está implementada por postfix. Por eso su configuración requiere de dos pasos:
**Configuración de SASL: mecanismos disponibles, backend que verifiquen autenticaciones (bbdd)
**Configurar postfix para habilitar autenticacion SASL
¿Qué implementaciones de SASL soporta postfix? Dos: Cyrus - SASL y Dovecot - SASL (desde la versión 2.3 de postfix). Para averiguar qué implementaciones soporta nuestro postfix: {{{postconf -a}}}. Nosotros utilizaremos Dovecot - SASL
''Configurando Dovecot SASL''
*Para configurar comunicación entre postfix y dovecot: establecemos un listener (socket UNIX), el usuario permitido es postfix y los permisos:
{{{
#En conf.d/10-master.conf:
     service auth {
        ...
        unix_listener /var/spool/postfix/private/auth {
          mode = 0660
          # Assuming the default Postfix user and group
          user = postfix
          group = postfix        
        }
       ...
     }
 
#En conf.d/10-auth.conf
     auth_mechanisms = plain login
}}}
''Habilitando SASL en postfix''
*Por defecto, postfix utiliza la implementación de Cyrus SASL. Para utilizar la de dovecot, hay que indicárselo en el main.cf: {{{smtpd_sasl_type = dovecot}}}
*Ahora hay que indicarle a postfix donde está el listener de dovecot (le daremos ruta relativa): {{{smtpd_sasl_path = private/auth}}}
*A continuación hay que habilitar SASL:
{{{smtpd_sasl_auth_enable = yes}}}
*Ahora (después de hacer un reload postfix) podemos ver, si hacemos una conexión telnet y saludamos con EHLO, que el servidor ofrece servicios de autenticación.
*Sin embargo, no todos los clientes entienden las opciones de autenticación ya que esperan un &quot;=&quot; después del &quot;AUTH&quot;. Para ellos, postfix les reenvía la línea del AUTH si colocamos: {{{broken_sasl_auth_clients = yes}}}. Si volvemos a conectarnos vía telnet veremos como envía la línea del AUTH dos veces.
!!!Políticas de seguridad
*Podemos indicar qué políticas deben aplicarse en la autenticación de clientes:
**noanonymous: no usar mecanismos de autenticación que permitan autenticaciones anónimas
**noplaintext: no usar mecanismos que envíen contraseñas y usuarios en texto plano.
**nodictionary: no usar mecanismos vulnerables a ataques de &quot;dicionario&quot;
**foward_secrecy: requerir autenticaciones entre dos sesiones seguidas
**mutual_auth: usar el mismo mecanismo para autenticar cliente y servidor
*Por defecto (para ver opciones por defecto: {{{postfix -d|grep ^smtpd_sasl }}}), postfix permite cualquier mecanismo excepto aquellos que permiten accesos anónimos:
{{{smtpd_sasl_security_options = noanonymous}}}
!!!Autorizaciones a clientes
La política de reenvios cambia, ya no se controla únicamente con el parámetro mynetworks. ¿Cómo le decimos a postfix que los clientes que se autentican vía SMTP AUTH tienen o no permisos para reenviar los mensajes?
*En el main.cf por ejemplo: {{{ smtpd_relay_restrictions =permit_mynetworks permit_sasl_authenticated  reject_unauth_destination }}}. Con estas opciones estamos permitiendo el reenvío a clientes de nuestra red (de lo que definamos en mynetworks), de los clientes autenticados vía sasl y rechazamos destinos que no válidos.
!!!¿Como comprobamos que funciona la autenticación SASL?
*En mynetworks solo permitimos la red local (localhost)
*Realizamos una conexión con telnet. Hay que buscar un blog o similar que nos indique cómo nos autenticamos vía telnet utilizando SASL. Entre otras cosas debemos averiguar como codificar nuestro usuario y contraseña.
*Prueba con algún cliente gráfico a ver qué pasa.
*¿Es segura la comunicación ahora? Es decir, con solo autenticar los usuarios, ¿podemos asegurar que la comunicación es segura?</pre>
</div>
<div title="Actividad 7: Comunicación Encriptada con SSL/TLS" creator="YourName" modifier="YourName" created="201403051723" changecount="1">
<pre>[[Fuente|http://www.postfix.org/TLS_README.html]](quick and dirty)
!Cómo configurar postfix con SSL/TLS
*Transport Layer Security (TLS) provee servicios de autenticación basada en certificados y encriptación de la comunicación.
*[[Funcionamiento según wikipedia]]
*[[Funcionamiento según intypedia|http://www.intypedia.com/]]
*Hay tres maneras de obtener una comunicación encriptada utilizando TLS:
**Generar certificados autofirmados (lo que vamos a hacer aquí)
**Crear nuestra entidad certificadora (CA) y expedir nuestras propias firmas o certificados
**Contratar a un tercero (de confianza) para que nos sirva de entidad certificadora.
*Las ventajas/inconvenientes de cada una de las maneras se pueden leer [[aquí|https://workaround.org/ispmail/squeeze/ssl-certificates]]
*__Para generar un certificado auto-firmado__: estamos generando nuestro propio certificado autofirmado.
**Creamos nuestra clave privada {{{openssl genrsa -out server.key 2048}}}
**Esta clave de 2048bits debe quedar con permisos de lectura y escritura únicamente para root: {{{chmod 600 server.key}}}
**Creamos nuestra clave pública {{{openssl req -new -key server.key -x509 -days 365 -out server.crt}}}
**Nos pedirá un montón de datos: país, nombre, organización, mail, etc.
*Ahora simplemente hay que habilitar tls en el archivo de configuración de postfix:
(NOTA: hay que copiar la clave y el certificado a /etc/ssl/certs y a /etc/ssl/private respectivamente)
{{{
smtpd_tls_cert_file=/etc/ssl/certs/server.crt
smtpd_tls_key_file=/etc/ssl/private/server.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
}}}
*Reiniciamos el servicio de Postfix
*Para testear la conexión TLS:{{{openssl s_client -connect &lt;nuestroSevidorSMTP&gt;:25 -starttls smtp}}} {{{--&gt;}}} Construimos el tunel SSL/TLS y, a partir de aquí, seguimos con una conexión telnet normal: {{{ EHLO server ....}}}
!¿Qué hay que hacer en esta actividad?
*Conseguir establecer la comunicación con postfix utilizando TLS. 
*Verificar la combinación de TLS con SASL 
*Buscar cómo conseguir lo mismo con Dovecot y hacerlo (muy sencillo)
*Comprobar con algún cliente gráfico que la comunicación con el servidor IMAP está encriptada.</pre>
</div>
<div title="Actividad 8: Postfix con MySql" creator="YourName" modifier="YourName" created="201403060200" modified="201403061127" changecount="20">
<pre>!Intro
*Postfix utiliza las tablas de búsqueda para: control de acceso, redireccionamiento (address rewriting) e, incluso, para filtrado de correos.
*Los tipos de tablas de búsqueda que soporta postfix se puede obtener realizando: {{{postconf -m}}}
*Cualquier tabla de búsqueda de postfix -sea del tipo que sea- alberga parejas de valores (key, value). Se les suele llamar &quot;mapas&quot; o &quot;hash table&quot;
!Para Debian squeeze (6.0)
[[Fuente|https://workaround.org/ispmail/squeeze]]
*En debian no es necesario recompilar postfix para poder &quot;engancharlo&quot; a Mysql. Solo es necesario instalar el paquete: //postfix-mysql//
!!!Dominios virtuales
*Postfix distingue tres tipos de dominios:
**''Local domains'':&amp;nbsp;
***Definido por el parámetro //mydestinations//
***Formado por local users (/etc/passwd). Es decir, si en //mydestinations// tenemos aula.net y asix.net y el SO tiene un usuario llamado filemon, el sistema recogerá todos los correos que vayan tanto a filemon@asix.net como a filemon@aula.net. De hecho, no hay forma de tener diferentes usuarios en cada dominio local.
***En principio, postfix guardará los correos de cada usuario en /var/mail/username
**''Virtual ~MailBox Domains''
***Domino para el que también se recogerán los correos. Es decir, igual que //mydestinations// pero en este caso los usuarios no son los del sistema.&amp;nbsp;
***Se utiliza el parámetro //virtual_mailbox_domains// para definirlos.
***Para este tipo de dominios el administrador define explícitamente quiénes son los usuarios.
&lt;&lt;&lt;
Por ejemplo, supongamos que tenemos los dominios virtuales siguientes: {{{virtual_mailbox_domains=aula.net asix.net}}}
Para definir los usuarios de cada dominio e indicar dónde se deben almacenar los correos de cada uno de ellos, podemos utilizar un archivo de texto que contenga:
{{{
filemon@aula.net &amp;nbsp; /var/mail/aula/filemon/Maildir
filemon@asix.net &amp;nbsp; /var/mail/asix/filemon/Maildir
etc...
}}}
&lt;&lt;&lt;
NOTA: A este tipo de mapas (clave, valor) o tablas de dos columnas se les llama ''mapping'' o ''hash table''
***Si tuviésemos muchos dominios virtuales podría ser problemático indicarlos todos mediante el parámetro //virtual_mailbox_domains// en el archivo de configuración. Una alternativa disponible es utilizar también un &quot;mapping&quot; o &quot;hash table&quot;
&lt;&lt;&lt;
Siguiendo con el ejemplo anterior, vamos a crear un archivo de texto -un mapa- que contenga los dominios virtuales:
{{{
asix.net &amp;nbsp;OK
aula.net &amp;nbsp;OK
....
}}}
El OK es formal. Postfix trabaja siempre con pares de valores pero en este caso le da igual lo que haya en la segunda columna (podría ser cualquier cosa en vez de &quot;OK&quot;)
Ahora los parámetros de configuración quedan así:
virtual_mailbox_domains=hash:/etc/postfix/virtual_mailbox_domains &amp;nbsp;#( ruta al documento que hemos creado con los dominios virtuales)
virtual_mailbox_maps=hash:/etc/postfix/virtual_mailbox_users #(ruta al documento con los usuarios virtuales)
&lt;&lt;&lt;
NOTA: Después de cada modificación en los archivos o mapas de usuarios y dominios virtuales se debe ejecutar {{{postmap /etc/postfix/virtual_mailbox_users/domains}}}. Este comando creará los archivos .db que son los que utilizará postfix realmente.
*** Obviamente existen muchas alternativas a esta forma de mapear los usuarios y dominios del sistema de correo. Otra forma es utilizar una base de datos.
&lt;&lt;&lt;
Ejemplo: dominios virtuales con mysql
*Primero creamos el archivo que &quot;define&quot; los usuarios virtuales. Lo llamaremos &quot;virtual_mailbox_maps.cf&quot; y contendrá información para acceder a mysql:
{{{
user = someone
password = some_password
hosts = 127.0.0.1
# A continuación, el nombre de la base de datos
dbname = mailserver
# La consulta SQL
query = SELECT mailbox_path FROM virtual_users WHERE email_address='%s'
#El parámetro %s (la clave del mapa) lo pondría postfix en cada consulta
}}}
*En main.cf pondríamos: {{{virtual_mailbox_maps=mysql:virtual_mailbox_maps.cf}}}
*Para testear la bbdd (emular las consultas que hará postfix): {{{postmap -q filemon@asix.net mysql:virtual_mailbox_maps.cf}}}
&lt;&lt;&lt;
**Virtual Alias Domains
***El tercer tipo de dominio en discordia
***Se utiliza para redirigir/reenviar correo entrante a otras direcciones.
***Se puede definir todo un alias de un dominio que redirija el correo a otro.&amp;nbsp;
***También se implementa con mapas pero en este caso pueden haber más de un valor (clave, valor1, valor2, ...)
!Qué hacer en esta actividad
Vamos a montar un conjunto de dominios y usuarios virtuales para postfix. Para ello:
*Preparamos la base de datos:
**Levantamos otra máquina con mysql
**Creamos la base de datos &quot;mailserver&quot;
**Creamos las tablas siguientes:  
***~VIRTUAL_DOMAINS (ID INT PRIMARY KEY ~AUTO_INCREMENT, NAME VARCHAR(50)) (Acuérdate de utilizar charset=utf8)
***VIR~TUAL_USERS(ID INT PRIMARY KEY ~AUTO_INCREMENT, ~ID_DOMAIN INT, PASSWORD VARCHAR(32), EMAIL VARCHAR(100), PATH VARCHAR(200)) DONDE ~ID_DOMAIN REFERENCIA ~VIRTUAL_DOMAINS (ID) (Acuérdate de utilizar charset=utf8)
**Realiza algunas inserciones para poder testear.
**Creamos el usuario mailserver. Le damos los permisos apropiados.
*Configurando postfix:
**Creamos el archivo virtual_mailbox_domains.cf:
{{{
user = mailserver
password = &lt;laDelUsuario_mailserver&gt;
hosts = &lt;dirección máquina con Mysql&gt;
dbname = mailserver
query= SELECT 1 FROM VIRTUAL_DOMAINS WHERE NAME='%s'
#Esta consulta permite averiguar si un dominio se encuentra en la tabla o no. Si es que sí, devolverá un 1 (da igual lo que 
#devuelva, pero tiene que ofrecer algún resultado)
}}}
**Creamos el archivo virtual_mailbox_maps.cf:
{{{
user = mailserver
password = &lt;laDelUsuario_mailserver&gt;
hosts = &lt;dirección máquina con Mysql&gt;
dbname = mailserver
query= SELECT PATH FROM VIRTUAL_USERS WHERE EMAIL='%s'
#Esta consulta permite averiguar dónde albergar los correos de un usuario)
}}}
**Añadimos al main.cf:
{{{
virtual_mailbox_domains=mysql:/etc/postfix/virtual_mailbox_domains.cf
virtual_mailbox_maps=mysql:/etc/postfix/virtual_mailbox_maps.cf
}}}
*Recargamos la configuración de postfix, comprobamos con postmap y ya está.
*Faltará comprobar que el envío de correos funciona correctamente haciendo uso de los nuevos usuarios virtuales.</pre>
</div>
<div title="Actividad 9: Un vistazo a la mensajería instantánea" creator="YourName" modifier="YourName" created="201403120139" modified="201403120141" changecount="2">
<pre>#Instala el cliente de IM sobre Linux o Windows //pidgin//. Este cliente puede conectarse a diferentes redes de IM (AIM, ICQ, Google talk, Jabber/XMPP, MSN Messenger,...). Prueba a comunicarte con tus compañeros de clase aunque estos utilicen diferentes redes de IM.
#Busca alguna comparativa de clientes de IM. Prueba a instalar alguno que desconozcas.
#Busca información sobre servidores de IM basados en XMPP. [[Ejemplo|http://xmpp.org/xmpp-software/servers/]]. Documenta brevemente características de alguno.
#¿Qué es IRC? ¿Qué servicio implementa?¿Qué relación tiene dicho servicio con IM?¿En qué se diferencia?</pre>
</div>
<div title="Actividad FTP II" creator="YourName" modifier="YourName" created="201401081638" changecount="1">
<pre>Configura //vsftp// (comenta las líneas que añades a la configuración) para que:
*Se permita la conexión a los usuarios locales.
*Los usuarios locales podrán descargar y subir archivos.
*Los usuarios locales estarán enjaulados en su directorio //home//.
Comenta lo que haces, inserta algún pantallazo que demuestre que logras la configuración pedida.</pre>
</div>
<div title="Actividad FTP III" creator="YourName" modifier="YourName" created="201401081642" changecount="1">
<pre>__Actividad_2__
Una de las variantes del protocolo FTP es TFTP. 

TFTP es un servicio ligero para la transferencia de archvos que no requiere autenticación de usuarios. Se trata de un servicio muy utilizado para transferir archivos de arranque a través de la red. 

Una de las opciones de arranque de un ordenador es el arranque desde red. El computador, cuando optamos por esta forma de arranque, busca un dhcp que le otorgue una configuración de red, le indique la dirección del servidor TFTP y el archivo que debe solicitarle. Por tanto hay que configurar:
**Un DHCP que traslade a los clientes la IP del servidor TFTP y el archivo de arranque que deben solicitarle 
**Un servidor TFTP que atienda las peticiones y que albergue los diferentes archivos de arranque así como el entorno PXE.

La receta para este guiso la tenéis:
*[[Usando dnsmasq|http://sirlagz.net/?p=131]]
*[[Usando dhcp3|http://www.debian-administration.org/articles/478]]

Yo he utilizado para realizar la práctica un isc-dchpd-server como servidor DHCP (con el que ya estuvimos trabajando en la ~UF1) y el demonio atfpd como servidor TFTP. Aunque, obvíamente, podéis optar por cualquier otro (dnsmasq y tftpd-hpa, por ejemplo). Aconsejo ir montando, configurando y testeando cada servicio por separado y después, una vez comprobado que funcionan como deben, pasar a enlazarlos.

El objetivo de la práctica es montar un servidor PXE que ofrezca a los clientes un abanico de posibilidades de arranque. En principio, con  ofrecer el memtest y algún núcleo más ([[uno interesante|http://clonezilla.org/livepxe.php]]) bastaría aunque os animo a añadir más. Sería conveniente, después de probar el montaje en local, testearlo con algún compañero de clase y reflexionar sobre qué problemas podrían aparecer si lo tuviésemos que montaren una red grande.

Por último, documentar la práctica: enlaces interesantes, problemas que han surgido, soluciones, problemas sin solución (de momento), configuración del software, etc. No olvides leer todo lo que puedas sobre TFTP, el entorno PXE (pxelinux en este caso), opciones del dhcp, etc.</pre>
</div>
<div title="Actividades" creator="YourName" modifier="YourName" created="201310022200" modified="201311291448" changecount="9">
<pre>[[Act_DHCP]]
[[Act_DNS]]

''Preparación examen''
[[Examen Año Pasado]]

[[Examen UF1]]
[[Recuperación UF1]]</pre>
</div>
<div title="Actividades Apache I" creator="YourName" modifier="YourName" created="201311210011" modified="201311210013" changecount="3">
<pre>#Cambia el mensaje de bienvenida de la página por defecto del Apache. Sustituye el //It works!// por la primera tonteria que se te ocurra. 
#Crea un enlace simbólico a una carpeta de tu escritorio desde el directorio del Apache. Elimina el archivo index.html de dicho directorio, ¿qué sucede? 
#Busca información: ¿que es apche2ctl? ¿Para qué sirve? Documéntalo para usos futuros... seguro que lo necesitarás.
#Cambia el puerto donde está escuchando apache al 2099. ¿Cómo podemos comprobar que está funcionado el servidor?</pre>
</div>
<div title="Actividades Apache II" creator="YourName" modifier="YourName" created="201311270042" modified="201311270043" changecount="2">
<pre>#Realizar una captura  con Wireshark de una comunicación HTTP. Identificar método, cabeceras, versión de HTTP, mensaje de respuesta.
#Instalar complemento de Firefox &quot;Live HTTP Headers&quot;. Accede a varias webs y captura las diferentes cabeceras.
#Accede a &quot;Herramientas para desarrolladores&quot; en //Google Chrome// e investiga la herramienta. ¿Para qué sive? Accede a varias webs y observa las peticiones HTTP: métodos, respuestas, tipos de recursos enviados por el servidor, código html, etc.
#Encuentra una buena página para consultar el significado de las cabeceras HTTP. Explica  brevemente las cabeceras capturas en la actividad 2.</pre>
</div>
<div title="Actividades Apache III" creator="YourName" modifier="YourName" created="201311271747" modified="201312041742" changecount="6">
<pre>!!!Actividades para documentar
#Documenta (o aprende su significado) las siguientes directivas: ~DirectoryIndex, Options Indexes, ~DocumentRoot, ~ServerName, Allow/Deny.
#Configura dos vhosts basados en IP. ¿Cómo quedaría la configuración del DNS? 
#Configura dos vhosts basados en nombres. ¿Cómo quedaría la configuración del DNS? 
#Configura dos vhosts basados en puertos. ¿Cómo quedaría la configuración del DNS?
</pre>
</div>
<div title="Actividades Apache IV" creator="YourName" modifier="YourName" created="201312111616" modified="201312111632" changecount="5">
<pre>1-El administrador quiere ser el único que tenga acceso a ciertos archivos 'sensibles' del servidor web. Se le ocurre para ello crear un servidor virtual que escuche en el puerto 55 y sólo permite acceso desde la máquina local. Además, dicho servidor virtual habrá de tener acceso al directorio donde están ubicados los archivos de configuración o 'sensibles'. ¿Cómo puede conseguirlo? Razona brevemente tu respuesta.

2- Un administrador tiene a su cargo dos administradores web que gestionan sendos sitios web. Ambos sitios web requieren autenticación básica para acceder a sus contenidos. El problema es que cada x tiempo el conjunto de usuarios que deben poder acceder a dichos contenidos va variando. ¿Cómo hacer que los administradores web puedan gestionar los permisos de sus sitios pero no tengan acceso a los archivos de configuración del apache? Ilustra tu respuesta con el código de configuración que consideres necesario.

</pre>
</div>
<div title="Actividades FTP I" creator="YourName" modifier="YourName" created="201401081350" changecount="1">
<pre>Realiza en tu máquina local:
*Captura el tráfico de la red con //~WireShark// en modo promiscuo. 
*Abre un terminal y realiza una conexión con el servidor ftp.rediris.es
*Para la captura y selecciona una trama que contenga el protocolo FTP, haz clic con el botón derecho y selecciona //Follow TCP Stream//.
*Observa y analiza el resultado: qué sucede en cada trama, qué mensajes se están enviados, cuántas conexiones se establecen para una petición, etc.
</pre>
</div>
<div title="Actividades UF2" creator="YourName" modifier="YourName" created="201311210013" modified="201402101714" changecount="19">
<pre>__Servidor Web__
''Actividades guiadas''
[[Instalación Apache]]
[[Configuración Autenticación Apache]]

''Actividades a realizar''
[[Actividades Apache I]]
[[Actividades Apache II]]
[[Actividades Apache III]]
[[Actividades Apache IV]]

__Investiga__
[[Netcraft]]
[[robtex]]

__Servidor FTP__
''Actividades guiadas''
[[Instalación vsftp]]

''Actividades a realizar''
[[Actividades FTP I]]
[[Actividad FTP II]]
[[Actividad FTP III]]

[[Examen UF2]]
[[Recuperación UF2]]</pre>
</div>
<div title="Actividades UF3" creator="YourName" modifier="YourName" created="201401290033" modified="201403142358" changecount="19">
<pre>__Servidor Correo__
''Actividades guiadas''
[[Instalación postfix]]
[[Configuración Postfix]]

''Actividades a realizar''
[[Actividad 1: Clientes de Correo]]
[[Actividad 2: Configuración postfix]]
[[Actividad 3: Postfix y DNS]]
[[Actividad 4: Protocolo SMTP]]
[[Actividad 5: Instalación Dovecot]]
[[Actividad 6: Autenticación de usuarios con SASL]]
[[Actividad 7: Comunicación Encriptada con SSL/TLS]]
[[Actividad 8: Postfix con MySql]]
[[Actividad 9: Un vistazo a la mensajería instantánea]] (opcional: no necesaria para obtener un 10)


''Último día de entrega: 31-03-14''</pre>
</div>
<div title="Actividades UF4" creator="YourName" modifier="YourName" created="201403131458" modified="201404091643" changecount="9">
<pre>[[Actividad 1: Codecs]]
[[Actividad 2: Servidor Streaming Audio]]
[[Actividad 2.1 (Opcional): Monta una radio]]
[[Actividad 3: Servidor Streaming a la carta]]
[[Actividad 4: Servidor Streaming vídeo y audio]]</pre>
</div>
<div title="Actividades_IP" creator="YourName" modifier="YourName" created="201309252155" modified="201310022159" changecount="2">
<pre>1- Utilizando el comando //netstat// obtén:
*Información de todas las conexiones TCP/IP y puertos de escucha de tu ordenador.
*Abre la página xtec.cat y consulta las conexiones TCP establecidas
*Los puertos UDP abiertos. ¿Qué diferencias aprecias en la información mostrada comparándola con la de los puertos TCP?
*Muestra las aplicaciones que han creado cada una de las conexiones TCP.
2- Utilizando el comando //nmap// (probable haya que descargarlo)) averigua: 
*Los puertos TCP y UDP abiertos en tu propio ordenador (//localhost//)
*Los puertos abiertos en la puerta de enlace de tu red. Reconoce los puertos estándar.
*Averigua puertos abiertos en www.google.es y en asterix.fi.upm.es
3- Emplea la aplicación //Wireshark// para analizar el formato y el contenido de los datagramas que circulan por la red. Haz un par de capturas y &quot;cotillea&quot; un poco. Identifica diferencias entre un segmento que encapsule datos del protocolo TCP y otro que encapsule datos del protocolo UDP.</pre>
</div>
<div title="Ayuda" creator="YourName" modifier="YourName" created="201309261514" changecount="1">
<pre>Dando formato al texto:

{{{ ''Texto en negrita'' }}} ''Texto en negrita''

{{{ //Texto en cursiva// }}} //Texto en cursiva//

{{{ --Texto tachado-- }}} --Texto tachado--

{{{ __Texto subrayado__ }}} __Texto subrayado__

{{{ ^^Superíndice^^ }}} ^^Superíndice^^

{{{ ~~Subíndice~~ }}} ~~Subíndice~~

{{{ @@color(grey):Texto coloreado en gris@@ }}} @@color(grey):texto coloreado en gris@@

{{{ @@bgcolor(green):texto subrayado en verde@@ }}} @@bgcolor(green):texto subrayado en verde@@

{{{ @@texto subrayado normal@@ }}} @@texto subrayado normal@@

{{{ Esto NO es una palabra a ~DeFinIR }}} Esto NO es una palabra a ~DeFinIR 

{{{ Esto es un enlace a [[Google|www.google.com]] }}} Esto es un enlace a [[Google|www.google.com]]

{{{ Esto es una imagen [img[Logo de Google|http://www.google.es/logos/Logo_25wht.gif]] }}} [img[Logo de Google|http://www.google.es/logos/Logo_25wht.gif]]


{{{ Esto es una imagen alineada a la izquierda [&lt;img[Logo de Google|http://www.google.es/logos/Logo_25wht.gif]] }}} [&lt;img[Logo de Google|http://www.google.es/logos/Logo_25wht.gif]]


{{{ Esto es una imagen alineada a la derecha [&gt;img[Logo de Google|http://www.google.es/logos/Logo_25wht.gif]] }}} [&gt;img[Logo de Google|http://www.google.es/logos/Logo_25wht.gif]]


{{{ Esto es una imagen con enlace [img[http://www.google.es/logos/Logo_25wht.gif|http://www.google.com]] }}} [img[http://www.google.es/logos/Logo_25wht.gif][http://www.google.com]]

{{{ -- }}} 2 guiones crean uno como este --

{{{ ---- }}}  4 guiones crean una línea horizontal como la siguiente: 
----
ESCAPE Para escapar al formato utilizamos {{{&quot;&quot;&quot;}}}. Así: &quot;&quot;&quot;----&quot;&quot;&quot;
{{{
;Esta es una entrada
:Esta es la definición, indentada
;Esta es la próxima entrada
:Esta es la definiciónEsta es la definiciónEsta es la definiciónEsta es la definiciónEsta es la definición
}}}
;Esta es una entrada
:Esta es la definición, indentada
;Esta es la próxima entrada
:Esta es la definiciónEsta es la definiciónEsta es la definiciónEsta es la definiciónEsta es la definición
{{{
* Esto es una lista
** Y esto una sublista
* Esto es una lista
* Esto es una lista
}}}
* Esto es una lista
** Y esto una sublista
* Esto es una lista
* Esto es una lista

{{{
# Esto es una lista numerada
## Y esto una siblista
# Esto es una lista numerada
# Esto es una lista numerada
}}}
# Esto es una lista numerada
## Y esto una siblista
# Esto es una lista numerada
# Esto es una lista numerada

{{{
| !Columna 1 | !Columna 2 | !Columna 3 |
| esto           | es una       | tabla          |
| esto           | es una       | tabla          |
}}}
| !Columna 1 | !Columna 2 | !Columna 3 |
| esto           | es una       | tabla          |
| esto           | es una       | tabla          |

{{{
&lt;&lt;&lt;
Esto es una cita
&lt;&lt;&lt;
}}}
&lt;&lt;&lt;
Esto es una cita
&lt;&lt;&lt;

{{{ &lt;&lt;tag ayuda&gt;&gt; }}} Obtiene un submenu con todas las entradas etiquetadas como ayuda &lt;&lt;tag ayuda&gt;&gt;

{{{ [[Esto es un concepto a definir o enlace interno]]  }}} [[Esto es un concepto a definir o enlace interno]]

{{{ !Esto es un título 1º nivel }}} 
!Esto es un título 1º nivel

{{{ !!Esto es un título 2º nivel }}} 
!!Esto es un título 2º nivel

{{{ !!!Esto es un título 3º nivel }}} 
!!!Esto es un título 3º nivel</pre>
</div>
<div title="Características Correo Electrónico" creator="YourName" modifier="YourName" created="201401290019" modified="201401290021" changecount="2">
<pre>__Definición__
:El servicio de correo electrónico ofrece a los usuarios la posibilidad de enviarse mensajes a través de una red TCP/IP. 

__Características__
*Es fácil de utilizar.
*Permite el intercambio de mensajes entre usuarios sin necesidad de que el emisor y el receptor establezcan una conexión previa. La comunicación es asíncrona.
*Los mensajes intercambiados son mensajes de texto que pueden contener otros recursos adjuntos (documentos, imágenes, programas, archivos de vídeo, etc.)
*Permite el intercambio de mensaje de forma rápida y económica.
*Un mismo mensaje se puede enviar simultáneamente a múltiples usuarios.

__Componentes__
*''Mensajes de correo'': mensajes de texto que pueden incluir documentos adjuntos.
*''Direcciones y cuentas de correo'': Los usuarios disponen de direcciones de correo asociadas a una cuenta de correo. Esta dirección identifica los mensajes que envía un usuario y la cuenta asociada permite almacenar los mensajes enviados y recibidos.
*''Servidores de correo'': conjunto de componentes que permiten el reenvío de mensajes de correo electrónico:
**''Buzones de correo'' (//mailbox//). Las cuentas de correo tienen asociadas buzones de correo en los cuales se depositan y almacenan los mensajes.
**''Agentes de transferencia de correos'' (MTA, //Mail Transfer Agent// o //Message Transfer Agent// o //mail relay//): Procesos que se encargan de recibir el correo o de reenviarlo a otros agentes de transporte. Pueden actuar como cliente y servidor del ''protocolo SMTP'' que es el protocolo utilizado en la transferencia de mensajes de correo. Es el componente principal y por ello, es habitual usar los términos ''servidor de correo'' y MTA como sinónimos.
**''Agentes de entrega de correos'' (MDA, //Mail Delivery Agent// o //Message Delivery Agent//): Procesos que se encargan de recibir y depositar el correo en los buzones destinatarios. Son invocados por los ~MTAs y pueden realizar  funciones adicionales de distribución, filtrado y clasificación.
**''Servidores POP/IMAP''. Procesos que permiten a los clientes de correo acceder a los buzones para obtener, consultar, borrar o modificar los mensajes almacenados. La comunicación entre ellos y los clientes se realiza según las normas de los protocolos POP y/o IMAP.
**''Componentes adicionales''. Añaden funcionalidades y se integran con el MTA y el MDA. Algunos ejemplos son filtros //antispam//, filtros //antivirus//, sistemas de autenticación, listas de distribución...
*''Clientes de correo o agentes de usuario de correo'' (MUA, //Mail User Agent//). Programas que permiten a los usuarios escribir, enviar y consultar  o manipular los correos almacenados en sus buzones. Actúan como clientes SMTP para enviar correos y pueden actuar como clientes POP/IMAP para acceder a los buzones.
*''Protocolos''. La comunicación entre los diferentes componentes del servicio se basa en los siguientes protocolos:
**''Protocolos de transferencia de correo'':
***''SMTP y SMTP extendido (ESMTP)''.
***Comunicación entre clientes (~MUAs) y ~MTAs, y comunicación entre ~MTAs.
**''Protocolos de entrega de correo''
***''POP e IMAP''.
***Comunicación entre clientes (~MUAs) y servidores POP/IMAP.
[img[MTA;MDA;MUA|http://www.unlocktheinbox.com/images/mua-mta-mda-diagram.png]]
                                                                                                                                                                                                                                                                                                                                                                     
</pre>
</div>
<div title="Características y funcionamiento del servicio DNS" creator="YourName" modifier="YourName" created="201310142127" changecount="1">
<pre>!!!Características fundamentales
*Ofrece un servicio de almacenamiento y consulta de información. Se trata de una base de datos distribuida entre múltiples equipos (''servidores de nombres'').
*La información se ordena según un esquema de nombres jerárquico (''espacio de nombres de dominio'').
*Las consultas las realizan los clientes DNS y para ello utilizan el ''protocolo DNS''.
*DNS puede almacenar varios tipos de información y por ello se puede utilizar para varios propositos. Los más comunes son:
**Resolución directa de nombres (búsqueda directa): obtener la información asociada a un nombre (normalmente IP).
**Resolución inversa de direcciones (búsqueda inversa): obtener el nombre/s asociado a una IP.
**Resolución de servidores de correo: dado un nombre de dominio (//gmail.com//) obtener el servidor a través del cual debe realizarse la entrega de correo electrónico. (&quot;gmail-smtp-in.l.google.com&quot;).
**Otros propósitos: ubicación de servidores para un servicio determinado, listas negras de //spam//, obtención de claves públicas, etc.
!!!Componentes
*''Espacio de nombres de dominio (//domain name space//) '': conjunto de nombres que se pueden utilizar para identificar máquinas o servicios de una red.
*''Base de datos DNS'': Base de datos ''distribuida y redundante'' que almacena información sobre los nombres de dominio. Esta base de datos se organiza en ''zonas'' que almacenan lo que se conoce como ''registros de recursos RR //Resource Records//''
*''Servidores de nombres ( o servidores DNS) (//name servers//)'': Programas que guardan y gestionan parte de la base de datos DNS (zonas) y que responden a las consultas de los diversos clientes.
*''Clientes DNS (//resolvers//)'': Programas que realizan consultas a los servidores DNS.
*''Protocolo DNS'': Conjunto de normas y reglas que siguen los servidores y clientes DNS para comunicarse.
!!!Funcionamiento:
*El servicio DNS sigue el modelo cliente/servidor.
*Los clientes DNS (//resolvers//) preguntan a los servidores DNS y estos responden con la información solicitada.
*Los servidores pueden: 
**Realizar preguntas a otros servidores de nombres cuando no tienen la información que les piden.
**Pueden intercambiar información sobre sus zonas (''tranferencias de zonas'')</pre>
</div>
<div title="Clientes DNS (resolver)" creator="YourName" modifier="YourName" created="201310231520" modified="201310231645" changecount="3">
<pre>;Resolver
:cualquier software capaz de preguntar a un servidor DNS e interpretar sus respuestas.
*Los SO incluyen o permiten instalar un conjunto de librerías, denominadas ''stub resolver'', que realizan estas funciones. Son invocadas por las aplicaciones cuando se utiliza un nombre de dominio.
*La forma de resolver el nombre de dominio es configurable. Lo más habitual es:
**El //resolver// consulta la caché de resolución de nombres (si está configurada).
**Si no está en cache, el //resolver// buscará el archivo //hosts// local. (Linux: /etc/hosts. y Windows: %SYSTEMROOT%\system32\drivers\etc\hosts)
**Si no está en //hosts//, el //resolver// efectuará una consulta recursiva al servidor de nombres que esté configurado.
!!Proceso de resolución
Las consultas a un servidor DNS pueden ser de dos tipos: recursivas o iterativas.
__Consultas recursivas__
Es aquella en la que el servidor tiene que dar una respuesta completa o exacta. Hay tres posibles respuestas:
*Respuesta positiva: da la información solicitada indicando si es autoriazada o no. No se puede averiguar si el servidor que responde con autoridad es maestro o esclavo.
*Respuesta negativa (NXDOMAIN): indica que el nombre no se pudo resolver.
*Una indicación de error. Por ejemplo, que no se pudo preguntar a otros servidores por problemas en la red.
Cuando un servidor recibe una consulta recursiva:
*1-Si es autorizado para alguna zona (maestro o esclavo) comprueba sus archivos de zona. Si encuentra la respuesta responde indicando que la respuesta es autoritativa.
*2-Si no encuentra la respuesta o no es autorizado y actúa como cache, consulta su cache de respuestas anteriores. Si encuentra la respuesta responde indicando que la respuesta no es autoritativa.
*3-En otro caso:
**Si tiene configurados reenviadores entonces reenvía la consulta recursiva a otro servidor DNS. La respuesta que obtenga se la traslada al cliente o el servidor que le preguntó.
**Si no tiene configurados reenviadores:
***Inicia una serie de consultas iterativas a otros servidores DNS.
***Los servidores DNS consultados devuelven referencias (//referrals//) a otros servidores DNS que se usan para realizar otra pregunta.
***La recursividad finaliza siempre cuando un servidor autorizado del espacio de nombres proporcione una respuesta positiva o negativa.
Nota 1: Si un servidor que actúa como cache obtiene la respuesta directamente de un servidor maestro, dará una respuesta autoritativa. Si la obtiene de cache dará una respuesta no autoritativa.    
Nota 2: Para que un servidor resuelva consultas recursivas tiene que tener activada la recursividad. La recursividad está asociada con el comportamiento del servidor como caché.                  
&lt;&lt;&lt;
Ejemplo:
[img[Consulta Recursiva|]]         
''Paso1'':
Usuario teclea en el navegador www.rediris.es. El navegador utilizará las librerías locales (//resolver//) para resolver el nombre. Dichas librerías mirarán primero en la caché local y después realizarán una consulta recursiva al servidor que tengan en la configuración.
''Paso 2'':
El servidor recibe la consulta y, antes que nada, mira en su caché. A continuación, realizará una consulta iterativa.
''Paso 3'':
El servidor realiza la misma consulta que recibió del cliente a uno de los servidores raíz. El servidor sabe quienes son los servidores raíz porque almacena el fichero //hits file//. Por ejemplo, a.root-servers.net.
El servidor raíz tendrá algo así:
{{{
es.   IN NS b.nic.es.
b.nic.es.  IN A 195.81.201.11
}}}
El servidor raíz que ha recibido la consulta iterativa responde con un listado de servidores autorizados para el dominio &quot;es.&quot;
''Paso 4'':
El servidor DNS realiza una consulta iterativa a uno de los servidores autorizados del dominio &quot;es&quot; (normalmente, al primero de la lista)
''Paso 5'':
El servidor autorizado para &quot;es.&quot; tendrá información del dominio &quot;rediris.es.&quot;
{{{
rediris.es   IN NS ns1.rediris.es
ns1.rediris.es IN A 193.100.200.100
}}}
Por lo tanto, el servidor autorizado para el dominio &quot;es.&quot; devuelve un listado de los servidores autorizados en los que ha delegado el dominio &quot;rediris.es&quot;
''Paso 6'':
El servidor DNS realiza una consulta iterativa a uno de los servidores autorizados del dominio &quot;rediris.es.&quot; (normalmente, al primero de la lista)
''Paso 7'':
El servidor autorizado para &quot;rediris.es&quot; contestará autoritativamente.
{{{
www.rediris.es.   IN A 193.100.200
}}}
''Paso 8'':
El servidor DNS reenviará la respuesta obtenida al cliente que la solicitó.

Pregunta: ¿Qué pasará si ahora algún otro cliente consulta www.redpupila.es?
&lt;&lt;&lt;
__Consultas Iterativas__
Una consulta iterativa (o no recursiva) es aquella en la que el servidor DNS puede proporcionar una respuesta parcial. Hay cuatro posibles respuestas:
*Respuesta positiva, es decir, da la información del nombre por el que se ha preguntado. En ella se indica si es autorizada o no.
*Respuesta negativa, indica que el nombre no se pudo resolver (NXDOMAIN).
*Respuesta indicando una referencia a otros servidores, autorizados o no, a los que se puede preguntar (algo que no es válido en el caso de una consulta recursiva).
*Una indicación de error.
Cuando un servidor recibe una consulta iterativa:
*Si es autorizado para alguna zona (maestro o esclavo) comprueba sus archivos de zona y da una respuesta autoritativa.
*Si no encuentra la respuesta o no es autorizado y actúa como caché, consulta su caché de respuestas anteriores. Si encuentra la respuesta responde indicando que no es autoritativa.
*Si no se encuentra respuesta exacta con el nombre, devuelve una referencia que apunta a un servidor DNS que está autorizado para un nivel inferior del espacio de nombres de dominio. (Ejemplo anterior)
!!Caché y TTL
*Clientes y servidores DNS mantienen en memoria caché, si están configurados para ello, las respuestas que reciben tanto si son positivas o negativas (nombres que no existen).
*El tiempo que guardan las respuestas en caché se denomina TTL (//Time To Live//) y se define en los archivos de zona de los servidores. Habrá un TTL para respuestas positivas y un TTL para respuestas negativas
*La RFC 1912 recomienda un valor TTL positivo de 1día o mayor (2 o 3 semanas)
*La RFC 2308 recomienda un valor TTL negativo de como máximo 3horas.</pre>
</div>
<div title="Configuración Autenticación Apache" creator="YourName" modifier="YourName" created="201312111626" changecount="1">
<pre>!!!1_ Control de acceso por IP y nombre de dominio
Para definir qué direcciones IP o nombres de dominio pueden acceder a un recurso del servidor podemos utilizar las directivas //Order, Allow y Deny// dentro de los diferentes contenedores. Para ver cómo hacemos:
*Primero lee la documentación: [[Manual|http://localhost/manual/en/mod/mod_authz_host.html]]
*Crea el directorio {{{/var/www/privado}}}. Dentro del directorio crea un fichero privado.html que contenga el texto &quot;página privada&quot;.
*En la configuración de uno de tus sitios virtuales edita:
{{{
&lt;Directory /var/www/privado&gt;
     Order allow, deny
     Allow from 127.0.0.1 localhost
&lt;/Directory&gt;
}}}
*Reinicia y comprueba que sólo puedes acceder localmente y no desde cualquier otra máquina. 
!!!2_Autenticación HTTP //Basic//
Vamos a implementar la autenticación basada en HTTP más sencilla. Para ello:
*Consulta la documentación sobre las directivas: //~AuthName, ~AuthType, ~AutUserFile y Require//.
*Comprueba en el directorio //mods-enabled// que el módulo //auth_basic// está habilitado.
*Para usar la autenticación básica hay que crear un fichero accesible por //Apache// en el que se guardarán los usuarios y sus contraseñas. Para crear este fichero disponemos de la herramienta //htpaswd// (mirar documentación):
**{{{sudo htpaswd -c /etc/apache2/passwd usuarioUno}}} (-c para crear el fichero).
**{{{sudo htpaswd  /etc/apache2/passwd usuarioDos}}}
*En el fichero de configuración del sitio virtual que decidas:
{{{
&lt;Directory /var/www/privado&gt;
     Order allow, deny
     Allow from 127.0.0.1 localhost
     AuthName &quot;Acceso privado&quot;
     AuthType Basic
     AuthUserFile /etc/apache2/passwd
     Require user usuarioUno usuarioDos
&lt;/Directory&gt;
}}}
*Faltará reiniciar y comprobar.
!!!3_ Archivos .htaccess
*Apache2 permite la descentralización de la configuración. Para ello utiliza unos archivos especiales que son los ''.htaccess'' que se colocan en el propio directorio de trabajo del servidor.
*Las directivas colocadas en estos archivos sólo afectan al directorio de trabajo (y subdirectorios) en que están colocados y, como se leen en cada petición, los cambios surten efecto de forma inmediata. Por lo mismo, se desaconseja su uso si se tiene aceso al archivo de configuración principal.
*Para averiguar qué directivas se pueden colocar hay que mirar el &quot;Context&quot; de la directiva. El administrador puede controlar qué directivas se pueden modificar en estos archivos mediante la directiva ~AllowOverRide.
&lt;&lt;&lt;
Ejemplo:
En el .htaccess:
{{{
AuthType Basic
AuthName &quot;Acceso privado&quot;
AuthUserFile /etc/apache2/passwd
Require user usuarioUno usuarioDos 
}}}
Y en el archivo de configuración {{{AllowOverride AuthConfig}}}
</pre>
</div>
<div title="Configuración Postfix" creator="YourName" modifier="YourName" created="201401300117" modified="201402061358" changecount="3">
<pre>Configura Postfix para que sea el servidor de correo de la red virtual:
*Saludará a los clientes con el mensaje &quot;debian.asix.net ESMTP Postifix&quot;.
*Gestionará el dominio asix.net como local.
*Solo permitirá el reenvío de correos enviados desde la red 10.33.X.0/24 y desde el equipo local.
*Los buzones de los usuarios se almacenan en formato //maildir// en el directorio //Maildir// dentro del home de cada usuario y su tamaño máximo será de 1 GB.
*El tamaño máximo de los mensajes de correo será de 5MB.
*Permitirá conexiones SMTP y conexiones SMTPS en el puerto 25 usando STARTTLS (usará un certificado digital autofirmado).
*No se configurará ningún tipo de autenticación SMTP.
*Enviará correos directamente a los destinatarios.
----
__Reenvío de correos desde la red virtual__
*{{{postconf -n}}}: para mostrar los parámetros definidos explícitamente en el fichero //main.cf// que no tienen su valor por defecto.
*{{{postconf -d}}}: mostrar todos los parámetros con sus valores por defecto.
*Parámetros básicos:
**''smtpd-banner'': mensaje que muestra a los clientes.
**''myhostname'': nombre de la máquina.
**''mydomain'': dominio de la máquina.
**''myorigin'': nombre de dominio que aparece en los correos que son enviados desde el equipo.
**''mydestination'': dominios para los que se considera el MTA como destino final y por tanto, no se reenvían los correos. Se pueden especificar varios.
**''mynetworks'': redes desde las que el servidor puede recibir correos de los clientes y reenviarlos. (Si se permiten todas y no hay autenticación, se considerará //Open relay//.
**''relay-domains'': dominios para los que está permitido el reenvío de correo.
**''relayhost'': especifica el host hacia el que se envía el correo (//smart host//). Si no se especifica el correo se envía directamente a los destinatarios.
**''mailbox_size_limit'': tamaño máximo que tendrán los buzones de correo.
**''message_size_limit'': tamaño máximo de los mensajes de correo.
**''inet_interfaces'': interfaces en las que se escucharán peticiones.
**''home_mailbox'': formato de los buzones de correo (//mbox// o //maildir//).
*Realizamos los cambios según el enunciado de la práctica:
{{{
mynetworks = 10.33.1.0/24 127.0.0.0/8
mailbox_size_limit = 1073741824
message_size_limit = 10485760
home_mailbox = Maildir/

smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
}}}
*Recargamos los ficheros de configuración {{{service postfix reload}}}</pre>
</div>
<div title="Contenido UF2" creator="YourName" modifier="YourName" created="201311210002" modified="201401171534" changecount="12">
<pre>__Servicio Web__
#[[Servicio Web: definición y componentes]]
#[[Servicio Web: protocolo HTTP]]
#[[Servicio Web: Alojamiento virtual de sitios web]]
#[[Servicio Web: Caché, Autenticación, Cookies, Conexiones persistentes, etc]]

__Servicios de transferencia de archivos__
#[[Servicio FTP: definición y componentes]]
#[[Servicio FTP: tipos de acceso, conexiones y modos]]
#[[Servicio FTP: Seguridad, FTPS, FXP, TFTP, SFTP/SCP]]</pre>
</div>
<div title="Contenido UF3" creator="YourName" modifier="YourName" created="201401290019" modified="201403150000" changecount="11">
<pre>[[Características Correo Electrónico]]
[[Funcionamiento Correo Electrónico]]
[[Direcciones y cuentas de correo]]
[[Servidores de correo]]
[[Mensajes]]
[[Protocolos]]
[[Seguridad_Correo]]
[[Servicios de mensajería instantánea]]
[[Listas de distribución]]</pre>
</div>
<div title="Contenido UF4" creator="YourName" modifier="YourName" created="201403131457" modified="201404091643" changecount="6">
<pre>__Servicios de audio y vídeo__
[[Formatos multimedia]]
[[Streaming]]
[[Protocolos Streaming]]
[[Distribución y suscripción de audio y vídeo]]</pre>
</div>
<div title="Contenidos" creator="YourName" modifier="YourName" created="201309261512" modified="201311130000" changecount="21">
<pre>''Conceptos básicos de TCP/IP y virtualizació''
#[[Introducción]]
#[[Nivel de red IP]]
##[[Direccionamiento IP]]
##[[Encaminamiento IP]]
#[[Nivel de transporte]]
#[[Actividades_IP]]
#[[Traducción de direcciones de red NAT y PAT]]
''Servicios de configuración automática de red''
#[[Introducción DHCP]]
#[[Definiciones]]
#[[Funcionamiento]]
#[[Act_DHCP]]
''Servicio de nombres de dominio (DNS)''
#[[Introducción DNS]]
#[[Características y funcionamiento del servicio DNS]]
#[[Espacio de nombres de dominio]]
#[[Servidores de nombres]]
#[[Clientes DNS (resolver)]]
#[[Resolución recursiva]]
#[[Registro de recursos]]
#[[DNS Dinámico]]
#[[Act_DNS]]
</pre>
</div>
<div title="DNS Dinámico" creator="YourName" modifier="YourName" created="201310231530" changecount="1">
<pre>Las actualizaciones de los archivos de zona se pueden realizar de forma manual o dinámica.
*''Actualizaciones manuales'': Responsabilidad del administrador. Si el archivo es grande e incluye varias redes las probabilidades de error humano son altas y el coste es elevado.
*''Actualizaciones dinámicas'': proceso por el cual una fuente externa (cliente DNS, servidor DHCP) actualiza los recursos de zona. Es un proceso automático, el administrador no edita los archivos de zona. Las actualizaciones pueden estar realizadas:
**Directamente por los equipos: Se configura el cliente DNS de cada equipo y el servidor DNS para que admitan este tipo de actualizaciones. 
**Servidor DHCP: Los clientes envían su nombre al DHCP y éste actualiza el registro DNS. El proceso sería:
**#CLIENTE DHCP AL Servidor DHCP: Dame una IP, soy Neptuno. (También puede suceder que sea el propio DHCP quién le otorgue un nombre)
**#Servidor DHCP: te doy IP y tu nombre de dominio es neptuno.asix.cat.
**#Servidor DHCP: actualiza el  servidor DNS tanto el de resolución directa como el de resolución inversa.</pre>
</div>
<div title="DefaultTiddlers" creator="YourName" modifier="YourName" created="201309242345" changecount="1">
<pre></pre>
</div>
<div title="Definiciones" creator="YourName" modifier="YourName" created="201310022137" modified="201310022140" changecount="2">
<pre>!Componentes
El servicio DHCP está basado en el modelo cliente/servidor y está formado por los siguientes componentes:
*Servidor DHCP: asigna la configuración de red.
*Cliente DHCP: realiza las peticiones al servidor y configura el equipo con los parámetros indicados por éste.
*Protocolo DHCP: conjunto de normas y reglas que permite la comunicación entre servidor y cliente.
*Agentes de retransmisión DHCP: Escuchan peticiones de clientes DHCP y las retransmiten a servidores DHCP ubicados en otras redes. Se utilizan para centralizar la configuración de múltiples redes.
!Asignación
A la hora de analizar las asignaciones de direcciones IP que realiza el servidor DHCP podemos estudiar diferentes conceptos:
!!!Tipos de asignación
Existen tres tipos de asignación:
*Asignación estática: asigna direcciones IP concretas a máquina concretas. A una dirección física establecida le asigna una IP determinada por el administrador.
*Asignación dinámica: el servidor asigna un IP dentro de un rango definido por el administrador. Es lo que se llama una &quot;concesión&quot;. Estas concesiones tienen un plazo de validez limitado (//lease time//).
*Asignación automática: asigna direcciones IP de forma permanente a máquinas clientes la primera vez que hacen la solicitud al servidor DHCP y hasta que el cliente las libera. Es decir, son concesiones de plazo ilimitado. 
!!!Ámbito, rango, exclusiones, reservas
;Ámbito
:Un ámbito es un agrupamiento de máquinas o clientes preestablecido por el administrador. Para cada ámbito se reserva un rango de direcciones IP para otorgar a los clientes de dicho ámbito. Habitualmente el administrador de red creará un ámbito para cada subred.
;Rango
:Intervalo consecutivo de direcciones IP validas y disponibles para ser asignadas a clientes DHCP. NOTA: se pueden definir tantos ámbitos y rangos como sea necesario para el entorno de una red.
;Exclusiones
:Conjunto de direcciones excluidas de un rango. No podrán ser concedidas. Se suele excluir direcciones de servidores de correo, web, etc.
;Reservas
:Consiste en la asignación de una dirección IP fija a un equipo y se puede utilizar para asignar a servidores o ~PCs concretos la misma dirección siempre. Un equipo es identificado en una red por su MAC
!!!Tiempo de concesión (//lease time//)
El plazo del contrato o concesión es el tiempo en que un cliente DHCP  mantiene como propios los datos de configuración que le otorgó un servidor. 
*Cada vez que el cliente arranca, cada cierto tiempo o bien cuando se alcanza el límite de concesión, el cliente tiene que solicitar su renovación. El servidor, puede extender el plazo de la concesión al cliente o asignar otra nueva.
*Para determinar el tiempo de concesión es necesario analizar las características de la red. En una red con un gran número de direcciones IP disponibles y donde la configuración de los clientes raramente cambia, el administrador podría incrementar el tiempo de concesión para reducir el tráfico derivado de las solicitudes de renovación por parte de los clientes. Si, por el contrario, una red tiene un número limitado de direcciones IP y donde la configuración de clientes cambia frecuentemente, el administrador puede reducir el tiempo de concesión para que las direcciones IP que ya no estén siendo usadas puedan estar disponibles para nuevas asignaciones.</pre>
</div>
<div title="Direccionamiento IP" creator="YourName" modifier="YourName" created="201309242352" modified="201309242353" changecount="3">
<pre>!El protocolo IP
*Realiza el direccionamiento de los dispositivos y el encaminamiento de la información a través de la red.
*La unidad de información es el datagrama. El formato del mismo viene especificado por ~IPv4. 
*Durante este curso nos referiremos a ~IPv4 de forma normal, cuando queramos referirnos a ~IPv6 lo especificaremos.
!!Formato de direcciones IP.
*Es un número binario de 32 bits. Es decir, puedes direccionar 2^^32^^ direcciones diferentes.
*Notación: 4 grupos de 8 bits escribiendo cada uno de ellos en notación decimal y separando cada grupo por un punto.
*Ejemplo:
&lt;&lt;&lt;
11001100001100111010101001010101 {{{--&gt;}}} 11001100.00110011.10101010.01010101 {{{--&gt;}}} 204.51.170.85
&lt;&lt;&lt;
*Cada dirección consta de dos partes: ''Identificador de red'' + ''Identificador del host''. (Lo mismo que teléfonos prefijo+número)
!!Máscara de red
*Se emplea para diferenciar el identificador de la red de el identificador del host. 
*Es un número binario de 32 bits que define en las posiciones a 1 el prefijo o Id. de red y en las posiciones a 0 el Id. del host.
*Ejemplo:
&lt;&lt;&lt;
11001100001100111010101001010101  AND 11111111.11111111.11111111.00000000 {{{ --&gt;}}} 11001100.00110011.10101010  = Id. de red.
&lt;&lt;&lt;
*Notación CIDR (//Classless ~InterDomain Routing//) 204.51.170.85 / 24
!!Clases de direcciones IP
El identificador de red puede tener una longitud variable pero inicialmente para facilitar el encaminamiento se crearon una serie de máscaras predefinidas. Son las ''clases de direcciones''. Tenemos:
*Clase A: Un //byte// para el Id de red y el resto para el Id. del //host//. Es decir, redes grandes. La máscara es 255.0.0.0.
*Clase B: Dos //bytes// para el Id de red y dos //bytes// para el Id del //host//. Redes medianas. 255.255.0.0.
*Clase C: Tres //bytes// para ld de red y un //byte// para Id de //host//. Redes pequeñas. 255.255.255.0.
*Clase D: Se emplea para //multicast//, es decir, envío de datagramas a un grupo de equipos de la red. No hay diferencia entre Id de red e Id de host.
*Clase E: Conjunto de direcciones específicas para proyectos de investigación.
!!Direcciones especiales
*Dirección de red: Id. de red + bits de //host// puestos a cero. La dirección de red del ejemplo anterior es 204.51.170.0/24
*Dirección de difusión limitada: Mensajes  de //broadcast//. Es la misma para todas las redes: 255.255.255.255.
*Dirección de difusión dirigida: Mensajes de //broadcast// a los dispositivos de la red. Utilizando el ejemplo anterior: 204.51.170.255/24.
*Dirección de bucle local: sirve para referenciar al interfaz, es decir, para los procesos de comunicación a través de TCP/IP que se generan dentro del //host//. Se emplea para ello cualquier dirección de la red 127.0.0.0 / 8.
!!Direcciones públicas y privadas.
Existe un conjunto de direcciones que se han reservado para un uso privado, es decir, son direcciones que no deben tener acceso a Internet.
Por tanto, existen:
*Direcciones públicas: identifican dispositivos conectados a Internet.
*Direcciones privadas: rangos reservados para intranets. Son: 10.0.0.0/8, 172.16.0.0/16 , 192.168.0.0 /16. Los //routers// conectados a Internet descartan el tráfico dirigido a direcciones privadas como medida de seguridad.
!!Direcciones de enlace local
Direcciones que se asignan los dispositivos a sí mismos cuando nadie lo hace. Se emplean las direcciones de la red 169.254.0.0/16. Estas direcciones tampoco pueden circular por Internet.
[[UF1_Actividad_1]]</pre>
</div>
<div title="Direcciones y cuentas de correo" creator="YourName" modifier="YourName" created="201401290034" changecount="1">
<pre>Una dirección de correo es una cadena de caracteres formada por dos partes (se permiten letras, números, guiones bajos y un solo punto) separadas por el carácter @.
Lo habitual es cada dirección tenga asociada una cuenta (un buzón) con contraseña en un servidor de correo electrónico donde se depositan y almacenan los mensajes. La segunda parte de la dirección indica el dominio al que pertenece.
Así en ''~NombreUsuario@dominio.org'', ~NombreUsuario es el nombre del usuario y dominio.org es el nombre del dominio. 
!!!Cuentas de correo redirigidas y alias
*Una cuenta de correo redirigida es una cuenta aparentemente normal pero internamente no tiene asociado un buzón (no puede almacenar mensajes). Los mensajes enviados a esa cuenta se redirigen a otra cuenta.
*Un alias es similar a una cuenta de correo redirigida, la diferencia es que las cuentas redirigidas &quot;apuntan&quot; a cuentas de otro dominio y los alias &quot;apuntan&quot; a cuentas de mismo dominio.
Utilidades de las cuentas redirigidas y los alias:
*Crearnos varias &quot;identidades&quot; con diferentes cuentas de correo pero con el mismo buzón. Los clientes de correo podrán clasificar los correos en función de la cuenta a la que van dirigidos.
*Usar un alias para suscribirse a un foro y, cuando ya no estemos interesados en el foro, dar de baja el alias (no hay que tocar la cuenta principal y dejamos de recibir mensajes que no nos interesan)
*Enviarte mensajes a ti mismo, crear varias cuentas en las diferentes redes, etc.</pre>
</div>
<div title="Distribución y suscripción de audio y vídeo" creator="YourName" modifier="YourName" created="201404012321" changecount="1">
<pre>Cuando hablamos de distribución y suscripción de audio y vídeo nos referimos a los //podcast// (//Personal On Demand Broadcasting//). Podemos definir podcast como un fichero, generalmente de audio o vídeo, que contiene una serie de etiquetas que permiten la distribución por suscripción (//syndication//) de dicho archivo, de forma que un usuario cualquiera pueda recibir las actualizaciones de los //podcast// en tiempo real.

El término //podcasting// se emplea de forma genérica para referirnos a la distribución de ficheros de audio obtenidos de forma automatizada gracias a formatos de redifusión web como RSS o Atom. La gran ventaja que ofrece el //podcasting// respecto a la simple navegación web es la posibilidad de suscripción a contenidos de nuestro interés.

Para mantener nuestros podcast actualizados, tenemos dos opciones: aplicaciones específicas (Juice, Doppler, Amarok, ~GoogleReader..) o el propio navegador web (marcadores dinámicos)</pre>
</div>
<div title="Encaminamiento IP" creator="YourName" modifier="YourName" created="201309242353" changecount="1">
<pre>:Proceso que permite trasladar un datagrama desde la máquina origen a la máquina destino independientemente de si ambas máquinas se encuentran en la misma red o en diferentes redes. El protocolo IP es responsable de ése encaminamiento.
!!!Encaminadores
*Definición: dispositivos de nivel 3 que enlazan las diferentes redes que forman parte de una &quot;red de redes&quot;. Desempeñan un papel crucial en el encaminamiento de datagramas.
*Un router está conectado al menos a dos redes y realizará el encaminamiento de todo el tráfico de datagramas que pase por él.
*Para un equipo el mundo se divide en dos: los que están en su misma red y el resto. Por tanto, cuando un equipo quiere enviar un datagrama a otra máquina debe decidir si ésta se encuentra en su misma red (envío directo) o no. Si la máquina destino no pertenece a la misma red, la máquina enviará el datagrama al encaminador. Por eso, al encaminador se le llama ''puerta de enlace'' o //gateway//.
*El router cuando recibe el datagrama debe encaminarlo. Pueden darse dos situaciones:
**Que el datagrama vaya dirigido a una dirección que pertenezca a una red conectada directamente al router, en cuyo caso la entrega es directa.
**Que el datagrama no vaya dirigido a una red conectada directamente al router, en cuyo caso reenviará el datagrama hacia otro encaminador siguiendo lo especificado en su tabla de encaminamiento. Caso de ser necesario este proceso se repetiría hasta alcanzar la red de destino o bien agotar el tiempo de vida (TTL, //time to live//) del datagrama.
!!!Tablas de encaminamiento
*Almacenan la información necesaria para realizar el encaminamiento de los datagramas y están implementadas tanto en los routers como en los hosts.
*Los campos de estas tablas son (Los más importantes):
**Destino (D): dirección IP de una red o host.
**Máscara de red(MR): asociada al Destino.
**Dirección de salto (DS): dirección IP a la que se enviará el datagrama si su dirección IP de destino coincide con la especificada en D y MR.
**Interfaz: dirección IP del encaminador por la que hay que enviar el datagrama a la DS.
*Cada registro de la tabla encamina a ese Destino en concreto. Se distinguen tres tipos de destinos:
**Ruta de red: cuando la tabla de encaminamiento se refiere a toda un red. 
**Ruta de host: cuando la entrada se refiere a un host.
**Ruta por defecto: cuando no es aplicable ninguno de los dos tipos anteriores.
&lt;&lt;&lt;
Actividades
#Ejecutar //route -n// y comentad.
#Ejecutar //route -C// y comentad. 
#Buscar forma de eliminar una entrada tal que impida la comunicación con 8.8.8.8
&lt;&lt;&lt;
!!!Protocolos de encaminamiento
*Las tablas de enrutamiento se inicializan con las rutas correspondientes a las redes adyacentes.
*Dos estrategias posibles de configuración:
**Encaminamiento estático: configuración de las tablas de forma manual. No se adapta a los cambios. Requiere supervisión.
**Encaminamiento dinámico: el propio encaminador actualiza sus tablas gracias a protocolos específicos. RIP, OSFP y BGP permiten la comunicación entre encaminadores para actualizar tablas.</pre>
</div>
<div title="Espacio de nombres de dominio" creator="YourName" modifier="YourName" created="201310142141" modified="201310142228" changecount="4">
<pre>;Definición
:El espacio de nombres de dominio es el conjunto de nombres que se pueden utilizar para identificar máquinas o servicios de una red.
;Nombres de dominio
:Cada nombre de dominio puede estar formado por una o varias cadenas de caracteres separadas por puntos. No se distinguen entre mayúsculas y minúsculas.
&lt;&lt;&lt;
Ejemplos:
&quot;pc01.xarxes.asix.cat.&quot;
&quot;com.&quot;
&quot;google.com.&quot;
&lt;&lt;&lt;
:El ''espacio de nombres'' se puede representar mediante una estructura jerárquica organizada en forma de árbol.
[img[arbol dns|http://www.mastermagazine.info/termino/wp-content/uploads/DNS.png]]
:Se pueden usar nombres que tengan como máximo 127 niveles y cada parte separada por puntos hasta 63 caracteres. En total no puede superar los 255 caracteres.
;Dominio raíz. Dominio y subdominios
:El árbol de dominio empieza en el dominio &quot;.&quot; que se conoce como ''dominio raíz''.
:Podemos usar los términos domino y subdominio al igual que en un sistema de archivos hablamos de directorios y subdirectorios. Así &quot;asix.cat.&quot; es subdominio de &quot;cat.&quot; y &quot;xarxes.asix.cat.&quot; es subdominio de &quot;asix.cat.&quot;
;Dominios de primer nivel
:Son ''TLD Top Level Domains'' o dominios de nivel superior y son los dominios que cuelgan del dominio raíz. Los que cuelgan de los dominios de primer nivel se denominan dominios de segundo nivel y así sucesivamente.
;Nombres absolutos
:Nombre formado por todas las partes separadas por puntos desde el nodo correspondiente hasta el dominio raíz. También se les denomina como nombres de dominio completos (FQDN = //Fully Qualified Domain Names//). El &quot;.&quot; final nos permite distinguir si un nombre es FQDN o no.
!!Administración de nombres de dominio en Internet. Delegación.
*La administración y organización del espacio de nombres de dominio de Internet se distribuye entre múltiples empresas y organizaciones, estando coordinada por la ''ICANN'' (//Internet Corporation for Assigned Names and Numbers//).
*ICANN se encarga de mantener el dominio raíz y de mantener los dominios de nivel superior (TLD) existentes. ~InterNIC es la organización asociada a ICANN que permite registrar dominios TLD.
*Los TLD son clasificados por la ICANN en:
**''Genéricos (gTLD)'': nombre significativo en función del propósito o del tipo de organización que lo utiliza. Se clasifican a su vez en:
***Dominios patrocinados (sTLD //sponsored TLD//): operan según las reglas de una entidad que soporta su patrocinio (&quot;aero&quot;, &quot;cat&quot;, &quot;coop&quot;, &quot;edu&quot;, &quot;gov&quot;, etc.)
***Dominios no patrocinados (uTLD //unsponsored TLD//): operan según las reglas del ICANN con unas políticas globales (&quot;com&quot;, &quot;info&quot;, &quot;org&quot;, &quot;net&quot;, ...).
**''Geográficos ((ccTLDs //country code ~TLDs//)'': nombres de dos letras establecidos en función de países o regiones. Las tareas de gestión se delegan a una entidad del país o territorio (&quot;es&quot;, &quot;fr&quot;, &quot;np&quot; (nepal),...).
**''&quot;arpa&quot;'': dominio que se utiliza para la infraestructura técnica de Internet. ICANN lo administra en cooperación con la comunidad técnica de Internet bajo la dirección de la ''IAB''(Internet Architecture Board). 
**''Dominios reservados'': dominios para pruebas privadas, ejemplos de documentación, etc. (&quot;test&quot;, &quot;localhost&quot;, ...)
*La administración de cada TLD (incluyendo gestión y registro de dominios de segundo nivel) es delegado en una organización concreta. Estas organizaciones se denominan operadores de registro (//registry operators//) o patrocinadores (//sponsors//) y están acreditadas por la ICANN. Por ejemplo, la ICANN ''delega'' en ''Red.es'' la administración del dominio &quot;es&quot;.
*Delegación: una organización que administra un dominio cede la gestión de uno, varios o todos sus subdominios a otras organizaciones. Gracias a la delegación se puede conseguir una administración descentralizada de DNS. Ejemplo: Red.es cede a la universidad de Valencia la gestión de uv.es y ésta a su vez cede el dominio mates.uv.es al departamento de matemáticas.
*La organización que administra un dominio es responsable de los nombres usados en ese dominio, de las direcciones IP asociadas a ellos y, del funcionamiento y mantenimiento de los servidores que almacenan esta información.
!!Registro de dominios. Agentes registradores
*Registrar un dominio consiste en &quot;reservar&quot; el nombre durante un tiempo (normalmente, un año).
*Un nombre de dominio puede ser registrado a través de diferentes compañías, conocidas como ''agentes registradores'' (//registrant//). Estos agentes asesoran a los registradores (personas, empresas u organizaciones que desean registrar un nombre) y tramitan la solicitud haciendo de intermediarios con los agentes de registro.
*Los agentes registradores deben estar acreditados por los operadores de registro y tienen libertad para asignar una parte del precio del registro.
</pre>
</div>
<div title="Evaluación" creator="YourName" modifier="YourName" created="201310211658" modified="201311122357" changecount="3">
<pre>!!!10% de la nota es actitud
Incluye:
*Puntualidad
*Atender a mis explicaciones, realizar preguntas, responder de forma rápida lo que pregunto (no estar en Babia), etc.
*Mostrar interés por la asignatura y por temas aledaños 
!!!40% de la nota es de la parte práctica
*Requisito: se debe obtener por lo menos un 4 en esta parte para poder realizar el aprobar la UF 
*Esta parte evalúa la realización de prácticas y ejercicios propuestos por el profesor.
*Si se realizan todas las prácticas obligatorias se obtiene un 4, con lo que se cumple con el mínimo exigido en esta parte.
*Las prácticas no obligatorias se entregarán al profesor debidamente documentadas. Se evaluarán y tendrán un peso del 60% dentro de la parte práctica. Para la evaluación de dichas prácticas, los criterios son:
**La labor de investigación realizada para llevar a cabo la práctica
**La resolución de los posibles problemas y/o cuestiones que van surgiendo
**La forma de documentarlo (breve, clara y esclarecedora)
**El número de prácticas que se documenten
!!!50% Examen práctico
*Prueba práctica para determinar el grado de asimilación de lo explicado durante la unidad formativa.</pre>
</div>
<div title="Examen Año Pasado" creator="YourName" modifier="YourName" created="201311071339" modified="201311130020" changecount="3">
<pre>1- (2 pto) Explica todas estas lí­neas: ¿dónde nos las podemos encontrar?¿Cuál es el significado de cada una de ellas?
{{{
         subnet 192.168.1.0 netmask 255.255.255.0 {
                  option routers                  192.168.1.254;
                  option subnet_mask              255.255.255.0
                  option domain_name              &quot;example.com&quot;;
                  option domain_name_servers       192.168.1.1;
                  range 192.168.1.10 192.168.1.100;
        }
}}}

2- (1 pto)¿Qué pasa o qué problemas (si es que los hay) pueden aparecer si el rango de cesión de ~IPs del servidor dhcp no pertenece a la misma subred que él? Es decir: servidor dhcp conectado a un adaptador de red con dirección IP estática 192.168.1.1 y que otorga direcciones en el &quot;range 10.33.1.10 10.33.1.20&quot;.

3- (1 pto) Si tenemos algún problema con el arranque del servidor, ¿dónde o cómo podemos buscar información sobre lo que está sucediendo o ha sucedido?

4- (1 pto) ¿Qué es ~IPCop?¿Qué utilidad puede tener en una red?¿Qué relación tiene o puede tener con el servicio NAT?
----
;~IpCop
:Es una distribución linux adaptada para servir de cortafuegos y de encaminador NAT

5-(2 pto) ¿Cómo configuramos un servidor dhcp que atiende peticiones por dos interfaces de red? ¿En qué punto de la red lo colocaríamos?¿Cómo serían sus archivos de configuración? Considera que a una red otorga direcciones del rango [10.33.1.10, 10.33.1.20] y a la otra del rango [10.33.2.10, 10.33.2.20]. 

6-(1 pto) Explica qué es un dns dinámico, qué utilidades tiene, ventajas, inconvenientes, etc.

7- (2 pto) ¿Qué habría que hacer para configurar una red con servidor dns sobre debian y un servidor dhcp sobre server08? Nota: la máquina sobre la que corre el servidor DHCP, también accede al servicio de dns vía debian. Adjunta todos los archivos de configuración o pantallazos que consideres necesarios. Considera las opciones de configuración más sencillas posibles.
-------------------------------------------------------
!!!Pregunta 1: DHCP (40%)
Instala y configura el servidor DHCP de ISC (//Internet Systems Consortium//) con las siguientes opciones (supón los datos que faltan de forma consecuente):
*Servirá el rango de direcciones IP comprendidas entre 192.168.0.3 y 192.168.0.15 en la red 192.168.0.0/28
*Proporcionará los siguientes parámetros a los clientes:
**Tiempo de concesión: 8 días.
**Máscara de red. 
**Puerta de enlace: 192.168.0.1
**Servidor DNS: 192.168.0.2
**Al equipo con nombre &quot;~ServidorDNS&quot; se le asignará siempre la dirección IP 192.168.0.2
**Al resto de equipos se le asignará de forma dinámica la configuración de red.
!!!Pregunta 2 (60%)
Configura el &quot;~ServidorDNS&quot; (en //bind9//):
*El servidor solo servirá a la red local (no sirve a equipos de Internet).
*Actuará como maestro y tendrá autoridad sobre el dominio mired.org.
*No se permitirán actualizaciones dinámicas.
*El servidor DNS maestro tiene por nombre ~ServidorDNS
*Se añadirán dos registros:
**~ServidorCorreo en 192.168.0.2 que actuará de servidor de correo.
**~DentroDeLaEmpresa.org en 192.168.0.2
Hay que:
*Configurar la resolución directa (30%) y la resolución inversa (70%)
*Comentar brevemente todos los pasos. Indicar los parámetros que se suponen.</pre>
</div>
<div title="Examen UF1" creator="YourName" modifier="YourName" created="201311130000" modified="201311151518" changecount="18">
<pre>!!!Pregunta 1: (70%)
Configura el servidor DHCP de Windows con las siguientes opciones (supón los datos que faltan de forma consecuente):
*El servidor tendrá dos tarjetas de red: una conectada a la red exterior y la otra con un IP fija (192.168.0.1) conectada a la red interna que llamaremos &quot;Xarxi&quot;.
*Servirá el rango de direcciones IP comprendidas entre 192.168.0.3 y 192.168.0.14 en la red 192.168.0.0/28
*Proporcionará los siguientes parámetros a los clientes:
**Tiempo de concesión: 2 días.
**Máscara de red. 
**Puerta de enlace: 192.168.0.1
**Servidor DNS: 192.168.0.2
**Al equipo con nombre &quot;~ServidorDNS&quot; se le asignará siempre la dirección IP 192.168.0.2
**Al resto de equipos se le asignará de forma dinámica la configuración de red, de tal manera que cuando alguien se conecte a la red interna &quot;Xarxi&quot; pueda navegar por Internet sin problemas (Suponiendo que el DNS funcione, claro)
Configura el &quot;~ServidorDNS&quot; (en //bind9//):
*El servidor actuará como caché. 
*Las peticiones que le lleguen las debe redirigir a 8.8.8.8
SE DEBE DOCUMENTAR TODO DE TAL MANERA QUE NO HAYA LUGAR A DUDAS DE QUE SE HA CONSEGUIDO LO QUE SE PIDE. 
!!!Pregunta 2: (30%)
Monta dos servidores DNS con //bind9// ambos o uno con //bind9// y otro con el DNS de Windows. Uno de los servidores controla la zona mired.org y delega el control de la zona dirección.mired.org al segundo servidor. 
Añade en cada una de las zonas los registros que consideres necesarios y alguno más que te permita realizar pruebas
Anexa los archivos de configuración. Y documenta con capturas o añadiendo los archivos que consideres que consigues lo que se pide.
----
!@@bgcolor(grey):Solución Examen@@
!!!Pregunta 1
__dhcp__
*Habilitar dos adaptadores para w2008. Uno en red interna y otro en NAT.
*En &quot;Administrador de conexiones&quot; habilitar uso compartido de la conexión de la &quot;Conexión de Area Local&quot; asociada al NAT.
*El uso compartido de la conexión obliga a utilizar la red 192.168.0.1
*Configurar la &quot;Conexión de Area Local&quot; de w2008 asociada a la red interna. Concederle al equipo un IP fija y máscara adecuada: 192.168.0.1 /28. De DNS se puede poner el 192.168.0.2,  pero da igual, puede no ponerse.
*A continuación, se configura el ámbito: rango de la 3 a la 14. Pta de enlace la 1, DNS el 2, y reservada para la máquina donde se vaya a ubicar el bind9. Máscara 28 y concesión dos días. 
*Levantamos otra máquina. Por ejemplo, Ubuntu64. La conectamos a la red interna.
*Miramos que Ubuntu64 recibe configuración correcta de red con un ifconfig o con el Network Manager. Comprobamos con un ping a 8.8.8.8. En cambio, ping www.google.es no lo resolverá. Si abrimos un navegador también veremos que hay problemas.
__dns__
*Levantamos debian64 con bind instalado.
*Lo conectamos a red interna. Recibirá configuración de red. Comprobamos con ifconfig y mirando el {{{/etc/resolv.conf}}} en el que //nameserver// debe estar apuntando a 192.168.0.2 (es decir, el mismo).
*En el archivo {{{/etc/bind/named.conf.options}}} (archivo opciones generales del servidor) descomentamos o añadimos las siguientes líneas:
{{{
forwarders {
          8.8.8.8;
};
}}}
*Chequeamos con {{{named-checkconf}}}
*Reiniciamos el servicio {{{service bind9 reload}}}
*Comprobamos: {{{ping www.google.es}}}
*Volvemos a la máquina Ubuntu64 y volvemos a intentar ping a www.google.es y a abrir el navedor; ambas pruebas deben funcionar.
!Pregunta 2
Retomando las máquinas tal y como las dejamos tras realizar la pregunta 1
__Servidor1: w2008__
*Deshabilitamos en w2008 la conexión de red asociada al NAT. Nos quedamos solo con la conexión de la red interna.
*Repasamos configuración de la conexión de la red interna de w2008: IP: 192.168.0.1 / 24 DNS: 192.168.0.1
*Accedemos a la configuración del DNS. Creamos una zona nueva:
**Nombre: direccion.asix.net.
**IP: 192.168.0.1
**Podemos poner como servidor w2008.asix.net que ya teníamos creado de clase
**Añadimos un registro prueba: manolo.direccion.asix.net asociado a lo IP 192.168.0.78
*Podemos verlo en {{{Windows/System32/dns/direccion.asix.net}}}:
[img[Documentos/M8/Imágenes/ExUF1ConfDNS.png]]
__Servidor2: debian64__
*Comprobamos su configuración de red: red interna, IP: 192.168.0.2 /24 DNS: 192.168.0.2
*Editamos el archivo {{{db.asix.net}}} al que le añadimos dos líneas:
**direccion  IN NS w2008.asix.net.
**w2008.asix.net. IN A 192.168.0.1
*Nos queda:
[img[Documentos/M8/Imágenes/ExUF1ConfDNS2.png]]
*Chequeamos: {{{named-checkconf}}} y {{{named-checkzone asix.net /etc/bind/db.asix.net}}} (las ~IPs incorrectas, como veis, se las traga también)
*Comprobamos desde debian: {{{nslookup manolo.direccion.asix.net}}}
[img[Documentos/M8/Imágenes/ExUF1ConfDNS3.png]]
</pre>
</div>
<div title="Examen UF2" creator="YourName" modifier="YourName" created="201401231354" modified="201402101726" changecount="6">
<pre>!!!Pregunta 1
Configura vsftpd para que:
#Usuario anónimo pueda acceder al directorio &quot;Public&quot; (debes crearlo) con permiso para colgar archivos. No debe poder eliminar ni renombrar, solo descargar y/o subir archivos en el directorio &quot;Public&quot;. Indica todos los pasos realizados.
#Los usuarios locales podrán acceder a su directorio de sistema.


!!!Pregunta 2
Configura apache para que:
#En la IP 192.168.1.12, en el puerto 80 y al nombre de ~DentroDeLaEmpresa.org:
##Sirva la página bienvenido.html.
##Sólo permita el acceso a los usuarios de la red 192.168.1.0
#En la IP 192.168.1.12, en el puerto 80 y al nombre de ~AdministrandoDentroDeLaEmpresa.org:
##Muestre el contenido del directorio en el que se encuentra bienvenido.html.
##Permita &quot;seguir&quot; los enlaces simbólicos que se encuentren en dicho directorio.
##Mantenga un registro de todos los accesos y errores que se produzcan en un archivo exclusivo para ~AdministrandoDentroDeLaEmpresa.org.
Ayuda: 
Se hace así:
        ErrorLog error.log
        LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b&quot; common
        CustomLog access_log common
#En la IP 192.168.1.12, en el puerto 8085 y sin nombre específico:
##Permita sólo el acceso a los usuarios admin1 y admin2.
##Liste el contenido del directorio raíz.
Se debe entregar los archivos de configuración modificados comentados de forma concisa pero suficiente.</pre>
</div>
<div title="ExtraOrdinarias" creator="YourName" modifier="YourName" created="201406151539" changecount="1">
<pre>[[Extraordinaria UF1]]
[[Extraordinaria UF2]]
[[Extraordinaria UF3]]
[[Extraordinaria UF4]]</pre>
</div>
<div title="Extraordinaria UF1" creator="YourName" modifier="YourName" created="201406151540" changecount="1">
<pre>!!!Pregunta 1: DHCP (40%)
Configura el servidor DHCP de ISC (//Internet Systems Consortium//) para un instituto como el IES Joan d'Austria con las siguientes opciones (supón los datos que faltan de forma consecuente):
*Servirá el rango de direcciones IP comprendidas entre 192.168.0.20 y 192.168.1.255 en la red 192.168.0.0/16
*Proporcionará los siguientes parámetros a los clientes:
**Tiempo de concesión: 8 días.
**Máscara de red. 
**Puerta de enlace: 192.168.0.1
**Servidor DNS: 192.168.0.2
**Al equipo con nombre &quot;~ServidorDNS&quot; se le asignará siempre la dirección IP 192.168.0.2
**Hay dos impresoras en el instituto. Siempre se  les debe asignar las mismas direcciones:
***Impresora1: 192.168.0.5
***Impresora2: 192.168.0.6
**Hay un servidor de recursos en la 192.168.0.3.
**Al resto de equipos se les asignará de forma dinámica la configuración de red.
!!!Pregunta 2 (60%)
Configura el &quot;~ServidorDNS&quot; (en //bind9//) para el IES Joan d'Austria:
*El servidor solo servirá a la red local (no sirve a equipos de Internet).
*Actuará como maestro y tendrá autoridad sobre el dominio iesjoandaustria.org.
*No se permitirán actualizaciones dinámicas.
*El servidor DNS maestro tiene por nombre ~ServidorDNS
*Se añadirán tantos registros como sean necesarios para atender las necesidades del IES Joan d'Austria (impresoras, servidor de recursos, etc)
Hay que:
*Configurar la resolución directa (20%), la resolución inversa (40%) y realizar pruebas QUE DEMUESTREN QUE AMBAS RESOLUCIONES funcionan correctamente (30%)
*Comentar brevemente todos los pasos. Indicar los parámetros que se suponen. (20%)
!Evaluación
__Pregunta 1__ 40 puntos.
*Configuración rango y red : hasta 10
*Configuración resto de propiedades (8días, puerta de enlace, máscara, dns, etc.): hasta 10
*Configuración IP fijas: hasta 10
*Documentación/pruebas: hasta 10
__Pregunta 2__ 60 puntos NOTA= A*0'2+B*0'4+((C+D)/2)*0'3+E*0'2
*Configuración fichero de zona resolución directa: (Nota A) hasta 10 puntos.
*Configuración fichero de zona resolución inversa: (Nota B) hasta 10 puntos.
*Realización de pruebas resolución directa: (Nota C) hasta 10 puntos.
*Realización de pruebas resolución inversa: (Nota D) hasta 10 puntos.
*Comentarios: (Nota E) hasta 10 puntos.</pre>
</div>
<div title="Extraordinaria UF2" creator="YourName" modifier="YourName" created="201406151544" modified="201406171414" changecount="3">
<pre>!!!Pregunta 1 (30%)
Configura vsftpd para que:
#No hay usuario anónimo. 
#Los usuarios locales podrán acceder a su directorio de sistema y deben poder bajar, subir archivos, crear directorios o eliminarlos . 
#Documenta brevemente todos los pasos y realiza alguna demostración (captura del log y algún pantallazo) de que efectivamente, un usuario puede subir un archivo, desconectarse y, a continuación, volver a conectarse y bajarse ese mismo archivo (o algún otro) que acaba de subir.
!!!Pregunta 2 (70%)
Configura apache para que:
*Atienda unicamente las peticiones que llegan a (por lo tanto no atenderá las que llegan a la interfaz local) (10%):
**192.168.1.10:80
**192.168.1.10:8080
*Sirva las web www.primera.cat y www.segunda.cat en función de la petición recibida en 192.168.1.10:80 (20%)
*Sirva la web www.recursos.cat en 192.168.1.10:8080 y sólo a los usuarios de la red 192.168.0.0/16 y que se autentifiquen (ojo, sin usar .htaccess) con elusuario y password: admin/coordinadorPepito (20%)
*En ningún caso mostrará el contenido del directorio donde se alojan las webs. (10%)
*Mantenga un registro de todos los accesos y errores que se produzcan en un archivo.(10%)
Se debe entregar los archivos de configuración modificados comentados de forma concisa pero suficiente. También se debe realizar alguna demostración de que el servidor funciona correctamente mediante capturas y/o archivos de registro (30%).
</pre>
</div>
<div title="Extraordinaria UF3" creator="YourName" modifier="YourName" created="201406151548" modified="201406161401" changecount="2">
<pre>NOTA: //Todas las preguntas valen lo mismo, es decir, 2'5 puntos//
!Pregunta 1
*Configura un //postfix// de tal manera que:
**Atienda los buzones del dominio iesjoandaustria.org.
**Que reenvíe los mensajes de correo de todos los clientes situados en la red local.
**Que disponga de los usuarios director@iesjoandaustria.org y secretario@iesjoandaustria.org
**Que no utilice ningún sistema de encriptación 
Inserta en el examen:
*Archivo de configuración: lo más pequeño posible y lo mejor comentado posible.
*Capturas de un envío de correo desde director@iesjoandaustria.org a secretario@iesjoandaustria.org utilizando telnet desde la interfaz local y capturas del registro de dicho envío.
!Pregunta 2
*Configura el DNS indicando que el gestor de correos del dominio iesjoandaustria.org es la máquina que dispone el //postfix// de la pregunta uno.
Inserta en el examen:
*Comprobaciones de que el servidor DNS funciona correctamente.
*Archivo de configuración del DNS (solo el archivo de zona)
!Pregunta 3
Envía desde una máquina cualquiera de la red un correo a director@iesjoandaustria.org. La máquina no debe ser la misma que la de la pregunta 1. Utiliza un cliente de correo (el que más rabia te dé). NO debes utilizar ninguna IP, es decir, todo lo resuelve el DNS de la pregunta 2.
*Inserta en el examen las capturas y registros que demuestren que logras lo que se te pide.
!Pregunta 4
Explica de forma breve qué cambios habría que realizar para enviar un correo a director@iesjoandaustria.org desde cualquier otra máquina pero utilizando un MTA diferente al del dominio iesjoandaustria.org (es decir, con dos ~MTAs)
!Evaluación
__Pregunta 1__ Hasta 25 ptos.
*Configuración : hasta 10 ptos.
*Creación de usuarios: hasta 5 ptos.
*Envío de correo: hasta 10 ptos.
__Pregunta 2__ Hasta 25 ptos.
*Configuración DNS: hasta 12'5 ptos.
*Pruebas: hasta 12'5 ptos.
__Pregunta 3__ Hasta 25 ptos.
*Envío de correo: hasta 15 ptos.
*Documentación de como se debe configurar el cliente / dns : hasta 10 ptos
__Pregunta 4__ Hasta 25 ptos.
*Añadir cliente a networks de MTA que envía. (5 ptos)
*En dns no hay que cambiar nada (debe estar el MX correcto) (10 ptos) 
*Añadir iesjoandaustria.org a mydestinations en MTA que recibe (10 ptos)
</pre>
</div>
<div title="Extraordinaria UF4" creator="YourName" modifier="YourName" created="201406151548" changecount="1">
<pre>Entrega de actividades de la unidad formativa.</pre>
</div>
<div title="Formatos multimedia" creator="YourName" modifier="YourName" created="201403131337" changecount="1">
<pre>__Codecs__
*Debido a que los contenidos multimedia suelen tener gran cantidad de información, los ficheros tienden a ser voluminosos. Por eso se tiende más al empleo de sistemas de compresión de datos para reducir el tamaño de ficheros. Las herramientas software encargadas del proceso de compresión/descompresión se denominan //Codecs//.
*El proceso habitual consiste en transformar un fichero por medio un codec, transmitirlo por la red como una cadena de bits (//stream//) y, al llegar al destino, restaurarlo empleando el mismo codec.
*Las técnicas de compresión son muy diferentes según la naturaleza de los datos (audio, vídeo, etc.). Pero una primera clasificación se puede realizar en función del mecanismo general para hacer la compresión de datos:
**''Codecs de compresión sin pérdida'': aplican algoritmos de compresión que tratan de eliminar  la redundancia de datos originales pero sin descartar nada. Es decir, el archivo siempre se podrá restaurar a su calidad original. Ejemplos: ZIP, FLAC,...
**''Codecs de comprensión con pérdida'': se asume cierta pérdida de calidad en el proceso de compresión, pero a cambio, se consigue reducir drásticamente el tamaño del fichero. Ejemplos: ~MP3, MPEG...
*El ''ratio de compresión'' nos mide la proporción en que se reduce un fichero después de la aplicación de un codec. A mayor valor, mayor compresión. Así un ratio de 5:1 indica que se comprime el fichero 5 veces obteniendo un fichero comprimido de un 20% del tamaño original.
__Formatos contenedores__
*Actualmente los formatos de archivos multimedia  disponen de flexibilidad suficiente para poder almacenar de forma integrada información relativa a varios medios diferentes. Por ejemplo un fichero que almacene una película debería poder contener datos relativos al vídeo, audio, subtítulos en varios idiomas y además información de sincronización de todo lo anterior. A este tipo de formatos se les llama formatos contenedores.
*Un formato almacenado en un formato contenedor necesitará varios codecs para poder codificar/descodificar cada uno de los elementos que forman parte del contenedor. 
*Algunos formatos contenedores habituales:
**''Ogg'': popular, gratuito, código abierto desarrollado por la fundición //Xiph//.
**''Matroska'':genérico, código abierto, usado para audio-vídeo de alta calidad.
**''AVI'': formato propietario de //Microsoft//.
**''~MP4 (~MPEG-14)'': desarrollado por un grupo de trabajo MPEG (//Moving Picture Experts Group//).

__Formatos y codec de audio__
*Los parámetros que caracterizan los formatos de audio son:
**''Frecuencia de muestreo'': Muestras por segundo en hertzios.
**''Calidad'': Número de bits empleado para codificar cada muestra. (8,16 o 32)
*Lógicamente a mayor calidad o mayor frecuencia, mayor es el tamaño del fichero. Por lo tanto, habrá que buscar soluciones de compromiso que dependerán del objetivo perseguido. 
*Algunos de los formatos más habituales y codecs son:
**''WAV'': //Microsoft//.
**''AIFF'': //Apple//
**''~MP3'' (~MPEG-1 y ~MPEG-2): codec perteneciente al conjunto de estándares desarrollados por MPEG. Permite reducir el tamaño en 10:1 sin apenas pérdida de calidad. Permite la parametriazación de su codificación en función del ''bitrate'' que mide la cantidad de bits empleados para codificar en segundo de audio. A mayor //bitrate//, mayor tamaño del fichero.
**''WMA'': Desarrollado para el reproductor //Microsoft Windows Media Player//.
**''ACC'': codec desarrollado por el grupo ~MPEG-2 que ha sido adoptado como codec de audio dentro del formato contenedor ~MP4.

__Formatos de imagen__
*Se caracterizan por:
**''Profundidad de color'': número máximo de colores diferentes para cada pixel que distingue el formato. Se mide en bits (8,16,24,32).
**''Resolución'': cantidad de puntos que se consideran a la hora de digitalizar la imagen. Se mide en megapixels o bien en dimensiones de imagen (pixels ancho x pixels alto). Así una imagen de 6 Megapixels  equivalen a 2000 pixels de ancho x 3000 de largo.
*El tamaño del fichero vendrá dado por el producto entre el número de píxeles y el número de bits de la profundidad del color.
*Los formatos más comunes son:
**''RAW'': gran calidad (64 de profundidad)
**''BMP'': formato de mapa de bits. Apenas realiza compresión de datos por lo que ocupa mucho espacio.
**''GIF'': poca calidad (8bits)
**''JPEG'': formato de compresión con pérdida pero admite diferentes calidades.
**''PNG'': similar al GIF pero de mayor calidad.

__Formatos y codecs de vídeo__
*Vienen determinados por:
**''Resolución y profundidad del color'': ya que un vídeo son una serie de imágenes consecutivas.
**''Frames'': número de imágenes por segundo. Se mide en fps (frames per second). Valores típicos entre 15 y 30.
*Formatos:
**''~RealVideo'': formato propietario de //~RealMedia//
**''Windows Media Video'': formato propietario de //Microsoft//.
**''Xvid'': codec libre basado en el estándar ~MPEG-4 ASP</pre>
</div>
<div title="Funcionamiento" creator="YourName" modifier="YourName" created="201310022142" modified="201310031359" changecount="6">
<pre>El funcionamiento del servicio DHCP sigue estos pasos:
#El cliente cuando se conecta a la red envía una solicitud en forma de //broadcast// a través de la red.
#Todos los servidores alcanzados por la solicitud responden al cliente con sus respectivas propuestas.
#El cliente acepta una de ellas haciéndoselo saber al servidor elegido.
#El servidor le entrega la información requerida por un plazo de tiempo (lease time).
#Esta información se mantiene asociada al cliente mientras éste no desactive la interfaz de red o no expire el plazo de la concesión.
#Renovaciones:
##Cada vez que el cliente arranca, cada cierto tiempo o bien cuando se alcanza el límite de la concesión, el cliente tiene que solicitar su renovación.
##Una vez vencido el plazo del contrato el servidor puede renovar la información del cliente, asignarle otra nueva o extender el plazo.
!! Obtener una concesión
Partimos de la situación en la que le servidor DHCP está a la escucha y preparado para atender las peticiones.
Podemos dividir el proceso en cuatro etapas:
*''Descubrimiento DHCP (DHCPDISCOVER)''
:El cliente difunde por //broadcast// un paquete DHCPDISCOVER  para localizar el servidor. El paquete tiene las siguientes características:
:*Puerto destino: 67/UDP
:*Puerto origen: 68
:*~IPorigen:0.0.0.0
:*~IPdestino:255.255.255.255
:*Lleva un identificador de la transacción
:*Incluye dirección MAC del cliente.
*''Oferta DHCP (DHCPOFFER)''
:Los servidores responden con DHCPOFFER. Ofrecen una IP al cliente, máscara, tiempo de concesión, etc. Cada servidor reserva la IP propuesta para no ofrecerla a otro.
*''Solicitud DHCP (DHCPREQUEST)''
:El cliente elige la &quot;mejor&quot; opción. Normalmente elige la primera. Difunde por //broadcast// un mensaje DHCPREQUEST poniendo el nombre del servidor elegido en uno de los campos de opciones (Id del servidor).
*''Reconocimiento DHCP (DHCPACK) reconocimiento negativo DHCP (DHCPNAK)''
:Si el mensaje DHCPREQUEST no contiene su dirección, el servidor considera su oferta rechazada. Si contiene su dirección envía un mensaje:
:*DHCPACK si la dirección aún está disponible.
:*DHCPNAK si ya no lo está dispoible o no es válida.
:Si el cliente recibe DHCPACK, puede usar la dirección IP. El cliente, además, debe verificar que la dirección IP es válida y no está duplicada. En el caso de detectar alguna duplicidad o considerar que la dirección no es válida, el cliente puede enviar DHCPDECLINE al servidor y vuelve al paso 1 (DHCPDISCOVER).
:Si el cliente recibe DHCPNAK, libera la dirección IP y vuelve al paso 1 (DHCPDISCOVER).
*''¿Qué ocurre si un equipo con una concesión activa cambia de subred?''
:Al reiniciarse el adaptador mandaría una petición de confirmación al servidor DHCP y éste le indicaría que su IP es inválida. El equipo habrá de solicitar una nueva concesión.
Esquema de una concesión típica:
 [img[as|http://publib.boulder.ibm.com/infocenter/iseries/v5r3/topic/rzakg/rzakg508.gif]]
!!Renovar una concesión
Los clientes intentan renovar su concesión:
*Cuando se inician (máquina o interfaz).
*Antes de que finalice el período de concesión. Por defecto, un cliente DHCP intenta renovar su concesión a la mitad del plazo de concesión, aunque este parámetro se puede configurar.
*Si no consigue renovar, al final el plazo libera la IP.
*También se puede realizar una renovación manual.
Se realizan dos pasos para renovar una concesión:
#El cliente difunde un DHCPREQUEST con la opción //Request IP address// (la dirección previamente asignada)
#El servidor DHCP correspondiente devuelve DHCPACK O DHCPNAK.
__Cuando un equipo se retira de la red__, el servidor detectará que ha caducado la concesión que tenía ese equipo y que no ha recibido ninguna petición de renovación, simplemente liberará la IP.
__Cuando se reinicia un equipo__ que ha obtenido una concesión activa, mandará un mensaje al servidor DHCP para confirmar si su configuración es válida. Si sí lo es, el servidor comprueba la validez de la concesión y, si es correcta, extiende el tiempo de la concesión a su valor por defecto.
!!Liberar una concesión
El cliente puede devolver la dirección IP al servidor DHCP que se la concedió antes de que finalice el plazo de la concesión, mediante DHCPRELEASE. Está situación se podría dar al cambiar un equipo de red, por ejemplo.
El cliente envía el mensaje y no espera respuesta.
</pre>
</div>
<div title="Funcionamiento Correo Electrónico" creator="YourName" modifier="YourName" created="201401290023" modified="201401290033" changecount="2">
<pre>Hay una gran cantidad de situaciones y arquitecturas posibles para implantar los servicios de correo en una organización.

De momento, tenemos:
*El servicio de correo está basado en el modelo cliente-servidor.
*Los usuarios disponen de cuentas de correo.
*Cada cuenta de correo dispone de buzones en un servidor de correo.
*Los usuarios utilizan clientes de correo (MUA) para escribir mensajes que envían a los servidores de correo (~MTAs). Se utiliza el protocolo SMTP para la comunicación entre el MUA y MTA.
*Los  ~MTAs de los servidores de correo se encargan de reenviar los mensajes a otros ~MTAs si el destinatario del mensaje no tiene cuenta en ellos. Si el destinatario sí tiene cuenta en el servidor se almacena el mensaje en el buzón (lo puede hacer el MDA).
*Los usuarios utilizan los clientes de correo (MUA) para acceder a los servidores de POP o IMAP y obterner y consultar los mensajes de sus buzones de correo. 
__Proceso general de envío/reenvío de correos__
#Un usuario escribe un mensaje de correo electrónico usando un cliente de correo (MUA). Normalmente, el mensaje contiene:
##Dirección de correo origen (profesor@asi.cat).
##Dirección/es de correo destino (alumno@asix.cat).
##Cuerpo del mensaje (texto, archivos, imágenes...).
#El cliente de correo (MUA) envía el correo usando el protocolo SMTP. Existen varias posibilidades:
##A un servidor de correo local (MTA local), si en la misma máquina donde está el cliente hay un MTA.
##A un servidor de correo remoto (MTA):
###Al servidor de correo del usuario destinatario (el del dominio asix.cat). No es habitual porque el servidor de correo debería estar configurado para no admitir correos de cualquier origen.
###Al servidor de correo del usuario que envía el mensaje (el del dominio asi.cat). Es lo habitual porque los ~MTAs deben estar configurados para recibir y/o reenviar correo solo de usuarios, dominios, equipos o redes autorizados.
###A otro servidor de correo (que se suele llamar //relay o smart host//). Debe estar configurado para admitir correos del usuario, dominio, equipo o red desde donde se envía.
#El servidor de correo (el MTA) recibe el mensaje usando el protocolo SMTP.
##Si el correo está dirigido a un usuario cuyo buzón está en el servidor local, el correo se almacena en el buzón del usuario.(Recepción de correo)
##Si el correo está dirigido a un usuario que no tiene cuenta en el servidor, existen dos posibilidades (Retransmisión o reenvío de correo):
###Envía el correo al servidor de correo destinatario del mensaje (asix.cat)
###Envía el correo a otro servidor de correo (//relay o smart host//) que vuelve a realizar el mismo proceso. Debe estar configurado para admitir correos del usuario, dominio, equipo o red desde donde se envía. Este paso se puede repetir bastantes veces, es posible por tanto, que el mensaje pase por varios MTA antes de llegar al destino.
__Envío de correos y DNS__
Los ~MTAs determinan cuál es el siguiente MTA al que tienen que enviar un mensaje en función de la dirección de correo de destino (y, por supuesto, de su configuración). Para averiguar la dirección IP del servidor de correo de dominio consultan el DNS. Hay que recordar que los servidores DNS almacenan registros de recursos de tipo MX que especifican cuál o cuáles son los equipos que actúan como servidores de correo de un dominio.
__Proceso general de recepción o entrega de correos__
*Iniciar sesión en el servidor de correo (no es lo habitual). Acceder al buzón directamente o usar un cliente de correo local que le permita consultar el buzón.
*Usar  un cliente de correo que se comunique con el servidor para descargar los mensajes usando un protocolo de entrega como POP o IMAP.
__Ejemplo típico del proceso de entrega y recepción del correo__
Situación: usuario usuario1@origen.org quiere escribir a usuario2@destino.com.
#El MUA de usuario1 envía el mensaje al MTA. Puede despositarlo directamente en la cola de mensajes del MTA o se lo envía usando SMTP. El MTA puede estar en la máquina origen, puede estar en el dominio local o puede ser cualquier otro configurado adecuadamente para reenviar correos de usuario1@origen.org.
#MTA al DNS: ¿Cuál es el servidor de correo del dominio destino.com? Obtiene la IP del servidor de correo del dominio destino.com.
#MTA envía el mensaje de correo al MTA destinatario.
#MTA destinatario recibe el mensaje y lo deposita en el buzón del usuario2 (MDA)
#El usuario2 utilizará un MUA para acceder a su buzón de correo utilizando ~POP3 o IMAP o SMTP.

</pre>
</div>
<div title="Funcionamiento según wikipedia" creator="YourName" modifier="YourName" created="201403051723" changecount="1">
<pre>El protocolo SSL intercambia registros; opcionalmente, cada registro puede ser comprimido, cifrado y empaquetado con un código de autenticación del mensaje (MAC). Cada registro tiene un campo de content_type que especifica el protocolo de nivel superior que se está usando.
Cuando se inicia la conexión, el nivel de registro encapsula otro protocolo, el protocolo handshake (o protocolo de acuerdo), que tiene el content_type 22.
El cliente envía y recibe varias estructuras handshake:
*Envía un mensaje ClientHello especificando una lista de conjunto de cifrados, métodos de compresión y la versión del protocolo SSL más alta permitida. Éste también envía bytes aleatorios que serán usados más tarde (llamados Challenge de Cliente o Reto). Además puede incluir el identificador de la sesión.
*Después, recibe un registro ServerHello, en el que el servidor elige los parámetros de conexión a partir de las opciones ofertadas con anterioridad por el cliente.
*Cuando los parámetros de la conexión son conocidos, cliente y servidor intercambian certificados (dependiendo de las claves públicas de cifrado seleccionadas). Estos certificados son actualmente X.509, pero hay también un borrador especificando el uso de certificados basados en OpenPGP.5
*Cliente y servidor negocian una clave secreta (simétrica) común llamada master secret, posiblemente usando el resultado de un intercambio Diffie-Hellman, o simplemente cifrando una clave secreta con una clave pública que es descifrada con la clave privada de cada uno. Todos los datos de claves restantes son derivados a partir de este master secret (y los valores aleatorios generados en el cliente y el servidor), que son pasados a través una función pseudoaleatoria cuidadosamente elegida.
TLS/SSL poseen una variedad de medidas de seguridad:
*Numerando todos los registros y usando el número de secuencia en el MAC.
*Usando un resumen de mensaje mejorado con una clave (de forma que solo con dicha clave se pueda comprobar el MAC). Esto se especifica en el RFC 2104).
*Protección contra varios ataques conocidos (incluyendo ataques man-in-the-middle), como los que implican un degradado del protocolo a versiones previas (por tanto, menos seguras), o conjuntos de cifrados más débiles.
*El mensaje que finaliza el protocolo handshake (Finished) envía un hash de todos los datos intercambiados y vistos por ambas partes.
*La función pseudo aleatoria divide los datos de entrada en 2 mitades y las procesa con algoritmos hash diferentes (MD5 y SHA), después realiza sobre ellos una operación XOR. De esta forma se protege a sí mismo de la eventualidad de que alguno de estos algoritmos se revelen vulnerables en el futuro.</pre>
</div>
<div title="Instalación Apache" creator="YourName" modifier="YourName" created="201311210006" changecount="1">
<pre>//Apache// es una fundación que desarrolla una gran cantidad de proyectos software. Uno de sus principales proyectos es un servidor web o HTTP &quot;open source&quot;.
*Iniciamos sesión en ubuntuXX con privilegios de administración.
*{{{sudo apt-get update}}} seguido de {{{sudo apt-get install apache2}}}
*Observa que al finalizar la instalación aparece un mensaje de advertencia &quot;Could not determine the servers fully qualified domain name...&quot;. Significa que //apache2// no es capaz de determinar cuál es el nombre completo del equipo.
*Al instalar el servidor se crean:
**Los archivos de configuración.
**El usuario //www-data// que se incluye en el grupo //www-data//. Son el usuario y el grupo con los que se ejecutan los procesos hijos de Apache.
**El directorio /var/www:
***Su propietario es el usuario //root// y su grupo es //root//.
***Es el directorio raíz del servidro virtual por defecto.
*Comprobamos {{{cat /etc/passwd}}}, {{{cat /etc/group}}} y {{{ls -l /var}}}
*Archivos de configuración:
**{{{/etc/apache2/apache2.conf}}}
***El archivo contiene un conjunto de directivas que determinan el comportamiento del servidor.
***Los comentarios son a nivel de línea y se utiliza el símbolo almohadilla #
***Las directivas no especificadas utilizan su valor por defecto.
***Se utiliza un fichero denominado {{{httpd.conf}}} en el que se almacenan todas las directivas de configuración (en Debian apache2.conf)
***Desde este fichero se incluyen (usando la directiva //include//) otros ficheros de configuración.
**{{{/etc/apache2/ports.conf}}}
***En él se definen las ~IPs y puertos en los que escucha el servidor.
**{{{/etc/apache2/mods-avaible/}}}:
***Directorio de configuración de módulos disponibles.
***Contiene ficheros .load y .conf. El primero contiene todo lo necesario para cargar un módulo concreto, los segundos contienen la configuración básica para inicializar el módulo.
**{{{/etc/apache2/mods-enabled}}}:
***Directorio de configuración de módulos habilitados. Los carga Apache al iniciarse.
***Son enlaces simbólicos a los ficheros de mods-available.
**{{{/etc/apache2/sites-available}}}
**Directorio de configuración de sitios virtuales disponibles.
**Por defecto está creado el fichero //defaul// con la configuración del denominado servidor virtual por defecto.
**{{{/etc/apache2/sites-enabled}}}
***Directorio de configuración de sitios virtuales configurados.
***Contiene enlaces simbólicos a sites-available
***Por defecto contiene //000-default// que es un enlace al fichero //default// de sites availables.
**{{{/etc/apache2/conf.d/}}}
***Directorio de configuraciones locales
***Los ficheros incluidos en este directorio se incluyen en el fichero apache.conf
***Algunas aplicaciones web incluyen su configuración en este directorio.
**{{{/etc/apache2/envars}}}: variables de entorno que utiliza el comando //apache2ctl//.
</pre>
</div>
<div title="Instalación postfix" creator="YourName" modifier="YourName" created="201401290042" modified="201401290058" changecount="2">
<pre>''Postfix'' es un MTA para sistemas //Unix/Linux//. Es rápido, modular y fácil de administrar (en relación a otros).
Vamos a instalar el MTA //Postfix// para que reciba correo del dominio asix.net y reenvíe mensajes directamente a los servidores de correo destinatarios.
__Instalación__
*Mirar que en /etc/hosts y /etc/hostname el nombre del equipo sea debian.asix.net.
*{{{sudo apt-get install postfix}}}
*Selecciona //Sitio de internet//, introduce el nombre de dominio que gestionará Postfix (asix.net.)
*Tras la instalación se han creado: Archivos de configuración, usuario //postfix// y grupo del mismo nombre, certificados digitales autofirmados para conexiones SMTPS.
__Configuración__
Postfix se configura editando parámetros en ficheros de configuración. Los archivos están en {{{/etc/postfix}}}
*{{{/etc/postfix/main.cf}}}: archivo de configuración principal. 
**Cada parámetro se especifica en una línea con el formato parámetro=valor.
**Si una línea comienza con un espacio es que continúa el parámetro anterior.
**Se puede utilizar $parámetro para asignar el valor de un parámetro a otro.
**Los comentarios son a nivel de línea y se utiliza el símbolo almohadilla.
**Los parámetros que no se especifiquen en el fichero de configuración, utilizan su valor por defecto.
*{{{/etc/postfix/master.cf}}}: Archivo de configuración del demonio maestro de Postfix. Especifica como //Postfix// interactúa con diferentes procesos para lograr la entrega de correo.
*{{{/etc/aliases}}}: archivo para definir alias de cuentas de correo.
__Comprobación__
*Que está rodando. {{{ps -ef|grep postfix}}}
*Que escucha {{{netstat -ltn}}}
*&quot;Saludar al servidor&quot;: {{{telnet localhost 25}}}
__Logs__
*{{{/var/log/mail.log}}}: Fichero principal. Se registra todo lo relacionado con el envío de correo}}}
*{{{/var/log/mail.info}}}: Registro de las acciones del servidor.
*{{{/var/log/mail.warn}}}: Registro de avisos.
*{{{/var/log/mail.err}}}: Registro de errores.
__Usuarios y preparación para probar el servidor__
*Postfix puede gestionar cuentas de correo de usuarios locales con cuenta en el sistema y usuarios virtuales (bbdd, servicios de directorio, etc.)
*Creamos los usuarios {{{sudo adduser mortadelo}}} y {{{sudo adduser filemon}}}
*Instalamos el paquete //mailutils// que contiene el cliente de correo ''mail''. {{{sudo apt-get install mailutils}}}
__Configuración por defecto__
*Gestiona cuentas de usuarios locales con el nombre de dominio asix.net.
*Solo permite el reenvío de correos enviados desde el propio equipo.
*Permite conexiones SMTP y conexiones SMTPS en el puerto 25 usando STARTTLS  (usando certificado digital autofirmado).
*No tiene configurada ningún tipo de autenticación SMTP.
*Permite el reenvío de correos destinados a cualquier dominio y envía los correos directamente a los destinatarios.
*Los buzones de los usuarios se almacenan en formato //mailbox// en el directorio /var/mail
__Correo entre usuarios locales__
*Inicial sesión como mortadelo
*Utiliza el comando //mail// para enviarle un correo a filemon (por defecto el comando mail envía los correo creados al MTA local) (NOTA: para enviar el correo usa Ctrl+D)
*Accede como filemon y consulta su buzón de correo /var/mail/filemon.
*Echa un vistazo a los logs (como administrador) para ver cómo a registrado el envío el correo.</pre>
</div>
<div title="Instalación vsftp" creator="YourName" modifier="YourName" created="201401081607" modified="201401081617" changecount="7">
<pre>__Instalación__
*En debianXX con permisos de //root//: {{{apt-get install vsftpd}}}
*Se crean:
**Archivos de configuración.
**El usuario ftp.
**El directorio /srv/ftp:
***Su propietario es el usuario //root// y su grupo es //ftp//.
***Es el directorio predeterminado de los usuarios anónimos.
*Comprueba que se ha creado el usuario: {{{cat /etc/passwd}}} y  {{{ /etc/group}}} y, también, {{{ls -l /srv}}}
*Archivos de configuración:
**{{{/etc/vsftpd.conf}}}: Fichero de configuración principal.
***Contiene directivas que determinan el comportamiento del servidor. 
***Las directivas tienen el formato: &lt;//directiva//&gt;=&lt;valor&gt; . IMPORTANTE: No debe haber espacios antes y después del signo &quot;=&quot;.
***Tres tipos de directivas: Booleanas, Numéricas, De cadena.
***Los comentarios son a nivel de línea y se utiliza el símbolo almohadilla (#)
***Las directivas que no se especifiquen en el fichero de configuración, utilizan su valor por defecto.
***Consultar //man vsftpd.conf// para obtener información sobre todas las directivas.
**Otros ficheros de configuración:
***Su nombre y ubicación se pueden definir en las directivas de //vsftpd.conf//
***Algunos más importantes: {{{/etc/ftpusers}}}, {{{/etc/vsftpd.user_list}}}, {{{/etc/vsftpd.chroot_list}}}
*Comprueba que el servidor está rodando {{{ ps -ef|grep vsftpd}}} y {{{netstat -ltn}}}
*Haz una copia del fichero //vsftpd.conf// antes de comenzar a modificarlo.
__Usuarios y preparación para probar el servidor__

//vsftpd// permite la conexión de:
*''Usuarios anónimos'':
**Requiere directiva //anonymous_enable// habilitada. 
**Permite conexión de usuarios anónimos con el nombre //anonymous// o //ftp//.
**El usuario accede al directorio /srv/ftp especificado en /etc/password para el usuario //ftp//. Está &quot;enjaulado&quot; en ese directorio.
*''Usuarios locales con cuenta en el sistema''
**Requiere //local_enable// habilitada.
**Cuando se conecta un usuario local hay dos opciones de configuración:
***Que no se enjaule en su directorio //home// y acceda al resto del sistema de archivos en función de los permisos.
***Que se enjaule y no pueda salir de su //home//.
*''Usuarios virtuales''
**Es posible crear cuentas de usuarios virtuales (que no existan en el SO).
**Las cuentas se almacenan en ficheros o en bbdd, servicios de directorio, etc. 
**Las cuentas virtuales se mapean en un usuario local del sistema.
Vamos a crear usuarios locales en el sistema para probar porteriormente el funcionamiento del servidor.
*Crea los usuarios locales mortadelo y filemon {{{adduser mortadelo}}} y {{{adduser filemon}}} en debianXX. Añade en el directorio //home// de cada uno de ellos dos archivos de texto y cierra la sesión. 
*Accede al directorio /srv/ftp y crea tres archivos de texto.
__Configuración por defecto__

La configuración por defecto del servidor es:
*Permite solo el acceso a usuarios anónimos. Estos usuarios están enjaulados en /srv/ftp
*Pueden descargar archivos pero no pueden subir. 
*El servidor usa todo el ancho de banda disponible.
*El fichero de logs por defecto es /var/log/vsftpd.log
Echa un vistazo al fichero de configuración de //vsftpd//. Comprueba que: 
**Está habilitado el acceso a usuarios anónimos: //anonymous_enable=YES//
**Está deshabilitado el acceso a usuarios locales: //local_enable=NO//
**No se permite subir archivos al servidor: //write_enable=NO//
Conéctate desde ~UbuntuXX y verifica: 
*Es posible acceder como usuario anónimo y descargar archivos.
*No es posible acceder con los usuarios locales mortadelo, filemon
Vuelve a debianXX y échale un vistazo a los logs del servidor. Observa acceso y transferencias realizadas.</pre>
</div>
<div title="Introducción" creator="YourName" modifier="YourName" created="201309242347" modified="201309242349" changecount="4">
<pre>!Arquitectura TCP/IP
La arquitectura TCP/IP nos proporciona una estructura y una serie de normas de funcionamiento para poder interconectar sistemas. La complejidad de esta tarea ha necesitado una subdivisión del trabajo en niveles o capas coordinadas de manera que, cada capa realiza una labor concreta y así la integración modular y jerárquica de todas ellas hace posible la comunicación.
En cada capa existen una serie de protocolos que ofrecen unas normas estrictas a seguir para el diálogo entre los sistemas. Cada protocolo se apoya en los protocolos de las capas inferiores para realizar su labor y, a su vez, ofrece servicios a las capas superiores. Ésta es una de las características fundamentales de la arquitectura TCP/IP. 

[img[TcpIp|Documentos/M8/Imágenes/tcp_ip_frentea_iso.png]]

!El modelo Cliente/Servidor
Para la comunicación de aplicaciones a través de una red se emplean fundamentalmente tres paradigmas:
*El modelo ''cliente/servidor'' es el más extendido y utilizado. 
*El modelo  entre pares o ~P2P (point to point) de difusión creciente y donde todos los nodos de la red son responsables por igual de la comunicación de las aplicaciones y no existe un elemento que centralice la comunicación.
*El modelo híbrido que resulta de la combinación de los dos anteriores y donde el servidor no presta el servicio como tal, sino que generalmente pone en contacto a los clienttes para que estos se comuniquen entre sí.
El modelo ''cliente/servidor'' define tanto la estructura de las aplicaciones que se comunican entre sí como su sincronización. Está formado por dos procesos que interactúan entre sí y que carecen de sentido el uno sin el otro:
*Proceso cliente:
**Normalmente inicia la comunicación {{{--&gt;}}} elemento activo.
**Envía peticiones al servidor y, a continuación, queda a la espera de la respuesta.
*Proceso servidor:
**Permanece a la espera de peticiones de algún cliente {{{--&gt;}}} elemento pasivo. </pre>
</div>
<div title="Introducción DHCP" creator="YourName" modifier="YourName" created="201310022136" changecount="1">
<pre>;Dinamic Host Configuration Protocol. Protocolo de configuración automática de hosts.
:Es un protocolo de la capa de aplicación que implementa un servicio de configuración automática de red en redes TCP/IP. 
*Inconvenientes de la configuración manual: tiempo de trabajo, errores, si un equipo cambia de ubicación y cambia de subred (portátiles-wifi) habrá de reconfigurarse, si hay que reestructurar la red habrá que reconfigurar todos los equipos, etc.
*Ventajas DHCP: disminución de la carga de trabajo del administrador, reconfiguraciones y reestructuración donde no es necesaria la intervención del administrador, disminución de errores. Además, el tráfico de paquetes que genera el servicio es mínimo. Inconveniente: si falla DHCP, falla todo (por eso, los servidores de una red suelen configurarse manualmente)
</pre>
</div>
<div title="Introducción DNS" creator="YourName" modifier="YourName" created="201310142125" changecount="1">
<pre>*Para facilitar el uso de los servicios y recursos que ofrece la red se han creado sistemas de nombres utilizados por ''servicios de resolución de nombres'' que permiten asociar nombres sencillos con direcciones numéricas. 
*''Resolver un nombre'' es traducir un nombre de un recurso de la red en su dirección numérica.
*El principal servicio de resolución de nombres sobre TCP/IP es el servicio ''DNS Domain Name System''.
*Tipos de sistemas de nombres:
**Sistemas de nombres planos: sin ningún tipo de agrupamiento, sin jerarquía que permita clasificarlos. Ejemplos: ~DNIs, nombres de las ciudades, nombres NETBIOS de //Windows//, etc.
**Sistemas de nombres jerárquicos: uso de nombres agrupados según algún criterio (distribución geográfica, tamaño, etc.). Ejemplos: números de teléfono (0034933894455, 0034 {{{--&gt;}}}Identifica a España, 93 {{{--&gt;}}} Barcelona); nombres usados en los sistemas de ficheros de los sistemas operativos (C:\datos\apuntes.txt), etc.
*''DNS ofrece un sistema de nombres jerárquico''.
*Mini Historia DNS: 
**Inicialmente se utilizaba un sistema de nombres planos. La relación entre IP y nombres se almacenaba en un archivo host.txt localizado en un servidor central. Los equipos obtenían periódiamente por FTP el archivo y así podían usar los nombres que contenía.
**Cuando la red aumentó aparecieron los problemas: sobrecarga del servidor como consecuencia del aumento del tamaño del fichero y del número de descargas, sobrecarga de la red, aumento de la probabilidad de duplicidad de nombres, dificultad de administrar el fichero y gestionar las múltiples peticiones de nuevos nombres, etc.
**En 1983 se creó el nuevo sistema DNS. Se buscaba que ofreciera: escalabilidad, administración descentralizada, velocidad, etc.</pre>
</div>
<div title="Listas de distribución" creator="YourName" modifier="YourName" created="201403120137" changecount="1">
<pre>Se puede considerar una lista de distribución como un servicio basado en una lista de direcciones de correo electrónico, que se utiliza para enviar mensajes de interés que se distribuyen a todos los miembros pertenecientes a la misma.
Para formar parte de una lista de distribución es necesario subscribirse, momento a partir del cual se empezarán a recibir todos los mensajes que se envían a la lista.
__''Tipos de acceso a la lista de distribución''__
Las listas de distribución se pueden configurar para funcionar de diferentes maneras:
*Listas de anuncios: la comunicación es siempre en el mismo sentido y los subscriptores solo reciben información sin poder enviar mensajes a la lista de distribución.
*Listas de discusión: se utilizan para que un grupo de usuarios se comuniquen entre sí.
*Listas personalizadas utilizando bases de datos: este tipo de listas permiten personalizar los mensajes que recibe cada usuario basándose en la información del mismo existente en una bbdd.
__''Tipos de listas de distribución''__
Las listas de distribución se pueden clasificar según la manera de participar en ellas: moderadas, abiertas o cerradas (solo el propietario envía)
También las podemos clasificar según quién puede participar en ella: públicas o privadas</pre>
</div>
<div title="Lo mío" creator="YourName" modifier="YourName" created="201309261349" changecount="1">
<pre>[[uf1]]</pre>
</div>
<div title="MainMenu" creator="YourName" modifier="YourName" created="201309242345" modified="201406151538" changecount="10">
<pre>[[UF1]]
[[UF2]]
[[UF3]]
[[UF4]]
[[ExtraOrdinarias]]
[[Renovación Windows]]
[[Ayuda]]
</pre>
</div>
<div title="Mensajes" creator="YourName" modifier="YourName" created="201402120000" changecount="1">
<pre>Los mensajes del correo electrónico son mensajes de texto que siguen el formato IMF (//Internet Mail Format//).
Están formados por tres partes:
*__Cabecera__: compuesta por líneas de texto ASCII con el formato nombre:valor/es y con información que es usada en la transferencia, análisis y clasificación del mensaje. Son incluidas y consultadas por los componentes que intervienen en la transferencia. Las cabeceras más usadas son:
**''To'': dirección/es de los destinatarios.
**''From'': dirección del remitente.
**''CC'': destinatarios secundarios.
**''BCC'': destinatarios ocultos.
**''Subject'' asunto del mensaje.
**''~Replay-To'': dirección a la que responder. La añade el MUA emisor. Puede ser diferente a la que aparece en el //From//.
**''Received'': agregada por los ~MTAs por los que pasa el mensaje. Se incluyen la identidad del MTA, la fecha, la hora de recepción y otra información. Se utiliza para hacer un seguimiento y resolver problemas.
**''~Delivered-To'': dirección real a la que es entregado el mensaje (sin alias).
**''Date'': fecha y hora del envío del mensaje.
**''~Message-Id'': identificador del mensaje.
**''~In-Replay-To'': identificador del mensaje al que se corresponde la respuesta.
**''~Return-Path'': generada por el MTA final indicando cuál es el emisor real del mensaje.
**Los ~MUAs y ~MTAs pueden definir sus propias cabeceras para añadir información adicional en los correos. Como convenio se ha establecido que se utilice el prefijo X- para indicar que es una cabecera no estándar. (~X-Originating-IP)
*__Cuerpo__: contiene el mensaje en sí. Inicialmente solo se podían enviar mensajes de texto en formato ASCII pero actualmente, gracias a las extensiones MIME, se puede enviar todo tipo de contenidos.
*__MIME__: Las extensiones MIME definen cabeceras que se pueden usar en el cuerpo del mensaje y permiten incluir: caracteres especiales (ñ, tildes), alfabetos no latinos (árabe, hebreo,..) y ficheros de audio, vídeo, imágenes....</pre>
</div>
<div title="Netcraft" creator="YourName" modifier="YourName" created="201311210016" modified="201312041637" changecount="3">
<pre>#//Netcraft// es una compañía que, entre otros servicios, ofrece análisis y comparativas de la Web. Visita su página [[web|http://www.netcraft.com/]]:
##¿Qué ofrece realmente esta web?
##¿Qué son todos estos &quot;servicios&quot; de  //anti-fraud and anti-phishing services, application testing, PCI scanning//
##¿Cuál es el servidor web más utilizado según esta web?
##En [[esta|http://www.netcraft.com/internet-data-mining/million-busiest-websites/]] hay un rincón que dice algo así como //What's that site running?//. Añade una URL a ese espacio, ¿qué sucede?¿Qué información nos devuelve la web?
##Investiga más secciones de la web, ¿encuentras algo interesante?</pre>
</div>
<div title="Nivel de red IP" creator="YourName" modifier="YourName" created="201309242352" changecount="1">
<pre>[[Direccionamiento IP]]
[[Encaminamiento IP]]</pre>
</div>
<div title="Nivel de transporte" creator="YourName" modifier="YourName" created="201309252155" changecount="1">
<pre>*IP permite comunicar máquinas remotas pero, ¿cómo mantener varias comunicaciones entre los dos mismos equipos? 
*El nivel de transporte se encarga de identificar los extremos finales de la comunicación.
;Puerto de comunicaciones
:Permite identificar los procesos del nivel de aplicación entre los que está establecida una comunicación.
*Un puerto se identifica por un binario de 16bits. Se clasifican:
**Puertos conocidos (0-1023): well known ports. Reservados para aplicaciones y servicios estándar (HTTP, FTP, etc.)
**Puertos registrados (1024-49151): para aplicaciones no estandarizadas.
**Puertos dinámicos (resto): habitualmente se emplean para iniciar conexiones desde el cliente. No suelen emplearse para procesos servidores.
*La correspondencia entre procesos y puertos se hace de dos formas:
**Asignación estática: caso de los //well known ports//
**Asignación dinámica: el SO asigna un puerto disponible al proceso que se lo solicita.
!!!Protocolos TCP y UDP
*El nivel de transporte dispone de dos protocolos __completamente independientes__: TCP y UDP. Ambos manejan el concepto de puerto de comunicación pero no tiene nada que ver el puerto 53 UDP con el puerto 53 TCP.
*UDP proporciona un servicio no orientado a conexión: no hay establecimiento de la comunicación y no hay control de flujo. UDP se utiliza en los casos en que prevalece velocidad de la transmisión sobre fiabilidad de la misma o en aplicaciones con requerimientos muy sencillos. (DHCP, DNS...)
*TCP //Transmission Control Protocol// proporciona un servicio orientado a conexión. Exige establecimiento de la conexión antes de empezar a transmitir. Ofrece también un servicio fiable: control de flujo y de errores.
*Una conexión se define de forma única por los datos relativos a los puntos extremos de la comunicación: (Dirección IP Origen, Puerto TCP origen) {{{--&gt;}}} (Dirección IP destino, Puerto TCP destino). No puede exister dos conexiones TCP que tengan en común estos cuatro elementos.

 </pre>
</div>
<div title="Protocolos" creator="YourName" modifier="YourName" created="201402120001" changecount="1">
<pre>!!!Protocolos de transferencia de correo. SMTP/ESMTP
__''SMTP''__
*//Simple Mail Transfer Protocol//
*Lo utilizan los ~MTAs para intercambiar correos y los ~MUAs para enviar correos a los ~MTAs.
*Utiliza TCP como protocolo de transporte.
*Su funcionamiento se basa en el intercambio de mensajes (comandos y respuestas) en formato ASCII entre cliente y servidor.
*Funcionamiento básico:
**Cliente establece conexión TCP con el servidor.
**Servidor responde con una respuesta (ejemplo 220)
**Cliente saluda al servidor con el comando HELO.
**Servidor acepta y envía otra respuesta (250).
**Se envían comandos y respuestas para enviar correos electrónicos.
**Se finaliza la conexión (QUIT).
*''Comandos SMTP'': utilizados por los clientes: HELO, DATA, MAIL FROM.... Admiten parámetros y acaban con &lt;CR&gt;&lt;LF&gt;
*''Codigos de estado'': respuestas de los servidores. Son números de tres dígitos seguidos de un mensaje descriptivo.
__''ESMTP''__
*//Extended Simple Mail Transfer//
*Define un conjunto de extensiones del protocolo SMTP que solucionan problemas y añaden funcionalidades: MIME, AUTH, STARTTLS...
*Los clientes que quieran utilizar ESMTP deben saludar con EHLO
!!!Protocolos de entrega de correo
__''Protocolo POP''__
*//Post Office Protocol//
*Versión actual ~POP3
*Permite:
**Conectarse al servidor
**Descargarse los mensajes de correo (eliminándolos o manteniendo una copia en el buzón).
**Cerrar la conexión.
*Utiliza TCP y se basa en el intercambio de mensajes ASCII.
*Ofrece diversos mecanismos  de autenticación (USER/PASS, APOP,SALS...)
*El usuario debe autenticarse para acceder a su buzón.
__''Protocolo IMAP''__
*//Internet Message Access Protocol//
*Versión ~IMAP4
*Utiliza TCP y se basa en el intercambio de mensajes ASCII
*Ofrece autenticación (AUTHENTICATE, LOGIN, SASL....)
*El usuario tiene que autenticarse.
*Permite:
**Operar en modo desconectado y establecer conexiones para descargar el correo (igual que POP)
**Operar en modo conectado permitiendo la manipulación  de los buzones como si fueran locales.
**Soporte para acceder a partes de los mensajes y obtenerlos parcialmente.
**Acceso simultáneo al mismo buzón por múltiples usuarios.
**Crear, borrar y manipular buzones.</pre>
</div>
<div title="Protocolos Streaming" creator="YourName" modifier="YourName" created="201403270035" changecount="1">
<pre>Hay muchos protocolos para streaming tanto libres como propietarios. Veremos los más habituales.
!!!Protocolo HTTP
Hay dos opciones:
*Se realiza una conexión HTTP normal y se descargaría el fichero completamente. A continuación, se remitiría el fichero al reproductor multimedia que reproduciría su contenido.
*Otra opción es obtener información sobre un fichero multimedia y posteriormente descargarlo mediante HTTP encapsulado sobre UDP, para acelerar la transferencia de datos.
En ambas opciones hay que descargar el fichero completamente para reproducirlo. Por esta razón al protocolo HTTP se le denomina de pseudo-streaming.
!!!Protocolo RTSP
*//Real Time Streaming Protocol//
*Protocolo a nivel de aplicación encargado de la gestión y control de la transmisión de uno o varios streams de contenido multimedia hacia un cliente. 
*Normalmente viaja sobre TCP (554/TCP) aunque puede utilizar UDP (para //multicast//) (554/UDP)
*El formato de los mensajes es del estilo de los mensajes de HTTP: mensajes de petición respuesta; las URL ({{{rtsp://zebra.cpd.ua.es/directoOptica}}}), integración con SSL/TSL, etc.
*Características propias:
**Es un protocolo con estado que marca la situación específica en la que se encuentra la conexión.
**Es un protocolo multiservidor, que permite controlar sesiones con diferentes servidores para una misma reproducción multimedia en el cliente.
**Servidores y clientes pueden realizar peticiones RTSP.
**La transmisión del contenido multimedia propiamente dicho, se hace mediante conexiones separadas empleando un protocolo diferente (RTP).
*''Métodos RTSP'':
**DESCRIBE: método empleado por el cliente para obtener una descripción de un contenido multimedia referenciado por una URL RTSP.
{{{
Ejemplo: Cliente → Servidor: Realiza petición informando de formatos aceptados por el cliente
            DESCRIBE rtsp://unservidor.com/uncontenido RTSP/1.0
            Accept: application/sdp, application/rtsl, application/ mheg

Servidor → Cliente: Contesta informando sobre flujos necesarios para la reproducción.
            RTSP/1.0 200 OK
           Content-Type: application/sdp
           Content-Length: 376
           i=Descripción del contenido
           m=audio 3456 RTP/AVP 0
           m=video 2232 RTP/AVP 31
}}}
**SETUP: se emplea a continuación del método DESCRIBE. El cliente indica al servidor el protocolo de transporte de datos (normalmente, RTP) y varios parámetros para la transmisión.
{{{
Ejemplo: Cliente →Servidor
          SETUP rtsp://unservidor.com/directorio/fichero.rm RTSP/1.0
         Transport: RTP/AVP; unicast; client_port=4588-4589

Respuesta  Servidor →Cliente:
         RTSP/1.0 200 OK
         Session: 47112344
         Transport: RTP/AVP;unicast;
        client_port=4588-4589;server_port=6256-6257
}}}
**PLAY: con este método el cliente indica al servidor que puede empezar a emitir el stream de datos multimedia. Se envía por parte del cliente después de haber recibido la respuesta SETUP del servidor.
**PAUSE: el cliente solicita al servidor que detenga momentáneamente el flujo de datos pero no finaliza la sesión
**TEARDOWN: el cliente finaliza la sesión, cierra la conexión y libera los recursos.
Las transiciones entre estados puede representarse con un diagrama de estados:
[img[DiagramaRTSP|http://profesores.elo.utfsm.cl/~agv/elo323/2s12/project/reports/MarceioBaeza/images/sesiones.JPG]]
!!!Protocolo RTP
*//Real Time Protocol//
*Protocolo a nivel de aplicación encargado del transporte del flujo de datos multimedia entre servidor y cliente.
*Encapsulado en UDP normalmente aunque puede ir sobre TCP.
*En el servidor todos los flujos de datos son multiplexados conjuntamente en paquetes RTP que a su vez van encapsulados en segmentos del nivel de transporte (TCP/UDP). Cada paquete RTP va numerado de forma consecutiva para reconocer la pérdida de paquetes que en cualquier caso nunca serán retransmitidos por la demora que eso supondría. En su lugar, cuando el cliente observa la pérdida de un paquete, por lo general, tratará de realizar una interpolación a partir de paquetes anteriores y posteriores.
*Para permitir que los múltiples flujos incluidos en los paquetes RTP se sincronicen sin problemas en el buffer de entrada del cliente, incluso cuando haya  pérdida de paquetes, se emplean marcas de tiempo en cada uno de los flujos multiplexados de forma que siempre sea posible asociar un instante de vídeo con el correspondiente de audio o texto del subtítulo.
*RTP es un protocolo que también se utiliza en Voz IP y videoconferencia.
!!!Protocolo RTCP
*//Real Time Control Protocol//
*Puesto RTP es un protocolo unidireccional del servidor hacia el cliente, el protocolo RTCP permite informar desde el cliente al servidor de la calidad del servicio prestado en función, por ejemplo, del número de paquetes perdidos, etc.
*Se encapsula en UDP y emplea normalmente un puerto consecutivo al empleado por RTP.</pre>
</div>
<div title="Recuperación UF1" creator="YourName" modifier="Pablo" created="201311201613" modified="201311211741" changecount="2">
<pre>__Pregunta 1__
Monta una red con las siguientes máquinas:
#Un windows7 que tenga dos tarjetas de red. Una estará conectada a la red externa y la otra a la red interna. Tendrá por IP: 192.168.0.1/24
#Un servidor Windows al que el servidor DHCP siempre le otorgará la misma IP en el que se encuentra rodando un servidor DNS. Este servidor responde de forma autoritiva a las preguntas realizadas sobre el dominio &quot;asix.net&quot; pero reenvía el resto de preguntas a 8.8.8.8. Entre los registros de este servidor DNS se puede hallar información sobre el servidor de correo del dominio &quot;asix.net&quot;.
#Un servidor Debian con IP fija sobre el que corre un servidor DHCP. Este servidor está configurado de tal manera que:
##A cualquier máquina que se conecte a la red interna le asigna una configuración de red que le permite navegar sin problemas por internet y resolver cualquier nombre del dominio &quot;asix.net&quot;
##Asigna una IP fija al servidor DNS.
__Pregunta 2__
Configura en el servidor DNS de la pregunta anterior la resolución inversa del dominio &quot;asix.net&quot;
!Evaluación
__Pregunta 1: Peso: 80%__
*Configuración de red de cada máquina: 30%
*Configuración del DNS: 20%
*Configuración del DHCP: 20%
*Documentación y demostración clara de que se consigue lo que se pide: 30%

__Pregunta 2: Peso 20%__
*Configuración : 50%
*Documentación y demostración: 50%
</pre>
</div>
<div title="Recuperación UF2" creator="YourName" modifier="YourName" created="201402031726" modified="201402170111" changecount="5">
<pre>!Parte FTP
Configura vsftpd para que:
#Usuario anónimo pueda acceder a algún directorio con permiso para colgar archivos. No debe poder eliminar ni renombrar, solo descargar y/o subir archivos en el directorio. Indica todos los pasos realizados.
#Los usuarios locales podrán acceder a su directorio de sistema. Todos los usuarios locales no podrán salir de su &quot;home&quot; excepto el usuario &quot;admin&quot;.
#Accede al servidor FTP como usuario anónimo y sube un archivo al directorio correspondiente. Después accede como usuario del sistema &quot;admin&quot; y bájate el archivo colgado por el usuario anónimo. Una vez hecho todo, inserta en el examen las líneas correspondientes a estos dos últimos accesos del registro.

!Parte Apache
Configura apache para que:
#En la IP 192.168.1.6, en el puerto 8080 y al nombre de webEmpresa.org:
##Sirva la página web.html.
##Sólo permita el acceso a los usuarios de la red 192.168.1.0/28 y también desde la máquina 192.168.1.30
#En la IP 192.168.1.6, en el puerto 80 y al nombre de Administracion.org:
##Sirva index.html con el mensaje &quot;Administrando la empresa&quot;
##No muestre el contenido de ningún directorio.
##No permita &quot;seguir&quot; los enlaces simbólicos que se encuentren en dicho directorio.

</pre>
</div>
<div title="Registro de recursos" creator="YourName" modifier="YourName" created="201310231528" changecount="1">
<pre>!Formato general
Los RR tienen dos representaciones: la textual y en binario. La representación en binario, definida en RFC 1035, es la utilizada en los mensajes del protocolo. Nosotros, lógicamente, veremos la representación textual.
Formato:
~NombreDeDominio  [TTL] Clase Tipo ~Tipo-Dato
*~NombreDeDominio: nombre del recurso.
*TTL //Time To Live//: Número de segundos que puede estar el registro en caché. Opcional (Existirá un valor global, para todos los RR). Si es 0 quiere decir que no tiene que ser almacendo en caché.
*Clase: Define la arquitectura. IN para TCP/IP.
*Tipo: Para indicar tipo de registro. Son diferentes en función del campo clase. Para el campo IN existen muchos (A, CNAME, NS, MX,...)
*~Tipo-Dato: Informción asociada al nombre de dominio. Varía en función del tipo de registro. (IP para Tipo A)
!Tipos de registros
[[Fuente|http://www.iana.org/assignments/dns-parameters/dns-parameters.xml]]
*''Registro SOA'' (//Start Of Authority//): Es el primer registro de una zona y define una serie de opciones generales de la misma. 
&lt;&lt;&lt;
{{{
asix.cat. IN SOA   ns1.asix.cat. admin.asix.cat. (
                           1                                          ;Número de serie
                            43200                                  ;Tiempo de refresco
                            36800                                 ;Tiempo de reintento
                            2419200                              ;Tiempo de expiración
                            604800   )                            ;TTL Negativo
}}}
&lt;&lt;&lt;
**MNAME: Nombre FQDN del servidor de nombres maestro del dominio. En el ejemplo: ns1.asix.cat.
**Contacto (//Contact//): Correo de la persona responsable del dominio. La arroba se reemplaza por un punto. En el ejemplo: admin.asix.cat
**Número de serie (//Serial//): Indica la versión del archivo de zona. Debe ser incrementado cada vez que el archivo se modifique. Es usado por los servidores secundarios para saber si deben realizar una transferencia de zona o no. Una práctica común es utilizar la fecha y dos dígitos más para modificaciones del mismo día.
**Actualización (//refresh//): Tiempo que esperan los servidores esclavos para preguntar al servidor maestro si hay cambios en la zona. La RFC 1912 recomienda  entre 1200 (20 min) y 43200 (12 horas). Dependerá de la frecuencia de los cambios en los archivos de la zona. Si se usan notificaciones //NOTIFY// se puede usar un valor más alto (1 día o más).
**Reintentos (//retry//): Si la transferencia de zona ha fallado, indica el tiempo que espera el servidor secundario hasta volver a intentarlo. Valores inferiores a los de refresco, normalmente.
**Caducidad (//expire//): Determina el tiempo que el servidor esclavo puede estar intentando contactar con el maestro para ver si hay cambios en la zona. Si el tiempo expira el servidor esclavo considera que algo ha pasado y se declara como no autorizado para la zona, y por lo tanto, no responde a preguntas sobre esa zona. La RFC 1912 recomienda valores entre 2 y 4 semanas.
**TTL negativo (//Time To Live//): Tiempo mínimo que almacenan las respuestas negativas sobre esa zona. Diferente a los TTL de los RR.
*''Registro NS''(//Name Server//): Permite establecer quién o quiénes son los servidores de una zona. También se utiliza en el caso de querer delegar la autoridad  de un subdominio a otro servidor.
&lt;&lt;&lt;
{{{
asix.cat.         IN    NS      ns1.asix.cat                 ;Servidor maestro
asix.cat.         IN    NS      ns2.asix.cat                 ;Servidor DNS esclavo.

ns1.asix.cat.  IN   A   193.100.200.100
ns2.asix.cat.   IN   A   193.100.200.100

;Delegación
xarxes.asix.cat     IN        NS         ns1.xarxes.asix.cat.
sistemes.asix.cat        IN       NS       dns.asix.org.

ns1.xarxes.asix.cat    IN  A   193.100.40.100      ;  GLUE Record
}}}
&lt;&lt;&lt;
**Cada zona debe de contener, como mínimo, un registro NS. 
**Cada zona debe contener, al menos, un registro NS por cada subdominio que haya delegado.
*''Registro A'' (//Address//): Establece una correspondencia entre un nombre de dominio completamente cualificado (FQDN) y una dirección IP versión 4.
*''Registro AAAA'': Establece una correspondencia entre un nombre de dominio completamente cualificado (FQDN) y una dirección IP versión 6.
&lt;&lt;&lt;
{{{
asterix.asix.cat.    IN    AAAA   2001:DB8::64
}}}
&lt;&lt;&lt;
*''Registro CNAME'' (//Canonical Name//): permite crear alias para nombres de dominio especificados en registros A y AAAA. 
&lt;&lt;&lt;
{{{
www.obelix.asix.cat       IN     A        193.100.200.111
www.asix.cat.        IN     CNAME     www.obelix.asix.cat 

;CNAME puede apuntar a un nombre de otro dominio
www.asix.cat.    IN    CNAME     www.obelix.cat.

;CNAME no se debe usar en la parte derecha de los registros MX o NS
asix.cat.                    IN                  dns.asix.cat.                    ;INCORRECTO dns es un CNAME

ns1.asix.cat.         IN     A           193.100.200.112
dns.asix.cat.        IN      CNAME        ns1.asix.cat.
}}}
&lt;&lt;&lt;
*''Registro MX'' (//Mail Exchange//): permite definir equipos encargados de la entrega de correo en el dominio. Son consultados por los agentes de transporte de correo SMTP, los MTA. Como se pueden indicar varios servidores de correo , en cada registro MX se puede especificar la preferencia de unos sobre otros. Un número más pequeño indica mayor preferencia.
&lt;&lt;&lt;
{{{
asix.cat.          IN          MX        10       mail1.asix.cat.         ; servidor de mayor preferencia.
asix.cat.          IN          MX         20       mail2.asix.cat.

mail1.asix.cat.     IN         A                   193.100.200.221
mail2.asix.cat.      IN         A                     193.100.200.222
}}}
&lt;&lt;&lt;
*''Registro  SRV'' (//Service Record//): permite definir equipos que soportan un servicio en particular. [[RFC 2782|http://tools.ietf.org/html/rfc2782]]
&lt;&lt;&lt;
{{{
_http._tcp.asix.cat.   IN  SVR    0  5  80  www.asix.cat.
_ldap._tcp.asix.cat.    IN       SVR          0  0  389    ldap.asix.cat.
}}}
&lt;&lt;&lt;
*''Registro PTR'' (//Pointer Record//) establece una correspondencia entre nombres de direcciones ~IPv4 e ~IPv6 y nombres de dominios. Se utiliza en las zonas de resolución inversa.
&lt;&lt;&lt;
{{{
100.200.100.193.in-addr.arpa.  IN  PTR  ns1.asix.cat.
200.200.100.193.in-addr.arpa   IN  PTR ns2.asix.cat.
}}}
&lt;&lt;&lt;
</pre>
</div>
<div title="Renovación Windows" creator="YourName" modifier="YourName" created="201310022205" changecount="1">
<pre>[[Página Microsoft|http://support.microsoft.com/kb/948472]]</pre>
</div>
<div title="Resolución recursiva" creator="YourName" modifier="YourName" created="201310231526" changecount="1">
<pre>*La resolución de direcciones funciona igual que la resolución de nombres de dominio. Las direcciones IP se tratan como nombres donde cada //byte// es un dominio que cuelga de los dominios &quot;in-addr.arpa&quot; para ~IPv4 e &quot;ip6.arpa&quot; para ~IPv6.  Es decir cuando cuando preguntamos por el nombre de dominio que corresponde a 192.168.200.100, realmente estamos preguntando por el nombre de dominio &quot;100.200.168.192.in-addr.arpa&quot;
*Los servidores tienen que almacenar zonas de resolución inversa con registros de recursos que asocien nombres de dominio con direcciones IP. Pueden existir zonas de resolución inversa maestra o primaria, y zonas de resolución inversa esclavas o secundarias. 
*La coherencia entre ambas zona directa e inversa es responsabilidad del administrador. No es obligatorio que un organismo o empresa que administra una zona directa tenga que administrar las zonas inversas asociadas. (De hecho,si contratamos un dominio normalmente no incluirán en la zona de resolución inversa. Hay que solicitarlo)
[img[Resolución inversa|http://es.tldp.org/LinuxFocus/pub/mirror/LinuxFocus/Castellano/May1998/img45/arpa-e.gif]]
*El proceso de resolución  inversa es similar al de resolución directa. Existen consultas recursivas, iterativas, caché, TTL, etc.</pre>
</div>
<div title="Seguridad_Correo" creator="YourName" modifier="YourName" created="201402262339" modified="201402262343" changecount="2">
<pre>Los principales problemas de seguridad:
*Tanto clientes como servidores son sistemas complejos con múltiples funcionalidades. Fácilmente pueden tener vulnerabilidades aprovechables por sus atacantes.
*El protocolo SMTP:
**En sus especificaciones originales no contempla mecanismos de autenticación.
**El intercambio de información se realiza en texto plano.
**No hay mecanismos para garantizar que los clientes y los servidores son quien dicen ser.
*Los mensajes de correo:
**Pueden contener información falsa, publicidad, código malicioso...
**Por defecto no se cifran ni se firman (suplantación, modificación...)
*Recepción de correo:
**Protocolos IMAP y POP incluyen mecanismos de autenticación.
**El intercambio de información se realiza en texto plano y no proporcionan mecanismos para garantizar que los clientes y los servidores son quienes dicen ser.
!!!Algunas soluciones utilizando extensiones
__''SASL''__
*//Simple Authentication and Security Layer//
*Es un //framework// de autenticación para protocolos orientados a conexión (SMTP, POP, IMAP, LDAP...)
*Permite distintos tipos de autenticación (ANONYMOUS, ~CRAM-MD5, GSSAPI, PLAIN, NTLM....)
*Algunos de estos mecanismos (PLAIN) no cifran, por eso se suele integrar con SSL/TLS.
__''SPA''__
*Mecanismo de autenticación implementado por servidores y clientes de //Microsoft// para protocolos SMTP, IMAP y POP.
__''Autenticación SMTP''__
Extensiones del protocolo, permiten:
*Autenticar a los usuarios antes de utilizar un MTA.
*Autenticar a los ~MTAs que envían correo a otros ~MTAs (//smart host//)
El estándar más utilizado es SMTP AUTH:
*Es una extensión de SASL para SMTP. Forma parte del conjunto de extensiones que forman ESMTP.
*Se implementan a través del comando AUTH.
*Se suele integrar con SSL/TLS para aumentar seguridad.
!!!Protocolos seguros
__''SMTPS''__
*Conjunto de especificaciones que determinan cómo encapsular SMTP en SSL/TLS.
*Los servidores SMTPS utilizan 465/TCP o 587/TCP.
*Se garantiza confidencialidad e integridad de los mensajes transmitidos. También se garantiza la autenticidad de los servidores.
__''POPS e IMAPS''__
*Conjunto de especificaciones que determinan cómo encapsular ~POP3 e ~IMAP4 en SSL/TLS.
*POPS en 995/TCP
*IMAPS en 993/TCP
*Se garantiza la confidencialidad e integridad de los mensajes descargados de los servidores y la autenticidad de estos últimos.
__''STARTTLS''__
*Es un mecanismo para negociar en conexiones SSL/TLS sobre protocolos de texto plano.
*Existen extensiones STARTTLS para SMTP, POP e IMAP.
*La extensión para SMTP, por ejemplo, permite negociar una conexión SSL/TLS usando el puerto estándar (25) con el comando ESMTP STARTTLS.
*Es habitual configurar ~MTAs con SMTP AUTH (SASL) y STARTTLS escuchando en el puerto 25 peticiones SMTPS.
!!!Firmado y cifrado de mensajes
Todos estos protocolos garantizan comunicación &quot;segura&quot; entre cliente y servidor o entre servidores pero, ¿qué pasa si el mensaje es interceptado? O, ¿Y si llega a algún servidor que no tiene definidas comunicaciones seguras? O si accede el administrador (o &quot;alguien&quot;) a los buzones. Además, ¿cómo comprobar que el usuario que nos envía el mensaje es quien dice ser?
Para prevenir estas situaciones se pueden firmar y cifrar los correos haciendo uso de algoritmos criptográficos. Los dos principales mecanismos para cifrar y firmar mensaje son:
*''S/MIME y certificados X.509'': Conjunto de algoritmos, protocolos y infraestructura de clave pública (certificados digitales, autoridades de certificación...) para firmar y cifrar los mensajes.
*''PGP //Pretty Good Privacy//'': Software criptográfico para firmar, cifrar y comprimir datos e intercambiarlos de forma segura. Se basa en &quot;anillos de confianza&quot; entre usuarios, no hay autoridades certificadoras.
</pre>
</div>
<div title="Servicio FTP: Seguridad, FTPS, FXP, TFTP, SFTP/SCP" creator="YourName" modifier="YourName" created="201401081554" modified="201401081642" changecount="4">
<pre>!!!Seguridad
*FTP no es un protocolo seguro. Fue diseñado para ofrecer velocidad no seguridad. Se utilizan mecanismos de autenticación pero:
**No se usan mecanismos para garantizar que los equipos involucrados en la tranferencia son quienes dicen ser. Es vulnerable a ataques de suplantación de identidad (//spoofing//).
**Todo el intercambio de información, incluyendo el usuario y //password// y la transferencia de cualquier archivo, se realiza en &quot;texto plano&quot; sin ningún tipo de cifrado. Es vulnerable a ataques de análisis de tráfico de red (//sniffing//).
!!!FTPS (o FTP/SSL)
;Def
:Conjunto de especificaciones que determinan cómo encapsular FTP en SSL (//Secure Sockets Layer//) o en TLS (//Transport Layer Security//) para ofrecer comunicaciones seguras.
Existen dos métodos para implementar FTPS:
*FTPS Implícito: 
**El cliente establece la conexión de control y establece la conexión SSL/TLS.
**Si el servidor no soporta FTPS se cierra la conexión.
**Todas las conexiones, tanto la de control como la de datos, son cifradas.
**Para mantener la compatibilidad con los clientes FTP que no soporten SSL/TLS se utilizan otros puertos para atender las peticiones FTP. Se usan los puertos 990/TCP para control y el 989/TCP para datos.
*FTPS Explicito (FTPES)
**El cliente establece una conexión de control al puerto 21, solicita explícitamente que la comunicación sea segura enviando el comando AUTH SSL O AUTH TTL y si el servidor lo soporta se establece una conexión SSL/TLS.
**Si el servidor no soporta FTPS le ofrece al cliente la posibilidad de usar FTP normal.
**El cliente y el servidor pueden negociar qué parte de las comunicaciones y/o conexiones serán cifradas.
**Suele ser el método recomendado.
!!!Protocolo FXP (//File eXchange Protocol//)
;Def
:Protocolo de tranferencia de datos directa  entre servidores FTP, utilizando un cliente para conectarlos inicialmente. Se utiliza para, por ejemplo, migrar ficheros de un servidor a otro.
!!!Servicio TFTP (//Trivial File Transfer Protocol//)
;Def
:Protocolo de la capa de aplicación diseñado para ofrecer un servicio de transferencia de ficheros simple y rápido basado en el modelo cliente/servidor. Sus principales características son:
:*TFTP utiliza UDP como protocolo de nivel de transporte. Los servidores TFTP usan el puerto 69/UDP.
:*No existen mecanismos de autenticación o cifrado.
Se utiliza principalmente en estaciones o dispositivos de red para cargar y hacer copias de seguridad del SO, archivos de configuración, aplicaciones, etc. (CISCO usa TFTP para realizar copias de seguridad y cargar nuevas versiones del SO en sus dispositivos).
!!!Servicios SFTP/SCP
SSH (//Secure Shell Protocol//) es un protocolo de capa de aplicación diseñado para ofrecer un servicio de acceso a terminales de equipos remotos. En la conexión SSH se autentican los dos extremos de la conexión y se cifran los datos intercambiados. Además, SSH integra mecanismos de tranferencia de ficheros garantizando igualmente autenticación, confidencialidad e integridad. Estos mecanismos son:
*SFTP:
**Transferencia de ficheros entre sistemas remotos.
**Permite listar ficheros y directorios del servidor
**Permite realizar funciones adicionales en el servidor como renombrar, borrar, crear archivos y carpetas, cambiar permisos, descomprimir...
*SCP
**Permite la copia de ficheros entre sistemas remotos.
[[Actividad FTP III]]</pre>
</div>
<div title="Servicio FTP: definición y componentes" creator="YourName" modifier="YourName" created="201401081343" modified="201401081351" changecount="4">
<pre>;Def
:FTP es un protocolo de la capa de aplicación diseñado para ofrecer un servicio estándar de transferencia de ficheros entre sistemas conectados a redes TCP/IP.
*//File Transfer Protocol//
*Uno de los servicios más antiguos de Internet (en 2011 cumplió 40 años)
*Permite a los usuarios:
**Acceder a directorios remotos y listar ficheros.
**Subir o bajar ficheros.
**Acciones relacionadas: renombrar, borrar, crear ficheros, carpetas, cambiar permisos, descomprimir...
__Componentes__
*Se basa en el modelo cliente/servidor.
*Cliente FTP: acceden al sistema donde están instalados y establecen conexiones con los servidores FTP para subir/bajar ficheros. Existen multitud y de diferentes tipos:
**En línea de comandos: la mayoria de SO integran un cliente que se puede invocar desde la línea de comandos con la orden //ftp//. Una vez establecida la conexión el cliente pone a disposición del usuario una serie de comandos (//ls//,//get//, //put//, //cd//, etc)
&lt;&lt;&lt;
Introduce en un terminal {{{ftp ftp.rediris.es}}} Utiliza el usuario //anonymous// y deja la contraseña vacía. Una vez conectado lista el contenido con //ls//.
Mira el lista de argumentos posibles del comando //ftp//. Obtén información con //help get//.
&lt;&lt;&lt;
**Clientes gráficos: //Filezilla client//, //~WinSCP//, //Gftp//, etc. Ofrecen interfaz gráfica y funciones adicionales.
**Navegadores (//Firefox//, //Explorer//, //Chrome//) / Exploradores (//Explorer//, //Nautilus//): pueden actuar como clientes ftp. Ofrecen un cliente sencillo y limitado pero muy útil en un momento dado. Permiten complementarlo para aumentar funcionalidad.
&lt;&lt;&lt;
Formato general: {{{ftp://[usuario][:password]@servidor.}}}
Ejemplo: {{{ftp://ftp.rediris.es}}} O también:{{{ftp://alumno@192.168.100.100}}}
&lt;&lt;&lt;
*Servidores FTP: acceden al sistema de ficheros donde están instalados, manejan las conexiones de los clientes y, en función de los privilegios definidos, permiten la descarga y/o subida de ficheros. Los más conocidos son: //vsftp//, //proftp//, //pure-ftpd// en linux y en Windows, tenemos: Servidor FTP incluido en IIS, //Filezilla Server//, //~Serv-U//.
*Protocolo FTP: conjunto de normas en base a las cuales comunican clientes y servidores. Usa TCP como protocolo de transporte. Los mensaje FTP son mensajes de texto que contienen comandos y respuestas.
**Los comandos FTP son cadenas de caracteres que finalizan con el código de final de línea (&lt;CR&gt;+&lt;LF&gt;, retorno de carro seguido del carácter salto de línea).
**Los respuestas FTP son enviadas por el servidor como consecuencia de la acción ejecutada al recibir un comando. Están compuestas por tres dígitos, que indica cómo se ha procesado el comando enviado, y  un mensaje de texto descriptivo. Los digitos determinan el tipo de respuesta. 

[[Actividades FTP I]]

</pre>
</div>
<div title="Servicio FTP: tipos de acceso, conexiones y modos" creator="YourName" modifier="YourName" created="201401081353" modified="201401081637" changecount="4">
<pre>!!!Tipos de acceso
Los servidores permiten dos tipos de acceso:
*Acceso anónimo: el cliente se conecta con un usuario especial anónimo. No hay autenticación. Normalmente se emplea //anonymous// y/o //ftp//. Normalmente tiene sólo permisos para descargar archivos y su acceso se limita a un directorio del servidor.
*Acceso autorizado: los usuarios tienen configurados en el servidor los privilegios. Acceden a directorios enjaulados o no (que no pueden &quot;subir&quot; a directorios superiores). La autenticación puede ser:
**Usuarios locales del servidor (del SO)
**Usuarios &quot;virtuales&quot; creados para el servicio. Se autentifican contra una bbdd (mysql, por ejemplo), LDAP o un fichero plano.
!!!Conexiones y modos
FTP se basa en TCP exclusivamente pero utiliza varias conexiones y puertos.
__Conexión de control__
*Inicio: cliente establece una conexión con el servidor. 
*Esta conexión es la de control. Es la que utiliza el cliente para enviar peticiones al servidor (get, put, etc.) y la que utiliza el servidor para enviar las respuestas.
*Permanece activa hasta que el cliente cierra sesión o hasta que el servidor decida finalizar la conexión porque caduca el tiempo de espera a causa de la inactividad (//timeout//)
__Conexión de datos__
*Cuando cliente solicita una transferencia de información se crea una nueva conexión (la de datos) que se cierra al finalizar la transmisión.
*Asociada a una conexión de control pueden existir múltiples conexiones de datos, tantas como transferencias simultáneas y hasta un máximo que se configure en el servidor.
''Puertos'': Inicialmente los servidores FTP usaban 21/TCP para atender las conexiones de control y el 20/TCP para atender las conexiones de datos. Actualmente, no usan siempre el 20 para las conexiones de datos.
!!!Modos
Un cliente puede iniciar la conexión a un servidor de dos formas distintas que se conocen como ''Modo activo'' y ''Modo pasivo''.
__Modo activo__

[img[Modo activo|http://upload.wikimedia.org/wikipedia/commons/thumb/9/90/Activo.svg/420px-Activo.svg.png]]

#Cliente establece conexión TCP de control con el puerto 21 del servidor.
#Cuando el cliente desea una transferencia de ficheros, envía el comando PORT al servidor en que se especifica su dirección IP y un número de puerto que abrirá para usar en la conexión de datos.
#Servidor inicia la conexión desde el 20 a donde le ha indicado el cliente (en la imagen el 1036)
#Se utiliza la conexión para la transferencia de datos.
__NOTA__
***El cliente tiene que abrir puertos {{{--&gt;}}} problemas de seguridad.
***Los cortafuegos suelen impedir este tipo de conexiones.
***Si el cliente está detrás de un encaminador/NATP éste descartará las conexiones iniciadas desde el exterior por el servidor FTP. 

__Modo Pasivo__

[img[Modo pasivo|http://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Pasivo.svg/420px-Pasivo.svg.png]]

#El cliente inicia y establece una conexión de control con el puerto 21 del servidor.
#Cuando solicita una transferencia de ficheros:
##El cliente envía el comando PASV para activar el modo pasivo. Como respuesta, el servidor retorna un número de puerto que tenga disponible.
##Se utiliza la conexión de datos para realizar la transferncia.

__NOTA__
***Resuelve el problema de apertura de puertos aleatorios en el cliente pero lo traslada al servidor.
***Cortafuegos actuales permiten realizar un seguimiento: comprueban que el cliente que solicita la conexión al puerto especificado por el servidor se corresponde con el cliente al que se le indicó ese puerto.
***Si el servidor está detrás de un NATP, hay que configurar un rango de puertos para las conexiones de datos y redirigirlos al servidor.

[[Instalación vsftp]]
[[Actividad FTP II]]</pre>
</div>
<div title="Servicio Web: Alojamiento virtual de sitios web" creator="YourName" modifier="YourName" created="201311270044" modified="201311271747" changecount="3">
<pre>El alojamiento virtual de sitios web (//web virtual hosting//) consiste en simular que existen varias máquinas con sus respectivos sitios web sobre un solo servidor web. También se usan los términos hosts virtuales, servidores virtuales o sitios virtuales. 
Se pueden diferenciar tres tipos de alojamiento virtual:
__Basado en ~IPs__
*El servidor tendrá diferentes direcciones IP por cada servidor web virtual. Cada servidor atenderá peticiones en una dirección IP diferente.
*Para realizar esta configuración el servidor debe tener varias tarjetas de red o asignar varias direcciones IP a una misma tarjeta.
*Supone un derroche de direcciones IP en comparación con el alojamiento virtual basado en nombres.
__Basado en nombres__
*El servidor dispone de varios nombres de dominio. Cada servidor virtual atiende las peticiones de un nombre de dominio.
*Hay que configurar un servidor DNS que asocie los nombres de dominio con la misma dirección IP.
*Este tipo de alojamiento se definió a partir de HTTP /1.1. El servidor es capaz de diferenciar el nombre de dominio por el que pregunta el cliente porque en el mensaje de petición HTTP se envía la cabecera //Host// con el nombre de dominio.
*Es la forma más habitual. Es simple y optimiza los recursos. En una misma IP se pueden alojar cientos de dominios.
__Basado en puertos__
*Cada servidor virtual atiende peticiones en una dirección IP y/o dominio:puerto diferentes. 
*Normalmente se combina el alojamiento basado en IP y/o en nombres con el uso de varios puertos a la escucha.
[[Actividades Apache III]]
</pre>
</div>
<div title="Servicio Web: Caché, Autenticación, Cookies, Conexiones persistentes, etc" creator="YourName" modifier="YourName" created="201312111554" modified="201401081339" changecount="8">
<pre>!!!Almacenamiento en cache
Tanto proxies como navegadores soportan almacenamiento caché (//caching//). Se definen las cabeceras (//Cache-control//, //~Last-Modified//, //Expire//, //Age//, //Etag//, //~If-Match//, //~If-Modified-Since//) que permiten controlar qué se almacena en caché, cuánto tiempo y qué no se almacena. También sirven para indicar si la información se puede //cachear// en un proxy o no, si hay que actualizar algo en cache porque se ha modificado, etc.
!!!Redirecciones
HTTP permite a servidores y a proxies redirigir las peticiones a otras localizaciones. El servidor indica la redirección mediante un código 3XX.
&lt;&lt;&lt;
Ejemplo
*302 &quot;Not Found&quot;: El recurso solicitado ha sido movido temporalmente a otra localización. El navegador debería buscarlo en la localización indicada en la cabecera //Location// de la respuesta.
*304 &quot;Not Modified&quot;: El recurso solicitado no se ha modificado y el navegador debería leerlo de su caché local.
&lt;&lt;&lt;
!!!Comprensión
Es posible que los servidores compriman (usando //gpiz//, por ejemplo) los recursos antes de enviárselos  a los clientes para reducir el tráfico de la red. Los clientes usan cabeceras en los mensajes de petición (//~Accept-Encoding//) para indicar que soportan compresión y los servidores para hacerle saber al cliente (//~Content-Encoding//) que envían datos comprimidos.
!!!Cookies
Una //cookie// es un fragmento de información que envía el servidor web en una respuesta HTTP y es almacenada, si su configuración lo permite, por el navegador para su uso futuro. El navegador puede enviar la cookie en solicitudes posteriores al mismo servidor.
*Los servidores envían las cookies usando cabeceras (//Cookies// y //~Set-Cookie//) y pueden incluir los siguientes detalles:
**Nombre de la cookie (//name//)
**Valor de la cookie (//Value//)
**Fecha de expiración (//Expires//): fecha y hora en la que la cookie deberá ser descartada por el navegador.
**Ruta (//Path//): lugar donde la cookie será guardada por el navegador.
**Dominio (//Domain//): nombre de dominio de donde &quot;viene&quot; la cookie.
*Cuando un navegador realiza una solicitud a un servidor HTTP consulta las cookies que tiene almacenadas. Si existen cookies no caducadas cuya ruta y dominio coincidan con los de la petición, se las envía al servidor usando las cabeceras (//Cookies// y //~Set-Cookie//)
Las cookies son utilizadas por los servidores web para diferenciar usuarios y conexiones y actuar en consecuencia.
!!!Autenticación
HTTP soporta el uso de mecanismos de autenticación para controlar el acceso a los recursos que ofrece el servidor. Estos mecanimos están basados en el uso del código de estado 401 y en las cabeceras //~WWW-Authenticate// y //Authoritation//. Los mecanismos básicos son:
*Basic: el cliente envía un usuario y una clave codificados con el algoritmo //base64//. Método no seguro, es muy fácil capturar y obtener la clave enviada.
*Digest: el cliente envía un usuario y una función //hash// de la clave al servidor (algoritmo ~MD5). Es más seguro que el anterior sistema pero también presenta vulnerabilidades.
La autentificación que ofrece HTTP no es segura y por ello se suele trasladar a las aplicaciones web.
!!!Conexiones persistentes
El uso de conexiones persistentes en HTTP consiste en que varias peticiones y respuestas sean transferidas usando la misma conexión TCP. Su uso reduce el número de conexiones TCP, lo que repercute en un menor gasto de CPU/memoria y una reducción de los tiempos de respuesta.
*En HTTP/1.0 el comportamiento por defecto es crear una conexión TCP por cada interacción de petición-respuesta. Existe la posibilidad de utilizar conexiones persistentes mediante la cabecera //Connection: ~Keep-Alive//.
*En HTTP/1.1 se introducen la conexiones persistentes por defecto. Se definen varias cabeceras (//Connection, ~Content-Length...//) y temporizadores en servidores y clientes para controlar cuándo hay que cerrar las conexiones TCP.

[[Configuración Autenticación Apache]]
[[Actividades Apache IV]]
</pre>
</div>
<div title="Servicio Web: definición y componentes" creator="YourName" modifier="YourName" created="201311270038" changecount="1">
<pre>__Servicio Web__
;Def HTTP
:HTTP (//Hiper Text Transfer Protocol//) es un protocolo de la capa de aplicación que facilita a los usuarios, de una forma sencilla e intuitiva, el acceso a la información hipermedia remota de sistemas conectados a una red TCP/IP. El modelo cliente/servidor y el protocolo HTTP son la base de WWW.
;Def WWW
:WWW (//World Wide Web//) es un servicio de distribución de información que permite acceder a millones de recursos distribuidos en servidores y localizados por direcciones (~URIs o ~URLs). 
:La WWW fue desarrollada por el CERN en 1989 y actualmente su desarrollo está controlado por el ~W3C (//World Wide Web Consortium//), comunidad internacional que desarrolla estándares web (XHTML, CSS, XML)
!!!Componentes y funcionamiento:
*__Recursos__:
**Documentos, vídeos, imágenes, audio, aplicaciones, buzones de correo, etc., accesibles a través de servidores web y conectados por hiperenlaces.
*__Nombres y direcciones__: 
**Sistema de nombres basado en cadenas de caracteres que identifican y localizan inequívocamente a los recursos en la Web. 
**Estas cadenas se denominan identificadores uniformes de recursos (//URI Uniform Resource Identifier//) y permiten acceder a los recursos disponibles usando una gran variedad de sistemas de denominación y métodos de acceso, llamados esquemas, como HTTP, FTP, etc. Los localizadores universales de recursos (//URL Universal Resource Locator//) son tipos de ~URIs.
&lt;&lt;&lt;
Ejemplos:
{{{http://192.168.1.12/M8.html}}} {{{--&gt;}}} http es el esquema. A continuación, IP y ruto al recurso.
{{{http://aula.asix.cat:8080/datos/data.txt}}} {{{--&gt;}}} Se indica esquema, el nombre DNS para obtener la IP, el puerto en el que está escuchando el servidor y la ruta al recurso.
{{{http://aula.asix.cat/buscar.php?id=2&amp;tema=Historia}}}{{{--&gt;}}} Esquema+Nombre DNS+(/buscar.php) ruta del recurso+(?id=2&amp;tema=Historia) parámetros enviados al servidor.
&lt;&lt;&lt;
*__Servidores Web__:
**Programas que atienden las peticiones de los clientes y procesan e interpretan código escrito en diferentes lenguajes y envían a los clientes los recursos solicitados. 
**El servidor puede enviar contenido estático o dinámico. 
**Por defecto escucha en 80/TCP.
**Los más utilizados son: Apache HTTP server, IIS (//Internet Information Server//) de Microsoft, Nginx, Servidor Web de Google, Lighttpd.
*__Clientes Web__:
**Programas con los que interactúa el usuario y que le permiten acceder a los recursos de la red. Son capaces por tanto, de solicitar recursos, recibirlos, procesarlos y mostrárselos al usuario si es necesario.
**Los más conocidos son: //Internet Explorer//, //Mozilla Firefox//, //Google Chrome//, //Chromiun//, //Safari//, //Opera//
**También están los clientes en modo texto: //Lynx//, //Links//
*__Proxies Web__
**El término //proxy// hace referencia a un programa que actúa como intermediario entre otros. Un //proxy Web// o //proxy HTTP// hace de intermediaro entre un cliente web y un servidor web. Se pueden clasificar:
***//Proxy// directo (//forward proxy//): Recibe la petición iniciada por un cliente web y se la traslada al servidor web. La solicitud del cliente es hacia el servidor web y no hacia el //proxy//, éste solo hace de intermediario. Usados habitualmente para optimizar y controlar el acceso a redes externas, como Internet, de los clientes de una organización o empresa. El proxy escucha en el puerto 3128.
***//Proxy// inverso (//reverse proxy//): Reciben la petición del cliente web y la reenvían a uno o varios servidores web. En este caso, la solicitud del cliente es hacia el //proxy//. Usados habitualmente para ofrecer acceso a servidores web que están detrás de un cortafuegos y no son accesibles directamente, para balancear la carga entre diferentes servidores web, para aumentar los acceso ofreciendo almacenamiento caché, etc.
[img[proxy|http://1.bp.blogspot.com/_KcaDSFcliq8/S9cMGQ3OjyI/AAAAAAAAAz4/1f9frdjF7m8/s1600/fwdrevproxy.png]]

!!!Actividades guiadas
[[Instalación Apache]]
[[Actividades Apache I]]</pre>
</div>
<div title="Servicio Web: protocolo HTTP" creator="YourName" modifier="YourName" created="201311270038" modified="201311270042" changecount="3">
<pre>;Def
:Protocolo de comunicación en la Web. Define las reglas que utilizan los componentes software (clientes, servidores y //proxies//) para comunicarse. Ha pasado por varias versiones HTTP /0.9 (obsoleta), HTTP /1.0 y HTTP /1.1 (versión actual), HTTP /1.2 (experimental)
;Funcionamiento
#El usuario introduce una URI (o URL) en la barra de direcciones del navegador.
#El cliente web analiza la URL y establece una conexión TCP con el servidor web. (Si se ha utilizado un nombre DNS previamente invoca al resolver para que resuelva el nombre)(si no se indica el número de puerto se conectará al puerto 80 del servidor).
#Cuando se ha establecido la conexión TCP, el navegador envía un mensaje HTTP de petición que depende de la URL.
#El servidor envía un mensaje de respuesta que depende de la petición enviada y del estado del servidor.
#Se cierra la conexión TCP.
!!!Mensajes HTTP
Se componen de líneas de texto plano (ASCII) que contienen las órdenes y parámetros con la sintaxis definida por el protocolo. Pueden ser de dos tipos:
__Mensajes de petición__
Tienen tres partes:
*Línea inicial de petición. Incluye: 
**Método utilizado (GET, POST, ...).
**La parte relativa al servidor de la URL o la URL completa si la conexión se establece con un servidor proxy.
**Versión del protocolo utilizada (opcional).
*Líneas de cabecera
**Conjunto de pares nombre/valor denominados cabeceras que determinan cómo será procesada la petición por parte del servidor.
&lt;&lt;&lt;
Ejemplo: La cabecera //Accept: text/html// indica que el navegador es capaz de procesar código HTML.
&lt;&lt;&lt;
**Si no hay cabeceras se envía un 0.
**Cada cabecera se muestra en una línea, es decir, las cabeceras se terminan con ~CR-LF.
**Detrás de la última cabecera se envía una línea en blanco.
*Cuerpo del mensaje (opcional): contiene parámetros o ficheros enviados al servidor.
__Mensaje de respuesta__
Tienen también tres partes:
*Línea inicial de respuesta (línea de estado)
**Versión HTTP utilizada.
**Código de estado o código de error que informa al cliente de cómo ha sido procesada la petición. Por ejemplo, el código 200 indica que la petición se ha procesado correctamente.
*Línea/s de cabecera:
**Conjunto de pares nombre/valor denominados cabeceras que describen los datos y la forma en que son enviados al cliente.
&lt;&lt;&lt;
Ejemplo: la cabecera //~Contet-Type:text/html// indica que se envía código HTML que deberá interpretar el navegador.
&lt;&lt;&lt;
**Si no hay cabeceras se envía un 0.
**Cada cabecera se muestra en una línea, es decir, acaban con ~CR-LF.
**Detrás de la última cabecera se envía una línea en blanco.
*Cuerpo del mensaje (opcional). Queda determinado por el tipo de recursos solicitados.
!!!Métodos de petición
Los métodos de petición especifican la operación que quiere realizar el cliente en el servidor. La versión HTTP 1.1 contempla siete métodos de petición:
__Método GET__
*Es el método más utilizado para obtener cualquier tipo de información del servidor.
*Se invoca cuando se introduce una URL en el navegador, se pincha en un hiperenlace o cuando se envía un formulario GET.
*Permite enviar parámetros al servidor en la URI (//Query String//). Para codificar los parámetros como parte de la URI:
**Se añaden a la URI detrás del nombre del recurso, separados de éste por un caráter ?.
**Los diferentes parámetros se separan entre sí por el carácter &amp;.
**Los espacios se sustituyen por +.
**Ejemplo: www.asix.cat/datos.php?nombre=Juan&amp;edad=28
*Los parámetros se incluyen en la línea inicial de la petición.
*Las peticiones GET no envían cuerpo del mensaje.
*No se puede usar para subir archivos o realizar otras operaciones que requieran enviar una gran cantidad de datos al servidor.
__Método POST__
*Se emplea para solicitar al servidor que acepte información que se envía adjunta en una petición.
*Las peticiones POST envían el cuerpo de mensaje y en él se incluyen los parámetros y los datos que se consideren. Los parámetros no son visibles por lo tanto en la URL.
*Se invoca normalmente como consecuencia de enviar un formulario HTML POST.
*No hay límite en la cantidad  de datos que se pueden enviar. Se utiliza, por tanto, para enviar ficheros al servidor.
__Método OPTIONS__
*Para solicitar al servidor información sobre las opciones de comunicación disponibles de un recurso determinado.
__Método HEAD__
*Para recuperar las cabeceras de una página web.
__Método PUT__
*Para enviar recursos al servidor. Por seguridad no es habitual que los servidores permitan este método.
__Método DELETE__
*Para eliminar recursos del servidor. Por seguridad no se suele habilitar.
__Método TRACE__
*Para trazar la ruta de una petición a través de proxies y cortafuegos. Para depurar.
!!!Cabeceras
*Las cabeceras son pares de nombre/valor que se pueden incluir en los mensajes de petición y de repuesta HTTP. Definen información (metadatos) sobre los datos que se intercambian los clientes y servidores, sobre los propios clientes y servidores, y sobre la propia transferencia de información. 
*Tienen el mismo formato que las cabeceras de los protocolos usados en los servicios de correo electrónico y noticias.
*Existe un gran número de cabeceras posibles en HTTP y se pueden clasificar:
**''Generales'': definen información que puede ser utilizada tanto por clientes como por servidores, ya que se aplican a una sesión completa de comunicación. Ejemplos: Control de cache (~Cache-Control), Fechas (Date), Codificación de la transferencia (~Transfer-Encoding)...
**''De petición'': empleadas por los clientes para enviar información al servidor. Proporcionan información sobre: el propio navegador (~User-Agent), nombre y puerto del servidor al que se dirige la petición (Host), tipos MIME, compresión, mapas de caracteres, idiomas que está dispuesto a aceptar el navegador (Accept), Cookies (Cookies), etc.
**''De respuesta'': empleadas por el servidor para enviar información añadida al cliente. Proporcionan información sobre: la edad de la respuesta (Age), si un recurso no está disponible, fecha en la que se espera que lo estará (~Retry-After), el tipo de servidor (Server), si el servidor necesita autorización para acceder al recurso pedido (~WWW-Authenticate), etc.
**''De identidad'': Información relacionada directamente con el recurso que se le va a proporcionar al cliente. Ejemplo: Codificación (~Content-Encoding), Idioma (~Content-Language), Longitud (~Content-Length), Tipo MIME de los recursos (~Content-Type), etc.
*La cabecera //Host// es obligatoria en ~HTTP1.1
*Las aplicaciones web pueden definir sus propias cabeceras para añadir información adicional en los mensajes HTTP. Por convenio, utilizan el prefijo X-.
!!!Códigos de estado y error.
*Códigos que envían los servidores en las respuestas HTTP y que informan al cliente de cómo ha sido procesada la petición. Se acompañan de texto explicativo.
*Son números de tres cifras que se clasifican en 5 grupos en función del primer dígito:
**100-199: Informativo //Informational//. Indica que el servidor ha recibido la información pero no ha finalizado de procesarla.
**200-299: Éxito //Sucessful//. Usados cuando la petición ha sido procesada satisfactoriamente.
**300-399: Redirección //Redirection//: La petición ha sido procesada y redirigida a otra localización.
**400-499: Errores del cliente //Client Error//: el servidor indica que hay algún error en la petición o que no se puede conceder.
**500-599: Errores en el servidor, Server Error: el servidor no puede atender una petición porque ha existido algún problema.
[[Actividades Apache II]]
</pre>
</div>
<div title="Servicios de mensajería instantánea" creator="YourName" modifier="YourName" created="201403120136" changecount="1">
<pre>;Def
:La mensajería instantánea (IM, Instant Messenger) permite enviar mensajes de texto en tiempo real entre usuarios conectados a una red.
!!!Componentes y funcionamiento
En general el proceso consta de los siguientes pasos:
*El usuario arranca su cliente de IM y se conecta con sus credenciales a un servidor de IM.
*El servidor de IM envía al cliente los contactos que tiene indicándole su estado. Adicionalmente, el servidor notifica a sus contactos que se ha conectado.
*Si el usuario quiere conectarse con un usuario de su lista de contactos los seleccionará y empezará la comunicación. También podría ser seleccionado por alguno de sus contactos.
*Además puede dar de alta contactos utilizando normalmente su dirección de correo electrónico.
*Cuando el usuario termina su cliente de IM, éste lo notifica al servidor que a su vez informa del cambio de estado a su lista de contactos.
!!!Protocolos
*''XMPP/Jabber'': //eXtensible Messaging and Presence Protocol// también conocido como //Jabber//, es un protocolo abierto de IM basado en XML. Este protocolo también da soporte a otras funcionalidades como llamadas de voz o vídeo, //Chat//. Sus características más relevantes son:
**Protocolo abierto.
**Es seguro. Un servidor puede aislarse de la red pública XMPP. Además utiliza diferentes mecanismos de seguridad SASL y TLS.
**Permite compatibilidad con otros sistemas de IM como ICQ o MSN Messenger mediante pasarela en el servidor.
**Es extensible. Fácilmente se pueden desarrollar nuevas funcionalidades para el protocolo.
**Es un protocolo patrocinado por Google que lo utiliza para //google talk//; también lo utiliza //Facebook// para su funcionalidad de IM.
*''Protocolos propietarios''
*MSNP: utilizado en el cliente //Windows Live Messenger de ~MIcrosoft//.
*OSCAR: utilizado por //~America-Online Instant Messenger//
!!!Clientes y servidores
Existen multitud de clientes de IM actualmente. Suelen incluir la posibilidad de utilizar voz y vídeo en tiempo real. También suelen permitir el envío de ficheros.
En cuanto a los servidores, tres cuartos de lo mismo, los más populares son: //jabberd2//, //ejabberd//, //Openfire//. Además están las soluciones de //Microsoft//: //Microsoft Office Communicator 2007// y //Microsoft Server Exchange 2010//</pre>
</div>
<div title="Servidores de correo" creator="YourName" modifier="YourName" created="201401300141" changecount="1">
<pre>;Definición
:Un servidor de correo es un conjunto de aplicaciones y procesos que permiten el almacenamiento y reenvío de mensajes de correo electrónico. El componente principal de un servidor de correo es el MTA pero también puede integrar una serie de componentes adicionales para ampliar y mejorar su funcionalidad.
__Agentes de transferencia de correos (MTA)__
;Definición
:Procesos encargados de la transferencia de los mensajes de correo entre equipos de una red mediante el protocolo SMTP. Son los responsables del encaminamiento del correo entre los diferentes sistemas.
Actúan como:
*Cliente SMTP para enviar correos a otros ~MTAs.
*Servidor SMTP para recibir correo de otros ~MTAs o de ~MUAs. Por defecto escuchan en el puerto 25.
Por tanto, un MTA se puede emplear para:
*''Recepción de correo'': Recibir correos destinados a usuarios con cuenta en él.
*''Retransmisión o reenvío'': Reenviar (//relay//) correos - es decir, actuar de pasarela:
**Destinados a usuarios que no tienen cuenta en él y originados por usuarios con cuenta en él o no.
**En la actualidad es muy importante que la retransmisión de correo (//relay//) por parte de un MTA esté controlada y restringida porque si no, podría ser utilizada por usuarios desconocidos para reenviar correo a otros sistemas y usuarios (//spam//). Para controlar el reenvío de correo los ~MTAs ofrecen múltiples opciones de configuración que se basan en:
***Autenticación previa en el MTA para reenviar correos.
***Restringir el reenvío de correos que provengan de determinadas ~IPs, segmentos de red, dominio, etc.
__Servidores //open relay//__
Término para referirse a un servidor MTA que permite el reenvío de correo desde cualquier lugar sin controlar ni verificar de dónde viene y de quién proviene.
Para controlar el //spam// y los correos maliciosos se han creado listas en las que se incluyen rangos de IP, dominios, etc. que son susceptibles de contener ~MTAs que actúan como //open relay//. Son listas que pueden ser consultadas por otros ~MTAs para rechazar o aceptar correo procedente de esas fuentes.
__Servidores //smart host//__
Término para referirse a ~MTAs que reciben correos de otros ~MTAs y que van dirigidos a destinatarios que no tienen cuenta en él. Su función es reenviarlos.
A diferencia  del //open relay//, el //smart host// debe estar configurado para permitir solo el reenvío de correos de determinados usuarios, ~IPs, dominios, etc. (si no sería un //open relay//).
__Buzones de correo__
Los ~MTAs almacenan los mensajes destinados a cuentas del servidor en sus buzones de correo. Pueden estar localizados en el mismo equipo o en otro. Cada MTA define el formato en el que se almacenan los mensajes de los buzones. Existen múltiples formatos (por ejemplo, mbox y maildir).
__Ejemplos de ~MTAs__
//Postfix, Sendmail, Microsoft Exchange, Qmail, Exim, Imail, hMailServer//</pre>
</div>
<div title="Servidores de nombres" creator="YourName" modifier="YourName" created="201310142148" changecount="1">
<pre>*Son programas que guardan la información sobre nombres de dominio y responden las preguntas de los clientes DNS y otros servidores de nombres. Almacenan, por tanto, una parte de la base de datos DNS.
*Escuchan peticiones en los puertos 53/TCP y 53/UDP.
*Cada servidor de nombres mantiene información de una parte del espacio de nombres de dominio que se conoce como ''zona''. Cuando un servidor contiene una zona se dice que es ''autorizado'' (//autoritative//) para esa zona.
*Las zonas se almacenan en ficheros de texto o en bases de datos (relacionales, LDAP, etc). (Formato definido en RFC 1035)
*Veamos un fichero de zona (imagen) del dominio  &quot;asix.cat&quot;. En concreto veamos el fichero de resolución directa del dominio &quot;asix.cat&quot; que se almacena en un servidor DNS que está en el equipo con IP 192.168.1.1 y cuyo nombre es ns1.asix.cat:
{{{
...
asix.cat              IN      NS      ns1.asix.cat
ns1.asix.cat        IN     A         192.168.1.1
obelix.asix.cat     IN     A         192.168.1.2
asterix.asix.cat    IN    A          192.168.1.3
www.asix.cat      IN    CNAME    obelix.asix.cat
ftp.asix.cat          IN    CNAME    asterix.asix.cat
...
}}}
*Cada línea del fichero se denomina ''registro de recursos'' (//RR Resource Records//).
*El administrador del servidor puede decidir si delega o no alguno de sus subdominios:
{{{
...
asix.cat              IN      NS      ns1.asix.cat
ns1.asix.cat        IN     A         192.168.1.1
obelix.asix.cat     IN     A         192.168.1.2
asterix.asix.cat    IN    A          192.168.1.3
www.asix.cat      IN    CNAME    obelix.asix.cat
ftp.asix.cat          IN    CNAME    asterix.asix.cat

;Subdominio xarxes.asix.cat delegado

xarxes.asix.cat      IN       NS           ns2.xarxes.asix.cat
ns2.xarxes.asix.cat     IN          A      192.168.1.20

;Subdominio bbdd.asix.cat no es delegado

www.bbdd.asix.cat       IN         A         192.168.1.4
pc01.bbdd.asix.cat        IN        A          192.168.1.5
pc02.bbdd.asix.cat        IN        A          192.168.1.6
...
}}}
*Una zona no es lo mismo que dominio (como se observa en el ejemplo anterior donde hay dos dominios (asix.cat y bbdd.asix.cat) en una sola zona). Un dominio es un subárbol del espacio de nombres. Los datos asociados a los nombres de un dominio pueden estar almacenados en una o varias zonas.
!!Tipos de servidores de nombres
Según la función que realizan los servidores de nombres se pueden clasificar (Ojo. Hay que tener en cuenta que un mismo servidor puede combinar varias de estas funciones simultáneamente):
*''Servidor maestro (o primario)'':
**Define una o varias zonas para las que es autorizado. Sus archivos de zonas son los que el administrador ha de modificar para añadir/borrar/actualizar nombres de dominio.
**Si un cliente le pregunta por un nombre de dominio para el que es autorizado, consulta sus ficheros de zona y responde.
**Si un cliente (o servidor) le pregunta por un nombre para el que no es autorizado, habrá de buscar información en otros servidores DNS o responder que no conoce la respuesta.
*''Servidor esclavo (o secundario)'':
**Define una o varias zonas para las que es autorizado.
**Obtiene los ficheros de zona de otro servidor autorizado para la zona (normalmente, el maestro) mediante un proceso que se denomina ''transferencia de zona''. 
**Los ficheros de zona, por tanto, son sólo de lectura y el administrador no debe editar en ellos.
**El funcionamiento ante las diferentes consultas de los clientes es similar al del maestro.
**Un servidor DNS puede ser maestro para una o varias zonas y al mismo tiempo esclavo para otras.
**Pueden existir varios servidores esclavos para una misma zona. Ventajas: reducir y repartir la carga, tolerancia a fallos, rapidez. Lo ideal es que los servidores DNS se encuentren en ubicaciones distintas de la red para evitar que un problema (fallo eléctrico, por ejemplo) les afecte simultáneamente.
*''Servidor caché''
**Para reducir la carga de los equipos, disminuir tráfico y, sobretodo, mejorar los tiempos de respuesta de las consultas, los servidores de nombres pueden actuar como servidores cache.
**No tiene autoridad sobre ningún dominio.
**Pregunta a otros servidores para resolver las peticiones de los clientes DNS.
**Los servidores caché guardan durante un tiempo (''TTL //Time To Live//'') las respuestas a las últimas preguntas que ha realizado a otros servidores de nombres. Así, cuando recibe una petición de un cliente lo primero que hace es consultar su memoria caché.
*''Servidor reenviador (//forwarder//)''
**Es un servidor DNS que otros servidores DNS designan para reenviarle consultas.
**Se utiliza para minimizar las consultas y el tráfico desde una red hacia Internet. Permite a los equipos locales compartir la caché del reenviador minimizando los tiempos de respuesta.
*''Servidor solo autorizado''
*Es autorizado para una o varias zonas como maestro y/o esclavo.
*No responde a preguntas que no sean relativas a sus zonas, es decir, no pregunta a otros servidores de nombres. Esto implica que no tiene actividad la recursividad, no es reenviador y no actúa como caché.
!!Ejemplos de servidores de nombres
Los más utilizados son:
*BIND (isc, libre)
*Servidor DNS de Microsoft 
*~PowerDNS (www.powerdns.com)
*Simple DNS (www.simpledns.com)
*Cisco Network Registrar
*//dnsmasq//</pre>
</div>
<div title="SiteSubtitle" creator="YourName" modifier="YourName" created="201309242345" changecount="1">
<pre>Curso 2013-14</pre>
</div>
<div title="SiteTitle" creator="YourName" modifier="YourName" created="201309242344" changecount="1">
<pre>M8</pre>
</div>
<div title="Streaming" creator="YourName" modifier="YourName" created="201403131339" changecount="1">
<pre>!!!Introducción
*El servicio de streaming permite el intercambio de ficheros, generalmente multimedia, desde un servidor hacia un cliente.
*La diferencia con otros servicios similares es que mientras en otros servicios hay que esperar la descarga completa del fichero antes de poder emplearlo, mediante streaming es posible suministrar un flujo de datos continuo  entre el servidor y cliente de forma que este último pueda procesar o reproducir la información según la va recibiendo del servidor.
!!!Características
Para permitir la reproducción del contenido multimedia en el cliente según se va recibiendo del servidor, los ficheros, que se envían fragmentados desde el servidor, deben ser reensamblados y sincronizados en el cliente para que, sin disponer del fichero completo, se puedan reproducir.

__''Arquitecturas''__
*Arquitectura cliente/servidor clásica
*Arquitectura sin servidor (//server-less//): se utiliza un servidor web. Se simula streaming mediante protocolo HTTP. Se denomina //falso-streaming//. 
*Arquitectura sin cliente (//Client-less//): no existe la aplicación propiamente dicha sino que está incrustada en otra por ejemplo, cuando se reproducen animaciones en //Flash// o //applets// en un navegador. En este sentido, html5 incluye nuevas etiquetas (&lt;audio&gt; y &lt;video&gt;) que incluyen //codecs// que permiten visualizar desde el navegador el contenido multimedia sin necesidad de abrir un reproductor propiamente dicho.
__''Componentes''__
*Servidores de streaming: alojan y ofrecen los recursos.
*Clientes de streaming: que permiten a los usuarios acceder a los recursos disponibles en los servidores de streaming y reproducirlos con la ayuda de //codecs//. Estos //codecs// nos permitirán tanto la codificación del contenido multimedia en un formato comprimido en el servidor, como su posterior decodificación en el cliente. El cliente dispondrá también de un ''buffer'' para almacenar de forma temporal los datos que se van recibiendo desde el servidor.
*Arquitecturas rápidas de red que consiguen mediante replicación y distribución de contenidos en diversos nodos de la red aumentar la velocidad de descarga.
*Protocolos rápidos específicos para streaming como RTPS y RTP. (Los veremos más adelante)
*Productor: es el encarga de generar el contenido multimedia. Este contenido puede emitirse en directo o bien almacenarse en el servidor para cuando lo solicite un cliente. 
*Formatos de audio/video y //codecs//: los contenidos generados por el productor son comprimidos empleando //codecs// para ser transmitidos al servidor de streaming que, a su vez, puede emplear nuevos //codecs// para ofrecer diferentes calidades o formatos a los clientes.
__''Tipos de streaming''__
*En directo: el servidor controla la transmisión. El contenido es emitido a criterio de servidor en un instante dado. No hay interactividad con el cliente. Está orientado a la multidifusión: todos los clientes reproducen los mismos contenidos. El contenido puede, a su vez, difundirse por la red mediante //unicast// o //multicast//. 
*Bajo demanda (//on demand//): los clientes controlan la transmisión. El servidor espera las peticiones de los clientes y son estos los que deciden qué contenido multimedia quieren recibir en cada momento. Permite interactividad con el cliente (saltar partes, repetir otras, etc.)
*Casi bajo demanda (//Near On Demand//): donde se simula un servicio bajo demanda gracias a emplear multitud de flujos en directo en constante emisión de forma que el cliente, cuando se conecta al servidor, realmente se incorpora al flujo de datos más cercano a lo solicitado.
__''Conexiones''__
Para que el servicio de streaming funcione son necesarios dos flujos de datos diferentes pero interrelacionados:
*Flujo de datos para el control de la transmisión. Emplea RTPS encapsulado en TCP o UDP y permite gestionar la interactividad con el cliente. 
*Flujo de datos para el transporte del contenido multimedia. Emplea RTP encapsulado en UDP. En los paquetes RTP van encapsulados, fraccionados y multiplexados los contenidos multimedia para incluir simultáneamente las partes de audio y vídeo en función del codec y formato elegido.</pre>
</div>
<div title="Temporización" creator="YourName" modifier="YourName" created="201309261519" modified="201311291447" changecount="15">
<pre>{{{
13 nov --&gt; Examen ~UF1
14 nov --&gt; Corrección
20 nov --&gt; Recuperación Ordinaria ~UF1
21 nov --&gt; Último día entrega de actividades. 
Se entregan vía mail
}}}
__''25_09_X''__
&lt;&lt;&lt;
*2h (2h)
*Presentación programación
*Primera clase. Explico: [[Introducción]]
&lt;&lt;&lt;
__''26_09_J''__
&lt;&lt;&lt;
*2h (4h)
*Acabamos con [[Introducción]]
*Vemos [[Direccionamiento IP]] actividad inclusive.
&lt;&lt;&lt;
__''2_10_X''__
&lt;&lt;&lt;
*2h (6h)
*Dedico 1h a ver el tema de Mercurial.
*Acabamos [[Encaminamiento IP]] y [[Nivel de transporte]]
*Realizamos [[Actividades]]
&lt;&lt;&lt;
__''3_10_J''__
&lt;&lt;&lt;
*2h (8h)
*Acabamos grupo de contenidos &quot;Conceptos básicos&quot;: repaso general y vemos lo que quedaba: [[Traducción de direcciones de red NAT y PAT]]
*Empezamos con DHCP
*Vemos [[Introducción DHCP]], [[Definiciones]], [[Funcionamiento]]
*Instalamos en máquina virtual Server2008
&lt;&lt;&lt;
__''9_10_X''__
&lt;&lt;&lt;
*2h (10h)
*Empezamos propiamente las actividades DHCP [[Act_DHCP]]
*Preparación de la red que utilizaremos durante el curso: server2008, ubuntu13.04, windows7, debian
&lt;&lt;&lt;
__''10_10_J''__
&lt;&lt;&lt;
*2h (10h)
*Actividades [[Act_DHCP]]: 1, 2, 3 y 4.
&lt;&lt;&lt;
__''16_10_X''__
&lt;&lt;&lt;
*2h (12h)
*Explico: [[Introducción DNS]] , [[Características y funcionamiento del servicio DNS]], [[Espacio de nombres de dominio]], [[Servidores de nombres]]
&lt;&lt;&lt;
__''17_10_J''__
&lt;&lt;&lt;
*2h (14h)
*Acabamos [[Act_DHCP]]. 
*Empezamos con [[Act_DNS]]
&lt;&lt;&lt;
__''23_10_X''__
&lt;&lt;&lt;
*2h (16h)
*Explico: [[Clientes DNS (resolver)]] ,  [[Resolución recursiva]], [[Registro de recursos]], [[DNS Dinámico]]
*Realizamos todos juntos de [[Act_DNS]] la actividad 12. Falta añadir a la configuración del DHCP el options nameserver.
&lt;&lt;&lt;
__''24_10_J''__ (Jornada de huelga)
&lt;&lt;&lt;
*2h (18h /16h) (disponibles / reales)
*No avanzo materia. Repaso con los alumnos que vienen a clase los contenidos vistos hasta la fecha.
&lt;&lt;&lt;
__''30_10_X''__
&lt;&lt;&lt;
*2h (20h / 18h)
*Acabamos la [[Act_DNS]] la actividad 12. Vemos que funciona correctamente.
*Realizamos la actividad 13: instalación de bind9 en debian y primeros pasos.
&lt;&lt;&lt;
__''31_10_J''__
&lt;&lt;&lt;
*2h (22h / 20h)
*Realizamos bajo mi guía la [[Act_DNS]] número 14. Se trata de la configuración del servidor DNS sobre debian.
&lt;&lt;&lt;
__''06_11_X''__: No hay clase (día con horario de lunes)
__''07_11_J''__
&lt;&lt;&lt;
*2h (24h / 22h)
*Repaso materia y preparación del examen del próximo día 13 de noviembre
*Realizamos exámenes de cursos anteriores. [[Examen Año Pasado]]
&lt;&lt;&lt;
__''13_11_X''__
&lt;&lt;&lt;
*2h (26h /24h)
*[[Examen UF1]]
&lt;&lt;&lt;
__''14_11_J''__
&lt;&lt;&lt;
*2h (28h /26h)
*Corrección del examen: hago paso a paso todos los ejercicios.
*Explico evaluación de ~UF1
*Introduzco temario de ~UF2
&lt;&lt;&lt;
__''20_11_X''__
&lt;&lt;&lt;
*2h (30h/28h)
*Recuperación ~UF1: [[Recuperación UF1]]
&lt;&lt;&lt;
</pre>
</div>
<div title="Temporización UF2" creator="YourName" modifier="YourName" created="201311210002" modified="201402101714" changecount="12">
<pre>__''21_11_J''__
&lt;&lt;&lt;
*2h (2h)
*Inicio de ~UF2
*Explico programación, forma de evaluar, cambios respecto a ~UF1
*Explico: [[Servicio Web: definición y componentes]]
*Realizamos todos juntos la instalación de [[Instalación Apache]]
*Explico archivos de configuración de Apache y parte de su sintaxis
*Realizan [[Actividades Apache I]]
&lt;&lt;&lt;
__''27_11_X''__
&lt;&lt;&lt;
*2h (4h)
*Explico [[Servicio Web: protocolo HTTP]]
*Propongo [[Actividades Apache II]]
&lt;&lt;&lt;
__''28_11_J''__
&lt;&lt;&lt;
*2h (6h)
*Explico [[Servicio Web: Alojamiento virtual de sitios web]]
*Realizamos todos juntos la virtualización por nombres
*Propongo [[Actividades Apache III]]
&lt;&lt;&lt;
__''04_12_X''__
&lt;&lt;&lt;
*2h (8h)
*Dos horas destinadas íntegramente a la realización de las actividades
*En general, acaban [[Actividades Apache II]] y la primera actividad de [[Actividades Apache III]]
&lt;&lt;&lt;
__05_12_J__: No hay clase (horario de lunes)

__''11_12_X''__
&lt;&lt;&lt;
*2h (10h)
*Explico el último punto del NA 1: [[Servicio Web: Caché, Autenticación, Cookies, Conexiones persistentes, etc]]
*Muestro cómo se realiza la [[Configuración Autenticación Apache]]
&lt;&lt;&lt;
__''12_12_J''__
&lt;&lt;&lt;
*2h (12h)
*Acabamos con [[Configuración Autenticación Apache]]
*Propongo [[Actividades Apache IV]]
&lt;&lt;&lt;
__18_12_X__: No hay clase (juntas de evaluación)

__19_12_J__: No hay clase (visita al Mobile World Centre)

__''08_01''__
&lt;&lt;&lt;
*2h (14h)
*Dedicamos un rato largo a comentar las opciones de calendario. Queda establecido el día 23 de enero el examen de la ~UF2. La recuperación la haremos en horas de tutoría.
*Empezamos la parte de FTP. 
*Explico [[Servicio FTP: definición y componentes]] y, también, [[Servicio FTP: tipos de acceso, conexiones [[Recuperación UF2]]y modos]]
&lt;&lt;&lt;
__''09_01''__
&lt;&lt;&lt;
*2h (16h)
*Una hora de clase reparando ordenadores: ordenador de sandra sin red... (lo considero tiempo para realizar actividades)
*Hacemos [[Instalación vsftp]]
&lt;&lt;&lt;
__''15_01''__
&lt;&lt;&lt;
*2h (18h)
*Explico [[Servicio FTP: Seguridad, FTPS, FXP, TFTP, SFTP/SCP]]
*Acabamos contenido teórico de la unidad
*Resto del tiempo para realizar actividades.
&lt;&lt;&lt;
__''16_01''__
&lt;&lt;&lt;
*2h (20h)
*Tiempo para realizar las actividades e ir presentándomelas
&lt;&lt;&lt;
__''22_01''__
&lt;&lt;&lt;
*2h (22h)
*Tiempo para realizar las actividades e ir presentándomelas
&lt;&lt;&lt;
__''23_01''__
&lt;&lt;&lt;
*2h (24h)
*Examen uf 2: [[Examen UF2]]
&lt;&lt;&lt;
__''03_02''__
&lt;&lt;&lt;
*2h (26h)
*Examen recuperación primera parte (en la hora de tutoría) [[Recuperación UF2]]
&lt;&lt;&lt;</pre>
</div>
<div title="Temporización UF3" creator="YourName" modifier="YourName" created="201401290048" modified="201403150000" changecount="8">
<pre>__Consideraciones generales__
*La UF consta de 25h
*Comienza el día: 29-01-2014
*Debería acabar el día 6-03-2014 (24h, realmente falta 1h)
*Según programación debería acabar el 21-02-2014.
*Quedarán 20h para la última UF.
__Desarrollo de la UF__
__''29_01 X''__
&lt;&lt;&lt;
*2h (2h)
*Inicio de la ~uf3
*Reviso la programación de la  ~uf2 para que vean qué hemos visto y qué no. 
*Presento la programación de la ~uf3 y explico cómo la voy a evaluar.
*Primera explicación: [[Características Correo Electrónico]] y [[Funcionamiento Correo Electrónico]]
&lt;&lt;&lt;
__''30_01 J''__
&lt;&lt;&lt;
*2h (4h)
*Les propongo la actividad [[Actividad 1: Clientes de Correo]]. Dejo casi 1h para realizarla
*Explico una vez más la diferencia entre NAT y adaptador puento de VirtualBox
*Realizamos la actividad guiada: [[Instalación postfix]]
&lt;&lt;&lt;
__''05_02 X''__
&lt;&lt;&lt;
*2h (6h)
*Explico [[Direcciones y cuentas de correo]] y [[Servidores de correo]]
*Realizamos actividad guiada [[Configuración Postfix]]
*Propongo [[Actividad 2: Configuración postfix]]
*Resto del tiempo (1h aprox) para realizar actividades.
&lt;&lt;&lt;
__''06_02 J''__
&lt;&lt;&lt;
*2h (8h)
*Propongo [[Actividad 3: Postfix y DNS]]
*Prácticamente todo el tiempo es para la realización de las actividades.
&lt;&lt;&lt;
__''12_02 X''__
&lt;&lt;&lt;
*2h (10h)
*Explico [[Mensajes]] y [[Protocolos]]
*Propongo: [[Actividad 4: Protocolo SMTP]]
&lt;&lt;&lt;
__''13_02 J''__
&lt;&lt;&lt;
*2h (12h)
*Propongo: [[Actividad 5: Instalación Dovecot]] (Servidor IMAP y POP)
&lt;&lt;&lt;
__19_02 X__: Juntas Evaluación. No hay clase

__''20_02 J''__
&lt;&lt;&lt;
*2h (14h)
*Tiempo para realización actividades. No explico nada ni añado más actividades. 
&lt;&lt;&lt;
__''26_02_X''__
&lt;&lt;&lt;
*2h (16h)
*Tiempo para realización de actividades. No explico nada ni añado más actividades
&lt;&lt;&lt;
__''27_02_J''__
&lt;&lt;&lt;
*2h (18h)
*Explico [[Seguridad_Correo]]
*Propongo actividad: [[Actividad 6: Autenticación de usuarios con SASL]]
&lt;&lt;&lt;
__''05_03_X''__
&lt;&lt;&lt;
*2h (20h)
*Propongo actividad: [[Actividad 7: Comunicación Encriptada con SSL/TLS]]
&lt;&lt;&lt;
__''06_03_J''__
&lt;&lt;&lt;
*2h (22h)
*Propongo actividad: [[Actividad 8: Postfix con MySql]]
*Explico sobre el final de la ~UF3:
**No habrá examen.
**Hay que tener hasta la actividadIV para aprobar.
**El último día para presentar actividades es el día 31 de marzo
**La UF acaba el próximo miércoles día 12-03
&lt;&lt;&lt;
__''12_03_X''__
&lt;&lt;&lt;
*2h (24h)
*Propongo lectura de [[Servicios de mensajería instantánea]] y [[Listas de distribución]]
*Propongo [[Actividad 9: Un vistazo a la mensajería instantánea]]
&lt;&lt;&lt;
__''13_03_J''__
&lt;&lt;&lt;
*1h (25h)
*Hora dedicada a acabar y presentar actividades 
*Hay hasta el 31_03 para presentar actividades pero ya será en tiempo de patio o similar
*Fin de la UF
&lt;&lt;&lt;</pre>
</div>
<div title="Temporización UF4" creator="YourName" modifier="YourName" created="201403142355" modified="201404091644" changecount="7">
<pre>__''13_03_J''__
&lt;&lt;&lt;
*1h (1h)
*Incio de la UF4. 
*Explico por encima la programación para esta UF y el calendario de la misma
*Propongo lectura de [[Formatos multimedia]] y  de [[Streaming]]
*Propongo [[Actividad 1: Codecs]]
&lt;&lt;&lt;
__''19_04_X''__ (Jornadas JEDAI)

__''20_04_J''__
&lt;&lt;&lt;
*2h (3h)
*Propongo actividad: [[Actividad 2: Servidor Streaming Audio]]
&lt;&lt;&lt;
__''26_04_X''__
&lt;&lt;&lt;
*2h (5h)
*Realización de actividades. Problema con la Actividad 1: el codec flac no funciona correctamente en Ubuntu
&lt;&lt;&lt;
__''27_04_J''__
&lt;&lt;&lt;
*2h (7h)
*Cuelgo más contenidos: [[Protocolos Streaming]]
*Propongo nuevas actividades: [[Actividad 2.1 (Opcional): Monta una radio]] y [[Actividad 3: Servidor Streaming a la carta]]
*Hasta aquí todo lo que vamos a ver de Servicios de Audio
&lt;&lt;&lt;
__''02_04_X''__ (Visita Marenostrum)

__''03_04_J''__
&lt;&lt;&lt;
*2h (9h)
*Añado [[Distribución y suscripción de audio y vídeo]]
*Propongo actividad [[Actividad 3: Servidor Streaming a la carta]]
*Propongo [[Actividad 4: Servidor Streaming vídeo y audio]]
&lt;&lt;&lt;
__''09_04_X''__
&lt;&lt;&lt;
*2h (11h)
*Últimas 2h de la uf y del módulo
&lt;&lt;&lt;</pre>
</div>
<div title="Traducción de direcciones de red NAT y PAT" creator="YourName" modifier="YourName" created="201309252158" changecount="1">
<pre>*NAT (//Network Address Translation//): permite que direcciones privadas acceden a internet con la misma IP pública (o un conjunto). //Nota: las direcciones privadas no pueden viajar por Internet, por definición//
!!Funcionamiento
Para que el sistema NAT funcione es necesario que el encaminador que da acceso a Internet reescriba algunos datos en los datagramas que encamina. Hay varios tipos de NAT:
*NAT básico: únicamente modifica la dirección IP (NAT a nivel de red). Completamente en desuso.
*NAPT/PAT: además de la IP se modifican los puertos empleados en la comunicación a nivel de transporte. (NAT a nivel de transporte). La información que se modifica al pasar por un encaminador NAT (=NAPT) es:
**IP origen y puerto origen en el tráfico saliente de la red privada.
**IP destino y puerto destino en el tráfico entrante en la red privada.
El encaminador NAT dispondrá de un tabla NAT con los cambios que se realizan. Esta tabla dispondrá al menos de los siguientes campos:
**Dirección IP interna (privada)
**Puerto interno
**Dirección IP externo (pública)
**Puerto externo
**Puerto del nivel de transporte (TCP o UDP)
Veámos con un poco más de detalle:
*Tráfico saliente: el encaminador cambia la IP y el puerto.
|!Red Privada|!Red Pública|
|~DirecciónIP:Puerto|~DirecciónIP:Puerto|
|192.168.1.10:23100|80.24.12.1:10001|
|192.168.1.11:23100|80.24.12.1:10002|
*Respuesta al tráfico saliente: el encaminador, cuando recibe un datagrama del exterior, comprueba si la dirección IP de destino y el puerto destino del datagrama entrante coinciden con algún registro de su tabla NAT. Si es así, quiere decir que el datagrama es una respuesta a un datagrama previo y, en este caso, el encaminador cambiará en el datagrama entrante la dirección IP de destino y el puerto destino por la dirección IP interna y el puerto interno. A continuación retransmitirá el datagrama modificado hacia la red interna.
*¿Qué pasa con el tráfico entrante nuevo? Es decir, ¿qué hará el encaminador con el datagrama que cuya IP y puerto no coincide con ninguno de los que tiene en su tabla? En general, descartará el datagrama. Ahora bien, ¿cómo disponer de un servidor detrás de un encaminador NAT? 
*Solución: redirección de puertos(//Port Forwanding//): consiste en &quot;decirle&quot; al encaminador  que redirija todo el tráfico entrante nuevo a una IP concreta de la red interna en función del puerto al que vaya dirigido. ¿Cómo? Añadiendo manualmente una entrada en la tabla NAT. 
*El redireccionamiento de puertos nos permitará disponer de varios servidores en la red interna accesibles todos a ellos a través de la dirección pública de nuestra red. Únicamente obligará a que para cada servicio se acceda a un puerto diferente.
*Limitación del NAT: ¿qué pasa con los datagramas pertenecientes a protocolos que utilizan la IP y el puerto en el campo datos? Solución: que el encaminador conozca el protocolo y modifique los números del campo datos para que sean coherentes.
</pre>
</div>
<div title="UF1" creator="YourName" modifier="YourName" created="201309242346" modified="201310211633" changecount="8">
<pre>[[Contenidos]]
[[Actividades]]
[[Temporización]]
[[Evaluación]]</pre>
</div>
<div title="UF1_Actividad_1" creator="YourName" modifier="YourName" created="201309242355" modified="201309261426" changecount="10">
<pre>A partir de los siguientes pares obtén dirección de red, la primera y la última dirección.
*(192.168.14.3,255.255.0.0)
*(10.23.31.7,255.255.255.0)
*(8.45.127.12, 255.0.0.0)
*(8.45.127.12, 255.255.240.0)
*(223.145.90.131, 255.255.255.192)
*(140.30.23.31, 255.224.0.0)
----
|!IP|!Dir Red|!Primera|!Última|
|192.168.14.3, 255.255.0.0|192.168.0.0 /16|192.168.0.1/16|192.168.255.254/16|
|10.23.31.7, 255.255.255.0|10.23.31.0/24|10.23.31.1/24|10.23.31.254/24|
|8.45.127.12,255.0.0.0|8.0.0.0 /8|8.0.0.1 /8|8.255.255.254 /8|
|8.45.127.12,255.255.240.0|8.45.112.0 /20|8.45.112.1/20|8.45.127.254 /20|
|223.145.90.131, 255.255.255.192|223.145.90.128 /26|223.145.90.129 /26| 223.145.90.254 /26|
|140.30.23.31, 255.224.0.0|140.0.0.0 /11|140.0.0.1 /11|140.31.255.254 /11|</pre>
</div>
<div title="UF2" creator="YourName" modifier="YourName" created="201311210000" modified="201402101714" changecount="4">
<pre>[[Contenido UF2]]
[[Actividades UF2]]
[[Temporización UF2]]</pre>
</div>
<div title="UF3" creator="YourName" modifier="YourName" created="201401290017" changecount="1">
<pre>[[Contenido UF3]]
[[Actividades UF3]]
[[Temporización UF3]]</pre>
</div>
<div title="UF4" creator="YourName" modifier="YourName" created="201403131337" modified="201403142351" changecount="4">
<pre>[[Contenido UF4]]
[[Actividades UF4]]
[[Temporización UF4]]
</pre>
</div>
<div title="ViewTemplate" creator="YourName" modifier="YourName" created="201309242345" changecount="1">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' role='navigation' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="robtex" creator="YourName" modifier="YourName" created="201312041633" modified="201312041637" changecount="2">
<pre>#Visita la página [[www.robtex.com|http://www.robtex.com]]. ¿Qué relación tiene dicha página con los servidores virtuales?
#¿Qué ofrece esta web?</pre>
</div>
<div title="uf1" creator="YourName" modifier="YourName" created="201309261351" changecount="1">
<pre></pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->

<!--POST-BODY-END-->
<script id="jsArea" type="text/javascript">
//<![CDATA[

//
// Please note:
//
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project repository at https://github.com/TiddlyWiki/tiddlywiki
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
//
// JSLint directives
/*global jQuery:false, version:false */
/*jslint bitwise:true, browser:true, confusion:true, eqeq:true, evil:true, forin:true, maxerr:100, plusplus:true, regexp:true, sloppy:true, sub:true, undef:true, unparam:true, vars:true, white:true */
//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animDuration: 400, // Duration of UI animations in milliseconds
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	locale: "en" // W3C language tag
};

// Hashmap of alternative parsers for the wikifier
config.parsers = {};

// Adaptors
config.adaptors = {};
config.defaultAdaptor = null;

// Backstage tasks
config.tasks = {};

// Annotations
config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

// Messages
config.messages = {
	messageClose: {},
	dates: {},
	tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkRegExpSearch: false,
	chkCaseSensitiveSearch: false,
	chkIncrementalSearch: true,
	chkAnimate: true,
	chkSaveBackups: true,
	chkAutoSave: false,
	chkGenerateAnRssFeed: false,
	chkSaveEmptyTemplate: false,
	chkOpenInNewWindow: true,
	chkToggleLinks: false,
	chkHttpReadOnly: true,
	chkForceMinorUpdate: false,
	chkConfirmDelete: true,
	chkInsertTabs: false,
	chkUsePreForStorage: true, // Whether to use <pre> format for storage
	chkDisplayInstrumentation: false,
	txtBackupFolder: "",
	txtEditorFocus: "text",
	txtMainTab: "tabTimeline",
	txtMoreTab: "moreTabAll",
	txtMaxEditRows: "30",
	txtFileSystemCharSet: "UTF-8",
	txtTheme: ""
	};
config.optionsDesc = {};

config.optionsSource = {};

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that should not really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

// Backstage tasks
config.backstageTasks = ["save","importTask","tweak","upgrade","plugins"];

// Extensions
config.extensions = {};

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: {sizeTextbox: 15},
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {},
		filter: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	options: {},
	newTiddler: {},
	newJournal: {},
	tabs: {},
	gradient: {},
	message: {},
	view: {defaultView: "text"},
	edit: {},
	tagChooser: {},
	toolbar: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	upgrade: {
		source: "http://tiddlywiki-releases.tiddlyspace.com/upgrade",
		backupExtension: "pre.core.upgrade"
	},
	sync: {},
	annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: {hideReadOnly: true},
	cancelTiddler: {},
	deleteTiddler: {hideReadOnly: true},
	permalink: {},
	references: {type: "popup"},
	jump: {type: "popup"},
	syncing: {type: "popup"},
	fields: {type: "popup"}
};

// Control of macro parameter evaluation
config.evaluateMacroParameters = "all";

// Basic regular expressions
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
if(!((new RegExp("[\u0150\u0170]","g")).test("\u0150"))) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.sectionSeparator = "##";
config.textPrimitives.urlPattern = "(?:file|http|https|mailto|ftp|irc|news|data):[^\\s'\"]+(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,"mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp = new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");
config.textPrimitives.tiddlerAnyLinkRegExp = new RegExp("("+ config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");

config.glyphs = {
	currBrowser: null,
	browsers: [],
	codes: {}
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: "",
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	AdvancedOptions: '<<options>>',
	PluginManager: '<<plugins>>',
	SystemSettings: '',
	ToolbarCommands: '|~ViewToolbar|closeTiddler closeOthers +editTiddler > fields syncing permalink references jump|\n|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler|',
	WindowTitle: '<<tiddler SiteTitle>> - <<tiddler SiteSubtitle>>'
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isGecko: navigator.product == "Gecko" && config.userAgent.indexOf("WebKit") == -1,
	ieVersion: /MSIE (\d{1,2}.\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
	firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	isOpera: config.userAgent.indexOf("opera") != -1,
	isChrome: config.userAgent.indexOf('chrome') > -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

merge(config.glyphs,{
	browsers: [
		function() {return config.browser.isIE;},
		function() {return true;}
		],
	codes: {
		downTriangle: ["\u25BC","\u25BE"],
		downArrow: ["\u2193","\u2193"],
		bentArrowLeft: ["\u2190","\u21A9"],
		bentArrowRight: ["\u2192","\u21AA"]
	}
});

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options,{
	txtUserName: "YourName"});

merge(config.tasks,{
	save: {text: "save", tooltip: "Save your changes to this TiddlyWiki"},
	importTask: {text: "import", tooltip: "Import tiddlers and plugins from other TiddlyWiki files and servers", content: '<<importTiddlers>>'},
	tweak: {text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>'},
	upgrade: {text: "upgrade", tooltip: "Upgrade TiddlyWiki core code", content: '<<upgrade>>'},
	plugins: {text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>'}
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc,{
	txtUserName: "Username for signing your edits",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkIncrementalSearch: "Incremental key-by-key searching",
	chkAnimate: "Enable animations",
	chkSaveBackups: "Keep backup file when saving changes",
	chkAutoSave: "Automatically save changes",
	chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
	chkSaveEmptyTemplate: "Generate an empty template when saving changes",
	chkOpenInNewWindow: "Open external links in a new window",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
	txtBackupFolder: "Name of folder to use for backups",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	txtTheme: "Name of the theme to use",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)"});

merge(config.messages,{
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#Download for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "Main TiddlyWiki file saved",
	mainDownload: "Downloading/saving main TiddlyWiki file",
	mainDownloadManual: "RIGHT CLICK HERE to download/save main TiddlyWiki file",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<%0>>",
	macroErrorDetails: "Error while executing macro <<%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'",
	upgradeDone: "The upgrade to version %0 is now complete\n\nClick 'OK' to reload the newly upgraded TiddlyWiki",
	invalidCookie: "Invalid cookie '%0'"});

merge(config.messages.messageClose,{
	text: "close",
	tooltip: "close this message area"});

config.messages.backstage = {
	open: {text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks"},
	close: {text: "close", tooltip: "Close the backstage area"},
	prompt: "backstage: ",
	decal: {
		edit: {text: "edit", tooltip: "Edit the tiddler '%0'"}
	}
};

config.messages.listView = {
	tiddlerTooltip: "Click for the full text of this tiddler",
	previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = ["st","nd","rd","th","th","th","th","th","th","th",
		"th","th","th","th","th","th","th","th","th","th",
		"st","nd","rd","th","th","th","th","th","th","th",
		"st"];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup,{
	});

merge(config.views.wikified.tag,{
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"});

merge(config.views.wikified,{
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"});

merge(config.views.editor,{
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"});

merge(config.views.editor.tagChooser,{
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"});

merge(config.messages,{
	sizeTemplates:
		[
		{unit: 1024*1024*1024, template: "%0\u00a0GB"},
		{unit: 1024*1024, template: "%0\u00a0MB"},
		{unit: 1024, template: "%0\u00a0KB"},
		{unit: 1, template: "%0\u00a0B"}
		]});

merge(config.macros.search,{
	label: "search",
	prompt: "Search this TiddlyWiki",
	placeholder: "",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"});

merge(config.macros.tagging,{
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"});

merge(config.macros.timeline,{
	dateFormat: "DD MMM YYYY"});

merge(config.macros.allTags,{
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll,{
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"});

merge(config.macros.permaview,{
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"});

merge(config.macros.saveChanges,{
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"});

merge(config.macros.newTiddler,{
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"});

merge(config.macros.newJournal,{
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"});

merge(config.macros.options,{
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in cookies in your browser",
	step1Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</input>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{name: 'Option', field: 'option', title: "Option", type: 'String'},
			{name: 'Description', field: 'description', title: "Description", type: 'WikiText'},
			{name: 'Name', field: 'name', title: "Name", type: 'String'}
			],
		rowClasses: [
			{className: 'lowlight', field: 'lowlight'}
			]}
	});

merge(config.macros.plugins,{
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Description', field: 'Description', title: "Description", type: 'String'},
			{name: 'Version', field: 'Version', title: "Version", type: 'String'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox'},
			{name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]},
	listViewTemplateReadOnly: {
		columns: [
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Description', field: 'Description', title: "Description", type: 'String'},
			{name: 'Version', field: 'Version', title: "Version", type: 'String'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]}
	});

merge(config.macros.toolbar,{
	moreLabel: "more",
	morePrompt: "Show additional commands",
	lessLabel: "less",
	lessPrompt: "Hide additional commands",
	separator: "|"
	});

merge(config.macros.refreshDisplay,{
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
	});

merge(config.macros.importTiddlers,{
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the server or TiddlyWiki file",
	step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
	openLabel: "open",
	openPrompt: "Open the connection to this file or server",
	statusOpenHost: "Opening the host",
	statusGetWorkspaceList: "Getting the list of available workspaces",
	step2Title: "Step 2: Choose the workspace",
	step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: <select name='selWorkspace'><option value=''>Choose...</option></select>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	statusOpenWorkspace: "Opening the workspace",
	statusGetTiddlerList: "Getting the list of available tiddlers",
	errorGettingTiddlerList: "Error getting list of tiddlers, click Cancel to try again",
	errorGettingTiddlerListHttp404: "Error retrieving tiddlers from url, please ensure the url exists. Click Cancel to try again.",
	errorGettingTiddlerListHttp: "Error retrieving tiddlers from url, please ensure this url exists and is <a href='http://enable-cors.org/'>CORS</a> enabled",
	errorGettingTiddlerListFile: "Error retrieving tiddlers from local file, please make sure the file is in the same directory as your TiddlyWiki. Click Cancel to try again.",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br><input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "Step 4: Importing %0 tiddler(s)",
	step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing tiddlers",
	statusDoneImport: "All tiddlers imported",
	systemServerNamePattern: "%2 on %1",
	systemServerNamePatternNoWorkspace: "%1",
	confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
	serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\nThis tiddler was automatically created to record the details of this server",
	serverSaveModifier: "(System)",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
			],
		rowClasses: [
			]}
	});

merge(config.macros.upgrade,{
	wizardTitle: "Upgrade TiddlyWiki core code",
	step1Title: "Update or repair this TiddlyWiki to the latest release",
	step1Html: "You are about to upgrade to the latest release of the TiddlyWiki core code (from <a href='%0' class='externalLink' target='_blank'>%1</a>). Your content will be preserved across the upgrade.<br><br>Note that core upgrades have been known to interfere with older plugins. If you run into problems with the upgraded file, see <a href='http://www.tiddlywiki.org/wiki/CoreUpgrades' class='externalLink' target='_blank'>http://www.tiddlywiki.org/wiki/CoreUpgrades</a>",
	errorCantUpgrade: "Unable to upgrade this TiddlyWiki. You can only perform upgrades on TiddlyWiki files stored locally",
	errorNotSaved: "You must save changes before you can perform an upgrade",
	step2Title: "Confirm the upgrade details",
	step2Html_downgrade: "You are about to downgrade to TiddlyWiki version %0 from %1.<br><br>Downgrading to an earlier version of the core code is not recommended",
	step2Html_restore: "This TiddlyWiki appears to be already using the latest version of the core code (%0).<br><br>You can continue to upgrade anyway to ensure that the core code hasn't been corrupted or damaged",
	step2Html_upgrade: "You are about to upgrade to TiddlyWiki version %0 from %1",
	upgradeLabel: "upgrade",
	upgradePrompt: "Prepare for the upgrade process",
	statusPreparingBackup: "Preparing backup",
	statusSavingBackup: "Saving backup file",
	errorSavingBackup: "There was a problem saving the backup file",
	statusLoadingCore: "Loading core code",
	errorLoadingCore: "Error loading the core code",
	errorCoreFormat: "Error with the new core code",
	statusSavingCore: "Saving the new core code",
	statusReloadingCore: "Reloading the new core code",
	startLabel: "start",
	startPrompt: "Start the upgrade process",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel the upgrade process",
	step3Title: "Upgrade cancelled",
	step3Html: "You have cancelled the upgrade process"
	});

merge(config.macros.annotations,{
	});

merge(config.commands.closeTiddler,{
	text: "close",
	tooltip: "Close this tiddler"});

merge(config.commands.closeOthers,{
	text: "close others",
	tooltip: "Close all other tiddlers"});

merge(config.commands.editTiddler,{
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"});

merge(config.commands.saveTiddler,{
	text: "done",
	tooltip: "Save changes to this tiddler"});

merge(config.commands.cancelTiddler,{
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"});

merge(config.commands.deleteTiddler,{
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"});

merge(config.commands.permalink,{
	text: "permalink",
	tooltip: "Permalink for this tiddler"});

merge(config.commands.references,{
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"});

merge(config.commands.jump,{
	text: "jump",
	tooltip: "Jump to another open tiddler"});

merge(config.commands.fields,{
	text: "fields",
	tooltip: "Show the extended fields of this tiddler",
	emptyText: "There are no extended fields for this tiddler",
	listViewTemplate: {
		columns: [
			{name: 'Field', field: 'field', title: "Field", type: 'String'},
			{name: 'Value', field: 'value', title: "Value", type: 'String'}
			],
		rowClasses: [
			],
		buttons: [
			]}});

merge(config.shadowTiddlers,{
	DefaultTiddlers: "[[GettingStarted]]",
	MainMenu: "[[GettingStarted]]",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY" "journal">><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options \u00bb" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>'
	});

merge(config.annotations,{
	AdvancedOptions: "This shadow tiddler provides access to several advanced options",
	ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
	DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
	EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
	GettingStarted: "This shadow tiddler provides basic usage instructions",
	ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
	MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
	MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
	MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
	MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
	MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately after the script block",
	OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
	PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
	PluginManager: "This shadow tiddler provides access to the plugin manager",
	SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
	SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
	SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
	SiteTitle: "This shadow tiddler is used as the first part of the page title",
	SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
	StyleSheetColors: "This shadow tiddler contains CSS definitions related to the color of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheet: "This tiddler can contain custom CSS definitions",
	StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
	StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
	SystemSettings: "This tiddler is used to store configuration options for this TiddlyWiki document",
	TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
	TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
	TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
	TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
	TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
	TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
	TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
	ToolbarCommands: "This shadow tiddler determines which commands are shown in tiddler toolbars",
	ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
	});
//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var anim = typeof Animator == "function" ? new Animator() : null; // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var showBackstage; // Whether to include the backstage area
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()

// Whether this file can be saved back to the same location [Preemption]
window.allowSave = window.allowSave || function(l)
{
	return true;
}

// Whether this file is being viewed locally
window.isLocal = function()
{
	return (document.location.protocol == "file:");
}

// Whether to use the JavaSaver applet
var useJavaSaver = window.isLocal() && (config.browser.isSafari || config.browser.isOpera);

// Allow preemption code a chance to tweak config and useJavaSaver [Preemption]
if (window.tweakConfig) window.tweakConfig();

if(!window || !window.console) {
	console = {tiddlywiki:true,log:function(message) {displayMessage(message);}};
}

// Starting up
function main()
{
	window.originalHTML=recreateOriginal();

	var t10,t9,t8,t7,t6,t5,t4,t3,t2,t1,t0 = new Date();
	startingUp = true;
	var doc = jQuery(document);
	jQuery.noConflict();
	window.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};
	params = getParameters();
	if(params)
		params = params.parseParams("open",null,false);
	store = new TiddlyWiki({config:config});
	invokeParamifier(params,"oninit");
	story = new Story("tiddlerDisplay","tiddler");
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	var s;
	for(s=0; s<config.notifyTiddlers.length; s++)
		store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
	t1 = new Date();
	loadShadowTiddlers();
	doc.trigger("loadShadows");
	t2 = new Date();
	store.loadFromDiv("storeArea","store",true);
	doc.trigger("loadTiddlers");
	loadOptions();
	t3 = new Date();
	invokeParamifier(params,"onload");
	t4 = new Date();
	readOnly = window.isLocal() ? false : config.options.chkHttpReadOnly;
	var pluginProblem = loadPlugins("systemConfig");
	doc.trigger("loadPlugins");
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	invokeParamifier(params,"onconfig");
	story.switchTheme(config.options.txtTheme);
	showBackstage = showBackstage !== undefined ? showBackstage : !readOnly;
	t6 = new Date();
	var m;
	for(m in config.macros) {
		if(config.macros[m].init)
			config.macros[m].init();
	}
	t7 = new Date();
	store.notifyAll();
	t8 = new Date();
	restart();
	refreshDisplay();
	t9 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null,"PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	if(showBackstage)
		backstage.init();
	t10 = new Date();
	if(config.options.chkDisplayInstrumentation) {
		displayMessage("LoadShadows " + (t2-t1) + " ms");
		displayMessage("LoadFromDiv " + (t3-t2) + " ms");
		displayMessage("LoadPlugins " + (t5-t4) + " ms");
		displayMessage("Macro init " + (t7-t6) + " ms");
		displayMessage("Notify " + (t8-t7) + " ms");
		displayMessage("Restart " + (t9-t8) + " ms");
		displayMessage("Total: " + (t10-t0) + " ms");
	}
	startingUp = false;
	doc.trigger("startup");
}

// Called on unload. All functions called conditionally since they themselves may have been unloaded.
function unload()
{
	if(window.checkUnsavedChanges)
		checkUnsavedChanges();
	if(window.scrubNodes)
		scrubNodes(document.body);
}

// Restarting
function restart()
{
	invokeParamifier(params,"onstart");
	if(story.isEmpty()) {
		story.displayDefaultTiddlers();
	}
	window.scrollTo(0,0);
}

function saveTest()
{
	var s = document.getElementById("saveTest");
	if(s.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers()
{
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea","shadows",true);
	shadows.forEachTiddler(function(title,tiddler){config.shadowTiddlers[title] = tiddler.text;});
}

function loadPlugins(tag)
{
	if(safeMode)
		return false;
	var tiddlers = store.getTaggedTiddlers(tag);
	tiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : 1);});
	var toLoad = [];
	var nLoaded = 0;
	var map = {};
	var nPlugins = tiddlers.length;
	installedPlugins = [];
	var i;
	for(i=0; i<nPlugins; i++) {
		var p = getPluginInfo(tiddlers[i]);
		installedPlugins[i] = p;
		var n = p.Name || p.title;
		if(n)
			map[n] = p;
		n = p.Source;
		if(n)
			map[n] = p;
	}
	var visit = function(p) {
		if(!p || p.done)
			return;
		p.done = 1;
		var reqs = p.Requires;
		if(reqs) {
			reqs = reqs.readBracketedList();
			var i;
			for(i=0; i<reqs.length; i++)
				visit(map[reqs[i]]);
		}
		toLoad.push(p);
	};
	for(i=0; i<nPlugins; i++)
		visit(installedPlugins[i]);
	for(i=0; i<toLoad.length; i++) {
		p = toLoad[i];
		pluginInfo = p;
		tiddler = p.tiddler;
		if(isPluginExecutable(p)) {
			if(isPluginEnabled(p)) {
				p.executed = true;
				var startTime = new Date();
				try {
					if(tiddler.text)
						window.eval(tiddler.text);
					nLoaded++;
				} catch(ex) {
					p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
					p.error = true;
					if(!console.tiddlywiki) {
						console.log("error evaluating " + tiddler.title, ex);
					}
				}
				pluginInfo.startupTime = String((new Date()) - startTime) + "ms";
			} else {
				nPlugins--;
			}
		} else {
			p.warning = true;
		}
	}
	return nLoaded != nPlugins;
}

function getPluginInfo(tiddler)
{
	var p = store.getTiddlerSlices(tiddler.title,["Name","Description","Version","Requires","CoreVersion","Date","Source","Author","License","Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigForce")) {
		plugin.log.push(config.messages.pluginForced);
		return true;
	}
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0],10) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1],10) - version.minor;
		if(w == 0 && coreVersion[2])
			w = parseInt(coreVersion[2],10) - version.revision;
		if(w > 0) {
			plugin.log.push(config.messages.pluginVersionError);
			return false;
		}
	}
	return true;
}

function isPluginEnabled(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigDisable")) {
		plugin.log.push(config.messages.pluginDisabled);
		return false;
	}
	return true;
}

//--
//-- Paramifiers
//--

function getParameters()
{
	var p = null;
	if(window.location.hash) {
		p = decodeURIComponent(window.location.hash.substr(1));
		if(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < "20051111")
			p = convertUTF8ToUnicode(p);
	}
	return p;
}

function invokeParamifier(params,handler)
{
	if(!params || params.length == undefined || params.length <= 1)
		return;
	var i;
	for(i=1; i<params.length; i++) {
		var p = config.paramifiers[params[i].name];
		if(p && p[handler] instanceof Function)
			p[handler](params[i].value);
		else {
			var h = config.optionHandlers[params[i].name.substr(0,3)];
			if(h && h.set instanceof Function)
				h.set(params[i].name,params[i].value);
		}
	}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(v) {
		if(!readOnly || store.tiddlerExists(v) || store.isShadowTiddler(v))
			story.displayTiddler("bottom",v,null,false,null);
	}
};

config.paramifiers.story = {
	onstart: function(v) {
		var list = store.getTiddlerText(v,"").parseParams("open",null,false);
		invokeParamifier(list,"onstart");
	}
};

config.paramifiers.search = {
	onstart: function(v) {
		story.search(v,false,false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v,false,true);
	}
};

config.paramifiers.tag = {
	onstart: function(v) {
		story.displayTiddlers(null,store.filterTiddlers("[tag["+v+"]]"),null,false,null);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		var args = v.parseParams("anon", null, null)[0];
		var title = args.title ? args.title[0] : v;
		var customFields = args.fields ? args.fields[0] : null;
		if(!readOnly) {
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,customFields);
			story.focusTiddler(title,"text");
			var i,tags = args.tag || [];
			for(i=0;i<tags.length;i++) {
				story.setTiddlerTag(title,tags[i],+1);
			}
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(v) {
		if(!readOnly) {
			var now = new Date();
			var title = now.formatString(v.trim());
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(title,"text");
		}
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};

config.paramifiers.theme = {
	onconfig: function(v) {
		story.switchTheme(v);
	}
};

config.paramifiers.upgrade = {
	onstart: function(v) {
		upgradeFrom(v);
	}
};

config.paramifiers.recent= {
	onstart: function(v) {
		var titles=[];
		var i,tiddlers=store.getTiddlers("modified","excludeLists").reverse();
		for(i=0; i<v && i<tiddlers.length; i++)
			titles.push(tiddlers[i].title);
		story.displayTiddlers(null,titles);
	}
};

config.paramifiers.filter = {
	onstart: function(v) {
		story.displayTiddlers(null,store.filterTiddlers(v),null,false);
	}
};

//--
//-- Formatter helpers
//--

function Formatter(formatters)
{
	var n;
	this.formatters = [];
	var pattern = [];
	for(n=0; n<formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);
	},

	inlineCssHelper: function(w)
	{
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s,v;
			if(lookaheadMatch[1]) {
				s = lookaheadMatch[1].unDash();
				v = lookaheadMatch[2];
			} else {
				s = lookaheadMatch[3].unDash();
				v = lookaheadMatch[4];
			}
			if(s=="bgcolor")
				s = "backgroundColor";
			if(s=="float")
				s = "cssFloat";
			styles.push({style: s, value: v});
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e,styles)
	{
		var t;
		for(t=0; t< styles.length; t++) {
			try {
				e.style[styles[t].style] = styles[t].value;
			} catch (ex) {
			}
		}
	},

	enclosedTextHelper: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE && (config.browser.ieVersion[1] < 10))
				text = text.replace(/\n/g,"\r");
			createTiddlyElement(w.output,this.element,null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link)
	{
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern,"mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if(link.indexOf(".")!=-1 || link.indexOf("\\")!=-1 || link.indexOf("/")!=-1 || link.indexOf("#")!=-1) {
			return true;
		}
		return false;
	}

};

//--
//-- Standard formatters
//--

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
	rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
	cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
	cellTermRegExp: /((?:\x20*)\|)/mg,
	rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},
	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table",null,"twtable");
		var prevColumns = [];
		var currRowType = null;
		var rowContainer;
		var rowCount = 0;
		var onmouseover = function() {jQuery(this).addClass("hoverRow");};
		var onmouseout = function() {jQuery(this).removeClass("hoverRow");};
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var nextRowType = lookaheadMatch[2];
			if(nextRowType == "k") {
				table.className = lookaheadMatch[1];
				w.nextMatch += lookaheadMatch[0].length+1;
			} else {
				if(nextRowType != currRowType) {
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
					currRowType = nextRowType;
				}
				if(currRowType == "c") {
					// Caption
					w.nextMatch++;
					if(rowContainer != table.firstChild)
						table.insertBefore(rowContainer,table.firstChild);
					rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
					w.subWikifyTerm(rowContainer,this.rowTermRegExp);
				} else {
					var theRow = createTiddlyElement(rowContainer,"tr",null,rowCount%2?"oddRow":"evenRow");
					theRow.onmouseover = onmouseover;
					theRow.onmouseout = onmouseout;
					this.rowHandler(w,theRow,prevColumns);
					rowCount++;
				}
			}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var colSpanCount = 1;
		var prevCell = null;
		this.cellRegExp.lastIndex = w.nextMatch;
		var cellMatch = this.cellRegExp.exec(w.source);
		while(cellMatch && cellMatch.index == w.nextMatch) {
			if(cellMatch[1] == "~") {
				// Rowspan
				var last = prevColumns[col];
				if(last) {
					last.rowSpanCount++;
					last.element.setAttribute("rowspan",last.rowSpanCount);
					last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
					last.element.valign = "center";
					if(colSpanCount > 1) {
						last.element.setAttribute("colspan",colSpanCount);
						last.element.setAttribute("colSpan",colSpanCount); // Needed for IE
						colSpanCount = 1;
					}
				}
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[1] == ">") {
				// Colspan
				colSpanCount++;
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[2]) {
				// End of row
				if(prevCell && colSpanCount > 1) {
					prevCell.setAttribute("colspan",colSpanCount);
					prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
				}
				w.nextMatch = this.cellRegExp.lastIndex;
				break;
			} else {
				// Cell
				w.nextMatch++;
				var styles = config.formatterHelpers.inlineCssHelper(w);
				var spaceLeft = false;
				var chr = w.source.substr(w.nextMatch,1);
				while(chr == " ") {
					spaceLeft = true;
					w.nextMatch++;
					chr = w.source.substr(w.nextMatch,1);
				}
				var cell;
				if(chr == "!") {
					cell = createTiddlyElement(e,"th");
					w.nextMatch++;
				} else {
					cell = createTiddlyElement(e,"td");
				}
				prevCell = cell;
				prevColumns[col] = {rowSpanCount:1,element:cell};
				if(colSpanCount > 1) {
					cell.setAttribute("colspan",colSpanCount);
					cell.setAttribute("colSpan",colSpanCount); // Needed for IE
					colSpanCount = 1;
				}
				config.formatterHelpers.applyCssHelper(cell,styles);
				w.subWikifyTerm(cell,this.cellTermRegExp);
				if(w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
					cell.align = spaceLeft ? "center" : "left";
				else if(spaceLeft)
					cell.align = "right";
				w.nextMatch--;
			}
			col++;
			this.cellRegExp.lastIndex = w.nextMatch;
			cellMatch = this.cellRegExp.exec(w.source);
		}
	}
},

{
	name: "heading",
	match: "^!{1,6}",
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
	}
},

{
	name: "list",
	match: "^(?:[\\*#;:]+)",
	lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0, currType = null;
		var listLevel, listType, itemType, baseType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			if(lookaheadMatch[1]) {
				listType = "ul";
				itemType = "li";
			} else if(lookaheadMatch[2]) {
				listType = "ol";
				itemType = "li";
			} else if(lookaheadMatch[3]) {
				listType = "dl";
				itemType = "dt";
			} else if(lookaheadMatch[4]) {
				listType = "dl";
				itemType = "dd";
			}
			if(!baseType)
				baseType = listType;
			listLevel = lookaheadMatch[0].length;
			w.nextMatch += lookaheadMatch[0].length;
			var t;
			if(listLevel > currLevel) {
				for(t=currLevel; t<listLevel; t++) {
					var target = (currLevel == 0) ? stack[stack.length-1] : stack[stack.length-1].lastChild;
					stack.push(createTiddlyElement(target,listType));
				}
			} else if(listType!=baseType && listLevel==1) {
				w.nextMatch -= lookaheadMatch[0].length;
				return;
			} else if(listLevel < currLevel) {
				for(t=currLevel; t>listLevel; t--)
					stack.pop();
			} else if(listLevel == currLevel && listType != currType) {
				stack.pop();
				stack.push(createTiddlyElement(stack[stack.length-1].lastChild,listType));
			}
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement(stack[stack.length-1],itemType);
			w.subWikifyTerm(e,this.termRegExp);
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	termRegExp: /(^<<<(\n|$))/mg,
	element: "blockquote",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "quoteByLine",
	match: "^>+",
	lookaheadRegExp: /^>+/mg,
	termRegExp: /(\n)/mg,
	element: "blockquote",
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t,matched;
		do {
			if(newLevel > currLevel) {
				for(t=currLevel; t<newLevel; t++)
					stack.push(createTiddlyElement(stack[stack.length-1],this.element));
			} else if(newLevel < currLevel) {
				for(t=currLevel; t>newLevel; t--)
					stack.pop();
			}
			currLevel = newLevel;
			w.subWikifyTerm(stack[stack.length-1],this.termRegExp);
			createTiddlyElement(stack[stack.length-1],"br");
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched) {
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
			}
		} while(matched);
	}
},

{
	name: "rule",
	match: "^----+$\\n?|<hr ?/?>\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "monospacedByLine",
	match: "^(?:/\\*\\{\\{\\{\\*/|\\{\\{\\{|//\\{\\{\\{|<!--\\{\\{\\{-->)\\n",
	element: "pre",
	handler: function(w)
	{
		switch(w.matchText) {
		case "/*{{{*/\n": // CSS
			this.lookaheadRegExp = /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\*\}\}\}\*\/$\n?)/mg;
			break;
		case "{{{\n": // monospaced block
			this.lookaheadRegExp = /^\{\{\{\n((?:^[^\n]*\n)+?)(^\f*\}\}\}$\n?)/mg;
			break;
		case "//{{{\n": // plugin
			this.lookaheadRegExp = /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\/\}\}\}$\n?)/mg;
			break;
		case "<!--{{{-->\n": //template
			this.lookaheadRegExp = /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^\f*<!--\}\}\}-->$\n?)/mg;
			break;
		default:
			break;
		}
		config.formatterHelpers.enclosedTextHelper.call(this,w);
	}
},

{
	name: "wikifyComment",
	match: "^(?:/\\*\\*\\*|<!---)\\n",
	handler: function(w)
	{
		var termRegExp = (w.matchText == "/***\n") ? (/(^\*\*\*\/\n)/mg) : (/(^--->\n)/mg);
		w.subWikifyTerm(w.output,termRegExp);
	}
},

{
	name: "macro",
	match: "<<",
	lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
		}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e;
			var text = lookaheadMatch[1];
			if(lookaheadMatch[3]) {
				// Pretty bracketted link
				var link = lookaheadMatch[3];
				e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link)) ?
						createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
			} else {
				// Simple bracketted link
				e = createTiddlyLink(w.output,text,false,null,w.isStatic,w.tiddler);
			}
			createTiddlyText(e,text);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "wikiLink",
	match: config.textPrimitives.unWikiLink+"?"+config.textPrimitives.wikiLink,
	handler: function(w)
	{
		if(w.matchText.substr(0,1) == config.textPrimitives.unWikiLink) {
			w.outputText(w.output,w.matchStart+1,w.nextMatch);
			return;
		}
		if(w.matchStart > 0) {
			var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,"mg");
			preRegExp.lastIndex = w.matchStart-1;
			var preMatch = preRegExp.exec(w.source);
			if(preMatch.index == w.matchStart-1) {
				w.outputText(w.output,w.matchStart,w.nextMatch);
				return;
			}
		}
		if(w.autoLinkWikiWords || store.isShadowTiddler(w.matchText)) {
			var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);
			w.outputText(link,w.matchStart,w.nextMatch);
		} else {
			w.outputText(w.output,w.matchStart,w.nextMatch);
		}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[[<>]?[Ii][Mm][Gg]\\[",
	lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e = w.output;
			if(lookaheadMatch[5]) {
				var link = lookaheadMatch[5];
				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
				jQuery(e).addClass("imageLink");
			}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3]) {
				img.title = lookaheadMatch[3];
				img.setAttribute("alt",lookaheadMatch[3]);
			}
			img.src = lookaheadMatch[4];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span").innerHTML = lookaheadMatch[1];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: "characterFormat",
	match: "''|//|__|\\^\\^|~~|--(?!\\s|$)|\\{\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "''":
			w.subWikifyTerm(w.output.appendChild(document.createElement("strong")),/('')/mg);
			break;
		case "//":
			w.subWikifyTerm(createTiddlyElement(w.output,"em"),/(\/\/)/mg);
			break;
		case "__":
			w.subWikifyTerm(createTiddlyElement(w.output,"u"),/(__)/mg);
			break;
		case "^^":
			w.subWikifyTerm(createTiddlyElement(w.output,"sup"),/(\^\^)/mg);
			break;
		case "~~":
			w.subWikifyTerm(createTiddlyElement(w.output,"sub"),/(~~)/mg);
			break;
		case "--":
			w.subWikifyTerm(createTiddlyElement(w.output,"strike"),/(--)/mg);
			break;
		case "{{{":
			var lookaheadRegExp = /\{\{\{((?:.|\n)*?)\}\}\}/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
				w.nextMatch = lookaheadRegExp.lastIndex;
			}
			break;
		}
	}
},

{
	name: "customFormat",
	match: "@@|\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "@@":
			var e = createTiddlyElement(w.output,"span");
			var styles = config.formatterHelpers.inlineCssHelper(w);
			if(styles.length == 0)
				e.className = "marked";
			else
				config.formatterHelpers.applyCssHelper(e,styles);
			w.subWikifyTerm(e,/(@@)/mg);
			break;
		case "{{":
			var lookaheadRegExp = /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch) {
				w.nextMatch = lookaheadRegExp.lastIndex;
				e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
				w.subWikifyTerm(e,/(\}\}\})/mg);
			}
			break;
		}
	}
},

{
	name: "mdash",
	match: "--",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
	}
},

{
	name: "lineBreak",
	match: "\\n|<br ?/?>",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
},

{
	name: "rawText",
	match: "\"{3}|<nowiki>",
	lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "htmlEntitiesEncoding",
	match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = w.matchText;
	}
}

];

//--
//-- Wikifier
//--

function getParser(tiddler,format)
{
	if(tiddler) {
		if(!format)
			format = tiddler.fields["wikiformat"];
		var i;
		if(format) {
			for(i in config.parsers) {
				if(format == config.parsers[i].format)
					return config.parsers[i];
			}
		} else {
			for(i in config.parsers) {
				if(tiddler.isTagged(config.parsers[i].formatTag))
					return config.parsers[i];
			}
		}
	}
	return formatter;
}

function Wikifier(source,formatter,highlightRegExp,tiddler)
{
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	this.subWikify(e);
	var text = jQuery(e).text();
	jQuery(e).remove();
	return text;
};

Wikifier.prototype.subWikify = function(output,terminator)
{
	try {
		if(terminator)
			this.subWikifyTerm(output,new RegExp("(" + terminator + ")","mg"));
		else
			this.subWikifyUnterm(output);
	} catch(ex) {
		showException(ex);
	}
};

Wikifier.prototype.subWikifyUnterm = function(output)
{
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	while(formatterMatch) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		var t;
		for(t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)
{
	var oldOutput = this.output;
	this.output = output;
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		var t;
		for(t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place,this.source.substring(startPos,endPos));
	}
};

function wikify(source,output,highlightRegExp,tiddler)
{
	if(source) {
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		var t0 = new Date();
		wikifier.subWikify(output);
		if(tiddler && config.options.chkDisplayInstrumentation)
			displayMessage("wikify:" +tiddler.title+ " in " + (new Date()-t0) + " ms");
	}
}

function wikifyStatic(source,highlightRegExp,tiddler,format)
{
	var e = createTiddlyElement(document.body,"pre");
	e.style.display = "none";
	var html = "";
	if(source && source != "") {
		if(!tiddler)
			tiddler = new Tiddler("temp");
		var wikifier = new Wikifier(source,getParser(tiddler,format),highlightRegExp,tiddler);
		wikifier.isStatic = true;
		wikifier.subWikify(e);
		html = e.innerHTML;
		jQuery(e).remove();
	}
	return html;
}

function wikifyPlainText(text,limit,tiddler)
{
	if(limit > 0)
		text = text.substr(0,limit);
	var wikifier = new Wikifier(text,formatter,null,tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source,output,highlightRegExp,tiddler)
{
	if(source) {
		var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
		wikifier.outputText(output,0,source.length);
	}
}

//--
//-- Macro definitions
//--

function invokeMacro(place,macro,params,wikifier,tiddler)
{
	try {
		var m = config.macros[macro];
		if(m && m.handler) {
			var tiddlerElem = story.findContainingTiddler(place);
			window.tiddler = tiddlerElem ? store.getTiddler(tiddlerElem.getAttribute("tiddler")) : null;
			window.place = place;
			var allowEval = true;
			if(config.evaluateMacroParameters=="system") {
				if(!tiddler || tiddler.tags.indexOf("systemAllowEval") == -1) {
					allowEval = false;
				}
			}
			m.handler(place,macro,m.noPreParse?null:params.readMacroParams(!allowEval),wikifier,params,tiddler);
		} else {
			createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
		}
	} catch(ex) {
		createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
	}
}

config.macros.version.handler = function(place)
{
	jQuery("<span/>").text(formatVersion()).appendTo(place);
};

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text = params[0] ? now.formatString(params[0].trim()) : now.toLocaleString();
	jQuery("<span/>").text(text).appendTo(place);
};

config.macros.list.template = "<<view title link>>";
config.macros.list.handler = function(place,macroName,params,wikifier,paramString)
{
	var list = document.createElement("ul");
	jQuery(list).attr({ refresh: "macro", macroName: macroName }).data("params", paramString);
	place.appendChild(list);
	this.refresh(list);
};

config.macros.list.refresh = function(list) {
	var paramString = jQuery(list).data("params");
	var params = paramString.readMacroParams();
	var args = paramString.parseParams("anon", null, null)[0];
	var type = args.anon ? args.anon[0] : "all";
	jQuery(list).empty().addClass("list list-" + type);
	var template = args.template ? store.getTiddlerText(args.template[0]) : false;
	if(!template) {
		template = config.macros.list.template;
	}
	if(this[type].prompt)
		createTiddlyElement(list,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	var t;
	for(t = 0; t < results.length; t++) {
		var li = document.createElement("li");
		list.appendChild(li);
		var tiddler = results[t];
		if(typeof(tiddler) == 'string') { // deal with missing etc..
				tiddler = store.getTiddler(tiddler) || new Tiddler(tiddler);
		}
		wikify(template, li, null, tiddler);
	}
	if(results.length === 0 && args.emptyMessage) {
		jQuery(list).addClass("emptyList");
		jQuery("<li />").text(args.emptyMessage[0]).appendTo(list);
	}
};

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
};

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params)
{
	return store.getTouched();
};

config.macros.list.filter.handler = function(params)
{
	var filter = params[1];
	var results = [];
	if(filter) {
		var tiddlers = store.filterTiddlers(filter);
		var t;
		for(t=0; t<tiddlers.length; t++)
			results.push(tiddlers[t].title);
	}
	return results;
};

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place,"ul");
	if(tags.length == 0)
		createTiddlyElement(ul,"li",null,"listTitle",this.noTags);
	var t;
	for(t=0; t<tags.length; t++) {
		var title = tags[t][0];
		var info = getTiddlyLinkInfo(title);
		var li = createTiddlyElement(ul,"li");
		var btn = createTiddlyButton(li,title + " (" + tags[t][1] + ")",this.tooltip.format([title]),onClickTag,info.classes);
		btn.setAttribute("tag",title);
		btn.setAttribute("refresh","link");
		btn.setAttribute("tiddlyLink",title);
		if(params[1]) {
			btn.setAttribute("sortby",params[1]);
		}
	}
};

var macro = config.macros.timeline;
merge(macro, {
	handler: function(place,macroName,params, wikifier, paramString, tiddler) {
		var container = jQuery("<div />").attr("params", paramString).
			attr("macroName", macroName).appendTo(place)[0];
		macro.refresh(container);
	},
	refresh: function(container) {
		jQuery(container).attr("refresh", "macro").empty();
		var paramString = jQuery(container).attr("params");
		var args = paramString.parseParams("anon", null, null)[0];
		var params = args.anon || [];

		var field = params[0] || "modified";
		var prefix = field.charAt(0);
		var no_prefix_field = prefix === "-" || prefix === "+" ? field.substr(1, field.length) : field;
		var dateFormat = params[2] || this.dateFormat;
		var groupTemplate = macro.groupTemplate.format(no_prefix_field, dateFormat);
		groupTemplate = args.groupTemplate ? store.getTiddlerText(args.groupTemplate[0]) || groupTemplate :
			groupTemplate;

		var itemTemplate = macro.itemTemplate;
		itemTemplate = args.template ? store.getTiddlerText(args.template[0]) || itemTemplate :
			itemTemplate;

		var tiddlers = args.filter ? store.sortTiddlers(store.filterTiddlers(args.filter[0]), field) :
			store.reverseLookup("tags", "excludeLists", false, field);
		var lastGroup = "", ul;
		var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1],10)) : 0;
		var t;
		for(t=tiddlers.length-1; t>=last; t--) {
			var tiddler = tiddlers[t];
			var theGroup = wikifyPlainText(groupTemplate,0,tiddler);
			if(typeof(ul) == "undefined" || theGroup != lastGroup) {
				ul = document.createElement("ul");
				jQuery(ul).addClass("timeline");
				container.appendChild(ul);
				createTiddlyElement(ul,"li",null,"listTitle",theGroup);
				lastGroup = theGroup;
			}
			var item = createTiddlyElement(ul,"li",null,"listLink");
			wikify(itemTemplate,item,null,tiddler);
		}
	},
	groupTemplate: "<<view %0 date '%1'>>", 
	itemTemplate: "<<view title link>>"
});

config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var allowEval = true;
	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.length > 0 && config.evaluateMacroParameters == "system") {
		// included tiddler and "system" evaluation required, so check tiddler tagged appropriately
		var title = stack[stack.length-1];
		var pos = title.indexOf(config.textPrimitives.sectionSeparator);
		if(pos != -1) {
			title = title.substr(0,pos); // get the base tiddler title
		}
		var t = store.getTiddler(title);
		if(!t || t.tags.indexOf("systemAllowEval") == -1) {
			allowEval = false;
		}
	}
	params = paramString.parseParams("name",null,allowEval,false,true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] || null;
	var args = params[0]["with"];
	var wrapper = createTiddlyElement(place,"span",null,className,null,{
		refresh: "content", tiddler: tiddlerName
	});
	if(args!==undefined)
		wrapper.setAttribute("args","[["+args.join("]] [[")+"]]");
	this.transclude(wrapper,tiddlerName,args);
};

config.macros.tiddler.transclude = function(wrapper,tiddlerName,args)
{
	var text = store.getTiddlerText(tiddlerName);
	if(!text)
		return;
	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.indexOf(tiddlerName) !== -1)
		return;
	stack.push(tiddlerName);
	try {
		if(typeof args == "string")
			args = args.readBracketedList();
		var n = args ? Math.min(args.length,9) : 0;
		var i;
		for(i=0; i<n; i++) {
			var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
			text = text.replace(placeholderRE,args[i]);
		}
		config.macros.tiddler.renderText(wrapper,text,tiddlerName);
	} finally {
		stack.pop();
	}
};

config.macros.tiddler.renderText = function(place,text,tiddlerName)
{
	wikify(text,place,null,store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
	var btn = createTagButton(place,params[0],null,params[1],params[2]);
	if(params[3]) {
		btn.setAttribute('sortby',params[3]);
	}
};

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params,"sep"," ");
	var lingo = config.views.wikified.tag;
	var label = null;
	var t;
	for(t=0; t<tiddler.tags.length; t++) {
		var tag = store.getTiddler(tiddler.tags[t]);
		if(!tag || !tag.tags.contains("excludeLists")) {
			if(!label)
				label = createTiddlyElement(ul,"li",null,"listTitle",lingo.labelTags.format([tiddler.title]));
			createTagButton(createTiddlyElement(ul,"li"),tiddler.tags[t],tiddler.title);
			if(t<tiddler.tags.length-1)
				createTiddlyText(ul,sep);
		}
	}
	if(!label)
		createTiddlyElement(ul,"li",null,"listTitle",lingo.labelNoTags.format([tiddler.title]));
};

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params,"sep"," ");
	ul.setAttribute("title",this.tooltip.format([title]));
	var sortby = getParam(params,"sortBy",false);
	var tagged = store.getTaggedTiddlers(title,sortby);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
	createTiddlyElement(ul,"li",null,"listTitle",prompt.format([title,tagged.length]));
	var t;
	for(t=0; t<tagged.length; t++) {
		createTiddlyLink(createTiddlyElement(ul,"li"),tagged[t].title,true);
		if(t<tagged.length-1)
			createTiddlyText(ul,sep);
	}
};

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.closeAll.onClick = function(e)
{
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.permaview.onClick = function(e)
{
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place,macroName,params)
{
	if(!readOnly)
		createTiddlyButton(place,params[0] || this.label,params[1] || this.prompt,this.onClick,null,null,this.accessKey);
};

config.macros.saveChanges.onClick = function(e)
{
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(ev)
{
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n,!isOpen,null,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOption(cookie);
	return false;
};

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
	var c = cookie || "";
	createTiddlyButton(place,title,tooltip,this.onClickSlider);
	var panel = createTiddlyElement(null,"div",null,"sliderPanel");
	panel.setAttribute("cookie",c);
	panel.style.display = config.options[c] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place,macroName,params)
{
	var panel = this.createSlider(place,params[0],params[2],params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh","content");
	panel.setAttribute("tiddler",params[1]);
	if(text)
		wikify(text,panel,null,store.getTiddler(params[1]));
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var panel = wikifier ? createTiddlyElement(place,"div",null,"gradient") : place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel,styles);
	}
	params = paramString.parseParams("color");
	var locolors = [], hicolors = [];
	var t;
	for(t=2; t<params.length; t++) {
		var c = params[t].value;
		if(params[t].name == "snap") {
			hicolors[hicolors.length-1] = c;
		} else {
			locolors.push(c);
			hicolors.push(c);
		}
	}
	drawGradient(panel,params[1].value != "vert",locolors,hicolors);
	if(wikifier)
		wikifier.subWikify(panel,">>");
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place,macroName,params)
{
	if(params[0]) {
		var names = params[0].split(".");
		var lookupMessage = function(root,nameIndex) {
				if(root[names[nameIndex]]) {
					if(nameIndex < names.length-1)
						return (lookupMessage(root[names[nameIndex]],nameIndex+1));
					else
						return root[names[nameIndex]];
				} else
					return null;
			};
		var m = lookupMessage(config,0);
		if(m == null)
			m = lookupMessage(window,0);
		createTiddlyText(place,m.toString().format(params.splice(1)));
	}
};


config.macros.view.depth = 0;
config.macros.view.values = [];
config.macros.view.views = {
	text: function(value,place,params,wikifier,paramString,tiddler) {
		highlightify(value,place,highlightHack,tiddler);
	},
	link: function(value,place,params,wikifier,paramString,tiddler) {
		createTiddlyLink(place,value,true);
	},
	wikified: function(value,place,params,wikifier,paramString,tiddler) {
		if(config.macros.view.depth>50)
			return;
		if(config.macros.view.depth>0) {
			if (value==config.macros.view.values[config.macros.view.depth-1]) {
				return;
			}
		}
		config.macros.view.values[config.macros.view.depth] = value;
		config.macros.view.depth++;
		if(params[2])
			value=params[2].unescapeLineBreaks().format([value]);
		wikify(value,place,highlightHack,tiddler);
		config.macros.view.depth--;
		config.macros.view.values[config.macros.view.depth] = null;
	},
	date: function(value,place,params,wikifier,paramString,tiddler) {
		value = Date.convertFromYYYYMMDDHHMM(value);
		createTiddlyText(place,value.formatString(params[2] || config.views.wikified.dateFormat));
	}
};

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) && params[0]) {
		var value = store.getValue(tiddler,params[0]);
		if(value) {
			var type = params[1] || config.macros.view.defaultView;
			var handler = config.macros.view.views[type];
			if(handler)
				handler(value,place,params,wikifier,paramString,tiddler);
		}
	}
};

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var field = params[0];
	var rows = params[1] || 0;
	var defVal = params[2] || '';
	if((tiddler instanceof Tiddler) && field) {
		story.setDirty(tiddler.title,true);
		var e,v;
		if(field != "text" && !rows) {
			e = createTiddlyElement(null,"input",null,null,null,{
				type: "text", edit: field, size: "40", autocomplete: "off"
			});
			e.value = store.getValue(tiddler,field) || defVal;
			place.appendChild(e);
		} else {
			var wrapper1 = createTiddlyElement(null,"fieldset",null,"fieldsetFix");
			var wrapper2 = createTiddlyElement(wrapper1,"div");
			e = createTiddlyElement(wrapper2,"textarea");
			e.value = v = store.getValue(tiddler,field) || defVal;
			rows = rows || 10;
			var lines = v.match(/\n/mg);
			var maxLines = Math.max(parseInt(config.options.txtMaxEditRows,10),5);
			if(lines != null && lines.length > rows)
				rows = lines.length + 5;
			rows = Math.min(rows,maxLines);
			e.setAttribute("rows",rows);
			e.setAttribute("edit",field);
			place.appendChild(wrapper1);
		}
		if(tiddler.isReadOnly()) {
			e.setAttribute("readOnly","readOnly");
			jQuery(e).addClass("readOnly");
		}
		return e;
	}
};

config.macros.tagChooser.onClick = function(ev)
{
	var e = ev || window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags(this.getAttribute("tags"));
	if(tags.length == 0)
		jQuery("<li/>").text(lingo.popupNone).appendTo(popup);
	var t;
	for(t=0; t<tags.length; t++) {
		var tag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
		tag.setAttribute("tag",tags[t][0]);
		tag.setAttribute("tiddler",this.getAttribute("tiddler"));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(ev)
{
	var e = ev || window.event;
	if(e.metaKey || e.ctrlKey) stopEvent(e); //# keep popup open on CTRL-click
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly)
		story.setTiddlerTag(title,tag,0);
	return false;
};

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(tiddler instanceof Tiddler) {
		var lingo = config.views.editor.tagChooser;
		var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
		btn.setAttribute("tiddler",tiddler.title);
		btn.setAttribute("tags",params[0]);
	}
};

config.macros.refreshDisplay.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.refreshDisplay.onClick = function(e)
{
	refreshAll();
	return false;
};

config.macros.annotations.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var title = tiddler ? tiddler.title : null;
	var a = title ? config.annotations[title] : null;
	if(!tiddler || !title || !a)
		return;
	var text = a.format([title]);
	wikify(text,createTiddlyElement(place,"div",null,"annotation"),null,tiddler);
};
//--
//-- NewTiddler and NewJournal macros
//--

config.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)
{
	var tags = [];
	var t;
	for(t=1; t<params.length; t++) {
		if((params[t].name == "anon" && t != 1) || (params[t].name == "tag"))
			tags.push(params[t].value);
	}
	label = getParam(params,"label",label);
	prompt = getParam(params,"prompt",prompt);
	accessKey = getParam(params,"accessKey",accessKey);
	newFocus = getParam(params,"focus",newFocus);
	var customFields = getParam(params,"fields","");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	var btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);
	btn.setAttribute("newTitle",title);
	btn.setAttribute("isJournal",isJournal ? "true" : "false");
	if(tags.length > 0)
		btn.setAttribute("params",tags.join("|"));
	btn.setAttribute("newFocus",newFocus);
	btn.setAttribute("newTemplate",getParam(params,"template",DEFAULT_EDIT_TEMPLATE));
	if(customFields !== "")
		btn.setAttribute("customFields",customFields);
	var text = getParam(params,"text");
	if(text !== undefined)
		btn.setAttribute("newText",text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function()
{
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal") == "true") {
		title = new Date().formatString(title.trim());
	}
	var params = this.getAttribute("params");
	var tags = params ? params.split("|") : [];
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	story.displayTiddler(null,title,template,false,null,null);
	var tiddlerElem = story.getTiddler(title);
	if(customFields)
		story.addCustomFields(tiddlerElem,customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string" && story.getTiddlerField(title,"text"))
		story.getTiddlerField(title,"text").value = text.format([title]);
	var t;
	for(t=0;t<tags.length;t++)
		story.setTiddlerTag(title,tags[t],+1);
	story.focusTiddler(title,focus);
	return false;
};

config.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
		title = getParam(params,"title",title);
		this.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"title",false);
	}
};

config.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : config.macros.timeline.dateFormat;
		title = getParam(params,"title",title);
		config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"text",true);
	}
};

//--
//-- Search macro
//--

config.macros.search.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,false,false,false);
	createTiddlyButton(place,this.label,this.prompt,this.onClick,"searchButton");
	var txt = createTiddlyElement(null,"input",null,"txtOptionInput searchField");
	txt.value = getParam(params,"anon","");
	if(config.browser.isSafari) {
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
	} else {
		txt.setAttribute("type","text");
	}
	place.appendChild(txt);
	txt.onkeyup = this.onKeyPress;
	txt.onfocus = this.onFocus;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",getParam(params,"accesskey",this.accessKey));
	txt.setAttribute("autocomplete","off");
	txt.setAttribute("lastSearchText","");
	txt.setAttribute("placeholder",getParam(params,"placeholder",this.placeholder));
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
	if(txt.value.length > 0) {
		story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
		txt.setAttribute("lastSearchText",txt.value);
	}
};

config.macros.search.onClick = function(e)
{
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(ev)
{
	var me = config.macros.search;
	var e = ev || window.event;
	switch(e.keyCode) {
		case 9: // Tab
			return;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			me.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(config.options.chkIncrementalSearch) {
		if(this.value.length > 2) {
			if(this.value != this.getAttribute("lastSearchText")) {
				if(me.timeout) {
					clearTimeout(me.timeout);
				}
				var txt = this;
				me.timeout = setTimeout(function() {me.doSearch(txt);},500);
			}
		} else {
			if(me.timeout) {
				clearTimeout(me.timeout);
			}
		}
	}
};

config.macros.search.onFocus = function(e)
{
	this.select();
};

//--
//-- Tabs macro
//--

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(null,"div",null,"tabsetWrapper " + cookie);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset");
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	var t;
	for(t=0; t<numTabs; t++) {
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		createTiddlyElement(tab,"span",null,null," ",{style:"font-size:0pt;line-height:0px"});
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset,config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	var t;
	for(t=0; t<nodes.length; t++) {
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab) {
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
		} else {
			nodes[t].className = "tab tabUnselected";
		}
	}
	if(theTab) {
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			jQuery(tabset.nextSibling).remove();
		var tabContent = createTiddlyElement(null,"div",null,"tabContents");
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		var contentTitle = theTab.getAttribute("content");
		wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
		if(cookie) {
			config.options[cookie] = tab;
			saveOption(cookie);
		}
	}
};

//--
//-- Tiddler toolbar
//--

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,className)
{
	if(typeof commandName != "string") {
		var c = null;
		var t;
		for(t in config.commands) {
			if(config.commands[t] == commandName)
				c = t;
		}
		commandName = c;
	}
	if((tiddler instanceof Tiddler) && (typeof commandName == "string")) {
		var command = config.commands[commandName];
		if(command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command,tiddler)) {
			var text = command.getText ? command.getText(tiddler) : this.getCommandText(command,tiddler);
			var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command,tiddler);
			var cmd = command.type == "popup" ? this.onClickPopup : this.onClickCommand;
			var btn = createTiddlyButton(null,text,tooltip,cmd);
			btn.setAttribute("commandName",commandName);
			btn.setAttribute("tiddler",tiddler.title);
			jQuery(btn).addClass("command_" + commandName);
			if(className)
				jQuery(btn).addClass(className);
			place.appendChild(btn);
		}
	}
};

config.macros.toolbar.isCommandEnabled = function(command,tiddler)
{
	var title = tiddler.title;
	var ro = tiddler.isReadOnly();
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	return (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);
};

config.macros.toolbar.getCommandText = function(command,tiddler)
{
	return (tiddler.isReadOnly() && command.readOnlyText) || command.text;
};

config.macros.toolbar.getCommandTooltip = function(command,tiddler)
{
	return (tiddler.isReadOnly() && command.readOnlyTooltip) || command.tooltip;
};

config.macros.toolbar.onClickCommand = function(ev)
{
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e,this,this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(ev)
{
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var command = config.commands[this.getAttribute("commandName")];
	var title = this.getAttribute("tiddler");
	popup.setAttribute("tiddler",title);
	command.handlePopup(popup,title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,className,event)
{
	var children = place.getElementsByTagName("a");
	var t;
	for(t=0; t<children.length; t++) {
		var c = children[t];
		if(jQuery(c).hasClass(className) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c,event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(ev)
{
	var e = this.nextSibling;
	e.style.display = "inline";
	this.style.display = "none";
	return false;
};

config.macros.toolbar.onClickLess = function(ev)
{
	var e = this.parentNode;
	var m = e.previousSibling;
	e.style.display = "none";
	m.style.display = "inline";
	return false;
};

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var t;
	for(t=0; t<params.length; t++) {
		var btn;
		var c = params[t];
		switch(c) {
		case "!":
			createTiddlyText(place,this.separator);
			break;
		case "*":
			createTiddlyElement(place,"br");
			break;
		case "<":
			btn = createTiddlyButton(place,this.lessLabel,this.lessPrompt,config.macros.toolbar.onClickLess);
			jQuery(btn).addClass("lessCommand");
			break;
		case ">":
			btn = createTiddlyButton(place,this.moreLabel,this.morePrompt,config.macros.toolbar.onClickMore);
			jQuery(btn).addClass("moreCommand");
			var e = createTiddlyElement(place,"span",null,"moreCommand");
			e.style.display = "none";
			place = e;
			break;
		default:
			var className = "";
			switch(c.substr(0,1)) {
			case "+":
				className = "defaultCommand";
				c = c.substr(1);
				break;
			case "-":
				className = "cancelCommand";
				c = c.substr(1);
				break;
			}
			if(config.commands[c]) {
				this.createCommand(place,c,tiddler,className);
			} else {
				this.customCommand(place,c,wikifier,tiddler);
			}
			break;
		}
	}
};

// Overrideable function to extend toolbar handler
config.macros.toolbar.customCommand = function(place,command,wikifier,tiddler)
{
};

//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event,src,title)
{
	if(story.isDirty(title) && !readOnly) {
		if(!confirm(config.commands.cancelTiddler.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.closeTiddler(title,true);
	return false;
};

config.commands.closeOthers.handler = function(event,src,title)
{
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event,src,title)
{
	clearMessage();
	var tiddlerElem = story.getTiddler(title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,fields);
	var e = story.getTiddlerField(title,config.options.txtEditorFocus||"text");
	if(e) {
		setCaretPosition(e,0);
	}
	return false;
};

config.commands.saveTiddler.handler = function(event,src,title)
{
	var newTitle = story.saveTiddler(title,event.shiftKey);
	if(newTitle)
		story.displayTiddler(null,newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event,src,title)
{
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.displayTiddler(null,title);
	return false;
};

config.commands.deleteTiddler.handler = function(event,src,title)
{
	var deleteIt = true;
	if(config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if(deleteIt) {
		store.removeTiddler(title);
		story.closeTiddler(title,true);
		autoSaveChanges();
	}
	return false;
};

config.commands.permalink.handler = function(event,src,title)
{
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if(window.location.hash != t)
		window.location.hash = t;
	return false;
};

config.commands.references.handlePopup = function(popup,title)
{
	var references = store.getReferringTiddlers(title);
	var c = false;
	var r;
	for(r=0; r<references.length; r++) {
		if(references[r].title != title && !references[r].isTagged("excludeLists")) {
			createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
			c = true;
		}
	}
	if(!c)
		createTiddlyElement(popup,"li",null,"disabled",this.popupNone);
};

config.commands.jump.handlePopup = function(popup,title)
{
	story.forEachTiddler(function(title,element) {
		createTiddlyLink(createTiddlyElement(popup,"li"),title,true,null,false,null,true);
		});
};

config.commands.fields.handlePopup = function(popup,title)
{
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var items = [];
	store.forEachField(tiddler,function(tiddler,fieldName,value){items.push({field:fieldName,value:value});},true);
	items.sort(function(a,b) {return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1);});
	if(items.length > 0)
		ListView.create(popup,items,this.listViewTemplate);
	else
		createTiddlyElement(popup,"div",null,null,this.emptyText);
};

//--
//-- Tiddler() object
//--

function Tiddler(title)
{
	this.title = title;
	this.text = "";
	this.creator = null;
	this.modifier = null;
	this.created = new Date();
	this.modified = this.created;
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function()
{
	if(this.linksUpdated==false)
		this.changed();
	return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function()
{
	var f = {};
	var i;
	for(i in this.fields) {
		if(i=="server.host" || i=="server.workspace" || i=="wikiformat"|| i=="server.type") {
			f[i] = this.fields[i];
		}
	}
	return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function()
{
	var c = this.fields['changecount'];
	c = c ? parseInt(c,10) : 0;
	this.fields['changecount'] = String(c+1);
};

// Clear the changeCount of a tiddler
Tiddler.prototype.clearChangeCount = function()
{
	if(this.fields['changecount']) {
		delete this.fields['changecount'];
	}
};

Tiddler.prototype.doNotSave = function()
{
	return this.fields['doNotSave'];
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function()
{
	var changecount = this.fields.changecount || 0;
	return changecount > 0;
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields,creator)
{
	this.assign(title,text,modifier,modified,tags,created,fields,creator);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields,creator)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(creator != undefined)
		this.creator = creator;
	if(created != undefined)
		this.created = created;
	if(fields != undefined)
		this.fields = fields;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined)
		this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var text = this.text;
	// remove 'quoted' text before scanning tiddler source
	text = text.replace(/\/%((?:.|\n)*?)%\//g,"").
		replace(/\{{3}((?:.|\n)*?)\}{3}/g,"").
		replace(/"""((?:.|\n)*?)"""/g,"").
		replace(/<nowiki\>((?:.|\n)*?)<\/nowiki\>/g,"").
		replace(/<html\>((?:.|\n)*?)<\/html\>/g,"").
		replace(/<script((?:.|\n)*?)<\/script\>/g,"");
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t==0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink+"|"+config.textPrimitives.anyLetter,"mg");
				preRegExp.lastIndex = formatMatch.index-1;
				var preMatch = preRegExp.exec(text);
				if(preMatch.index != formatMatch.index-1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2-t] && !config.formatterHelpers.isExternalLink(formatMatch[3-t])) // titledBrackettedLink
			this.links.pushUnique(formatMatch[3-t]);
		else if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4-t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function()
{
	var modifier = this.modifier;
	if(!modifier)
		modifier = config.messages.subtitleUnknown || "";
	var modified = this.modified;
	if(modified)
		modified = modified.toLocaleString();
	else
		modified = config.messages.subtitleUnknown || "";
	var f = config.messages.tiddlerLinkTooltip || "%0 - %1, %2";
	return f.format([this.title,modifier,modified]);
};

Tiddler.prototype.isReadOnly = function()
{
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function()
{
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.getServerType = function()
{
	var serverType = null;
	if(this.fields['server.type'])
		serverType = this.fields['server.type'];
	if(!serverType)
		serverType = this.fields['wikiformat'];
	if(serverType && !config.adaptors[serverType])
		serverType = null;
	return serverType;
};

Tiddler.prototype.getAdaptor = function()
{
	var serverType = this.getServerType();
	return serverType ? new config.adaptors[serverType]() : null;
};

//--
//-- TiddlyWiki instance contains TiddlerS
//--

function TiddlyWiki(params)
{
	var tiddlers = {}; // Hashmap by name of tiddlers
	if(params && params.config) {
		this.config = config;
	}
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		var t = tiddlers[title];
		return t instanceof Tiddler ? t : null;
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		var t;
		for(t in tiddlers) {
			var tiddler = tiddlers[t];
			if(tiddler instanceof Tiddler)
				callback.call(this,t,tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function()
{
	return this.dirty;
};

TiddlyWiki.prototype.tiddlerExists = function(title)
{
	var t = this.fetchTiddler(title);
	return t != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
	return config.shadowTiddlers[title] === undefined ? false : true;
};

TiddlyWiki.prototype.isAvailable = function(title) {
	if (!title)
		return false;
	var s = title ? title.indexOf(config.textPrimitives.sectionSeparator) : -1;
	if(s!=-1)
		title = title.substr(0,s);
	return this.tiddlerExists(title) || this.isShadowTiddler(title);
};

TiddlyWiki.prototype.createTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler(title);
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

TiddlyWiki.prototype.getTiddler = function(title)
{
	var t = this.fetchTiddler(title);
	if(t != undefined)
		return t;
	else
		return null;
};

TiddlyWiki.prototype.getShadowTiddlerText = function(title)
{
	if(typeof config.shadowTiddlers[title] == "string")
		return config.shadowTiddlers[title];
	else
		return "";
};

// Retrieve tiddler contents
TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
	if(!title)
		return defaultText;
	var pos = title.indexOf(config.textPrimitives.sectionSeparator);
	var section = null;
	if(pos != -1) {
		section = title.substr(pos + config.textPrimitives.sectionSeparator.length);
		title = title.substr(0,pos);
	}
	pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));
		if(slice)
			return slice;
	}
	var tiddler = this.fetchTiddler(title);
	var text = tiddler ? tiddler.text : null;
	if(!tiddler && this.isShadowTiddler(title)) {
		text = this.getShadowTiddlerText(title);
	}
	if(text) {
		if(!section)
			return text;
		var re = new RegExp("(^!{1,6}[ \t]*" + section.escapeRegExp() + "[ \t]*\n)","mg");
		re.lastIndex = 0;
		var match = re.exec(text);
		if(match) {
			var t = text.substr(match.index+match[1].length);
			var re2 = /^!/mg;
			re2.lastIndex = 0;
			match = re2.exec(t); //# search for the next heading
			if(match)
				t = t.substr(0,match.index-1);//# don't include final \n
			return t;
		}
		return defaultText;
	}
	if(defaultText != undefined)
		return defaultText;
	return null;
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,null);
	if(text == null)
		return defaultText;
	var textOut = [];
	var match,lastPos = 0;
	do {
		match = bracketRegExp.exec(text);
		if(match) {
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],"",depth-1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

//TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\n]+)[\t\x20]*\|$)/gm;
TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]*)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\|\n]*)[\t\x20]*\|$)/gm;
// @internal
TiddlyWiki.prototype.calcAllSlices = function(title)
{
	var slices = {};
	var text = this.getTiddlerText(title,"");
	this.slicesRE.lastIndex = 0;
	var m = this.slicesRE.exec(text);
	while(m) {
		if(m[2])
			slices[m[2]] = m[3];
		else
			slices[m[5]] = m[6];
		m = this.slicesRE.exec(text);
	}
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)
{
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)
{
	var t,r = {};
	for(t=0; t<sliceNames.length; t++) {
		var slice = this.getTiddlerSlice(title,sliceNames[t]);
		if(slice)
			r[sliceNames[t]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.suspendNotifications = function()
{
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function()
{
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
	if(!this.notificationLevel) {
	    var t;
		for(t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if((n.name == null && doBlanket) || (n.name == title))
				n.notify(title);
		}
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
	if(!this.notificationLevel) {
	    var t;
		for(t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if(n.name)
				n.notify(n.name);
		}
	}
};

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
	var i;
	for(i=0; i<this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({name: title, notify: fn});
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		tiddler.clearChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		var t = tiddler.tags.indexOf(tag);
		if(t != -1)
			tiddler.tags.splice(t,1);
		if(status)
			tiddler.tags.push(tag);
		tiddler.changed();
		tiddler.incChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.addTiddlerFields = function(title,fields)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler)
		return;
	merge(tiddler.fields,fields);
	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title,true);
	this.setDirty(true);
};

// Store tiddler in TiddlyWiki instance
TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created,creator)
{
	var tiddler;
	if(title instanceof Tiddler) {
		tiddler = title;
		tiddler.fields = merge(merge({},tiddler.fields),config.defaultCustomFields,true);
		title = tiddler.title;
		newTitle = title;
	} else {
		tiddler = this.fetchTiddler(title);
		if(tiddler) {
			created = created || tiddler.created; // Preserve created date
			creator = creator || tiddler.creator;
			this.deleteTiddler(title);
		} else {
			created = created || modified;
			tiddler = new Tiddler();
		}
		fields = merge(merge({},fields),config.defaultCustomFields,true);
		tiddler.set(newTitle,newBody,modifier,modified,tags,created,fields,creator);
	}
	this.addTiddler(tiddler);
	if(clearChangeCount)
		tiddler.clearChangeCount();
	else
		tiddler.incChangeCount();
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.setDirty(true);
	return tiddler;
};

TiddlyWiki.prototype.incChangeCount = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.getLoader = function()
{
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function()
{
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function()
{
	return this.getSaver().externalize(store);
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)
{
	this.idPrefix = idPrefix;
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem)
		return;
	var tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		var i;
		for(i = 0;i<tiddlers.length; i++)
			tiddlers[i].changed();
	}
	jQuery(document).trigger("loadTiddlers");
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text)
{
	var posDiv = locateStoreArea(text);
	if(!posDiv)
		return null;
	var content = "<" + "html><" + "body>" + text.substring(posDiv[0],posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";
	// Create the iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6
	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();
	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea,"store");
	// Get rid of the iframe
	iframe.parentNode.removeChild(iframe);
	return this;
};

TiddlyWiki.prototype.updateTiddlers = function()
{
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title,tiddler) {
		tiddler.changed();
	});
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag,match)
{
	var candidates = this.reverseLookup("tags",excludeTag,!!match);
	var t,results = [];
	for(t=0; t<candidates.length; t++) {
		if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
			results.push(candidates[t]);
	}
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Returns a list of all tags in use
//   excludeTag - if present, excludes tags that are themselves tagged with excludeTag
// Returns an array of arrays where [tag][0] is the name of the tag and [tag][1] is the number of occurances
TiddlyWiki.prototype.getTags = function(excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
	    var g,c;
		for(g=0; g<tiddler.tags.length; g++) {
			var tag = tiddler.tags[g];
			var n = true;
			for(c=0; c<results.length; c++) {
				if(results[c][0] == tag) {
					n = false;
					results[c][1]++;
				}
			}
			if(n && excludeTag) {
				var t = this.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					n = false;
			}
			if(n)
				results.push([tag,1]);
		}
	});
	results.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
};

TiddlyWiki.prototype.getValueTiddlers = function(field,value,sortField)
{
	return this.reverseLookup(field,value,true,sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links",title,true,sortField);
};

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var f = !lookupMatch;
		var values;
		if(["links", "tags"].contains(lookupField)) {
			values = tiddler[lookupField];
		} else {
			var accessor = TiddlyWiki.standardFieldAccess[lookupField];
			if(accessor) {
				values = [ accessor.get(tiddler) ];
			} else {
				values = tiddler.fields[lookupField] ? [tiddler.fields[lookupField]] : [];
			}
		}
		var lookup;
		for(lookup=0; lookup<values.length; lookup++) {
			if(values[lookup] == lookupValue)
				f = lookupMatch;
		}
		if(f)
			results.push(tiddler);
	});
	if(!sortField)
		sortField = "title";
	return this.sortTiddlers(results,sortField);
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field)
		results.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function()
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
			return;
		var n;
		for(n=0; n<tiddler.links.length;n++) {
			var link = tiddler.links[n];
			if(this.getTiddlerText(link,null) == null && !this.isShadowTiddler(link) && !config.macros[link])
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
	var t,results = [];
	for(t in config.shadowTiddlers) {
		if(this.isShadowTiddler(t))
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
		});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler)
{
	var t = (typeof tiddler == "string") ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

// Sort a list of tiddlers
TiddlyWiki.prototype.sortTiddlers = function(tiddlers,field)
{
	var asc = +1;
	switch(field.substr(0,1)) {
	case "-":
		asc = -1;
		field = field.substr(1);
		break;
	case "+":
		field = field.substr(1);
		break;
	}
	if(TiddlyWiki.standardFieldAccess[field]) {
		if(field=="title") {
			tiddlers.sort(function(a,b) {return a[field].toLowerCase() < b[field].toLowerCase() ? -asc : (a[field].toLowerCase() == b[field].toLowerCase() ? 0 : asc);});
		} else {
			tiddlers.sort(function(a,b) {return a[field] < b[field] ? -asc : (a[field] == b[field] ? 0 : asc);});
		}
	} else {
		tiddlers.sort(function(a,b) {return a.fields[field] < b.fields[field] ? -asc : (a.fields[field] == b.fields[field] ? 0 : +asc);});
	}
	return tiddlers;
};

//--
//-- Filter a list of tiddlers
//--

config.filters = {
	tiddler: function(results,match) {
		var title = match[1]||match[4];
		var tiddler = this.fetchTiddler(title);
		if(tiddler) {
			results.pushUnique(tiddler);
		} else if(this.isShadowTiddler(title)) {
			tiddler = new Tiddler();
			tiddler.set(title,this.getTiddlerText(title));
			results.pushUnique(tiddler);
		} else {
			results.pushUnique(new Tiddler(title));
		}
		return results;
	},
	tag: function(results,match) {
		var m,matched = this.getTaggedTiddlers(match[3]);
		for(m=0; m<matched.length; m++) {
			results.pushUnique(matched[m]);
		}
		return results;
	},
	sort: function(results,match) {
		return this.sortTiddlers(results,match[3]);
	},
	limit: function(results,match) {
		return results.slice(0,parseInt(match[3],10));
	},
	field: function(results,match) {
		var m,matched = this.getValueTiddlers(match[2],match[3]);
		for (m = 0; m < matched.length; m++) {
			results.pushUnique(matched[m]);
		}
		return results;
	}
};

// Filter a list of tiddlers
TiddlyWiki.prototype.filterTiddlers = function(filter)
{
	var re = /([^\s\[\]]+)|(?:\[([ \w\.\-]+)\[([^\]]+)\]\])|(?:\[\[([^\]]+)\]\])/mg;

	var results = [];
	if(filter) {
		var match = re.exec(filter);
		while(match) {
			var handler = (match[1]||match[4])?'tiddler':config.filters[match[2]]?match[2]:'field';
			results = config.filters[handler].call(this,results,match);
			match = re.exec(filter);
		}
	}
	return results;
};
// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by "."
TiddlyWiki.isValidFieldName = function(name)
{
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name)
{
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(n,readOnly)
{
	this.set = readOnly ?
			function(t,v) {if(v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :
			function(t,v) {if(v != t[n]) {t[n] = v; return true;}};
	this.get = function(t) {return t[n];};
}

function DateFieldAccess(n)
{
	this.set = function(t,v) {
		var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);
		if(d != t[n]) {
			t[n] = d; return true;
		}
	};
	this.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};
}

function LinksFieldAccess(n)
{
	this.set = function(t,v) {
		var s = (typeof v == "string") ? v.readBracketedList() : v;
		if(s.toString() != t[n].toString()) {
			t[n] = s; return true;
		}
	};
	this.get = function(t) {return String.encodeTiddlyLinkList(t[n]);};
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title",true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title",true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"creator":  new StringFieldAccess("creator"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name)
{
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddler,fieldName,value)
{
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return;
	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		if(isRemove)
			// don't remove StandardFields
			return;
		var h = TiddlyWiki.standardFieldAccess[fieldName];
		if(!h.set(t,value))
			return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp("^"+fieldName+"\\.");
				var dirty = false;
				var n;
				for(n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty)
					return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience provide a nicer conversion Date->String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value)
				return;
			t.fields[fieldName] = value;
		}
	}
	// When we are here the tiddler/store really was changed.
	this.notify(t.title,true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddler,fieldName)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	if(fieldName.indexOf(config.textPrimitives.sectionSeparator) === 0 || fieldName.indexOf(config.textPrimitives.sliceSeparator) === 0) {
		var sliceType = fieldName.substr(0, 2);
		var sliceName = fieldName.substring(2);
		return store.getTiddlerText("%0%1%2".format(t.title,sliceType,sliceName));
	} else {
		fieldName = fieldName.toLowerCase();
		var accessor = TiddlyWiki.standardFieldAccess[fieldName];
		if(accessor) {
			return accessor.get(t);
		}
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler,fieldName,value).
TiddlyWiki.prototype.forEachField = function(tiddler,callback,onlyExtendedFields)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	var n,result;
	for(n in t.fields) {
		result = callback(t,n,t.fields[n]);
		if(result)
			return result;
		}
	if(onlyExtendedFields)
		return undefined;
	for(n in TiddlyWiki.standardFieldAccess) {
		if(n != "tiddler") {
			// even though the "title" field can also be referenced through the name "tiddler"
			// we only visit this field once.
			result = callback(t,n,TiddlyWiki.standardFieldAccess[n].get(t));
			if(result)
				return result;
		}
	}
	return undefined;
};

//--
//-- Story functions
//--

function Story(containerId,idPrefix)
{
	this.container = containerId;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
	this.tiddlerId = function(title) {
		title = title.replace(/_/g, "__").replace(/ /g, "_");
		var id = this.idPrefix + title;
		return id==this.container ? this.idPrefix + "_" + title : id;
	};
	this.containerId = function() {
		return this.container;
	};
}

Story.prototype.getTiddler = function(title)
{
	return document.getElementById(this.tiddlerId(title));
};

Story.prototype.getContainer = function()
{
	return document.getElementById(this.containerId());
};

Story.prototype.forEachTiddler = function(fn)
{
	var place = this.getContainer();
	if(!place)
		return;
	var e = place.firstChild;
	while(e) {
		var n = e.nextSibling;
		var title = e.getAttribute("tiddler");
		if(title) {
			fn.call(this,title,e);
		}
		e = n;
	}
};

Story.prototype.displayDefaultTiddlers = function()
{
	this.displayTiddlers(null,store.filterTiddlers(store.getTiddlerText("DefaultTiddlers")));
};

Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,unused,customFields,toggle)
{
	var t;
	for(t = titles.length-1;t>=0;t--)
		this.displayTiddler(srcElement,titles[t],template,animate,unused,customFields);
};

Story.prototype.displayTiddler = function(srcElement,tiddler,template,animate,unused,customFields,toggle,animationSrc)
{
	var title = (tiddler instanceof Tiddler) ? tiddler.title : tiddler;
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(toggle) {
			if(tiddlerElem.getAttribute("dirty") != "true")
				this.closeTiddler(title,true);
		} else {
			this.refreshTiddler(title,template,false,customFields);
		}
	} else {
		var place = this.getContainer();
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place,before,title,template,customFields);
	}
	if(animationSrc && typeof animationSrc !== "string") {
		srcElement = animationSrc;
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim && typeof Zoomer == "function" && typeof Scroller == "function")
			anim.startAnimating(new Zoomer(title,srcElement,tiddlerElem),new Scroller(tiddlerElem));
		else
			window.scrollTo(0,ensureVisible(tiddlerElem));
	}
	return tiddlerElem;
};

Story.prototype.positionTiddler = function(srcElement)
{
	var place = this.getContainer();
	var before = null;
	if(typeof srcElement == "string") {
		switch(srcElement) {
		case "top":
			before = place.firstChild;
			break;
		case "bottom":
			before = null;
			break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null) {
			before = place.firstChild;
		} else if(after.nextSibling) {
			before = after.nextSibling;
			if(before.nodeType != 1)
				before = null;
		}
	}
	return before;
};

Story.prototype.createTiddler = function(place,before,title,template,customFields)
{
	var tiddlerElem = createTiddlyElement(null,"div",this.tiddlerId(title),"tiddler");
	tiddlerElem.setAttribute("refresh","tiddler");
	if(customFields)
		tiddlerElem.setAttribute("tiddlyFields",customFields);
	place.insertBefore(tiddlerElem,before);
	var defaultText = null;
	if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
		defaultText = this.loadMissingTiddler(title,customFields);
	this.refreshTiddler(title,template,false,customFields,defaultText);
	return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title,fields,callback)
{
	var getTiddlerCallback = function(context)
	{
		if(context.status) {
			var t = context.tiddler;
			if(!t.created)
				t.created = new Date();
			if(!t.modified)
				t.modified = t.created;
			var dirty = store.isDirty();
			context.tiddler = store.saveTiddler(t.title,t.title,t.text,t.modifier,t.modified,t.tags,t.fields,true,t.created,t.creator);
			if(!window.allowSave())
				store.setDirty(dirty);
			autoSaveChanges();
		} else {
			story.refreshTiddler(context.title,null,true);
		}
		context.adaptor.close();
		if(callback) {
			callback(context);
		}
	};
	var tiddler = new Tiddler(title);
	tiddler.fields = typeof fields == "string" ? fields.decodeHashMap() : fields||{};
	var context = {serverType:tiddler.getServerType()};
	if(!context.serverType)
		return "";
	context.host = tiddler.fields['server.host'];
	context.workspace = tiddler.fields['server.workspace'];
	var adaptor = new config.adaptors[context.serverType]();
	adaptor.getTiddler(title,context,null,getTiddlerCallback);
	return config.messages.loadingMissingTiddler.format([title,context.serverType,context.host,context.workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title,template)
{
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
	return store.getRecursiveTiddlerText(template,null,10);
};

Story.prototype.refreshTiddler = function(title,template,force,customFields,defaultText)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(tiddlerElem.getAttribute("dirty") == "true" && !force)
			return tiddlerElem;
		template = this.chooseTemplateForTiddler(title,template);
		var currTemplate = tiddlerElem.getAttribute("template");
		if((template != currTemplate) || force) {
			var tiddler = store.getTiddler(title);
			if(!tiddler) {
				tiddler = new Tiddler();
				if(store.isShadowTiddler(title)) {
					var tags = [];
					tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,tags,version.date);
				} else {
					var text = template=="EditTemplate" ?
								config.views.editor.defaultText.format([title]) :
								config.views.wikified.defaultText.format([title]);
					text = defaultText || text;
					var fields = customFields ? customFields.decodeHashMap() : null;
					tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date,fields);
				}
			}
			tiddlerElem.setAttribute("tags",tiddler.tags.join(" "));
			tiddlerElem.setAttribute("tiddler",title);
			tiddlerElem.setAttribute("template",template);
			tiddlerElem.onmouseover = this.onTiddlerMouseOver;
			tiddlerElem.onmouseout = this.onTiddlerMouseOut;
			tiddlerElem.ondblclick = this.onTiddlerDblClick;
			tiddlerElem[window.event?"onkeydown":"onkeypress"] = this.onTiddlerKeyPress;
			tiddlerElem.innerHTML = this.getTemplateForTiddler(title,template,tiddler);
			applyHtmlMacros(tiddlerElem,tiddler);
			if(store.getTaggedTiddlers(title).length > 0)
				jQuery(tiddlerElem).addClass("isTag");
			else
				jQuery(tiddlerElem).removeClass("isTag");
			if(store.tiddlerExists(title)) {
				jQuery(tiddlerElem).removeClass("shadow");
				jQuery(tiddlerElem).removeClass("missing");
			} else {
				jQuery(tiddlerElem).addClass(store.isShadowTiddler(title) ? "shadow" : "missing");
			}
			if(customFields)
				this.addCustomFields(tiddlerElem,customFields);
		}
	}
	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place,customFields)
{
	var fields = customFields.decodeHashMap();
	var w = createTiddlyElement(place,"div",null,"customFields");
	w.style.display = "none";
	var t;
	for(t in fields) {
		var e = document.createElement("input");
		e.setAttribute("type","text");
		e.setAttribute("value",fields[t]);
		w.appendChild(e);
		e.setAttribute("edit",t);
	}
};

Story.prototype.refreshAllTiddlers = function(force)
{
	var e = this.getContainer().firstChild;
	while(e) {
		var template = e.getAttribute("template");
		if(template && e.getAttribute("dirty") != "true") {
			this.refreshTiddler(e.getAttribute("tiddler"),force ? null : template,true);
		}
		e = e.nextSibling;
	}
};

Story.prototype.onTiddlerMouseOver = function(e)
{
	jQuery(this).addClass("selected");
};

Story.prototype.onTiddlerMouseOut = function(e)
{
	jQuery(this).removeClass("selected");
};

Story.prototype.onTiddlerDblClick = function(ev)
{
	var e = ev || window.event;
	var target = resolveTarget(e);
	if(target && target.nodeName.toLowerCase() != "input" && target.nodeName.toLowerCase() != "textarea") {
		if(document.selection && document.selection.empty)
			document.selection.empty();
		config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
		e.cancelBubble = true;
		if(e.stopPropagation) e.stopPropagation();
		return true;
	}
	return false;
};

Story.prototype.onTiddlerKeyPress = function(ev)
{
	var e = ev || window.event;
	clearMessage();
	var consume = false;
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
	case 9: // Tab
		var ed = story.getTiddlerField(title,"text");
		if(target.tagName.toLowerCase() == "input" && ed.value==config.views.editor.defaultText.format([title])) {
			// moving from input field and editor still contains default text, so select it
			ed.focus();
			ed.select();
			consume = true;
		}
		if(config.options.chkInsertTabs && target.tagName.toLowerCase() == "textarea") {
			replaceSelection(target,String.fromCharCode(9));
			consume = true;
		}
		if(config.isOpera) {
			target.onblur = function() {
				this.focus();
				this.onblur = null;
			};
		}
		break;
	case 13: // Ctrl-Enter
	case 10: // Ctrl-Enter on IE PC
	case 77: // Ctrl-Enter is "M" on some platforms
		if(e.ctrlKey) {
			blurElement(this);
			config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
			consume = true;
		}
		break;
	case 27: // Escape
		blurElement(this);
		config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
		consume = true;
		break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title,field)
{
	var tiddlerElem = this.getTiddler(title);
	var e = null;
	if(tiddlerElem) {
		var t,children = tiddlerElem.getElementsByTagName("*");
		for(t=0; t<children.length; t++) {
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea") {
				if(!e)
					e = c;
				if(c.getAttribute("edit") == field)
					e = c;
			}
		}
	}
	return e;
};

Story.prototype.focusTiddler = function(title,field)
{
	var e = this.getTiddlerField(title,field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title,tag,mode,field)
{
	var c = this.getTiddlerField(title,field);
	var tags = c.value.readBracketedList();
	tags.setItem(tag,mode);
	c.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title,tag,mode)
{
	this.setTiddlerField(title,tag,mode,"tags");
};

Story.prototype.closeTiddler = function(title,animate,unused)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		clearMessage();
		this.scrubTiddler(tiddlerElem);
		if(config.options.chkAnimate && animate && anim && typeof Slider == "function")
			anim.startAnimating(new Slider(tiddlerElem,false,null,"all"));
		else {
			jQuery(tiddlerElem).remove();
		}
	}
};

Story.prototype.scrubTiddler = function(tiddlerElem)
{
	tiddlerElem.id = null;
};

Story.prototype.setDirty = function(title,dirty)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		tiddlerElem.setAttribute("dirty",dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		return tiddlerElem.getAttribute("dirty") == "true";
	return null;
};

Story.prototype.areAnyDirty = function()
{
	var r = false;
	this.forEachTiddler(function(title,element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude)
{
	clearMessage();
	this.forEachTiddler(function(title,element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0,ensureVisible(this.container));
};

Story.prototype.isEmpty = function()
{
	var place = this.getContainer();
	return place && place.firstChild == null;
};

Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ? text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack,"title","excludeSearch");
	this.displayTiddlers(null,matches);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([matches.length.toString(),q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(e)
{
	while(e && !jQuery(e).hasClass("tiddler")) {
		e = jQuery(e).hasClass("popup") && Popup.stack[0] ? Popup.stack[0].root : e.parentNode;
	}
	return e;
};

Story.prototype.gatherSaveFields = function(e,fields)
{
	if(e && e.getAttribute) {
		var f = e.getAttribute("edit");
		if(f)
			fields[f] = e.value.replace(/\r/mg,"");
		if(e.hasChildNodes()) {
			var t,c = e.childNodes;
			for(t=0; t<c.length; t++)
				this.gatherSaveFields(c[t],fields);
		}
	}
};

Story.prototype.hasChanges = function(title)
{
	var e = this.getTiddler(title);
	if(e) {
		var fields = {};
		this.gatherSaveFields(e,fields);
		if(store.fetchTiddler(title)) {
		    var n;
			for(n in fields) {
				if(store.getValue(title,n) != fields[n]) //# tiddler changed
					return true;
			}
		} else {
			if(store.isShadowTiddler(title) && store.getShadowTiddlerText(title) == fields.text) { //# not checking for title or tags
				return false;
			} else { //# changed shadow or new tiddler
				return true;
			}
		}
	}
	return false;
};

Story.prototype.saveTiddler = function(title,minorUpdate)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		var fields = {};
		this.gatherSaveFields(tiddlerElem,fields);
		var newTitle = fields.title || title;
		if(!store.tiddlerExists(newTitle)) {
			newTitle = newTitle.trim();
			var creator = config.options.txtUserName;
		}
		if(store.tiddlerExists(newTitle) && newTitle != title) {
			if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
				return null;
				title = newTitle;
		}
		if(newTitle != title)
			this.closeTiddler(newTitle,false);
		tiddlerElem.id = this.tiddlerId(newTitle);
		tiddlerElem.setAttribute("tiddler",newTitle);
		tiddlerElem.setAttribute("template",DEFAULT_VIEW_TEMPLATE);
		tiddlerElem.setAttribute("dirty","false");
		if(config.options.chkForceMinorUpdate)
			minorUpdate = !minorUpdate;
		if(!store.tiddlerExists(newTitle))
			minorUpdate = false;
		var newDate = new Date();
		if(store.tiddlerExists(title)) {
			var t = store.fetchTiddler(title);
			var extendedFields = t.fields;
			creator = t.creator;
		} else {
			extendedFields = merge({},config.defaultCustomFields);
		}
		var n;
		for(n in fields) {
			if(!TiddlyWiki.isStandardField(n))
				extendedFields[n] = fields[n];
		}
		var tiddler = store.saveTiddler(title,newTitle,fields.text,minorUpdate ? undefined : config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags,extendedFields,null,null,creator);
		autoSaveChanges(null,[tiddler]);
		return newTitle;
	}
	return null;
};

Story.prototype.permaView = function()
{
	var links = [];
	this.forEachTiddler(function(title,element) {
		links.push(String.encodeTiddlyLink(title));
	});
	var t = encodeURIComponent(links.join(" "));
	if(t == "")
		t = "#";
	if(window.location.hash != t)
		window.location.hash = t;
};

Story.prototype.switchTheme = function(theme)
{
	if(safeMode)
		return;

	var getSlice = function(theme,slice) {
		var r;
		if(readOnly)
			r = store.getTiddlerSlice(theme,slice+"ReadOnly") || store.getTiddlerSlice(theme,"Web"+slice);
		r = r || store.getTiddlerSlice(theme,slice);
		if(r && r.indexOf(config.textPrimitives.sectionSeparator)==0)
			r = theme + r;
		return store.isAvailable(r) ? r : slice;
	};

	var replaceNotification = function(i,name,theme,slice) {
		var newName = getSlice(theme,slice);
		if(name!=newName && store.namedNotifications[i].name==name) {
			store.namedNotifications[i].name = newName;
			return newName;
		}
		return name;
	};

	var pt = config.refresherData.pageTemplate;
	var vi = DEFAULT_VIEW_TEMPLATE;
	var vt = config.tiddlerTemplates[vi];
	var ei = DEFAULT_EDIT_TEMPLATE;
	var et = config.tiddlerTemplates[ei];

	var i;
	for(i=0; i<config.notifyTiddlers.length; i++) {
		var name = config.notifyTiddlers[i].name;
		switch(name) {
		case "PageTemplate":
			config.refresherData.pageTemplate = replaceNotification(i,config.refresherData.pageTemplate,theme,name);
			break;
		case "StyleSheet":
			removeStyleSheet(config.refresherData.styleSheet);
			config.refresherData.styleSheet = replaceNotification(i,config.refresherData.styleSheet,theme,name);
			break;
		case "ColorPalette":
			config.refresherData.colorPalette = replaceNotification(i,config.refresherData.colorPalette,theme,name);
			break;
		default:
			break;
		}
	}
	config.tiddlerTemplates[vi] = getSlice(theme,"ViewTemplate");
	config.tiddlerTemplates[ei] = getSlice(theme,"EditTemplate");
	if(!startingUp) {
		if(config.refresherData.pageTemplate!=pt || config.tiddlerTemplates[vi]!=vt || config.tiddlerTemplates[ei]!=et) {
			refreshAll();
			this.refreshAllTiddlers(true);
		} else {
			setStylesheet(store.getRecursiveTiddlerText(config.refresherData.styleSheet,"",10),config.refreshers.styleSheet);
		}
		config.options.txtTheme = theme;
		saveOption("txtTheme");
	}
};

//--
//-- Backstage
//--
// Backstage tasks
config.tasks.save.action = saveChanges;

var backstage = {
	area: null,
	toolbar: null,
	button: null,
	showButton: null,
	hideButton: null,
	cloak: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,
	content: null,

	init: function() {
		var cmb = config.messages.backstage;
		this.area = document.getElementById("backstageArea");
		this.toolbar = jQuery("#backstageToolbar").empty()[0];
		this.button = jQuery("#backstageButton").empty()[0];
		this.button.style.display = "block";
		var t = cmb.open.text + " " + glyph("bentArrowLeft");
		this.showButton = createTiddlyButton(this.button,t,cmb.open.tooltip,
						function(e) {backstage.show(); return false;},null,"backstageShow");
		t = glyph("bentArrowRight") + " " + cmb.close.text;
		this.hideButton = createTiddlyButton(this.button,t,cmb.close.tooltip,
						function(e) {backstage.hide(); return false;},null,"backstageHide");
		this.cloak = document.getElementById("backstageCloak");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel,"div",null,"backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel,"div",null,"backstagePanelBody");
		this.cloak.onmousedown = function(e) {backstage.switchTab(null);};
		createTiddlyText(this.toolbar,cmb.prompt);
		for(t=0; t<config.backstageTasks.length; t++) {
			var taskName = config.backstageTasks[t];
			var task = config.tasks[taskName];
			var handler = task.action ? this.onClickCommand : this.onClickTab;
			var text = task.text + (task.action ? "" : glyph("downTriangle"));
			var btn = createTiddlyButton(this.toolbar,text,task.tooltip,handler,"backstageTab");
			jQuery(btn).addClass(task.action ? "backstageAction" : "backstageTask");
			btn.setAttribute("task", taskName);
			}
		this.content = document.getElementById("contentWrapper");
		if(config.options.chkBackstage)
			this.show();
		else
			this.hide();
	},

	isVisible: function() {
		return this.area ? this.area.style.display == "block" : false;
	},

	show: function() {
		this.area.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.toolbar.style.left = findWindowWidth() + "px";
			var p = [{style: "left", start: findWindowWidth(), end: 0, template: "%0px"}];
			anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p));
		} else {
			backstage.area.style.left = "0px";
		}
		jQuery(this.showButton).hide();
		jQuery(this.hideButton).show();
		config.options.chkBackstage = true;
		saveOption("chkBackstage");
		jQuery(this.content).addClass("backstageVisible");
	},

	hide: function() {
		if(this.currTabElem) {
			this.switchTab(null);
		} else {
			backstage.toolbar.style.left = "0px";
			if(anim && config.options.chkAnimate) {
				var p = [{style: "left", start: 0, end: findWindowWidth(), template: "%0px"}];
				var c = function(element,properties) {backstage.area.style.display = "none";};
				anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p,c));
			} else {
				this.area.style.display = "none";
			}
			this.showButton.style.display = "block";
			this.hideButton.style.display = "none";
			config.options.chkBackstage = false;
			saveOption("chkBackstage");
			jQuery(this.content).removeClass("backstageVisible");
		}
	},

	onClickCommand: function(e) {
		var task = config.tasks[this.getAttribute("task")];
		if(task.action) {
			backstage.switchTab(null);
			task.action();
		}
		return false;
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.toolbar.firstChild;
		while(e) {
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling;
		}
		if(tabName == backstage.currTabName) {
			backstage.hidePanel();
			return;
		}
		if(backstage.currTabElem) {
			jQuery(this.currTabElem).removeClass("backstageSelTab");
		}
		if(tabElem && tabName) {
			backstage.preparePanel();
			jQuery(tabElem).addClass("backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content,backstage.panelBody,null,null);
			backstage.showPanel();
		} else if(backstage.currTabElem) {
			backstage.hidePanel();
		}
		backstage.currTabName = tabName;
		backstage.currTabElem = tabElem;
	},

	isPanelVisible: function() {
		return backstage.panel ? backstage.panel.style.display == "block" : false;
	},

	preparePanel: function() {
		backstage.cloak.style.height = findDocHeight() + "px";
		backstage.cloak.style.display = "block";
		jQuery(backstage.panelBody).empty();
		return backstage.panelBody;
	},

	showPanel: function() {
		backstage.panel.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
			var p = [{style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px"}];
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p),new Scroller(backstage.panel,false));
		} else {
			backstage.panel.style.top = "0px";
		}
		return backstage.panelBody;
	},

	hidePanel: function() {
		if(backstage.currTabElem)
			jQuery(backstage.currTabElem).removeClass("backstageSelTab");
		backstage.currTabElem = null;
		backstage.currTabName = null;
		if(anim && config.options.chkAnimate) {
			var p = [
				{style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px"},
				{style: "display", atEnd: "none"}
			];
			var c = function(element,properties) {backstage.cloak.style.display = "none";};
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p,c));
		} else {
			jQuery([backstage.panel,backstage.cloak]).hide();
		}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place,macroName,params)
{
	var backstageTask = config.tasks[params[0]];
	if(backstageTask)
		createTiddlyButton(place,backstageTask.text,backstageTask.tooltip,function(e) {backstage.switchTab(params[0]); return false;});
};

//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(readOnly) {
		createTiddlyElement(place,"div",null,"marked",this.readOnlyWarning);
		return;
	}
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e)
{
	var wizard = new Wizard(this);
	wizard.clear();
	config.macros.importTiddlers.restart(wizard);
	return false;
};

config.macros.importTiddlers.onClose = function(e)
{
	backstage.hidePanel();
	return false;
};

config.macros.importTiddlers.restart = function(wizard)
{
	var me = config.macros.importTiddlers;
	wizard.addStep(this.step1Title,this.step1Html);
	var t,s = wizard.getElement("selTypes");
	for(t in config.adaptors) {
		var e = createTiddlyElement(s,"option",null,null,config.adaptors[t].serverLabel || t);
		e.value = t;
	}
	if(config.defaultAdaptor)
		s.value = config.defaultAdaptor;
	s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(t in feeds) {
		e = createTiddlyElement(s,"option",null,null,t);
		e.value = t;
	}
	wizard.setValue("feeds",feeds);
	s.onchange = me.onFeedChange;
	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = me.onBrowseChange;
	fileInput.onkeyup = me.onBrowseChange;
	wizard.setButtons([{caption: this.openLabel, tooltip: this.openPrompt, onClick: me.onOpen}]);
	wizard.formElem.action = "javascript:;";
	wizard.formElem.onsubmit = function() {
		if(!this.txtPath || this.txtPath.value.length) //# check for manually entered path in first step
			this.lastChild.firstChild.onclick();
	};
};

config.macros.importTiddlers.getFeeds = function()
{
	var feeds = {};
	var t,tagged = store.getTaggedTiddlers("systemServer","title");
	for(t=0; t<tagged.length; t++) {
		var title = tagged[t].title;
		var serverType = store.getTiddlerSlice(title,"Type");
		if(!serverType)
			serverType = "file";
		feeds[title] = {title: title,
						url: store.getTiddlerSlice(title,"URL"),
						workspace: store.getTiddlerSlice(title,"Workspace"),
						workspaceList: store.getTiddlerSlice(title,"WorkspaceList"),
						tiddlerFilter: store.getTiddlerSlice(title,"TiddlerFilter"),
						serverType: serverType,
						description: store.getTiddlerSlice(title,"Description")};
	}
	return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e)
{
	var wizard = new Wizard(this);
	var selTypes = wizard.getElement("selTypes");
	var fileInput = wizard.getElement("txtPath");
	var feeds = wizard.getValue("feeds");
	var f = feeds[this.value];
	if(f) {
		selTypes.value = f.serverType;
		fileInput.value = f.url;
		wizard.setValue("feedName",f.serverType);
		wizard.setValue("feedHost",f.url);
		wizard.setValue("feedWorkspace",f.workspace);
		wizard.setValue("feedWorkspaceList",f.workspaceList);
		wizard.setValue("feedTiddlerFilter",f.tiddlerFilter);
	}
	return false;
};

config.macros.importTiddlers.onBrowseChange = function(e)
{
	var wizard = new Wizard(this);
	var file = this.value;
	file = file.replace(/^C:\\fakepath\\/i,''); // remove fakepath (chrome/opera/safari)
	if(this.files && this.files[0]) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalFileRead");
			file = this.files[0].fileName; // REQUIRES PRIVILEGES.. NULL otherwise
		} catch (ex) {
			// non-priv fallback: combine filename with path to current document
			var path=getLocalPath(document.location.href);
			var slashpos=path.lastIndexOf('/'); if (slashpos==-1) slashpos=path.lastIndexOf('\\'); 
			if (slashpos!=-1) path=path.substr(0,slashpos+1); // remove filename, leave trailing 	slash
			file=path+file;
		}
	}
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = config.macros.importTiddlers.getURLFromLocalPath(file);
	var serverType = wizard.getElement("selTypes");
	serverType.value = "file";
	return true;
};

config.macros.importTiddlers.getURLFromLocalPath = function(v)
{
	if(!v || !v.length)
		return v;
	v = v.replace(/\\/g,"/"); // use "/" for cross-platform consistency
	var u;
	var t = v.split(":");
	var p = t[1] || t[0]; // remove drive letter (if any)
	if(t[1] && (t[0] == "http" || t[0] == "https" || t[0] == "file")) {
		u = v;
	} else if(p.substr(0,1)=="/") {
		u = document.location.protocol + "//" + document.location.hostname + (t[1] ? "/" : "") + v;
	} else {
		var c = document.location.href.replace(/\\/g,"/");
		var pos = c.lastIndexOf("/");
		if(pos!=-1)
			c = c.substr(0,pos); // remove filename
		u = c + "/" + p;
	}
	return u;
};

config.macros.importTiddlers.onOpen = function(e)
{
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	var serverType = wizard.getElement("selTypes").value || config.defaultAdaptor;
	var adaptor = new config.adaptors[serverType]();
	wizard.setValue("adaptor",adaptor);
	wizard.setValue("serverType",serverType);
	wizard.setValue("host",url);
	adaptor.openHost(url,null,wizard,me.onOpenHost);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusOpenHost);
	return false;
};

config.macros.importTiddlers.onOpenHost = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	var adaptor = wizard.getValue("adaptor");
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
	adaptor.getWorkspaceList(context,wizard,me.onGetWorkspaceList);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
	wizard.setValue("context",context);
	var workspace = wizard.getValue("feedWorkspace");
	if(!workspace && context.workspaces.length==1)
		workspace = context.workspaces[0].title;
	if(workspace) {
		context.adaptor.openWorkspace(workspace,context,wizard,me.onOpenWorkspace);
		wizard.setValue("workspace",workspace);
		wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusOpenWorkspace);
		return;
	}
	wizard.addStep(me.step2Title,me.step2Html);
	var t,s = wizard.getElement("selWorkspace");
	s.onchange = me.onWorkspaceChange;
	for(t=0; t<context.workspaces.length; t++) {
		var e = createTiddlyElement(s,"option",null,null,context.workspaces[t].title);
		e.value = context.workspaces[t].title;
	}
	var workspaceList = wizard.getValue("feedWorkspaceList");
	if(workspaceList) {
		var n,list = workspaceList.parseParams("workspace",null,false,true);
		for(n=1; n<list.length; n++) {
			if(context.workspaces.findByField("title",list[n].value) == null) {
				e = createTiddlyElement(s,"option",null,null,list[n].value);
				e.value = list[n].value;
			}
		}
	}
	if(workspace) {
		t = wizard.getElement("txtWorkspace");
		t.value = workspace;
	}
	wizard.setButtons([{caption: me.openLabel, tooltip: me.openPrompt, onClick: me.onChooseWorkspace}]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e)
{
	var wizard = new Wizard(this);
	var t = wizard.getElement("txtWorkspace");
	t.value = this.value;
	this.selectedIndex = 0;
	return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e)
{
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var adaptor = wizard.getValue("adaptor");
	var workspace = wizard.getElement("txtWorkspace").value;
	wizard.setValue("workspace",workspace);
	var context = wizard.getValue("context");
	adaptor.openWorkspace(workspace,context,wizard,me.onOpenWorkspace);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusOpenWorkspace);
	return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
	var adaptor = wizard.getValue("adaptor");
	var browse=wizard.getElement("txtBrowse");
	if (browse.files) context.file=browse.files[0]; // for HTML5 FileReader
	adaptor.getTiddlerList(context,wizard,me.onGetTiddlerList,wizard.getValue("feedTiddlerFilter"));
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(context.status !== true) {
		var error = context.statusText||me.errorGettingTiddlerList;
		if(context.host.indexOf("file://") === 0) {
			error = me.errorGettingTiddlerListFile;
		} else {
			error = context.xhr && context.xhr.status == 404 ? me.errorGettingTiddlerListHttp404 :
				me.errorGettingTiddlerListHttp;
		}
		wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],"");
		jQuery("span.status", wizard.footerEl).html(error); // so error message can be html
		return;
	}
	// Extract data for the listview
	var listedTiddlers = [];
	if(context.tiddlers) {
		var n;
		for(n=0; n<context.tiddlers.length; n++) {
			var tiddler = context.tiddlers[n];
			listedTiddlers.push({
				title: tiddler.title,
				modified: tiddler.modified,
				modifier: tiddler.modifier,
				text: tiddler.text ? wikifyPlainText(tiddler.text,100) : "",
				tags: tiddler.tags,
				size: tiddler.text ? tiddler.text.length : 0,
				tiddler: tiddler
			});
		}
	}
	listedTiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	// Display the listview
	wizard.addStep(me.step3Title,me.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	var listView = ListView.create(listWrapper,listedTiddlers,me.listViewTemplate);
	wizard.setValue("listView",listView);
	wizard.setValue("context",context);
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
	txtSaveTiddler.value = me.generateSystemServerName(wizard);
	wizard.setButtons([
			{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel},
			{caption: me.importLabel, tooltip: me.importPrompt, onClick: me.doImport}
		]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard)
{
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
	return pattern.format([serverType,host,workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard)
{
	var me = config.macros.importTiddlers;
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
	if(store.tiddlerExists(txtSaveTiddler)) {
		if(!confirm(me.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
			return;
		store.suspendNotifications();
		store.removeTiddler(txtSaveTiddler);
		store.resumeNotifications();
	}
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var text = me.serverSaveTemplate.format([serverType,host,workspace]);
	store.saveTiddler(txtSaveTiddler,txtSaveTiddler,text,me.serverSaveModifier,new Date(),["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e)
{
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	if(wizard.getElement("chkSave").checked)
		me.saveServerTiddler(wizard);
	var chkSync = wizard.getElement("chkSync").checked;
	wizard.setValue("sync",chkSync);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var adaptor = wizard.getValue("adaptor");
	var overwrite = [];
	var t;
	for(t=0; t<rowNames.length; t++) {
		if(store.tiddlerExists(rowNames[t]))
			overwrite.push(rowNames[t]);
	}
	if(overwrite.length > 0) {
		if(!confirm(me.confirmOverwriteText.format([overwrite.join(", ")])))
			return false;
	}
	wizard.addStep(me.step4Title.format([rowNames.length]),me.step4Html);
	for(t=0; t<rowNames.length; t++) {
		var link = document.createElement("div");
		createTiddlyLink(link,rowNames[t],true);
		var place = wizard.getElement("markReport");
		place.parentNode.insertBefore(link,place);
	}
	wizard.setValue("remainingImports",rowNames.length);
	wizard.setButtons([
			{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}
		],me.statusDoingImport);
	var wizardContext = wizard.getValue("context");
	var tiddlers = wizardContext ? wizardContext.tiddlers : [];
	for(t=0; t<rowNames.length; t++) {
		var context = {
			allowSynchronous:true,
			tiddler:tiddlers[tiddlers.findByField("title",rowNames[t])]
		};
		adaptor.getTiddler(rowNames[t],context,wizard,me.onGetTiddler);
	}
	return false;
};

config.macros.importTiddlers.onGetTiddler = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(!context.status)
		displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
	var tiddler = context.tiddler;
	store.suspendNotifications();
	store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
	if(!wizard.getValue("sync")) {
		store.setValue(tiddler.title,'server',null);
	}
	store.resumeNotifications();
	if(!context.isSynchronous)
		store.notify(tiddler.title,true);
	var remainingImports = wizard.getValue("remainingImports")-1;
	wizard.setValue("remainingImports",remainingImports);
	if(remainingImports == 0) {
		if(context.isSynchronous) {
			store.notifyAll();
			refreshDisplay();
		}
		wizard.setButtons([
				{caption: me.doneLabel, tooltip: me.donePrompt, onClick: me.onClose}
			],me.statusDoneImport);
		autoSaveChanges();
	}
};

//--
//-- Upgrade macro
//--

config.macros.upgrade.handler = function(place)
{
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	w.addStep(this.step1Title,this.step1Html.format([this.source,this.source]));
	w.setButtons([{caption: this.upgradeLabel, tooltip: this.upgradePrompt, onClick: this.onClickUpgrade}]);
};

config.macros.upgrade.onClickUpgrade = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	if(!window.allowSave()) {
		alert(me.errorCantUpgrade);
		return false;
	}
	if(story.areAnyDirty() || store.isDirty()) {
		alert(me.errorNotSaved);
		return false;
	}
	var localPath = getLocalPath(document.location.toString());
	var backupPath = getBackupPath(localPath,me.backupExtension);
	w.setValue("backupPath",backupPath);
	w.setButtons([],me.statusPreparingBackup);
	var original = loadOriginal(localPath);
	w.setButtons([],me.statusSavingBackup);
	var backup = copyFile(backupPath,localPath);
	if(!backup)
		backup = saveFile(backupPath,original);
	if(!backup) {
		w.setButtons([],me.errorSavingBackup);
		alert(me.errorSavingBackup);
		return false;
	}
	w.setButtons([],me.statusLoadingCore);
	var options = {
		type:"GET",
		url:me.source,
		processData:false,
		success:function(data,textStatus,jqXHR) {
			me.onLoadCore(true,w,jqXHR.responseText,me.source,jqXHR);
		},
		error:function(jqXHR,textStatus,errorThrown) {
			me.onLoadCore(false,w,null,me.source,jqXHR);
		}
	};
	ajaxReq(options);
	return false;
};

config.macros.upgrade.onLoadCore = function(status,params,responseText,url,xhr)
{
	var me = config.macros.upgrade;
	var w = params;
	var errMsg;
	if(!status)
		errMsg = me.errorLoadingCore;
	var newVer = me.extractVersion(responseText);
	if(!newVer)
		errMsg = me.errorCoreFormat;
	if(errMsg) {
		w.setButtons([],errMsg);
		alert(errMsg);
		return;
	}
	var onStartUpgrade = function(e) {
		w.setButtons([],me.statusSavingCore);
		var localPath = getLocalPath(document.location.toString());
		saveFile(localPath,responseText);
		w.setButtons([],me.statusReloadingCore);
		var backupPath = w.getValue("backupPath");
		var newLoc = document.location.toString() + "?time=" + new Date().convertToYYYYMMDDHHMM() + "#upgrade:[[" + encodeURI(backupPath) + "]]";
		window.setTimeout(function () {window.location = newLoc;},10);
	};
	var step2 = [me.step2Html_downgrade,me.step2Html_restore,me.step2Html_upgrade][compareVersions(version,newVer) + 1];
	w.addStep(me.step2Title,step2.format([formatVersion(newVer),formatVersion(version)]));
	w.setButtons([{caption: me.startLabel, tooltip: me.startPrompt, onClick: onStartUpgrade},{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}]);
};

config.macros.upgrade.onCancel = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	w.addStep(me.step3Title,me.step3Html);
	w.setButtons([]);
	return false;
};

config.macros.upgrade.extractVersion = function(upgradeFile)
{
	var re = /^var version = \{title: "([^"]+)", major: (\d+), minor: (\d+), revision: (\d+)(, beta: (\d+)){0,1}, date: new Date\("([^"]+)"\)/mg;
	var m = re.exec(upgradeFile);
	return m ? {title: m[1], major: m[2], minor: m[3], revision: m[4], beta: m[6], date: new Date(m[7])} : null;
};

function upgradeFrom(path)
{
	var importStore = new TiddlyWiki();
	var tw = loadFile(path);
	if(window.netscape !== undefined)
		tw = convertUTF8ToUnicode(tw);
	importStore.importTiddlyWiki(tw);
	importStore.forEachTiddler(function(title,tiddler) {
		if(!store.getTiddler(title)) {
			store.addTiddler(tiddler);
		}
	});
	refreshDisplay();
	saveChanges(); //# To create appropriate Markup* sections
	alert(config.messages.upgradeDone.format([formatVersion()]));
	window.location = window.location.toString().substr(0,window.location.toString().lastIndexOf("?"));
}

//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place,macroName,params,wikifier,paramString)
{
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	listWrapper.setAttribute("refresh","macro");
	listWrapper.setAttribute("macroName","plugins");
	listWrapper.setAttribute("params",paramString);
	this.refresh(listWrapper,paramString);
};

config.macros.plugins.refresh = function(listWrapper,params)
{
	var me = config.macros.plugins;
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper,function(e,rowName) {
			if(e.checked)
				selectedRows.push(e.getAttribute("rowName"));
		});
	jQuery(listWrapper).empty();
	params = params.parseParams("anon");
	var plugins = installedPlugins.slice(0);
	var t,tiddler,p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(t=0; t<configTiddlers.length; t++) {
		tiddler = configTiddlers[t];
		if(plugins.findByField("title",tiddler.title) == null) {
			p = getPluginInfo(tiddler);
			p.executed = false;
			p.log.splice(0,0,this.skippedText);
			plugins.push(p);
		}
	}
	for(t=0; t<plugins.length; t++) {
		p = plugins[t];
		p.size = p.tiddler.text ? p.tiddler.text.length : 0;
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[t].title) != -1;
	}
	if(plugins.length == 0) {
		createTiddlyElement(listWrapper,"em",null,null,this.noPluginText);
		wizard.setButtons([]);
	} else {
		var template = readOnly ? this.listViewTemplateReadOnly : this.listViewTemplate;
		var listView = ListView.create(listWrapper,plugins,template,this.onSelectCommand);
		wizard.setValue("listView",listView);
		if(!readOnly) {
			wizard.setButtons([
				{caption: me.removeLabel, tooltip: me.removePrompt, onClick: me.doRemoveTag},
				{caption: me.deleteLabel, tooltip: me.deletePrompt, onClick: me.doDelete}
			]);
		}
	}
};

config.macros.plugins.doRemoveTag = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		var t;
		for(t=0; t<rowNames.length; t++) {
			store.setTiddlerTag(rowNames[t],false,"systemConfig");
		}
		autoSaveChanges();
	}
};

config.macros.plugins.doDelete = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
			var t;
			for(t=0; t<rowNames.length; t++) {
				store.removeTiddler(rowNames[t]);
				story.closeTiddler(rowNames[t],true);
			}
		}
		autoSaveChanges();
	}
};

//--
//-- Message area
//--

function getMessageDiv()
{
	var msgArea = document.getElementById("messageArea");
	if(!msgArea)
		return null;
	if(!msgArea.hasChildNodes())
		createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),
			config.messages.messageClose.text,
			config.messages.messageClose.tooltip,
			clearMessage);
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea,"div");
}

function displayMessage(text,linkText)
{
	var e = getMessageDiv();
	if(!e) {
		alert(text);
		return;
	}
	if(linkText) {
		var link = createTiddlyElement(e,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
	} else {
		e.appendChild(document.createTextNode(text));
	}
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	if(msgArea) {
		jQuery(msgArea).empty();
		msgArea.style.display = "none";
	}
	return false;
}

//--
//-- Refresh mechanism
//--

config.notifyTiddlers = [
	{name: "SystemSettings", notify: onSystemSettingsChange},
	{name: "StyleSheetLayout", notify: refreshStyles},
	{name: "StyleSheetColors", notify: refreshStyles},
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},
	{name: "SiteTitle", notify: refreshPageTitle},
	{name: "SiteSubtitle", notify: refreshPageTitle},
	{name: "WindowTitle", notify: refreshPageTitle},
	{name: "ColorPalette", notify: refreshColorPalette},
	{name: null, notify: refreshDisplay}
];

config.refreshers = {
	link: function(e,changeList)
		{
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e,title);
		return true;
		},

	tiddler: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && (changeList.indexOf && changeList.indexOf(title) != -1) && !story.isDirty(title))
			story.refreshTiddler(title,template,true);
		else
			refreshElements(e,changeList);
		return true;
		},

	content: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		var args = e.getAttribute("args");
		if(force != null || changeList == null || (changeList.indexOf && changeList.indexOf(title) != -1)) {
			jQuery(e).empty();
			config.macros.tiddler.transclude(e,title,args);
			return true;
		} else
			return false;
		},

	macro: function(e,changeList)
		{
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e,params);
		return true;
		}
};

config.refresherData = {
	styleSheet: "StyleSheet",
	defaultStyleSheet: "StyleSheet",
	pageTemplate: "PageTemplate",
	defaultPageTemplate: "PageTemplate",
	colorPalette: "ColorPalette",
	defaultColorPalette: "ColorPalette"
};

function refreshElements(root,changeList)
{
	var c,nodes = root.childNodes;
	for(c=0; c<nodes.length; c++) {
		var e = nodes[c], type = null;
		if(e.getAttribute && (e.tagName ? e.tagName != "IFRAME" : true))
			type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = false;
		if(refresher != undefined)
			refreshed = refresher(e,changeList);
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e,changeList);
	}
}

function applyHtmlMacros(root,tiddler)
{
	var e = root.firstChild;
	while(e) {
		var nextChild = e.nextSibling;
		if(e.getAttribute) {
			var macro = e.getAttribute("macro");
			if(macro) {
				e.removeAttribute("macro");
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1) {
					params = macro.substr(p+1);
					macro = macro.substr(0,p);
				}
				invokeMacro(e,macro,params,null,tiddler);
			}
		}
		if(e.hasChildNodes())
			applyHtmlMacros(e,tiddler);
		e = nextChild;
	}
}

function refreshPageTemplate(title)
{
	var stash = jQuery("<div/>").appendTo("body").hide()[0];
	var display = story.getContainer();
	var nodes,t;
	if(display) {
		nodes = display.childNodes;
		for(t=nodes.length-1; t>=0; t--)
			stash.appendChild(nodes[t]);
	}
	var wrapper = document.getElementById("contentWrapper");

	if(!title || !store.isAvailable(title))
		title = config.refresherData.pageTemplate;
	if(!store.isAvailable(title))
		title = config.refresherData.defaultPageTemplate; //# this one is always avaialable
	wrapper.innerHTML = store.getRecursiveTiddlerText(title,null,10);
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = story.getContainer();
	jQuery(display).empty();
	if(!display)
		display = createTiddlyElement(wrapper,"div",story.containerId());
	nodes = stash.childNodes;
	for(t=nodes.length-1; t>=0; t--)
		display.appendChild(nodes[t]);
	jQuery(stash).remove();
}

function refreshDisplay(hint)
{
	if(typeof hint == "string")
		hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e,hint);
	if(backstage.isPanelVisible()) {
		e = document.getElementById("backstage");
		refreshElements(e,hint);
	}
}

function refreshPageTitle()
{
	document.title = getPageTitle();
}

function getPageTitle()
{
	return wikifyPlainText(store.getTiddlerText("WindowTitle",""),null,tiddler);
}

function refreshStyles(title,doc)
{
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title,doc || document);
}

function refreshColorPalette(title)
{
	if(!startingUp)
		refreshAll();
}

function refreshAll()
{
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles(config.refresherData.styleSheet);
	refreshStyles("StyleSheetPrint");
}

//--
//-- Option handling
//--

config.optionHandlers = {
	'txt': {
		get: function(name) {return encodeCookie(config.options[name].toString());},
		set: function(name,value) {config.options[name] = decodeCookie(value);}
	},
	'chk': {
		get: function(name) {return config.options[name] ? 'true' : 'false';},
		set: function(name,value) {config.options[name] = value == 'true';}
	}
};

function setOption(name,value)
{
	var optType = name.substr(0,3);
	if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
		config.optionHandlers[optType].set(name,value);
}

// Gets the value of an option as a string. Most code should just read from config.options.* directly
function getOption(name)
{
	var optType = name.substr(0,3);
	return config.optionHandlers[optType] && config.optionHandlers[optType].get ? config.optionHandlers[optType].get(name) : null;
}

function loadOptions()
{
	if(safeMode)
		return;
	loadCookies();
	loadSystemSettings();
}
// @Deprecated; retained for backwards compatibility
var loadOptionsCookie = loadOptions;

function getCookies()
{
	var cookieList = document.cookie.split(';');
	var i,cookies = {};
	for(i=0; i<cookieList.length; i++) {
		var p = cookieList[i].indexOf('=');
		if(p != -1) {
			var name = cookieList[i].substr(0,p).trim();
			var value = cookieList[i].substr(p+1).trim();
			cookies[name] = value;
		}
	}
	return cookies;
}

function loadCookies()
{
	var i,cookies = getCookies();
	if(cookies['TiddlyWiki']) {
		cookies = cookies['TiddlyWiki'].decodeHashMap();
	}
	for(i in cookies) {
		if(config.optionsSource[i] != 'setting') {
			setOption(i,cookies[i]);
		}
	}
}

function loadSystemSettings()
{
	var key,settings = store.calcAllSlices('SystemSettings');
	config.optionsSource = {};
	for(key in settings) {
		setOption(key,settings[key]);
		config.optionsSource[key] = 'setting';
	}
}

function onSystemSettingsChange()
{
	if(!startingUp) {
		loadSystemSettings();
	}
}

function saveOption(name)
{
	if(safeMode)
		return;
	if(name.match(/[()\s]/g, '_')) {
		alert(config.messages.invalidCookie.format([name]));
		return;
	}
	saveCookie(name);
	if(config.optionsSource[name] == 'setting') {
		saveSystemSetting(name,true);
	}
}
// @Deprecated; retained for backwards compatibility
var saveOptionCookie = saveOption;

function removeCookie(name)
{
	document.cookie = name + '=; expires=Thu, 01-Jan-1970 00:00:01 UTC; path=/;';
}

function saveCookie(name)
{
	var key,cookies = {};
	for(key in config.options) {
		var value = getOption(key);
		value = value == null ? 'false' : value;
		cookies[key] = value;
	}
	document.cookie = 'TiddlyWiki=' + String.encodeHashMap(cookies) + '; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/';
	cookies = getCookies();
	var c;
	for(c in cookies) {
		var optType = c.substr(0,3);
		if(config.optionHandlers[optType])
			removeCookie(c);
	}
}

var systemSettingSave;
function commitSystemSettings(storeWasDirty)
{
	if(systemSettingSave) {
		window.clearTimeout(systemSettingSave);
	}
	systemSettingSave = window.setTimeout(function() {
		var tiddler = store.getTiddler('SystemSettings');
		autoSaveChanges(null,[tiddler]);
	}, 1000);
}

function saveSystemSetting(name,saveFile)
{
	var title = 'SystemSettings';
	var slice = store.getTiddlerSlice(title,name);
	if(readOnly || slice === getOption(name)) {
		return; //# don't save if read-only or the option hasn't changed
	}
	var slices = store.calcAllSlices(title);
	var key;
	for(key in config.optionsSource) {
		var value = getOption(key) || '';
		if(slices[key] !== value) {
			slices[key] = value;
		}
	}
	var text = [];
	for(key in slices) {
		text.push('%0: %1'.format([key,slices[key]]));
	}
	text = text.sort().join('\n');
	var storeWasDirty = store.isDirty();
	var tiddler = store.getTiddler(title);
	if(tiddler) {
		tiddler.text = text;
		tiddler = store.saveTiddler(tiddler);
	} else {
		tiddler = store.saveTiddler(title,title,text,'System',new Date(),['excludeLists'],config.defaultCustomFields);
	}
	if(saveFile) {
		commitSystemSettings(storeWasDirty);
	}
}

function encodeCookie(s)
{
	return escape(convertUnicodeToHtmlEntities(s));
}

function decodeCookie(s)
{
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re,function($0) {return String.fromCharCode(eval($0.replace(/[&#;]/g,'')));});
}

config.macros.option.genericCreate = function(place,type,opt,className,desc)
{
	var typeInfo = config.macros.option.types[type];
	var c = document.createElement(typeInfo.elementType);
	if(typeInfo.typeValue)
		c.setAttribute('type',typeInfo.typeValue);
	c[typeInfo.eventName] = typeInfo.onChange;
	c.setAttribute('option',opt);
	c.className = className || typeInfo.className;
	if(config.optionsDesc[opt])
		c.setAttribute('title',config.optionsDesc[opt]);
	place.appendChild(c);
	if(desc != 'no')
		createTiddlyText(place,config.optionsDesc[opt] || opt);
	c[typeInfo.valueField] = config.options[opt];
	return c;
};

config.macros.option.genericOnChange = function(e)
{
	var opt = this.getAttribute('option');
	if(opt) {
		var optType = opt.substr(0,3);
		var handler = config.macros.option.types[optType];
		if(handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt,handler.valueField,this[handler.valueField],handler.elementType,this);
	}
	return true;
};

config.macros.option.types = {
	'txt': {
		elementType: 'input',
		valueField: 'value',
		eventName: 'onchange',
		className: 'txtOptionInput',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: 'input',
		valueField: 'checked',
		eventName: 'onclick',
		className: 'chkOptionInput',
		typeValue: 'checkbox',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt,valueField,value,elementType,elem)
{
	config.options[opt] = value;
	saveOption(opt);
	var t,nodes = document.getElementsByTagName(elementType);
	for(t=0; t<nodes.length; t++) {
		var optNode = nodes[t].getAttribute('option');
		if(opt == optNode && nodes[t]!=elem)
			nodes[t][valueField] = value;
	}
};

config.macros.option.handler = function(place,macroName,params,wikifier,paramString)
{
	params = paramString.parseParams('anon',null,true,false,false);
	var opt = (params[1] && params[1].name == 'anon') ? params[1].value : getParam(params,'name',null);
	var className = (params[2] && params[2].name == 'anon') ? params[2].value : getParam(params,'class',null);
	var desc = getParam(params,'desc','no');
	var type = opt.substr(0,3);
	var h = config.macros.option.types[type];
	if(h && h.create)
		h.create(place,type,opt,className,desc);
};

config.macros.options.handler = function(place,macroName,params,wikifier,paramString)
{
	params = paramString.parseParams('anon',null,true,false,false);
	var showUnknown = getParam(params,'showUnknown','no');
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement('markList');
	var chkUnknown = wizard.getElement('chkUnknown');
	chkUnknown.checked = showUnknown == 'yes';
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement('div');
	markList.parentNode.insertBefore(listWrapper,markList);
	wizard.setValue('listWrapper',listWrapper);
	this.refreshOptions(listWrapper,showUnknown == 'yes');
};

config.macros.options.refreshOptions = function(listWrapper,showUnknown)
{
	var n,opts = [];
	for(n in config.options) {
		var opt = {};
		opt.option = '';
		opt.name = n;
		opt.lowlight = !config.optionsDesc[n];
		opt.description = opt.lowlight ? this.unknownDescription : config.optionsDesc[n];
		if(!opt.lowlight || showUnknown)
			opts.push(opt);
	}
	opts.sort(function(a,b) {return a.name.substr(3) < b.name.substr(3) ? -1 : (a.name.substr(3) == b.name.substr(3) ? 0 : +1);});
	ListView.create(listWrapper,opts,this.listViewTemplate);
	for(n=0; n<opts.length; n++) {
		var type = opts[n].name.substr(0,3);
		var h = config.macros.option.types[type];
		if(h && h.create) {
			h.create(opts[n].colElements['option'],type,opts[n].name,null,'no');
		}
	}
};

config.macros.options.onChangeUnknown = function(e)
{
	var wizard = new Wizard(this);
	var listWrapper = wizard.getValue('listWrapper');
	jQuery(listWrapper).empty();
	config.macros.options.refreshOptions(listWrapper,this.checked);
	return false;
};

//--
//-- Saving
//--

var saveUsingSafari = false;

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var startSaveAreaRE = /<((div)|(DIV)) ((id)|(ID))=["']?storeArea['"]?>/; // Used for IE6
var endSaveArea = '</d' + 'iv>';
var endSaveAreaCaps = '</D' + 'IV>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
	hadConfirmExit = true;
	if((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
	}
}

function updateLanguageAttribute(s)
{
	if(config.locale) {
		var mRE = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/;
		var m = mRE.exec(s);
		if(m) {
			var t = m[1];
			if(m[2])
				t += ' xml:lang="' + config.locale + '"';
			if(m[3])
				t += ' lang="' + config.locale + '"';
			t += ">";
			s = s.substr(0,m.index) + t + s.substr(m.index+m[0].length);
		}
	}
	return s;
}

function updateMarkupBlock(s,blockName,tiddlerName)
{
	return s.replaceChunk(
			"<!--%0-START-->".format([blockName]),
			"<!--%0-END-->".format([blockName]),
			"\n" + convertUnicodeToFileFormat(store.getRecursiveTiddlerText(tiddlerName,"")) + "\n");
}

function updateOriginal(original,posDiv,localPath)
{
	if(!posDiv)
		posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return null;
	}
	var revised = original.substr(0,posDiv[0] + startSaveArea.length) + "\n" +
				convertUnicodeToFileFormat(store.allTiddlersAsHtml()) + "\n" +
				original.substr(posDiv[1]);
	var newSiteTitle = convertUnicodeToFileFormat(getPageTitle()).htmlEncode();
	revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
	revised = updateLanguageAttribute(revised);
	revised = updateMarkupBlock(revised,"PRE-HEAD","MarkupPreHead");
	revised = updateMarkupBlock(revised,"POST-HEAD","MarkupPostHead");
	revised = updateMarkupBlock(revised,"PRE-BODY","MarkupPreBody");
	revised = updateMarkupBlock(revised,"POST-SCRIPT","MarkupPostBody");
	return revised;
}

function locateStoreArea(original)
{
	// Locate the storeArea divs
	if(!original)
		return null;
	var posOpeningDiv = original.search(startSaveAreaRE);
	var limitClosingDiv = original.indexOf("<"+"!--POST-STOREAREA--"+">");
	if(limitClosingDiv == -1)
		limitClosingDiv = original.indexOf("<"+"!--POST-BODY-START--"+">");
	var start = limitClosingDiv == -1 ? original.length : limitClosingDiv;
	var posClosingDiv = original.lastIndexOf(endSaveArea,start);
	if(posClosingDiv == -1)
		posClosingDiv = original.lastIndexOf(endSaveAreaCaps,start);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv,posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty,tiddlers)
{
	if(config.options.chkAutoSave)
		saveChanges(onlyIfDirty,tiddlers);
}

function loadOriginal(localPath)
{
	var content=loadFile(localPath);
	if (!content) content=window.originalHTML||recreateOriginal();
	return content;
}

function recreateOriginal()
{
	// construct doctype
	var content = "<!DOCTYPE ";
	var t=document.doctype;
	if (!t) 
		content+="html"
	else {
		content+=t.name;
		if      (t.publicId)		content+=' PUBLIC "'+t.publicId+'"';
		else if (t.systemId)		content+=' SYSTEM "'+t.systemId+'"';
	}
	content+=' "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"';
	content+='>\n';

	// append current document content
	content+=document.documentElement.outerHTML;

	content=content.replace(/<div id="saveTest">savetest<\/div>/,'<div id="saveTest"></div>');
	content=content.replace(/script><applet [^\>]*><\/applet>/g,'script>');
	content=content.replace(/><head>/,'>\n<head>');
	content=content.replace(/\n\n<\/body><\/html>$/,'</body>\n</html>\n');
	content=content.replace(/(<(meta) [^\>]*[^\/])>/g,'$1 />');
	content=content.replace(/<noscript>[^\<]*<\/noscript>/,
		function(m){return m.replace(/&lt;/g,'<').replace(/&gt;/g,'>');});
	content=content.replace(/<div id="copyright">[^\<]*<\/div>/,
		function(m){return m.replace(/\xA9/g,'&copy;');});

	return content;
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty,tiddlers)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	clearMessage();
	var t0 = new Date();
	var msg = config.messages;
	var originalPath = document.location.toString();
	if(!window.allowSave()) {
		alert(msg.notFileUrlError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null,msg.saveInstructions);
		return;
	}
	var localPath = getLocalPath(originalPath);
	var original = loadOriginal(localPath);
	if(original == null) {
		alert(msg.cantSaveError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null,msg.saveInstructions);
		return;
	}
	var posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(msg.invalidFileError.format([localPath]));
		return;
	}
	var co=config.options; //# abbreviation
	config.saveByDownload=false;
	config.saveByManualDownload=false;
	saveMain(localPath,original,posDiv);
	if (!config.saveByDownload && !config.saveByManualDownload) {
		if(co.chkSaveBackups)
			saveBackup(localPath,original);
		if(co.chkSaveEmptyTemplate)
			saveEmpty(localPath,original,posDiv);
		if(co.chkGenerateAnRssFeed && saveRss instanceof Function)
			saveRss(localPath);
	}
	if(co.chkDisplayInstrumentation)
		displayMessage("saveChanges " + (new Date()-t0) + " ms");
}


function saveMain(localPath,original,posDiv)
{
	var save;
	try {
		var revised = updateOriginal(original,posDiv,localPath);
		save = saveFile(localPath,revised);
	} catch (ex) {
		showException(ex);
	}
	if(save) {
		if (!config.saveByManualDownload) {
			if (config.saveByDownload) { //# set by HTML5DownloadSaveFile()
				var link = getDataURI(revised);
				var msg  = config.messages.mainDownload;
			} else {
				var link = "file://" + localPath;
				var msg  = config.messages.mainSaved;
			}
			displayMessage(msg,link);
		}
		store.setDirty(false);
	} else {
		alert(config.messages.mainFailed);
	}
}

function saveBackup(localPath,original)
{
	var backupPath = getBackupPath(localPath);
	var backup = copyFile(backupPath,localPath);
	if(!backup)
		backup = saveFile(backupPath,original);
	if(backup)
		displayMessage(config.messages.backupSaved,"file://" + backupPath);
	else
		alert(config.messages.backupFailed);
}

function saveEmpty(localPath,original,posDiv)
{
	var emptyPath,p;
	if((p = localPath.lastIndexOf("/")) != -1)
		emptyPath = localPath.substr(0,p) + "/";
	else if((p = localPath.lastIndexOf("\\")) != -1)
		emptyPath = localPath.substr(0,p) + "\\";
	else
		emptyPath = localPath + ".";
	emptyPath += "empty.html";
	var empty = original.substr(0,posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
	var emptySave = saveFile(emptyPath,empty);
	if(emptySave)
		displayMessage(config.messages.emptySaved,"file://" + emptyPath);
	else
		alert(config.messages.emptyFailed);
}

// Translate URL to local path [Preemption]
window.getLocalPath = window.getLocalPath || function(origPath)
{
	var originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

function getBackupPath(localPath,title,extension)
{
	var slash = "\\";
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1) {
		dirPathPos = localPath.lastIndexOf("/");
		slash = "/";
	}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == "")
		backupFolder = ".";
	var backupPath = localPath.substr(0,dirPathPos) + slash + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + ".";
	if(title)
		backupPath += title.replace(/[\\\/\*\?\":<> ]/g,"_") + ".";
	backupPath += (new Date()).convertToYYYYMMDDHHMMSSMMM() + "." + (extension || "html");
	return backupPath;
}

//--
//-- RSS Saving
//--

function saveRss(localPath)
{
	var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
	if(saveFile(rssPath,convertUnicodeToFileFormat(generateRss())))
		displayMessage(config.messages.rssSaved,"file://" + rssPath);
	else
		alert(config.messages.rssFailed);
}

tiddlerToRssItem = function(tiddler,uri)
{
	var s = "<title" + ">" + tiddler.title.htmlEncode() + "</title" + ">\n";
	s += "<description>" + wikifyStatic(tiddler.text,null,tiddler).htmlEncode() + "</description>\n";
	var i;
	for(i=0; i<tiddler.tags.length; i++)
		s += "<category>" + tiddler.tags[i] + "</category>\n";
	s += "<link>" + uri + "#" + encodeURIComponent(String.encodeTiddlyLink(tiddler.title)) + "</link>\n";
	s +="<pubDate>" + tiddler.modified.toGMTString() + "</pubDate>\n";
	return s;
};

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlainText(store.getTiddlerText("SiteTitle",""),null,tiddler).htmlEncode() + "</title" + ">");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlainText(store.getTiddlerText("SiteSubtitle",""),null,tiddler).htmlEncode() + "</description>");
	s.push("<language>" + config.locale + "</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + formatVersion() + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified","excludeLists");
	var i,n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for(i=tiddlers.length-1; i>=n; i--) {
		s.push("<item>\n" + tiddlerToRssItem(tiddlers[i],u) + "\n</item>");
	}
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}

//--
//-- Filesystem code
//--

// Copy a file in filesystem [Preemption]
window.copyFile = window.copyFile || function(dest,source)
{
	return config.browser.isIE ? ieCopyFile(dest,source) : false;
}


// Save a file in filesystem [Preemption]
window.saveFile = window.saveFile || function(fileUrl,content)
{
	var r = mozillaSaveFile(fileUrl,content);
	if(!r)
		r = ieSaveFile(fileUrl,content);
	if(!r)
		r = javaSaveFile(fileUrl,content);
	if(!r)
		r = HTML5DownloadSaveFile(fileUrl,content);
	if(!r)
		r = manualSaveFile(fileUrl,content);
	return r;
}

// Load a file from filesystem [Preemption]
window.loadFile = window.loadFile || function(fileUrl)
{
	var r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = javaLoadFile(fileUrl);
	return r;
}

function ieCreatePath(path)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}

	var pos = path.lastIndexOf("\\");
	if(pos==-1)
		pos = path.lastIndexOf("/");
	if(pos!=-1)
		path = path.substring(0,pos+1);

	var scan = [path];
	var parent = fso.GetParentFolderName(path);
	while(parent && !fso.FolderExists(parent)) {
		scan.push(parent);
		parent = fso.GetParentFolderName(parent);
	}

	for(i=scan.length-1;i>=0;i--) {
		if(!fso.FolderExists(scan[i])) {
			fso.CreateFolder(scan[i]);
		}
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath,content)
{
	ieCreatePath(filePath);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest,source)
{
	ieCreatePath(dest);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath,content)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				file.create(0,0x01B4);// 0x01B4 = 0664
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file,0x22,0x04,null);
			out.write(content,content.length);
			out.flush();
			out.close();
			return true;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				return null;
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file,0x01,0x04,null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			var contents = sInputStream.read(sInputStream.available());
			sInputStream.close();
			inputStream.close();
			return contents;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

function javaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	return i > 0 ? url.substring(i-1) : url;
}

/*
 *
 * in between when the applet has been started
 * and the user has given permission to run the applet
 * we get an applet object, but it doesn't have the methods
 * we expect yet.
 *
 */
var LOG_TIDDLYSAVER = true;
function logTiddlySaverException(msg, ex) {
	var applet = document.applets['TiddlySaver'];
	console.log(msg + ": " + ex);
	if (LOG_TIDDLYSAVER && applet) {
		try {
			console.log(msg + ": " + applet.getLastErrorMsg());
			console.log(msg + ": " + applet.getLastErrorStackTrace());
		} catch (ex) {}
	}
}

function javaDebugInformation () {
	var applet = document.applets['TiddlySaver'];
	var what = [
		["Java Version", applet.getJavaVersion],
		["Last Exception", applet.getLastErrorMessage],
		["Last Exception Stack Trace", applet.getLastErrorStackTrace],
		["System Properties", applet.getSystemProperties] ];

	function formatItem (description, method) {
		try {
			 result = String(method.call(applet));
		} catch (ex) {
			 result = String(ex)
		}
		return description + ": " + result
	}

	return jQuery.map(what, function (item) { return formatItem.apply(this, item) })
			.join('\n\n')
}

function javaSaveFile(filePath,content)
{
	var applet = document.applets['TiddlySaver'];
	try {
		if (applet && filePath) 
			return applet.saveFile(javaUrlToFilename(filePath), "UTF-8", content);
	} catch(ex) {
		logTiddlySaverException("javaSaveFile", ex);
	}
	// is this next block working anywhere ? -- grmble
	try {
		var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
		s.print(content);
		s.close();
	} catch(ex2) {
		return null;
	}
	return true;
}

function javaLoadFile(filePath)
{
	var applet = document.applets['TiddlySaver'];
	try {
		if (applet && filePath) {
			var ret = applet.loadFile(javaUrlToFilename(filePath),"UTF-8");
			if(!ret)
				return null;
			return String(ret);
		}
	} catch(ex) {
		logTiddlySaverException("javaLoadFile", ex);
	}
	// is this next block working anywhere ? -- grmble
	var content = [];
	try {
		var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
		var line;
		while((line = r.readLine()) != null)
			content.push(String(line));
		r.close();
	} catch(ex2) {
		return null;
	}
	return content.join("\n");
}

function HTML5DownloadSaveFile(filePath,content)
{
	if(document.createElement("a").download !== undefined) {
		config.saveByDownload=true;
		var slashpos=filePath.lastIndexOf("/");
		if (slashpos==-1) slashpos=filePath.lastIndexOf("\\"); 
		var filename=filePath.substr(slashpos+1);
		var uri = getDataURI(content);
		var link = document.createElement("a");
		link.setAttribute("target","_blank");
		link.setAttribute("href",uri);
		link.setAttribute("download",filename);
		document.body.appendChild(link); link.click(); document.body.removeChild(link);
		return true;
	}
	return null;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function manualSaveFile(filePath,content)
{
	// FALLBACK for showing a link to data: URI
	config.saveByManualDownload=true;
	var slashpos=filePath.lastIndexOf("/");
	if (slashpos==-1) slashpos=filePath.lastIndexOf("\\"); 
	var filename=filePath.substr(slashpos+1);
	var uri = getDataURI(content);
	displayMessage(config.messages.mainDownloadManual,uri);
	return true;
}

// construct data URI (using base64 encoding to preserve multi-byte encodings)
function getDataURI(data) {
	if (config.browser.isIE)
		return "data:text/html,"+encodeURIComponent(data);
	else
		return "data:text/html;base64,"+encodeBase64(data);
}

function encodeBase64(data) {
	if (!data) return "";
	var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
	var out = "";
	var chr1,chr2,chr3="";
	var enc1,enc2,enc3,enc4="";
	for (var count=0,i=0; i<data.length; ) {
		chr1=data.charCodeAt(i++);
		chr2=data.charCodeAt(i++);
		chr3=data.charCodeAt(i++);
		enc1=chr1 >> 2;
		enc2=((chr1 & 3) << 4) | (chr2 >> 4);
		enc3=((chr2 & 15) << 2) | (chr3 >> 6);
		enc4=chr3 & 63;
		if (isNaN(chr2)) enc3=enc4=64;
		else if (isNaN(chr3)) enc4=64;
		out+=keyStr.charAt(enc1)+keyStr.charAt(enc2)+keyStr.charAt(enc3)+keyStr.charAt(enc4);
		chr1=chr2=chr3=enc1=enc2=enc3=enc4="";
	}
	return out;
}//--
//-- Filesystem utilities
//--

function convertUTF8ToUnicode(u)
{
	return config.browser.isOpera || !window.netscape ? manualConvertUTF8ToUnicode(u) : mozConvertUTF8ToUnicode(u);
}


function manualConvertUTF8ToUnicode(utf)
{
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return fin.length > 0 ? s+fin : s;
}

function convertUnicodeToFileFormat(s)
{
	return config.browser.isOpera || !window.netscape ? (config.browser.isIE ? convertUnicodeToHtmlEntities(s) : s) : mozConvertUnicodeToUTF8(s);
}

function convertUnicodeToHtmlEntities(s)
{
	var re = /[^\u0000-\u007F]/g;
	return s.replace(re,function($0) {return "&#" + $0.charCodeAt(0).toString() + ";";});
}

function convertUnicodeToUTF8(s)
{
// return convertUnicodeToFileFormat to allow plugin migration
	return convertUnicodeToFileFormat(s);
}

function manualConvertUnicodeToUTF8(s)
{
	return unescape(encodeURIComponent(s));
}

function mozConvertUnicodeToUTF8(s)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	return fin.length > 0 ? u + fin : u;
}

function convertUriToUTF8(uri,charSet)
{
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri,charSet);
}
//--
//-- Server adaptor base class
//--

function AdaptorBase()
{
	this.host = null;
	this.store = null;
	return this;
}

AdaptorBase.prototype.close = function()
{
	return true;
};

AdaptorBase.prototype.fullHostName = function(host)
{
	if(!host)
		return '';
	host = host.trim();
	if(!host.match(/:\/\//))
		host = 'http://' + host;
	if(host.substr(host.length-1) == '/')
		host = host.substr(0,host.length-1);
	return host;
};

AdaptorBase.minHostName = function(host)
{
	return host;
};

AdaptorBase.prototype.setContext = function(context,userParams,callback)
{
	if(!context) context = {};
	context.userParams = userParams;
	if(callback) context.callback = callback;
	context.adaptor = this;
	if(!context.host)
		context.host = this.host;
	context.host = this.fullHostName(context.host);
	if(!context.workspace)
		context.workspace = this.workspace;
	return context;
};

// Open the specified host
AdaptorBase.prototype.openHost = function(host,context,userParams,callback)
{
	this.host = host;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {context.callback(context,userParams);},10);
	return true;
};

// Open the specified workspace
AdaptorBase.prototype.openWorkspace = function(workspace,context,userParams,callback)
{
	this.workspace = workspace;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

//--
//-- Server adaptor for talking to static TiddlyWiki files
//--

function FileAdaptor()
{
}

FileAdaptor.prototype = new AdaptorBase();

FileAdaptor.serverType = 'file';
FileAdaptor.serverLabel = 'TiddlyWiki';

FileAdaptor.loadTiddlyWikiSuccess = function(context,jqXHR)
{
	context.status = true;
	context.adaptor.store = new TiddlyWiki();
	if(!context.adaptor.store.importTiddlyWiki(jqXHR.responseText)) {
		context.statusText = config.messages.invalidFileError.format([context.host]);
		context.status = false;
	}
	context.complete(context,context.userParams);
};

FileAdaptor.loadTiddlyWikiError = function(context,jqXHR)
{
	context.status = false;
	context.statusText = jqXHR.message;
	context.complete(context,context.userParams);
};

// Get the list of workspaces on a given server
FileAdaptor.prototype.getWorkspaceList = function(context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.workspaces = [{title:"(default)"}];
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

// Gets the list of tiddlers within a given workspace
FileAdaptor.prototype.getTiddlerList = function(context,userParams,callback,filter)
{
	context = this.setContext(context,userParams,callback);
	if(!context.filter)
		context.filter = filter;
	context.complete = FileAdaptor.getTiddlerListComplete;
	if(this.store) {
		return context.complete(context,context.userParams);
	}
	var options = {
		type:"GET",
		url:context.host,
		file:context.file, // for HTML5 FileReader
		processData:false,
		success:function(data,textStatus,jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context,jqXHR);
		},
		error:function(jqXHR,textStatus,errorThrown) {
			context.xhr = jqXHR;
			FileAdaptor.loadTiddlyWikiError(context,jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerListComplete = function(context,userParams)
{
	if(context.status) {
		if(context.filter) {
			context.tiddlers = context.adaptor.store.filterTiddlers(context.filter);
		} else {
			context.tiddlers = [];
			context.adaptor.store.forEachTiddler(function(title,tiddler) {context.tiddlers.push(tiddler);});
		}
		var i;
		for(i=0; i<context.tiddlers.length; i++) {
			context.tiddlers[i].fields['server.type'] = FileAdaptor.serverType;
			context.tiddlers[i].fields['server.host'] = AdaptorBase.minHostName(context.host);
			context.tiddlers[i].fields['server.page.revision'] = context.tiddlers[i].modified.convertToYYYYMMDDHHMM();
		}
		context.status = true;
	}
	if(context.callback) {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler)
{
	var info = {};
	info.uri = tiddler.fields['server.host'] + "#" + tiddler.title;
	return info;
};

// Retrieve a tiddler from a given workspace on a given server
FileAdaptor.prototype.getTiddler = function(title,context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.title = title;
	context.complete = FileAdaptor.getTiddlerComplete;
	if(context.adaptor.store) {
		return context.complete(context,context.userParams);
	}
	var options = {
		type:"GET",
		url:context.host,
		processData:false,
		success:function(data,textStatus,jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context,jqXHR);
		},
		error:function(jqXHR,textStatus,errorThrown) {
			FileAdaptor.loadTiddlyWikiError(context,jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerComplete = function(context,userParams)
{
	var t = context.adaptor.store.fetchTiddler(context.title);
	if(t) {
		t.fields['server.type'] = FileAdaptor.serverType;
		t.fields['server.host'] = AdaptorBase.minHostName(context.host);
		t.fields['server.page.revision'] = t.modified.convertToYYYYMMDDHHMM();
		context.tiddler = t;
		context.status = true;
	} else { //# tiddler does not exist in document
		context.status = false;
	}
	if(context.allowSynchronous) {
		context.isSynchronous = true;
		context.callback(context,userParams);
	} else {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.close = function()
{
	this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

config.defaultAdaptor = FileAdaptor.serverType;

//--
//-- HTTP request code
//--

function ajaxReq(args)
{
	if (args.file || args.url.startsWith("file"))  // LOCAL FILE
		return localAjax(args);
	return jQuery.ajax(args);
}

function localAjax(args)
{
	var success=function(data)
		{ args.success(data,"success",{ responseText:data }); }
	var failure=function(who)
		{ args.error({ message:who+": cannot read local file" },"error",0); }

	if (args.file) try { // HTML5 FileReader (Chrome, FF20+, Safari, etc.)
		var reader=new FileReader();
		reader.onload=function(e)  { success(e.target.result); }
		reader.onerror=function(e) { failure("FileReader"); }
		reader.readAsText(args.file);
		return true;
	} catch (ex) { ; }

	try { // local file I/O (IE, FF with TiddlyFox, Chrome/Safari with TiddlySaver, etc.)
		var data=loadFile(getLocalPath(args.url));
		if (data) success(data);
		else failure("loadFile");
		return true;
	} catch (ex) { ; }

	return true;
}

function httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache)
{
	var httpSuccess = function(xhr) {
		try {
			// IE error sometimes returns 1223 when it should be 204 so treat it as success, see #1450
			return (!xhr.status && location.protocol === "file:") ||
				(xhr.status >= 200 && xhr.status < 300) ||
				xhr.status === 304 || xhr.status === 1223;
		} catch(e) {}
		return false;
	};

	var options = {
		type:type,
		url:url,
		processData:false,
		data:data,
		cache:!!allowCache,
		beforeSend: function(xhr) {
			var i;
			for(i in headers)
				xhr.setRequestHeader(i,headers[i]);
		}
	};

	if(callback) {
		options.complete = function(xhr,textStatus) {
			if(httpSuccess(xhr))
				callback(true,params,xhr.responseText,url,xhr);
			else
				callback(false,params,null,url,xhr);
		};
	}
	if(contentType)
		options.contentType = contentType;
	if(username)
		options.username = username;
	if(password)
		options.password = password;
	try {
		if(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
			window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	} catch (ex) {
	}
	return jQuery.ajax(options);
}
//--
//-- TiddlyWiki-specific utility functions
//--

// Returns TiddlyWiki version string
function formatVersion(v)
{
	v = v || version;
	return v.major + "." + v.minor + "." + v.revision +
		(v.alpha ? " (alpha " + v.alpha + ")" : "") +
		(v.beta ? " (beta " + v.beta + ")" : "");
}

function compareVersions(v1,v2)
{
	var x1,x2,i,a = ["major","minor","revision"];
	for(i = 0; i<a.length; i++) {
		x1 = v1[a[i]] || 0;
		x2 = v2[a[i]] || 0;
		if(x1<x2)
			return 1;
		if(x1>x2)
			return -1;
	}
	x1 = v1.beta || 9999;
	x2 = v2.beta || 9999;
	if(x1<x2)
		return 1;
	return x1 > x2 ? -1 : 0;
}

function merge(dst,src,preserveExisting)
{
	var i;
	for(i in src) {
		if(!preserveExisting || dst[i] === undefined)
			dst[i] = src[i];
	}
	return dst;
}

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if(e.target)
		obj = e.target;
	else if(e.srcElement)
		obj = e.srcElement;
	if(obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return obj;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e,message)
{
	var s = e.description || e.toString();
	return message ? "%0:\n%1".format([message,s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e,message)
{
	alert(exceptionText(e,message));
}

function alertAndThrow(m)
{
	alert(m);
	throw(m);
}

function glyph(name)
{
	var g = config.glyphs;
	var b = g.currBrowser;
	if(b == null) {
		b = 0;
		while(b < g.browsers.length-1 && !g.browsers[b]())
			b++;
		g.currBrowser = b;
	}
	if(!g.codes[name])
		return "";
	return g.codes[name][b];
}

function createTiddlyText(parent,text)
{
	return parent.appendChild(document.createTextNode(text));
}

function createTiddlyCheckbox(parent,caption,checked,onChange)
{
	var cb = document.createElement("input");
	cb.setAttribute("type","checkbox");
	cb.onclick = onChange;
	parent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption,parent);
	return cb;
}

function createTiddlyElement(parent,element,id,className,text,attribs)
{
	var n,e = document.createElement(element);
	if(className != null)
		e.className = className;
	if(id != null)
		e.setAttribute("id",id);
	if(text != null)
		e.appendChild(document.createTextNode(text));
	if(attribs) {
		for(n in attribs) {
			e.setAttribute(n,attribs[n]);
		}
	}
	if(parent != null)
		parent.appendChild(e);
	return e;
}

function createTiddlyButton(parent,text,tooltip,action,className,id,accessKey,attribs)
{
	var i,btn = document.createElement("a");
	btn.setAttribute("href","javascript:;");
	if(action) {
		btn.onclick = action;
	}
	if(tooltip)
		btn.setAttribute("title",tooltip);
	if(text)
		btn.appendChild(document.createTextNode(text));
	btn.className = className || "button";
	if(id)
		btn.id = id;
	if(attribs) {
		for(i in attribs) {
			btn.setAttribute(i,attribs[i]);
		}
	}
	if(parent)
		parent.appendChild(btn);
	if(accessKey)
		btn.setAttribute("accessKey",accessKey);
	return btn;
}

function createExternalLink(place,url,label)
{
	var link = document.createElement("a");
	link.className = "externalLink";
	link.href = url;
	var f = config.messages.externalLinkTooltip;
	link.title = f ? f.format([url]) : url;
	if(config.options.chkOpenInNewWindow)
		link.target = "_blank";
	place.appendChild(link);
	if(label)
		createTiddlyText(link, label);
	return link;
}

function getTiddlyLinkInfo(title,currClasses)
{
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
	    var f;
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			f = config.messages.shadowedTiddlerToolTip;
			classes.pushUnique("shadow");
		} else {
			f = config.messages.undefinedTiddlerToolTip;
			classes.remove("shadow");
		}
		subTitle = f ? f.format([title]) : "";
	}
	if(typeof config.annotations[title]=="string")
		subTitle = config.annotations[title];
	return {classes: classes.join(" "),subTitle: subTitle};
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(ev)
{
	var e = ev || window.event;
	var target = resolveTarget(e);
	var link = target;
	var title = null;
	var fields = null;
	var noToggle = null;
	do {
		title = link.getAttribute("tiddlyLink");
		fields = link.getAttribute("tiddlyFields");
		noToggle = link.getAttribute("noToggle");
		link = link.parentNode;
	} while(title == null && link != null);
	if(!store.isShadowTiddler(title)) {
		var f = fields ? fields.decodeHashMap() : {};
		fields = String.encodeHashMap(merge(f,config.defaultCustomFields,true));
	}
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		if(noToggle)
			toggling = false;
		if(store.getTiddler(title))
			fields = null;
		story.displayTiddler(target,title,null,true,null,fields,toggling);
	}
	clearMessage();
	return false;
}

function createTiddlyLink(place,title,includeText,className,isStatic,linkedFromTiddler,noToggle)
{
	var title = jQuery.trim(title);
	var text = includeText ? title : null;
	var i = getTiddlyLinkInfo(title,className);
	var btn = isStatic ? createExternalLink(place,store.getTiddlerText("SiteUrl",null) + "#" + title) : createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);
	if(isStatic)
		btn.className += ' ' + className;
	btn.setAttribute("refresh","link");
	btn.setAttribute("tiddlyLink",title);
	if(noToggle)
		btn.setAttribute("noToggle","true");
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields)
			btn.setAttribute("tiddlyFields",fields);
	}
	return btn;
}

function refreshTiddlyLink(e,title)
{
	var i = getTiddlyLinkInfo(title,e.className);
	e.className = i.classes;
	e.title = i.subTitle;
}

function createTiddlyDropDown(place,onchange,options,defaultValue)
{
	var sel = createTiddlyElement(place,"select");
	sel.onchange = onchange;
	var t;
	for(t=0; t<options.length; t++) {
		var e = createTiddlyElement(sel,"option",null,null,options[t].caption);
		e.value = options[t].name;
		if(options[t].name == defaultValue)
			e.selected = true;
	}
	return sel;
}

//--
//-- TiddlyWiki-specific popup utility functions
//--

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(ev)
{
	var tiddlers = store.getTaggedTiddlers(this.getAttribute("tag"));
	var sortby = this.getAttribute("sortby");
	if(sortby&&sortby.length) {
		store.sortTiddlers(tiddlers,sortby);
	}
	story.displayTiddlers(this,tiddlers);
	return false;
}

// Event handler for clicking on a tiddler tag
function onClickTag(ev)
{
	var e = ev || window.event;
	var popup = Popup.create(this);
	jQuery(popup).addClass("taggedTiddlerList");
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = tag.indexOf("[")==-1 ? store.getTaggedTiddlers(tag) : store.filterTiddlers(tag);
		var sortby = this.getAttribute("sortby");
		if(sortby&&sortby.length) {
			store.sortTiddlers(tagged,sortby);
		}
		var titles = [];
		var r;
		for(r=0;r<tagged.length;r++) {
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			openAll.setAttribute("sortby",sortby);
			createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
			for(r=0; r<titles.length; r++) {
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
			}
		} else {
			createTiddlyElement(popup,"li",null,"disabled",lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
		createTiddlyText(h,lingo.openTag.format([tag]));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler,title,tooltip)
{
	var btn = createTiddlyButton(place,title||tag,(tooltip||config.views.wikified.tag.tooltip).format([tag]),onClickTag);
	btn.setAttribute("tag",tag);
	if(excludeTiddler)
		btn.setAttribute("tiddler",excludeTiddler);
	return btn;
}

function onClickTiddlyPopup(ev)
{
	var e = ev || window.event;
	var tiddler = this.tiddler;
	if(tiddler.text) {
		var popup = Popup.create(this,"div","popupTiddler");
		wikify(tiddler.text,popup,null,tiddler);
		Popup.show();
	}
	if(e) e.cancelBubble = true;
	if(e && e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyPopup(place,caption,tooltip,tiddler)
{
	if(tiddler.text) {
		createTiddlyLink(place,caption,true);
		var btn = createTiddlyButton(place,glyph("downArrow"),tooltip,onClickTiddlyPopup,"tiddlerPopupButton");
		btn.tiddler = tiddler;
	} else {
		createTiddlyText(place,caption);
	}
}

function onClickError(ev)
{
	var e = ev || window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	var t;
	for(t=0; t<lines.length; t++)
		createTiddlyElement(popup,"li",null,null,lines[t]);
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place,title,text)
{
	var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
	if(text) btn.setAttribute("errorText",text);
}
//-
//- Animation engine
//-

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID = 0; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() //# Variable number of arguments
{
	var t;
	for(t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},10);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a < me.animations.length) {
		var animation = me.animations[a];
		if(animation.tick()) {
			a++;
		} else {
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
};

//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element,duration,properties,callback)
{
	this.element = element;
	this.duration = duration;
	this.properties = properties;
	this.startTime = new Date();
	this.endTime = Number(this.startTime) + duration;
	this.callback = callback;
	this.tick();
	return this;
}

Morpher.prototype.assignStyle = function(element,style,value)
{
	switch(style) {
	case "-tw-vertScroll":
		window.scrollTo(findScrollX(),value);
		break;
	case "-tw-horizScroll":
		window.scrollTo(value,findScrollY());
		break;
	default:
		element.style[style] = value;
		break;
	}
};

Morpher.prototype.stop = function()
{
	var t;
	for(t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.atEnd !== undefined) {
			this.assignStyle(this.element,p.style,p.atEnd);
		}
	}
	if(this.callback)
		this.callback(this.element,this.properties);
};

Morpher.prototype.tick = function()
{
	var currTime = Number(new Date());
	var t,progress = Animator.slowInSlowOut(Math.min(1,(currTime-this.startTime)/this.duration));
	for(t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.start !== undefined && p.end !== undefined) {
			var template = p.template || "%0";
			switch(p.format) {
			case undefined:
			case "style":
				var v = p.start + (p.end-p.start) * progress;
				this.assignStyle(this.element,p.style,template.format([v]));
				break;
			case "color":
				break;
			}
		}
	}
	if(currTime >= this.endTime) {
		this.stop();
		return false;
	}
	return true;
};

//--
//-- Zoomer animation
//--

function Zoomer(text,startElement,targetElement,unused)
{
	var e = createTiddlyElement(document.body,"div",null,"zoomer");
	createTiddlyElement(e,"div",null,null,text);
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	var p = [
		{style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px'},
		{style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px'},
		{style: 'width', start: Math.min(startElement.scrollWidth,winWidth), end: Math.min(targetElement.scrollWidth,winWidth), template: '%0px', atEnd: 'auto'},
		{style: 'height', start: Math.min(startElement.scrollHeight,winHeight), end: Math.min(targetElement.scrollHeight,winHeight), template: '%0px', atEnd: 'auto'},
		{style: 'fontSize', start: 8, end: 24, template: '%0pt'}
	];
	var c = function(element,properties) {jQuery(element).remove();};
	return new Morpher(e,config.animDuration,p,c);
}

//--
//-- Scroller animation
//--

function Scroller(targetElement)
{
	var p = [{style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)}];
	return new Morpher(targetElement,config.animDuration,p);
}

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,unused,deleteMode)
{
	element.style.overflow = 'hidden';
	if(opening)
		element.style.height = '0px'; // Resolves a Firefox flashing bug
	element.style.display = 'block';
	var height = element.scrollHeight;
	var p = [];
	var c = null;
	if(opening) {
		p.push({style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto'});
		p.push({style: 'opacity', start: 0, end: 1, template: '%0'});
		p.push({style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)'});
	} else {
		p.push({style: 'height', start: height, end: 0, template: '%0px'});
		p.push({style: 'display', atEnd: 'none'});
		p.push({style: 'opacity', start: 1, end: 0, template: '%0'});
		p.push({style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)'});
		switch(deleteMode) {
		case "all":
			c = function(element,properties) {jQuery(element).remove();};
			break;
		case "children":
			c = function(element,properties) {jQuery(element).empty();};
			break;
		}
	}
	return new Morpher(element,config.animDuration,p,c);
}

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root,elem,className)
{
	var stackPosition = this.find(root,"popup");
	Popup.remove(stackPosition+1);
	var popup = createTiddlyElement(document.body,elem || "ol","popup",className || "popup");
	popup.stackPosition = stackPosition;
	Popup.stack.push({root: root, popup: popup});
	return popup;
};

Popup.onDocumentClick = function(ev)
{
	var e = ev || window.event;
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(valign,halign,offset)
{
	var curr = Popup.stack[Popup.stack.length-1];
	this.place(curr.root,curr.popup,valign,halign,offset);
	jQuery(curr.root).addClass("highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
};

Popup.place = function(root,popup,valign,halign,offset)
{
	if(!offset)
		offset = {x:0,y:0};
	if(popup.stackPosition >= 0 && !valign && !halign) {
		offset.x = offset.x + root.offsetWidth;
	} else {
		offset.x = (halign == "right") ? offset.x + root.offsetWidth : offset.x;
		offset.y = (valign == "top") ? offset.y : offset.y + root.offsetHeight;
	}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth > winWidth*0.75)
		popup.style.width = winWidth*0.75 + "px";
	var popupWidth = popup.offsetWidth;
	var scrollWidth = winWidth - document.body.offsetWidth;
	if(popupLeft + popupWidth > winWidth - scrollWidth - 1) {
		if(halign == "right")
			popupLeft = popupLeft - root.offsetWidth - popupWidth;
		else
			popupLeft = winWidth - popupWidth - scrollWidth - 1;
	}
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
};

Popup.find = function(e)
{
	var t,pos = -1;
	for(t=this.stack.length-1; t>=0; t--) {
		if(isDescendant(e,this.stack[t].popup))
			pos = t;
	}
	return pos;
};

Popup.remove = function(pos)
{
	if(!pos) pos = 0;
	if(Popup.stack.length > pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from)
{
	var t;
	for(t=Popup.stack.length-1; t>=from; t--) {
		var p = Popup.stack[t];
		jQuery(p.root).removeClass("highlight");
		jQuery(p.popup).remove();
	}
	Popup.stack = Popup.stack.slice(0,from);
};

//--
//-- Wizard support
//--

function Wizard(elem)
{
	if(elem) {
		this.formElem = findRelated(elem,"wizard","className");
		this.bodyElem = findRelated(this.formElem.firstChild,"wizardBody","className","nextSibling");
		this.footElem = findRelated(this.formElem.firstChild,"wizardFooter","className","nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name,value)
{
	jQuery(this.formElem).data(name, value);
};

Wizard.prototype.getValue = function(name)
{
	return this.formElem ? jQuery(this.formElem).data(name) : null;
};

Wizard.prototype.createWizard = function(place,title)
{
	this.formElem = createTiddlyElement(place,"form",null,"wizard");
	createTiddlyElement(this.formElem,"h1",null,null,title);
	this.bodyElem = createTiddlyElement(this.formElem,"div",null,"wizardBody");
	this.footElem = createTiddlyElement(this.formElem,"div",null,"wizardFooter");
	return this.formElem;
};

Wizard.prototype.clear = function()
{
	jQuery(this.bodyElem).empty();
};

Wizard.prototype.setButtons = function(buttonInfo,status)
{
	jQuery(this.footElem).empty();
	var t;
	for(t=0; t<buttonInfo.length; t++) {
		createTiddlyButton(this.footElem,buttonInfo[t].caption,buttonInfo[t].tooltip,buttonInfo[t].onClick);
		insertSpacer(this.footElem);
		}
	if(typeof status == "string") {
		createTiddlyElement(this.footElem,"span",null,"status",status);
	}
};

Wizard.prototype.addStep = function(stepTitle,html)
{
	jQuery(this.bodyElem).empty();
	var w = createTiddlyElement(this.bodyElem,"div");
	createTiddlyElement(w,"h2",null,null,stepTitle);
	var step = createTiddlyElement(w,"div",null,"wizardStep");
	step.innerHTML = html;
	applyHtmlMacros(step,tiddler);
};

Wizard.prototype.getElement = function(name)
{
	return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place,listObject,listTemplate,callback,className)
{
	var table = createTiddlyElement(place,"table",null,className || "listView twtable");
	var thead = createTiddlyElement(table,"thead");
	var t,r = createTiddlyElement(thead,"tr");
	for(t=0; t<listTemplate.columns.length; t++) {
		var columnTemplate = listTemplate.columns[t];
		var c = createTiddlyElement(r,"th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader) {
			colType.createHeader(c,columnTemplate,t);
			if(columnTemplate.className)
				jQuery(c).addClass(columnTemplate.className);
		}
	}
	var rc,tbody = createTiddlyElement(table,"tbody");
	for(rc=0; rc<listObject.length; rc++) {
		var rowObject = listObject[rc];
		r = createTiddlyElement(tbody,"tr");
		for(c=0; c<listTemplate.rowClasses.length; c++) {
			if(rowObject[listTemplate.rowClasses[c].field])
				jQuery(r).addClass(listTemplate.rowClasses[c].className);
		}
		rowObject.rowElement = r;
		rowObject.colElements = {};
		var cc;
		for(cc=0; cc<listTemplate.columns.length; cc++) {
			c = createTiddlyElement(r,"td");
			columnTemplate = listTemplate.columns[cc];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem) {
				colType.createItem(c,rowObject,field,columnTemplate,cc,rc);
				if(columnTemplate.className)
					jQuery(c).addClass(columnTemplate.className);
			}
			rowObject.colElements[field] = c;
		}
	}
	if(callback && listTemplate.actions)
		createTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);
	if(callback && listTemplate.buttons) {
		for(t=0; t<listTemplate.buttons.length; t++) {
			var a = listTemplate.buttons[t];
			if(a && a.name != "")
				createTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback,name,allowEmptySelection)
{
	return function(e) {
		var view = findRelated(this,"TABLE",null,"previousSibling");
		var tiddlers = [];
		ListView.forEachSelector(view,function(e,rowName) {
					if(e.checked)
						tiddlers.push(rowName);
					});
		if(tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if(this.nodeName.toLowerCase() == "select") {
				callback(view,this.value,tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view,name,tiddlers);
			}
		}
	};
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view,callback)
{
	var checkboxes = view.getElementsByTagName("input");
	var t,hadOne = false;
	for(t=0; t<checkboxes.length; t++) {
		var cb = checkboxes[t];
		if(cb.getAttribute("type") == "checkbox") {
			var rn = cb.getAttribute("rowName");
			if(rn) {
				callback(cb,rn);
				hadOne = true;
			}
		}
	}
	return hadOne;
};

ListView.getSelectedRows = function(view)
{
	var rowNames = [];
	ListView.forEachSelector(view,function(e,rowName) {
				if(e.checked)
					rowNames.push(rowName);
				});
	return rowNames;
};

ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyText(place,columnTemplate.title);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v);
		}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				wikify(v,place,null,null);
		}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined && v.title)
				createTiddlyPopup(place,v.title,config.messages.listView.tiddlerTooltip,v);
		}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var msg = config.messages.sizeTemplates;
			var v = listObject[field];
			if(v != undefined) {
				var t = 0;
				while(t<msg.length-1 && v<msg[t].unit)
					t++;
				createTiddlyText(place,msg[t].template.format([Math.round(v/msg[t].unit)]));
			}
		}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			var c = columnTemplate.text;
			if(v != undefined)
				createExternalLink(place,v,c || v);
		}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
		}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var t;
				for(t=0; t<v.length; t++) {
					createTiddlyText(place,v[t]);
					createTiddlyElement(place,"br");
				}
			}
		}
};

ListView.columnTypes.Selector = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyCheckbox(place,null,false,this.onHeaderChange);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],null);
			e.setAttribute("rowName",listObject[columnTemplate.rowName]);
		},
	onHeaderChange: function(e)
		{
			var state = this.checked;
			var view = findRelated(this,"TABLE");
			if(!view)
				return;
			ListView.forEachSelector(view,function(e,rowName) {
								e.checked = state;
							});
		}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var tags = listObject[field];
			createTiddlyText(place,String.encodeTiddlyLinkList(tags));
		}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			if(listObject[field] == true)
				createTiddlyText(place,columnTemplate.trueText);
			if(listObject[field] == false)
				createTiddlyText(place,columnTemplate.falseText);
		}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);
			e.setAttribute("tiddler",listObject.title);
			e.setAttribute("tag",columnTemplate.tag);
		},
	onChange : function(e)
		{
			var tag = this.getAttribute("tag");
			var tiddler = this.getAttribute("tiddler");
			store.setTiddlerTag(tiddler,this.checked,tag);
		}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);
				createTiddlyText(link,listObject[field]);
			}
		}
};

//--
//-- Augmented methods for the JavaScript Array() object
//--

// Add indexOf function if browser does not support it
if(!Array.indexOf) {
Array.prototype.indexOf = function(item,from)
{
	if(!from)
		from = 0;
	var i;
	for(i=from; i<this.length; i++) {
		if(this[i] === item)
			return i;
	}
	return -1;
};}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field,value)
{
	var t;
	for(t=0; t<this.length; t++) {
		if(this[t][field] === value)
			return t;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
	return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.setItem = function(value,mode)
{
	var p = this.indexOf(value);
	if(mode == 0)
		mode = (p == -1) ? +1 : -1;
	if(mode == +1) {
		if(p == -1)
			this.push(value);
	} else if(mode == -1) {
		if(p != -1)
			this.splice(p,1);
	}
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
	var i;
	for(i=0; i<items.length; i++) {
		if(this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
	var i;
	for(i = 0; i<items.length; i++) {
		if(this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique === false) {
		this.push(item);
	} else {
		if(this.indexOf(item) == -1)
			this.push(item);
	}
};

Array.prototype.remove = function(item)
{
	var p = this.indexOf(item);
	if(p != -1)
		this.splice(p,1);
};

if(!Array.prototype.map) {
Array.prototype.map = function(fn,thisObj)
{
	var scope = thisObj || window;
	var i,j,a = [];
	for(i=0, j=this.length; i < j; ++i) {
		a.push(fn.call(scope,this[i],i,this));
	}
	return a;
};}

//--
//-- Augmented methods for the JavaScript String() object
//--

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length-n) : this;
};

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	return this.replace(/^\s*|\s*$/g,"");
};

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var t,s = this.split("-");
	if(s.length > 1) {
		for(t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	}
	return s.join("");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(s)
{
	var substrings = s && s.constructor == Array ? s : arguments;
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var match,r = [];
	do {
		match = subRegExp.exec(this);
		if(match && match[1]) {
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1],10)]);
			currPos = subRegExp.lastIndex;
		}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	var s = "\\^$*+?()=!|,{}[].";
	var t,c = this;
	for(t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function()
{
	return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function()
{
	return this.replace(/\\n/mg,"\n").replace(/\\b/mg," ").replace(/\\s/mg,"\\").replace(/\r/mg,"");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	return this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
	return this.replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\"").replace(/&amp;/mg,"&");
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)
{
	var parseToken = function(match,p) {
		var n;
		if(match[p]) // Double quoted
			n = match[p];
		else if(match[p+1]) // Single quoted
			n = match[p+1];
		else if(match[p+2]) // Double-square-bracket quoted
			n = match[p+2];
		else if(match[p+3]) // Double-brace quoted
			try {
				n = match[p+3];
				if(allowEval && config.evaluateMacroParameters != "none") {
					if(config.evaluateMacroParameters == "restricted") {
						if(window.restrictedEval) {
							n = window.restrictedEval(n);
						}
					} else {
						n = window.eval(n);
					}
				}
			} catch(ex) {
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(ex);
			}
		else if(match[p+4]) // Unquoted
			n = match[p+4];
		else if(match[p+5]) // empty quote
			n = "";
		return n;
	};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token,"mg") : new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
	var match;
	do {
		match = re.exec(this);
		if(match) {
			var n = parseToken(match,1);
			if(noNames) {
				r.push({name:"",value:n});
			} else {
				var v = parseToken(match,8);
				if(v == null && defaultName) {
					v = n;
					n = defaultName;
				} else if(v == null && defaultValue) {
					v = defaultValue;
				}
				r.push({name:n,value:v});
				if(cascadeDefaults) {
					defaultName = n;
					defaultValue = v;
				}
			}
		}
	} while(match);
	// Summarise parameters into first element
	var t;
	for(t=1; t<r.length; t++) {
		if(r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
	}
	return r;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function(notAllowEval)
{
	var p = this.parseParams("list",null,!notAllowEval,true);
	var t,n = [];
	for(t=1; t<p.length; t++)
		n.push(p[t].value);
	return n;
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var p = this.parseParams("list",null,false,true);
	var t,n = [];
	for(t=1; t<p.length; t++) {
		if(p[t].value)
			n.pushUnique(p[t].value,unique);
	}
	return n;
};

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end)
{
	var s = this.indexOf(start);
	if(s != -1) {
		s += start.length;
		var e = this.indexOf(end,s);
		if(e != -1)
			return [s,e];
	}
};

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
	var r = this.getChunkRange(start,end);
	return r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;
};

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end)
{
	var r = this.getChunkRange(start,end);
	if(r)
		return this.substring(r[0],r[1]);
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list)
{
	if(list) {
		var t,results = [];
		for(t=0; t<list.length; t++)
			results.push(String.encodeTiddlyLink(list[t]));
		return results.join(" ");
	} else {
		return "";
	}
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function()
{
	var fields = this.parseParams("anon","",false);
	var t,r = {};
	for(t=1; t<fields.length; t++)
		r[fields[t].name] = fields[t].value;
	return r;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap)
{
	var t,r = [];
	for(t in hashmap)
		r.push(t + ':"' + hashmap[t] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return s;
};

String.prototype.startsWith = function(prefix)
{
	return !prefix || this.substring(0,prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params,name,defaultValue)
{
	if(!params)
		return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params,name,defaultValue)
{
	return !!getParam(params,name,defaultValue);
}

//--
//-- Augmented methods for the JavaScript Date() object
//--

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	var t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
	t = t.replace(/hh12/g,this.getHours12());
	t = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	t = t.replace(/hh/g,this.getHours());
	t = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
	t = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	t = t.replace(/mm/g,this.getMinutes());
	t = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	t = t.replace(/ss/g,this.getSeconds());
	t = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());
	t = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());
	t = t.replace(/wYYYY/g,this.getYearForWeekNo());
	t = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
	t = t.replace(/YYYY/g,this.getFullYear());
	t = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	t = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	t = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	t = t.replace(/MM/g,this.getMonth()+1);
	t = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
	t = t.replace(/WW/g,this.getWeek());
	t = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	t = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
	t = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	t = t.replace(/DDth/g,this.getDate()+this.daySuffix());
	t = t.replace(/DD/g,this.getDate());
	var tz = this.getTimezoneOffset();
	var atz = Math.abs(tz);
	t = t.replace(/TZD/g,(tz < 0 ? '+' : '-') + String.zeroPad(Math.floor(atz / 60),2) + ':' + String.zeroPad(atz % 60,2));
	t = t.replace(/\\/g,"");
	return t;
};

Date.prototype.getWeek = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
	var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000);
	return Math.floor(n/7)+1;
};

Date.prototype.getYearForWeekNo = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
	return dt.getFullYear();
};

Date.prototype.getHours12 = function()
{
	var h = this.getHours();
	return h > 12 ? h-12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function()
{
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function()
{
	return config.messages.dates.daySuffixes[this.getDate()-1];
};

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
	return this.getFullYear() + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);
};

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);
};

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),3) +"0";
};

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	d = d?d.replace(/[^0-9]/g, ""):"";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0,12));
};

// Static method to create a date from a UTC YYYYMMDDHHMMSS format string
Date.convertFromYYYYMMDDHHMMSS = function(d)
{
	d = d?d.replace(/[^0-9]/g, ""):"";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0,14));
};

// Static method to create a date from a UTC YYYYMMDDHHMMSSMMM format string
Date.convertFromYYYYMMDDHHMMSSMMM = function(d)
{
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return new Date(Date.UTC(parseInt(d.substr(0,4),10),
			parseInt(d.substr(4,2),10)-1,
			parseInt(d.substr(6,2),10),
			parseInt(d.substr(8,2)||"00",10),
			parseInt(d.substr(10,2)||"00",10),
			parseInt(d.substr(12,2)||"00",10),
			parseInt(d.substr(14,3)||"000",10)));
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0,1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
			} else {
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	var clamp = function(x,min,max) {
		return x < min ? min : (x > max ? max : x);
	};
	return "#" +
			("0" + Math.floor(clamp(this.r,0,1) * 255).toString(16)).right(2) +
			("0" + Math.floor(clamp(this.g,0,1) * 255).toString(16)).right(2) +
			("0" + Math.floor(clamp(this.b,0,1) * 255).toString(16)).right(2);
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

function drawGradient(place,horiz,locolors,hicolors)
{
	if(!hicolors)
		hicolors = locolors;
	var t;
	for(t=0; t<= 100; t+=2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var p = t/100*(locolors.length-1);
		var hc = hicolors[Math.floor(p)];
		if(typeof hc == "string")
			hc = new RGB(hc);
		var lc = locolors[Math.ceil(p)];
		if(typeof lc == "string")
			lc = new RGB(lc);
		bar.style.backgroundColor = hc.mix(lc,p-Math.floor(p)).toString();
	}
}

function addEvent(obj,type,fn)
{
	if(obj.attachEvent) {
		obj["e"+type+fn] = fn;
		obj[type+fn] = function(){obj["e"+type+fn](window.event);};
		obj.attachEvent("on"+type,obj[type+fn]);
	} else {
		obj.addEventListener(type,fn,false);
	}
}

function removeEvent(obj,type,fn)
{
	if(obj.detachEvent) {
		obj.detachEvent("on"+type,obj[type+fn]);
		obj[type+fn] = null;
	} else {
		obj.removeEventListener(type,fn,false);
	}
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e,value,name,relative)
{
	name = name || "tagName";
	relative = relative || "parentNode";
	if(name == "className") {
		while(e && !jQuery(e).hasClass(value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth()
{
	return window.innerWidth || document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight()
{
	return window.innerHeight || document.documentElement.clientHeight;
}

// Get the current height of the document
function findDocHeight() {
    var D = document;
    return Math.max(
        Math.max(D.body.scrollHeight, D.documentElement.scrollHeight),
        Math.max(D.body.offsetHeight, D.documentElement.offsetHeight),
        Math.max(D.body.clientHeight, D.documentElement.clientHeight)
    );
}

// Get the current horizontal page scroll position
function findScrollX()
{
	return window.scrollX || document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY()
{
	return window.scrollY || document.documentElement.scrollTop;
}

function findPosX(obj)
{
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

// Blur a particular element
function blurElement(e)
{
	if(e && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e,text)
{
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length,oldpos + text.length);
		var linecount = e.value.split("\n").length;
		var thisline = e.value.substr(0,e.selectionStart).split("\n").length-1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if(document.selection) {
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart("character", -text.length);
				range.select();
			}
		}
	}
}

// Set the caret position in a text area
function setCaretPosition(e,pos)
{
	if(e.selectionStart || e.selectionStart == '0') {
		e.selectionStart = pos;
		e.selectionEnd = pos;
		e.focus();
	} else if(document.selection) {
		// IE support
		e.focus ();
		var sel = document.selection.createRange();
		sel.moveStart('character', -e.value.length);
		sel.moveStart('character',pos);
		sel.moveEnd('character',0);
		sel.select();
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e)
{
	var t = "";
	while(e && e.nodeName == "#text") {
		t += e.nodeValue;
		e = e.nextSibling;
	}
	return t;
}

// Returns true if the element e has a given ancestor element
function isDescendant(e,ancestor)
{
	while(e) {
		if(e === ancestor)
			return true;
		e = e.parentNode;
	}
	return false;
}


// deprecate the following...

// Prevent an event from bubbling
function stopEvent(e)
{
	var ev = e || window.event;
	ev.cancelBubble = true;
	if(ev.stopPropagation) ev.stopPropagation();
	return false;
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e)
{
	if(!config.browser.isIE)
		return;
	var att = e.attributes;
	if(att) {
		var t;
		for(t=0; t<att.length; t++) {
			var n = att[t].name;
			if(n !== "style" && (typeof e[n] === "function" || (typeof e[n] === "object" && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while(c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

function setStylesheet(s,id,doc)
{
	jQuery.twStylesheet(s,{id:id,doc:doc});
}

function removeStyleSheet(id)
{
	jQuery.twStylesheet.remove({id:id});
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store,node,tiddlers)
{
	var title = this.getTitle(store,node);
	if(safeMode && store.isShadowTiddler(title))
		return;
	if(title) {
		var tiddler = store.createTiddler(title);
		this.internalizeTiddler(store,tiddler,title,node);
		tiddlers.push(tiddler);
	}
};

LoaderBase.prototype.loadTiddlers = function(store,nodes)
{
	var t,tiddlers = [];
	for(t = 0; t < nodes.length; t++) {
		try {
			this.loadTiddler(store,nodes[t],tiddlers);
		} catch(ex) {
			showException(ex,config.messages.tiddlerLoadError.format([this.getTitle(store,nodes[t])]));
		}
	}
	return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store)
{
	var results = [];
	var t,tiddlers = store.getTiddlers("title");
	for(t = 0; t < tiddlers.length; t++) {
		if(!tiddlers[t].doNotSave())
			results.push(this.externalizeTiddler(store, tiddlers[t]));
	}
	return results.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store,node)
{
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title");
		if(!title)
			title = node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var lenPrefix = store.idPrefix.length;
		if(node.id.substr(0,lenPrefix) == store.idPrefix)
			title = node.id.substr(lenPrefix);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store,tiddler,title,node)
{
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName!="PRE" && e.nodeName!="pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg,"").htmlDecode();
	}
	var creator = node.getAttribute("creator");
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMMSS(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMMSS(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var i,attrs = node.attributes;
	for(i = attrs.length-1; i >= 0; i--) {
		var name = attrs[i].name;
		if(attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title,text,modifier,modified,tags,created,fields,creator);
	return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store,tiddler)
{
	try {
		var extendedAttributes = "";
		var usePre = config.options.chkUsePreForStorage;
		store.forEachField(tiddler,
			function(tiddler,fieldName,value) {
				// don't store stuff from the temp namespace
				if(typeof value != "string")
					value = "";
				if(!fieldName.match(/^temp\./))
					extendedAttributes += ' %0="%1"'.format([fieldName,value.escapeLineBreaks().htmlEncode()]);
			},true);
		var created = tiddler.created;
		var modified = tiddler.modified;
		var attributes = tiddler.creator ? ' creator="' + tiddler.creator.htmlEncode() + '"' : "";
		attributes += tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "";
		attributes += (usePre && created == version.date) ? "" :' created="' + created.convertToYYYYMMDDHHMM() + '"';
		attributes += (usePre && modified == created) ? "" : ' modified="' + modified.convertToYYYYMMDDHHMM() +'"';
		var tags = tiddler.getTags();
		if(!usePre || tags)
			attributes += ' tags="' + tags.htmlEncode() + '"';
		return ('<div %0="%1"%2%3>%4</'+'div>').format([
				usePre ? "title" : "tiddler",
				tiddler.title.htmlEncode(),
				attributes,
				extendedAttributes,
				usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
			]);
	} catch (ex) {
		throw exceptionText(ex,config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};



//]]>
</script>

<script id="jsdeprecatedArea" type="text/javascript">
//<![CDATA[
//--
//-- Deprecated Crypto functions and associated conversion routines.
//-- Use the jQuery.encoding functions directly instead.
//--

// Crypto 'namespace'
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	return jQuery.encoding.strToBe32s(str);
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	return jQuery.encoding.be32sToStr(be);
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	return jQuery.encoding.be32sToHex(be);
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return jQuery.encoding.digests.hexSha1Str(str);
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return jQuery.encoding.digests.sha1Str(str);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	return jQuery.encoding.digests.sha1(x,blen);
};

//--
//-- Deprecated code
//--

// @Deprecated: Use createElementAndWikify and this.termRegExp instead
config.formatterHelpers.charFormatHelper = function(w)
{
	w.subWikify(createTiddlyElement(w.output,this.element),this.terminator);
};

// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead
config.formatterHelpers.monospacedByLineHelper = function(w)
{
	var lookaheadRegExp = new RegExp(this.lookahead,"mg");
	lookaheadRegExp.lastIndex = w.matchStart;
	var lookaheadMatch = lookaheadRegExp.exec(w.source);
	if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
		var text = lookaheadMatch[1];
		if(config.browser.isIE)
			text = text.replace(/\n/g,"\r");
		createTiddlyElement(w.output,"pre",null,null,text);
		w.nextMatch = lookaheadRegExp.lastIndex;
	}
};

// @Deprecated: Use <br> or <br /> instead of <<br>>
config.macros.br = {};
config.macros.br.handler = function(place)
{
	createTiddlyElement(place,"br");
};

// Find an entry in an array. Returns the array index or null
// @Deprecated: Use indexOf instead
Array.prototype.find = function(item)
{
	var i = this.indexOf(item);
	return i == -1 ? null : i;
};

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
// @Deprecated: Use store.getLoader().internalizeTiddler instead
Tiddler.prototype.loadFromDiv = function(divRef,title)
{
	return store.getLoader().internalizeTiddler(store,this,title,divRef);
};

// Format the text for storage in an HTML DIV
// @Deprecated Use store.getSaver().externalizeTiddler instead.
Tiddler.prototype.saveToDiv = function()
{
	return store.getSaver().externalizeTiddler(store,this);
};

// @Deprecated: Use store.allTiddlersAsHtml() instead
function allTiddlersAsHtml()
{
	return store.allTiddlersAsHtml();
}

// @Deprecated: Use refreshPageTemplate instead
function applyPageTemplate(title)
{
	refreshPageTemplate(title);
}

// @Deprecated: Use story.displayTiddlers instead
function displayTiddlers(srcElement,titles,template,unused1,unused2,animate,unused3)
{
	story.displayTiddlers(srcElement,titles,template,animate);
}

// @Deprecated: Use story.displayTiddler instead
function displayTiddler(srcElement,title,template,unused1,unused2,animate,unused3)
{
	story.displayTiddler(srcElement,title,template,animate);
}

// @Deprecated: Use functions on right hand side directly instead
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// @Deprecated: Use right hand side directly instead
var regexpBackSlashEn = new RegExp("\\\\n","mg");
var regexpBackSlash = new RegExp("\\\\","mg");
var regexpBackSlashEss = new RegExp("\\\\s","mg");
var regexpNewLine = new RegExp("\n","mg");
var regexpCarriageReturn = new RegExp("\r","mg");

//--
//-- Deprecated FileAdaptor functions
//--

FileAdaptor.loadTiddlyWikiCallback = function(status,context,responseText,url,xhr)
{
	context.status = status;
	if(!status) {
		context.statusText = "Error reading file";
	} else {
		context.adaptor.store = new TiddlyWiki();
		if(!context.adaptor.store.importTiddlyWiki(responseText)) {
			context.statusText = config.messages.invalidFileError.format([url]);
			context.status = false;
		}
	}
	context.complete(context,context.userParams);
};

//--
//-- Deprecated HTTP request code
//-- Use the jQuery ajax functions directly instead
//--

function loadRemoteFile(url,callback,params)
{
	return httpReq("GET",url,callback,params);
}

function doHttp(type,url,data,contentType,username,password,callback,params,headers,allowCache)
{
	return httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache);
}

//--
//-- Deprecated String functions
//--

// @Deprecated: no direct replacement, since not used in core code
String.prototype.toJSONString = function()
{
	// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"' : '\\"',
		'\\': '\\\\'
		};
	var replaceFn = function(a,b) {
		var c = m[b];
		if(c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
		};
	if(/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g,replaceFn) + '"';
	return '"' + this + '"';
};

//--
//-- Deprecated Tiddler code
//--

// @Deprecated: Use tiddlerToRssItem(tiddler,uri) instead
Tiddler.prototype.toRssItem = function(uri)
{
	return tiddlerToRssItem(this,uri);
};

// @Deprecated: Use "<item>\n" + tiddlerToRssItem(tiddler,uri)  + "\n</item>" instead
Tiddler.prototype.saveToRss = function(uri)
{
	return "<item>\n" + tiddlerToRssItem(this,uri) + "\n</item>";
};

// @Deprecated: Use jQuery.encoding.digests.hexSha1Str instead
Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};

//--
//-- Deprecated Number functions
//--

// @Deprecated: no direct replacement, since not used in core code
// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	var c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return Number(c);
};

//--
//-- Deprecated utility functions
//-- Use the jQuery functions directly instead
//--

// Remove all children of a node
function removeChildren(e)
{
	jQuery(e).empty();
}

// Remove a node and all it's children
function removeNode(e)
{
	jQuery(e).remove();
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	return jQuery(e).text();
}

function addClass(e,className)
{
	jQuery(e).addClass(className);
}

function removeClass(e,className)
{
	jQuery(e).removeClass(className);
}

function hasClass(e,className)
{
	return jQuery(e).hasClass(className);
}

//--
//-- Deprecated Wikifier code
//--

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
	} else {
		return "";
	}
}


//]]>
</script>
<script id="jslibArea" type="text/javascript">
//<![CDATA[
/*! jQuery v1.8.3 jquery.com | jquery.org/license */
(function(e,t){function _(e){var t=M[e]={};return v.each(e.split(y),function(e,n){t[n]=!0}),t}function H(e,n,r){if(r===t&&e.nodeType===1){var i="data-"+n.replace(P,"-$1").toLowerCase();r=e.getAttribute(i);if(typeof r=="string"){try{r=r==="true"?!0:r==="false"?!1:r==="null"?null:+r+""===r?+r:D.test(r)?v.parseJSON(r):r}catch(s){}v.data(e,n,r)}else r=t}return r}function B(e){var t;for(t in e){if(t==="data"&&v.isEmptyObject(e[t]))continue;if(t!=="toJSON")return!1}return!0}function et(){return!1}function tt(){return!0}function ut(e){return!e||!e.parentNode||e.parentNode.nodeType===11}function at(e,t){do e=e[t];while(e&&e.nodeType!==1);return e}function ft(e,t,n){t=t||0;if(v.isFunction(t))return v.grep(e,function(e,r){var i=!!t.call(e,r,e);return i===n});if(t.nodeType)return v.grep(e,function(e,r){return e===t===n});if(typeof t=="string"){var r=v.grep(e,function(e){return e.nodeType===1});if(it.test(t))return v.filter(t,r,!n);t=v.filter(t,r)}return v.grep(e,function(e,r){return v.inArray(e,t)>=0===n})}function lt(e){var t=ct.split("|"),n=e.createDocumentFragment();if(n.createElement)while(t.length)n.createElement(t.pop());return n}function Lt(e,t){return e.getElementsByTagName(t)[0]||e.appendChild(e.ownerDocument.createElement(t))}function At(e,t){if(t.nodeType!==1||!v.hasData(e))return;var n,r,i,s=v._data(e),o=v._data(t,s),u=s.events;if(u){delete o.handle,o.events={};for(n in u)for(r=0,i=u[n].length;r<i;r++)v.event.add(t,n,u[n][r])}o.data&&(o.data=v.extend({},o.data))}function Ot(e,t){var n;if(t.nodeType!==1)return;t.clearAttributes&&t.clearAttributes(),t.mergeAttributes&&t.mergeAttributes(e),n=t.nodeName.toLowerCase(),n==="object"?(t.parentNode&&(t.outerHTML=e.outerHTML),v.support.html5Clone&&e.innerHTML&&!v.trim(t.innerHTML)&&(t.innerHTML=e.innerHTML)):n==="input"&&Et.test(e.type)?(t.defaultChecked=t.checked=e.checked,t.value!==e.value&&(t.value=e.value)):n==="option"?t.selected=e.defaultSelected:n==="input"||n==="textarea"?t.defaultValue=e.defaultValue:n==="script"&&t.text!==e.text&&(t.text=e.text),t.removeAttribute(v.expando)}function Mt(e){return typeof e.getElementsByTagName!="undefined"?e.getElementsByTagName("*"):typeof e.querySelectorAll!="undefined"?e.querySelectorAll("*"):[]}function _t(e){Et.test(e.type)&&(e.defaultChecked=e.checked)}function Qt(e,t){if(t in e)return t;var n=t.charAt(0).toUpperCase()+t.slice(1),r=t,i=Jt.length;while(i--){t=Jt[i]+n;if(t in e)return t}return r}function Gt(e,t){return e=t||e,v.css(e,"display")==="none"||!v.contains(e.ownerDocument,e)}function Yt(e,t){var n,r,i=[],s=0,o=e.length;for(;s<o;s++){n=e[s];if(!n.style)continue;i[s]=v._data(n,"olddisplay"),t?(!i[s]&&n.style.display==="none"&&(n.style.display=""),n.style.display===""&&Gt(n)&&(i[s]=v._data(n,"olddisplay",nn(n.nodeName)))):(r=Dt(n,"display"),!i[s]&&r!=="none"&&v._data(n,"olddisplay",r))}for(s=0;s<o;s++){n=e[s];if(!n.style)continue;if(!t||n.style.display==="none"||n.style.display==="")n.style.display=t?i[s]||"":"none"}return e}function Zt(e,t,n){var r=Rt.exec(t);return r?Math.max(0,r[1]-(n||0))+(r[2]||"px"):t}function en(e,t,n,r){var i=n===(r?"border":"content")?4:t==="width"?1:0,s=0;for(;i<4;i+=2)n==="margin"&&(s+=v.css(e,n+$t[i],!0)),r?(n==="content"&&(s-=parseFloat(Dt(e,"padding"+$t[i]))||0),n!=="margin"&&(s-=parseFloat(Dt(e,"border"+$t[i]+"Width"))||0)):(s+=parseFloat(Dt(e,"padding"+$t[i]))||0,n!=="padding"&&(s+=parseFloat(Dt(e,"border"+$t[i]+"Width"))||0));return s}function tn(e,t,n){var r=t==="width"?e.offsetWidth:e.offsetHeight,i=!0,s=v.support.boxSizing&&v.css(e,"boxSizing")==="border-box";if(r<=0||r==null){r=Dt(e,t);if(r<0||r==null)r=e.style[t];if(Ut.test(r))return r;i=s&&(v.support.boxSizingReliable||r===e.style[t]),r=parseFloat(r)||0}return r+en(e,t,n||(s?"border":"content"),i)+"px"}function nn(e){if(Wt[e])return Wt[e];var t=v("<"+e+">").appendTo(i.body),n=t.css("display");t.remove();if(n==="none"||n===""){Pt=i.body.appendChild(Pt||v.extend(i.createElement("iframe"),{frameBorder:0,width:0,height:0}));if(!Ht||!Pt.createElement)Ht=(Pt.contentWindow||Pt.contentDocument).document,Ht.write("<!doctype html><html><body>"),Ht.close();t=Ht.body.appendChild(Ht.createElement(e)),n=Dt(t,"display"),i.body.removeChild(Pt)}return Wt[e]=n,n}function fn(e,t,n,r){var i;if(v.isArray(t))v.each(t,function(t,i){n||sn.test(e)?r(e,i):fn(e+"["+(typeof i=="object"?t:"")+"]",i,n,r)});else if(!n&&v.type(t)==="object")for(i in t)fn(e+"["+i+"]",t[i],n,r);else r(e,t)}function Cn(e){return function(t,n){typeof t!="string"&&(n=t,t="*");var r,i,s,o=t.toLowerCase().split(y),u=0,a=o.length;if(v.isFunction(n))for(;u<a;u++)r=o[u],s=/^\+/.test(r),s&&(r=r.substr(1)||"*"),i=e[r]=e[r]||[],i[s?"unshift":"push"](n)}}function kn(e,n,r,i,s,o){s=s||n.dataTypes[0],o=o||{},o[s]=!0;var u,a=e[s],f=0,l=a?a.length:0,c=e===Sn;for(;f<l&&(c||!u);f++)u=a[f](n,r,i),typeof u=="string"&&(!c||o[u]?u=t:(n.dataTypes.unshift(u),u=kn(e,n,r,i,u,o)));return(c||!u)&&!o["*"]&&(u=kn(e,n,r,i,"*",o)),u}function Ln(e,n){var r,i,s=v.ajaxSettings.flatOptions||{};for(r in n)n[r]!==t&&((s[r]?e:i||(i={}))[r]=n[r]);i&&v.extend(!0,e,i)}function An(e,n,r){var i,s,o,u,a=e.contents,f=e.dataTypes,l=e.responseFields;for(s in l)s in r&&(n[l[s]]=r[s]);while(f[0]==="*")f.shift(),i===t&&(i=e.mimeType||n.getResponseHeader("content-type"));if(i)for(s in a)if(a[s]&&a[s].test(i)){f.unshift(s);break}if(f[0]in r)o=f[0];else{for(s in r){if(!f[0]||e.converters[s+" "+f[0]]){o=s;break}u||(u=s)}o=o||u}if(o)return o!==f[0]&&f.unshift(o),r[o]}function On(e,t){var n,r,i,s,o=e.dataTypes.slice(),u=o[0],a={},f=0;e.dataFilter&&(t=e.dataFilter(t,e.dataType));if(o[1])for(n in e.converters)a[n.toLowerCase()]=e.converters[n];for(;i=o[++f];)if(i!=="*"){if(u!=="*"&&u!==i){n=a[u+" "+i]||a["* "+i];if(!n)for(r in a){s=r.split(" ");if(s[1]===i){n=a[u+" "+s[0]]||a["* "+s[0]];if(n){n===!0?n=a[r]:a[r]!==!0&&(i=s[0],o.splice(f--,0,i));break}}}if(n!==!0)if(n&&e["throws"])t=n(t);else try{t=n(t)}catch(l){return{state:"parsererror",error:n?l:"No conversion from "+u+" to "+i}}}u=i}return{state:"success",data:t}}function Fn(){try{return new e.XMLHttpRequest}catch(t){}}function In(){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}function $n(){return setTimeout(function(){qn=t},0),qn=v.now()}function Jn(e,t){v.each(t,function(t,n){var r=(Vn[t]||[]).concat(Vn["*"]),i=0,s=r.length;for(;i<s;i++)if(r[i].call(e,t,n))return})}function Kn(e,t,n){var r,i=0,s=0,o=Xn.length,u=v.Deferred().always(function(){delete a.elem}),a=function(){var t=qn||$n(),n=Math.max(0,f.startTime+f.duration-t),r=n/f.duration||0,i=1-r,s=0,o=f.tweens.length;for(;s<o;s++)f.tweens[s].run(i);return u.notifyWith(e,[f,i,n]),i<1&&o?n:(u.resolveWith(e,[f]),!1)},f=u.promise({elem:e,props:v.extend({},t),opts:v.extend(!0,{specialEasing:{}},n),originalProperties:t,originalOptions:n,startTime:qn||$n(),duration:n.duration,tweens:[],createTween:function(t,n,r){var i=v.Tween(e,f.opts,t,n,f.opts.specialEasing[t]||f.opts.easing);return f.tweens.push(i),i},stop:function(t){var n=0,r=t?f.tweens.length:0;for(;n<r;n++)f.tweens[n].run(1);return t?u.resolveWith(e,[f,t]):u.rejectWith(e,[f,t]),this}}),l=f.props;Qn(l,f.opts.specialEasing);for(;i<o;i++){r=Xn[i].call(f,e,l,f.opts);if(r)return r}return Jn(f,l),v.isFunction(f.opts.start)&&f.opts.start.call(e,f),v.fx.timer(v.extend(a,{anim:f,queue:f.opts.queue,elem:e})),f.progress(f.opts.progress).done(f.opts.done,f.opts.complete).fail(f.opts.fail).always(f.opts.always)}function Qn(e,t){var n,r,i,s,o;for(n in e){r=v.camelCase(n),i=t[r],s=e[n],v.isArray(s)&&(i=s[1],s=e[n]=s[0]),n!==r&&(e[r]=s,delete e[n]),o=v.cssHooks[r];if(o&&"expand"in o){s=o.expand(s),delete e[r];for(n in s)n in e||(e[n]=s[n],t[n]=i)}else t[r]=i}}function Gn(e,t,n){var r,i,s,o,u,a,f,l,c,h=this,p=e.style,d={},m=[],g=e.nodeType&&Gt(e);n.queue||(l=v._queueHooks(e,"fx"),l.unqueued==null&&(l.unqueued=0,c=l.empty.fire,l.empty.fire=function(){l.unqueued||c()}),l.unqueued++,h.always(function(){h.always(function(){l.unqueued--,v.queue(e,"fx").length||l.empty.fire()})})),e.nodeType===1&&("height"in t||"width"in t)&&(n.overflow=[p.overflow,p.overflowX,p.overflowY],v.css(e,"display")==="inline"&&v.css(e,"float")==="none"&&(!v.support.inlineBlockNeedsLayout||nn(e.nodeName)==="inline"?p.display="inline-block":p.zoom=1)),n.overflow&&(p.overflow="hidden",v.support.shrinkWrapBlocks||h.done(function(){p.overflow=n.overflow[0],p.overflowX=n.overflow[1],p.overflowY=n.overflow[2]}));for(r in t){s=t[r];if(Un.exec(s)){delete t[r],a=a||s==="toggle";if(s===(g?"hide":"show"))continue;m.push(r)}}o=m.length;if(o){u=v._data(e,"fxshow")||v._data(e,"fxshow",{}),"hidden"in u&&(g=u.hidden),a&&(u.hidden=!g),g?v(e).show():h.done(function(){v(e).hide()}),h.done(function(){var t;v.removeData(e,"fxshow",!0);for(t in d)v.style(e,t,d[t])});for(r=0;r<o;r++)i=m[r],f=h.createTween(i,g?u[i]:0),d[i]=u[i]||v.style(e,i),i in u||(u[i]=f.start,g&&(f.end=f.start,f.start=i==="width"||i==="height"?1:0))}}function Yn(e,t,n,r,i){return new Yn.prototype.init(e,t,n,r,i)}function Zn(e,t){var n,r={height:e},i=0;t=t?1:0;for(;i<4;i+=2-t)n=$t[i],r["margin"+n]=r["padding"+n]=e;return t&&(r.opacity=r.width=e),r}function tr(e){return v.isWindow(e)?e:e.nodeType===9?e.defaultView||e.parentWindow:!1}var n,r,i=e.document,s=e.location,o=e.navigator,u=e.jQuery,a=e.$,f=Array.prototype.push,l=Array.prototype.slice,c=Array.prototype.indexOf,h=Object.prototype.toString,p=Object.prototype.hasOwnProperty,d=String.prototype.trim,v=function(e,t){return new v.fn.init(e,t,n)},m=/[\-+]?(?:\d*\.|)\d+(?:[eE][\-+]?\d+|)/.source,g=/\S/,y=/\s+/,b=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,w=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,E=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,S=/^[\],:{}\s]*$/,x=/(?:^|:|,)(?:\s*\[)+/g,T=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,N=/"[^"\\\r\n]*"|true|false|null|-?(?:\d\d*\.|)\d+(?:[eE][\-+]?\d+|)/g,C=/^-ms-/,k=/-([\da-z])/gi,L=function(e,t){return(t+"").toUpperCase()},A=function(){i.addEventListener?(i.removeEventListener("DOMContentLoaded",A,!1),v.ready()):i.readyState==="complete"&&(i.detachEvent("onreadystatechange",A),v.ready())},O={};v.fn=v.prototype={constructor:v,init:function(e,n,r){var s,o,u,a;if(!e)return this;if(e.nodeType)return this.context=this[0]=e,this.length=1,this;if(typeof e=="string"){e.charAt(0)==="<"&&e.charAt(e.length-1)===">"&&e.length>=3?s=[null,e,null]:s=w.exec(e);if(s&&(s[1]||!n)){if(s[1])return n=n instanceof v?n[0]:n,a=n&&n.nodeType?n.ownerDocument||n:i,e=v.parseHTML(s[1],a,!0),E.test(s[1])&&v.isPlainObject(n)&&this.attr.call(e,n,!0),v.merge(this,e);o=i.getElementById(s[2]);if(o&&o.parentNode){if(o.id!==s[2])return r.find(e);this.length=1,this[0]=o}return this.context=i,this.selector=e,this}return!n||n.jquery?(n||r).find(e):this.constructor(n).find(e)}return v.isFunction(e)?r.ready(e):(e.selector!==t&&(this.selector=e.selector,this.context=e.context),v.makeArray(e,this))},selector:"",jquery:"1.8.3",length:0,size:function(){return this.length},toArray:function(){return l.call(this)},get:function(e){return e==null?this.toArray():e<0?this[this.length+e]:this[e]},pushStack:function(e,t,n){var r=v.merge(this.constructor(),e);return r.prevObject=this,r.context=this.context,t==="find"?r.selector=this.selector+(this.selector?" ":"")+n:t&&(r.selector=this.selector+"."+t+"("+n+")"),r},each:function(e,t){return v.each(this,e,t)},ready:function(e){return v.ready.promise().done(e),this},eq:function(e){return e=+e,e===-1?this.slice(e):this.slice(e,e+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(l.apply(this,arguments),"slice",l.call(arguments).join(","))},map:function(e){return this.pushStack(v.map(this,function(t,n){return e.call(t,n,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:f,sort:[].sort,splice:[].splice},v.fn.init.prototype=v.fn,v.extend=v.fn.extend=function(){var e,n,r,i,s,o,u=arguments[0]||{},a=1,f=arguments.length,l=!1;typeof u=="boolean"&&(l=u,u=arguments[1]||{},a=2),typeof u!="object"&&!v.isFunction(u)&&(u={}),f===a&&(u=this,--a);for(;a<f;a++)if((e=arguments[a])!=null)for(n in e){r=u[n],i=e[n];if(u===i)continue;l&&i&&(v.isPlainObject(i)||(s=v.isArray(i)))?(s?(s=!1,o=r&&v.isArray(r)?r:[]):o=r&&v.isPlainObject(r)?r:{},u[n]=v.extend(l,o,i)):i!==t&&(u[n]=i)}return u},v.extend({noConflict:function(t){return e.$===v&&(e.$=a),t&&e.jQuery===v&&(e.jQuery=u),v},isReady:!1,readyWait:1,holdReady:function(e){e?v.readyWait++:v.ready(!0)},ready:function(e){if(e===!0?--v.readyWait:v.isReady)return;if(!i.body)return setTimeout(v.ready,1);v.isReady=!0;if(e!==!0&&--v.readyWait>0)return;r.resolveWith(i,[v]),v.fn.trigger&&v(i).trigger("ready").off("ready")},isFunction:function(e){return v.type(e)==="function"},isArray:Array.isArray||function(e){return v.type(e)==="array"},isWindow:function(e){return e!=null&&e==e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return e==null?String(e):O[h.call(e)]||"object"},isPlainObject:function(e){if(!e||v.type(e)!=="object"||e.nodeType||v.isWindow(e))return!1;try{if(e.constructor&&!p.call(e,"constructor")&&!p.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(n){return!1}var r;for(r in e);return r===t||p.call(e,r)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw new Error(e)},parseHTML:function(e,t,n){var r;return!e||typeof e!="string"?null:(typeof t=="boolean"&&(n=t,t=0),t=t||i,(r=E.exec(e))?[t.createElement(r[1])]:(r=v.buildFragment([e],t,n?null:[]),v.merge([],(r.cacheable?v.clone(r.fragment):r.fragment).childNodes)))},parseJSON:function(t){if(!t||typeof t!="string")return null;t=v.trim(t);if(e.JSON&&e.JSON.parse)return e.JSON.parse(t);if(S.test(t.replace(T,"@").replace(N,"]").replace(x,"")))return(new Function("return "+t))();v.error("Invalid JSON: "+t)},parseXML:function(n){var r,i;if(!n||typeof n!="string")return null;try{e.DOMParser?(i=new DOMParser,r=i.parseFromString(n,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(n))}catch(s){r=t}return(!r||!r.documentElement||r.getElementsByTagName("parsererror").length)&&v.error("Invalid XML: "+n),r},noop:function(){},globalEval:function(t){t&&g.test(t)&&(e.execScript||function(t){e.eval.call(e,t)})(t)},camelCase:function(e){return e.replace(C,"ms-").replace(k,L)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,n,r){var i,s=0,o=e.length,u=o===t||v.isFunction(e);if(r){if(u){for(i in e)if(n.apply(e[i],r)===!1)break}else for(;s<o;)if(n.apply(e[s++],r)===!1)break}else if(u){for(i in e)if(n.call(e[i],i,e[i])===!1)break}else for(;s<o;)if(n.call(e[s],s,e[s++])===!1)break;return e},trim:d&&!d.call("\ufeff\u00a0")?function(e){return e==null?"":d.call(e)}:function(e){return e==null?"":(e+"").replace(b,"")},makeArray:function(e,t){var n,r=t||[];return e!=null&&(n=v.type(e),e.length==null||n==="string"||n==="function"||n==="regexp"||v.isWindow(e)?f.call(r,e):v.merge(r,e)),r},inArray:function(e,t,n){var r;if(t){if(c)return c.call(t,e,n);r=t.length,n=n?n<0?Math.max(0,r+n):n:0;for(;n<r;n++)if(n in t&&t[n]===e)return n}return-1},merge:function(e,n){var r=n.length,i=e.length,s=0;if(typeof r=="number")for(;s<r;s++)e[i++]=n[s];else while(n[s]!==t)e[i++]=n[s++];return e.length=i,e},grep:function(e,t,n){var r,i=[],s=0,o=e.length;n=!!n;for(;s<o;s++)r=!!t(e[s],s),n!==r&&i.push(e[s]);return i},map:function(e,n,r){var i,s,o=[],u=0,a=e.length,f=e instanceof v||a!==t&&typeof a=="number"&&(a>0&&e[0]&&e[a-1]||a===0||v.isArray(e));if(f)for(;u<a;u++)i=n(e[u],u,r),i!=null&&(o[o.length]=i);else for(s in e)i=n(e[s],s,r),i!=null&&(o[o.length]=i);return o.concat.apply([],o)},guid:1,proxy:function(e,n){var r,i,s;return typeof n=="string"&&(r=e[n],n=e,e=r),v.isFunction(e)?(i=l.call(arguments,2),s=function(){return e.apply(n,i.concat(l.call(arguments)))},s.guid=e.guid=e.guid||v.guid++,s):t},access:function(e,n,r,i,s,o,u){var a,f=r==null,l=0,c=e.length;if(r&&typeof r=="object"){for(l in r)v.access(e,n,l,r[l],1,o,i);s=1}else if(i!==t){a=u===t&&v.isFunction(i),f&&(a?(a=n,n=function(e,t,n){return a.call(v(e),n)}):(n.call(e,i),n=null));if(n)for(;l<c;l++)n(e[l],r,a?i.call(e[l],l,n(e[l],r)):i,u);s=1}return s?e:f?n.call(e):c?n(e[0],r):o},now:function(){return(new Date).getTime()}}),v.ready.promise=function(t){if(!r){r=v.Deferred();if(i.readyState==="complete")setTimeout(v.ready,1);else if(i.addEventListener)i.addEventListener("DOMContentLoaded",A,!1),e.addEventListener("load",v.ready,!1);else{i.attachEvent("onreadystatechange",A),e.attachEvent("onload",v.ready);var n=!1;try{n=e.frameElement==null&&i.documentElement}catch(s){}n&&n.doScroll&&function o(){if(!v.isReady){try{n.doScroll("left")}catch(e){return setTimeout(o,50)}v.ready()}}()}}return r.promise(t)},v.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(e,t){O["[object "+t+"]"]=t.toLowerCase()}),n=v(i);var M={};v.Callbacks=function(e){e=typeof e=="string"?M[e]||_(e):v.extend({},e);var n,r,i,s,o,u,a=[],f=!e.once&&[],l=function(t){n=e.memory&&t,r=!0,u=s||0,s=0,o=a.length,i=!0;for(;a&&u<o;u++)if(a[u].apply(t[0],t[1])===!1&&e.stopOnFalse){n=!1;break}i=!1,a&&(f?f.length&&l(f.shift()):n?a=[]:c.disable())},c={add:function(){if(a){var t=a.length;(function r(t){v.each(t,function(t,n){var i=v.type(n);i==="function"?(!e.unique||!c.has(n))&&a.push(n):n&&n.length&&i!=="string"&&r(n)})})(arguments),i?o=a.length:n&&(s=t,l(n))}return this},remove:function(){return a&&v.each(arguments,function(e,t){var n;while((n=v.inArray(t,a,n))>-1)a.splice(n,1),i&&(n<=o&&o--,n<=u&&u--)}),this},has:function(e){return v.inArray(e,a)>-1},empty:function(){return a=[],this},disable:function(){return a=f=n=t,this},disabled:function(){return!a},lock:function(){return f=t,n||c.disable(),this},locked:function(){return!f},fireWith:function(e,t){return t=t||[],t=[e,t.slice?t.slice():t],a&&(!r||f)&&(i?f.push(t):l(t)),this},fire:function(){return c.fireWith(this,arguments),this},fired:function(){return!!r}};return c},v.extend({Deferred:function(e){var t=[["resolve","done",v.Callbacks("once memory"),"resolved"],["reject","fail",v.Callbacks("once memory"),"rejected"],["notify","progress",v.Callbacks("memory")]],n="pending",r={state:function(){return n},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return v.Deferred(function(n){v.each(t,function(t,r){var s=r[0],o=e[t];i[r[1]](v.isFunction(o)?function(){var e=o.apply(this,arguments);e&&v.isFunction(e.promise)?e.promise().done(n.resolve).fail(n.reject).progress(n.notify):n[s+"With"](this===i?n:this,[e])}:n[s])}),e=null}).promise()},promise:function(e){return e!=null?v.extend(e,r):r}},i={};return r.pipe=r.then,v.each(t,function(e,s){var o=s[2],u=s[3];r[s[1]]=o.add,u&&o.add(function(){n=u},t[e^1][2].disable,t[2][2].lock),i[s[0]]=o.fire,i[s[0]+"With"]=o.fireWith}),r.promise(i),e&&e.call(i,i),i},when:function(e){var t=0,n=l.call(arguments),r=n.length,i=r!==1||e&&v.isFunction(e.promise)?r:0,s=i===1?e:v.Deferred(),o=function(e,t,n){return function(r){t[e]=this,n[e]=arguments.length>1?l.call(arguments):r,n===u?s.notifyWith(t,n):--i||s.resolveWith(t,n)}},u,a,f;if(r>1){u=new Array(r),a=new Array(r),f=new Array(r);for(;t<r;t++)n[t]&&v.isFunction(n[t].promise)?n[t].promise().done(o(t,f,n)).fail(s.reject).progress(o(t,a,u)):--i}return i||s.resolveWith(f,n),s.promise()}}),v.support=function(){var t,n,r,s,o,u,a,f,l,c,h,p=i.createElement("div");p.setAttribute("className","t"),p.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",n=p.getElementsByTagName("*"),r=p.getElementsByTagName("a")[0];if(!n||!r||!n.length)return{};s=i.createElement("select"),o=s.appendChild(i.createElement("option")),u=p.getElementsByTagName("input")[0],r.style.cssText="top:1px;float:left;opacity:.5",t={leadingWhitespace:p.firstChild.nodeType===3,tbody:!p.getElementsByTagName("tbody").length,htmlSerialize:!!p.getElementsByTagName("link").length,style:/top/.test(r.getAttribute("style")),hrefNormalized:r.getAttribute("href")==="/a",opacity:/^0.5/.test(r.style.opacity),cssFloat:!!r.style.cssFloat,checkOn:u.value==="on",optSelected:o.selected,getSetAttribute:p.className!=="t",enctype:!!i.createElement("form").enctype,html5Clone:i.createElement("nav").cloneNode(!0).outerHTML!=="<:nav></:nav>",boxModel:i.compatMode==="CSS1Compat",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0,boxSizingReliable:!0,pixelPosition:!1},u.checked=!0,t.noCloneChecked=u.cloneNode(!0).checked,s.disabled=!0,t.optDisabled=!o.disabled;try{delete p.test}catch(d){t.deleteExpando=!1}!p.addEventListener&&p.attachEvent&&p.fireEvent&&(p.attachEvent("onclick",h=function(){t.noCloneEvent=!1}),p.cloneNode(!0).fireEvent("onclick"),p.detachEvent("onclick",h)),u=i.createElement("input"),u.value="t",u.setAttribute("type","radio"),t.radioValue=u.value==="t",u.setAttribute("checked","checked"),u.setAttribute("name","t"),p.appendChild(u),a=i.createDocumentFragment(),a.appendChild(p.lastChild),t.checkClone=a.cloneNode(!0).cloneNode(!0).lastChild.checked,t.appendChecked=u.checked,a.removeChild(u),a.appendChild(p);if(p.attachEvent)for(l in{submit:!0,change:!0,focusin:!0})f="on"+l,c=f in p,c||(p.setAttribute(f,"return;"),c=typeof p[f]=="function"),t[l+"Bubbles"]=c;return v(function(){var n,r,s,o,u="padding:0;margin:0;border:0;display:block;overflow:hidden;",a=i.getElementsByTagName("body")[0];if(!a)return;n=i.createElement("div"),n.style.cssText="visibility:hidden;border:0;width:0;height:0;position:static;top:0;margin-top:1px",a.insertBefore(n,a.firstChild),r=i.createElement("div"),n.appendChild(r),r.innerHTML="<table><tr><td></td><td>t</td></tr></table>",s=r.getElementsByTagName("td"),s[0].style.cssText="padding:0;margin:0;border:0;display:none",c=s[0].offsetHeight===0,s[0].style.display="",s[1].style.display="none",t.reliableHiddenOffsets=c&&s[0].offsetHeight===0,r.innerHTML="",r.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",t.boxSizing=r.offsetWidth===4,t.doesNotIncludeMarginInBodyOffset=a.offsetTop!==1,e.getComputedStyle&&(t.pixelPosition=(e.getComputedStyle(r,null)||{}).top!=="1%",t.boxSizingReliable=(e.getComputedStyle(r,null)||{width:"4px"}).width==="4px",o=i.createElement("div"),o.style.cssText=r.style.cssText=u,o.style.marginRight=o.style.width="0",r.style.width="1px",r.appendChild(o),t.reliableMarginRight=!parseFloat((e.getComputedStyle(o,null)||{}).marginRight)),typeof r.style.zoom!="undefined"&&(r.innerHTML="",r.style.cssText=u+"width:1px;padding:1px;display:inline;zoom:1",t.inlineBlockNeedsLayout=r.offsetWidth===3,r.style.display="block",r.style.overflow="visible",r.innerHTML="<div></div>",r.firstChild.style.width="5px",t.shrinkWrapBlocks=r.offsetWidth!==3,n.style.zoom=1),a.removeChild(n),n=r=s=o=null}),a.removeChild(p),n=r=s=o=u=a=p=null,t}();var D=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,P=/([A-Z])/g;v.extend({cache:{},deletedIds:[],uuid:0,expando:"jQuery"+(v.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(e){return e=e.nodeType?v.cache[e[v.expando]]:e[v.expando],!!e&&!B(e)},data:function(e,n,r,i){if(!v.acceptData(e))return;var s,o,u=v.expando,a=typeof n=="string",f=e.nodeType,l=f?v.cache:e,c=f?e[u]:e[u]&&u;if((!c||!l[c]||!i&&!l[c].data)&&a&&r===t)return;c||(f?e[u]=c=v.deletedIds.pop()||v.guid++:c=u),l[c]||(l[c]={},f||(l[c].toJSON=v.noop));if(typeof n=="object"||typeof n=="function")i?l[c]=v.extend(l[c],n):l[c].data=v.extend(l[c].data,n);return s=l[c],i||(s.data||(s.data={}),s=s.data),r!==t&&(s[v.camelCase(n)]=r),a?(o=s[n],o==null&&(o=s[v.camelCase(n)])):o=s,o},removeData:function(e,t,n){if(!v.acceptData(e))return;var r,i,s,o=e.nodeType,u=o?v.cache:e,a=o?e[v.expando]:v.expando;if(!u[a])return;if(t){r=n?u[a]:u[a].data;if(r){v.isArray(t)||(t in r?t=[t]:(t=v.camelCase(t),t in r?t=[t]:t=t.split(" ")));for(i=0,s=t.length;i<s;i++)delete r[t[i]];if(!(n?B:v.isEmptyObject)(r))return}}if(!n){delete u[a].data;if(!B(u[a]))return}o?v.cleanData([e],!0):v.support.deleteExpando||u!=u.window?delete u[a]:u[a]=null},_data:function(e,t,n){return v.data(e,t,n,!0)},acceptData:function(e){var t=e.nodeName&&v.noData[e.nodeName.toLowerCase()];return!t||t!==!0&&e.getAttribute("classid")===t}}),v.fn.extend({data:function(e,n){var r,i,s,o,u,a=this[0],f=0,l=null;if(e===t){if(this.length){l=v.data(a);if(a.nodeType===1&&!v._data(a,"parsedAttrs")){s=a.attributes;for(u=s.length;f<u;f++)o=s[f].name,o.indexOf("data-")||(o=v.camelCase(o.substring(5)),H(a,o,l[o]));v._data(a,"parsedAttrs",!0)}}return l}return typeof e=="object"?this.each(function(){v.data(this,e)}):(r=e.split(".",2),r[1]=r[1]?"."+r[1]:"",i=r[1]+"!",v.access(this,function(n){if(n===t)return l=this.triggerHandler("getData"+i,[r[0]]),l===t&&a&&(l=v.data(a,e),l=H(a,e,l)),l===t&&r[1]?this.data(r[0]):l;r[1]=n,this.each(function(){var t=v(this);t.triggerHandler("setData"+i,r),v.data(this,e,n),t.triggerHandler("changeData"+i,r)})},null,n,arguments.length>1,null,!1))},removeData:function(e){return this.each(function(){v.removeData(this,e)})}}),v.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=v._data(e,t),n&&(!r||v.isArray(n)?r=v._data(e,t,v.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=v.queue(e,t),r=n.length,i=n.shift(),s=v._queueHooks(e,t),o=function(){v.dequeue(e,t)};i==="inprogress"&&(i=n.shift(),r--),i&&(t==="fx"&&n.unshift("inprogress"),delete s.stop,i.call(e,o,s)),!r&&s&&s.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return v._data(e,n)||v._data(e,n,{empty:v.Callbacks("once memory").add(function(){v.removeData(e,t+"queue",!0),v.removeData(e,n,!0)})})}}),v.fn.extend({queue:function(e,n){var r=2;return typeof e!="string"&&(n=e,e="fx",r--),arguments.length<r?v.queue(this[0],e):n===t?this:this.each(function(){var t=v.queue(this,e,n);v._queueHooks(this,e),e==="fx"&&t[0]!=="inprogress"&&v.dequeue(this,e)})},dequeue:function(e){return this.each(function(){v.dequeue(this,e)})},delay:function(e,t){return e=v.fx?v.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,n){var r=setTimeout(t,e);n.stop=function(){clearTimeout(r)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,n){var r,i=1,s=v.Deferred(),o=this,u=this.length,a=function(){--i||s.resolveWith(o,[o])};typeof e!="string"&&(n=e,e=t),e=e||"fx";while(u--)r=v._data(o[u],e+"queueHooks"),r&&r.empty&&(i++,r.empty.add(a));return a(),s.promise(n)}});var j,F,I,q=/[\t\r\n]/g,R=/\r/g,U=/^(?:button|input)$/i,z=/^(?:button|input|object|select|textarea)$/i,W=/^a(?:rea|)$/i,X=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,V=v.support.getSetAttribute;v.fn.extend({attr:function(e,t){return v.access(this,v.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){v.removeAttr(this,e)})},prop:function(e,t){return v.access(this,v.prop,e,t,arguments.length>1)},removeProp:function(e){return e=v.propFix[e]||e,this.each(function(){try{this[e]=t,delete this[e]}catch(n){}})},addClass:function(e){var t,n,r,i,s,o,u;if(v.isFunction(e))return this.each(function(t){v(this).addClass(e.call(this,t,this.className))});if(e&&typeof e=="string"){t=e.split(y);for(n=0,r=this.length;n<r;n++){i=this[n];if(i.nodeType===1)if(!i.className&&t.length===1)i.className=e;else{s=" "+i.className+" ";for(o=0,u=t.length;o<u;o++)s.indexOf(" "+t[o]+" ")<0&&(s+=t[o]+" ");i.className=v.trim(s)}}}return this},removeClass:function(e){var n,r,i,s,o,u,a;if(v.isFunction(e))return this.each(function(t){v(this).removeClass(e.call(this,t,this.className))});if(e&&typeof e=="string"||e===t){n=(e||"").split(y);for(u=0,a=this.length;u<a;u++){i=this[u];if(i.nodeType===1&&i.className){r=(" "+i.className+" ").replace(q," ");for(s=0,o=n.length;s<o;s++)while(r.indexOf(" "+n[s]+" ")>=0)r=r.replace(" "+n[s]+" "," ");i.className=e?v.trim(r):""}}}return this},toggleClass:function(e,t){var n=typeof e,r=typeof t=="boolean";return v.isFunction(e)?this.each(function(n){v(this).toggleClass(e.call(this,n,this.className,t),t)}):this.each(function(){if(n==="string"){var i,s=0,o=v(this),u=t,a=e.split(y);while(i=a[s++])u=r?u:!o.hasClass(i),o[u?"addClass":"removeClass"](i)}else if(n==="undefined"||n==="boolean")this.className&&v._data(this,"__className__",this.className),this.className=this.className||e===!1?"":v._data(this,"__className__")||""})},hasClass:function(e){var t=" "+e+" ",n=0,r=this.length;for(;n<r;n++)if(this[n].nodeType===1&&(" "+this[n].className+" ").replace(q," ").indexOf(t)>=0)return!0;return!1},val:function(e){var n,r,i,s=this[0];if(!arguments.length){if(s)return n=v.valHooks[s.type]||v.valHooks[s.nodeName.toLowerCase()],n&&"get"in n&&(r=n.get(s,"value"))!==t?r:(r=s.value,typeof r=="string"?r.replace(R,""):r==null?"":r);return}return i=v.isFunction(e),this.each(function(r){var s,o=v(this);if(this.nodeType!==1)return;i?s=e.call(this,r,o.val()):s=e,s==null?s="":typeof s=="number"?s+="":v.isArray(s)&&(s=v.map(s,function(e){return e==null?"":e+""})),n=v.valHooks[this.type]||v.valHooks[this.nodeName.toLowerCase()];if(!n||!("set"in n)||n.set(this,s,"value")===t)this.value=s})}}),v.extend({valHooks:{option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){var t,n,r=e.options,i=e.selectedIndex,s=e.type==="select-one"||i<0,o=s?null:[],u=s?i+1:r.length,a=i<0?u:s?i:0;for(;a<u;a++){n=r[a];if((n.selected||a===i)&&(v.support.optDisabled?!n.disabled:n.getAttribute("disabled")===null)&&(!n.parentNode.disabled||!v.nodeName(n.parentNode,"optgroup"))){t=v(n).val();if(s)return t;o.push(t)}}return o},set:function(e,t){var n=v.makeArray(t);return v(e).find("option").each(function(){this.selected=v.inArray(v(this).val(),n)>=0}),n.length||(e.selectedIndex=-1),n}}},attrFn:{},attr:function(e,n,r,i){var s,o,u,a=e.nodeType;if(!e||a===3||a===8||a===2)return;if(i&&v.isFunction(v.fn[n]))return v(e)[n](r);if(typeof e.getAttribute=="undefined")return v.prop(e,n,r);u=a!==1||!v.isXMLDoc(e),u&&(n=n.toLowerCase(),o=v.attrHooks[n]||(X.test(n)?F:j));if(r!==t){if(r===null){v.removeAttr(e,n);return}return o&&"set"in o&&u&&(s=o.set(e,r,n))!==t?s:(e.setAttribute(n,r+""),r)}return o&&"get"in o&&u&&(s=o.get(e,n))!==null?s:(s=e.getAttribute(n),s===null?t:s)},removeAttr:function(e,t){var n,r,i,s,o=0;if(t&&e.nodeType===1){r=t.split(y);for(;o<r.length;o++)i=r[o],i&&(n=v.propFix[i]||i,s=X.test(i),s||v.attr(e,i,""),e.removeAttribute(V?i:n),s&&n in e&&(e[n]=!1))}},attrHooks:{type:{set:function(e,t){if(U.test(e.nodeName)&&e.parentNode)v.error("type property can't be changed");else if(!v.support.radioValue&&t==="radio"&&v.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}},value:{get:function(e,t){return j&&v.nodeName(e,"button")?j.get(e,t):t in e?e.value:null},set:function(e,t,n){if(j&&v.nodeName(e,"button"))return j.set(e,t,n);e.value=t}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(e,n,r){var i,s,o,u=e.nodeType;if(!e||u===3||u===8||u===2)return;return o=u!==1||!v.isXMLDoc(e),o&&(n=v.propFix[n]||n,s=v.propHooks[n]),r!==t?s&&"set"in s&&(i=s.set(e,r,n))!==t?i:e[n]=r:s&&"get"in s&&(i=s.get(e,n))!==null?i:e[n]},propHooks:{tabIndex:{get:function(e){var n=e.getAttributeNode("tabindex");return n&&n.specified?parseInt(n.value,10):z.test(e.nodeName)||W.test(e.nodeName)&&e.href?0:t}}}}),F={get:function(e,n){var r,i=v.prop(e,n);return i===!0||typeof i!="boolean"&&(r=e.getAttributeNode(n))&&r.nodeValue!==!1?n.toLowerCase():t},set:function(e,t,n){var r;return t===!1?v.removeAttr(e,n):(r=v.propFix[n]||n,r in e&&(e[r]=!0),e.setAttribute(n,n.toLowerCase())),n}},V||(I={name:!0,id:!0,coords:!0},j=v.valHooks.button={get:function(e,n){var r;return r=e.getAttributeNode(n),r&&(I[n]?r.value!=="":r.specified)?r.value:t},set:function(e,t,n){var r=e.getAttributeNode(n);return r||(r=i.createAttribute(n),e.setAttributeNode(r)),r.value=t+""}},v.each(["width","height"],function(e,t){v.attrHooks[t]=v.extend(v.attrHooks[t],{set:function(e,n){if(n==="")return e.setAttribute(t,"auto"),n}})}),v.attrHooks.contenteditable={get:j.get,set:function(e,t,n){t===""&&(t="false"),j.set(e,t,n)}}),v.support.hrefNormalized||v.each(["href","src","width","height"],function(e,n){v.attrHooks[n]=v.extend(v.attrHooks[n],{get:function(e){var r=e.getAttribute(n,2);return r===null?t:r}})}),v.support.style||(v.attrHooks.style={get:function(e){return e.style.cssText.toLowerCase()||t},set:function(e,t){return e.style.cssText=t+""}}),v.support.optSelected||(v.propHooks.selected=v.extend(v.propHooks.selected,{get:function(e){var t=e.parentNode;return t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex),null}})),v.support.enctype||(v.propFix.enctype="encoding"),v.support.checkOn||v.each(["radio","checkbox"],function(){v.valHooks[this]={get:function(e){return e.getAttribute("value")===null?"on":e.value}}}),v.each(["radio","checkbox"],function(){v.valHooks[this]=v.extend(v.valHooks[this],{set:function(e,t){if(v.isArray(t))return e.checked=v.inArray(v(e).val(),t)>=0}})});var $=/^(?:textarea|input|select)$/i,J=/^([^\.]*|)(?:\.(.+)|)$/,K=/(?:^|\s)hover(\.\S+|)\b/,Q=/^key/,G=/^(?:mouse|contextmenu)|click/,Y=/^(?:focusinfocus|focusoutblur)$/,Z=function(e){return v.event.special.hover?e:e.replace(K,"mouseenter$1 mouseleave$1")};v.event={add:function(e,n,r,i,s){var o,u,a,f,l,c,h,p,d,m,g;if(e.nodeType===3||e.nodeType===8||!n||!r||!(o=v._data(e)))return;r.handler&&(d=r,r=d.handler,s=d.selector),r.guid||(r.guid=v.guid++),a=o.events,a||(o.events=a={}),u=o.handle,u||(o.handle=u=function(e){return typeof v=="undefined"||!!e&&v.event.triggered===e.type?t:v.event.dispatch.apply(u.elem,arguments)},u.elem=e),n=v.trim(Z(n)).split(" ");for(f=0;f<n.length;f++){l=J.exec(n[f])||[],c=l[1],h=(l[2]||"").split(".").sort(),g=v.event.special[c]||{},c=(s?g.delegateType:g.bindType)||c,g=v.event.special[c]||{},p=v.extend({type:c,origType:l[1],data:i,handler:r,guid:r.guid,selector:s,needsContext:s&&v.expr.match.needsContext.test(s),namespace:h.join(".")},d),m=a[c];if(!m){m=a[c]=[],m.delegateCount=0;if(!g.setup||g.setup.call(e,i,h,u)===!1)e.addEventListener?e.addEventListener(c,u,!1):e.attachEvent&&e.attachEvent("on"+c,u)}g.add&&(g.add.call(e,p),p.handler.guid||(p.handler.guid=r.guid)),s?m.splice(m.delegateCount++,0,p):m.push(p),v.event.global[c]=!0}e=null},global:{},remove:function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p,d,m,g=v.hasData(e)&&v._data(e);if(!g||!(h=g.events))return;t=v.trim(Z(t||"")).split(" ");for(s=0;s<t.length;s++){o=J.exec(t[s])||[],u=a=o[1],f=o[2];if(!u){for(u in h)v.event.remove(e,u+t[s],n,r,!0);continue}p=v.event.special[u]||{},u=(r?p.delegateType:p.bindType)||u,d=h[u]||[],l=d.length,f=f?new RegExp("(^|\\.)"+f.split(".").sort().join("\\.(?:.*\\.|)")+"(\\.|$)"):null;for(c=0;c<d.length;c++)m=d[c],(i||a===m.origType)&&(!n||n.guid===m.guid)&&(!f||f.test(m.namespace))&&(!r||r===m.selector||r==="**"&&m.selector)&&(d.splice(c--,1),m.selector&&d.delegateCount--,p.remove&&p.remove.call(e,m));d.length===0&&l!==d.length&&((!p.teardown||p.teardown.call(e,f,g.handle)===!1)&&v.removeEvent(e,u,g.handle),delete h[u])}v.isEmptyObject(h)&&(delete g.handle,v.removeData(e,"events",!0))},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(n,r,s,o){if(!s||s.nodeType!==3&&s.nodeType!==8){var u,a,f,l,c,h,p,d,m,g,y=n.type||n,b=[];if(Y.test(y+v.event.triggered))return;y.indexOf("!")>=0&&(y=y.slice(0,-1),a=!0),y.indexOf(".")>=0&&(b=y.split("."),y=b.shift(),b.sort());if((!s||v.event.customEvent[y])&&!v.event.global[y])return;n=typeof n=="object"?n[v.expando]?n:new v.Event(y,n):new v.Event(y),n.type=y,n.isTrigger=!0,n.exclusive=a,n.namespace=b.join("."),n.namespace_re=n.namespace?new RegExp("(^|\\.)"+b.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,h=y.indexOf(":")<0?"on"+y:"";if(!s){u=v.cache;for(f in u)u[f].events&&u[f].events[y]&&v.event.trigger(n,r,u[f].handle.elem,!0);return}n.result=t,n.target||(n.target=s),r=r!=null?v.makeArray(r):[],r.unshift(n),p=v.event.special[y]||{};if(p.trigger&&p.trigger.apply(s,r)===!1)return;m=[[s,p.bindType||y]];if(!o&&!p.noBubble&&!v.isWindow(s)){g=p.delegateType||y,l=Y.test(g+y)?s:s.parentNode;for(c=s;l;l=l.parentNode)m.push([l,g]),c=l;c===(s.ownerDocument||i)&&m.push([c.defaultView||c.parentWindow||e,g])}for(f=0;f<m.length&&!n.isPropagationStopped();f++)l=m[f][0],n.type=m[f][1],d=(v._data(l,"events")||{})[n.type]&&v._data(l,"handle"),d&&d.apply(l,r),d=h&&l[h],d&&v.acceptData(l)&&d.apply&&d.apply(l,r)===!1&&n.preventDefault();return n.type=y,!o&&!n.isDefaultPrevented()&&(!p._default||p._default.apply(s.ownerDocument,r)===!1)&&(y!=="click"||!v.nodeName(s,"a"))&&v.acceptData(s)&&h&&s[y]&&(y!=="focus"&&y!=="blur"||n.target.offsetWidth!==0)&&!v.isWindow(s)&&(c=s[h],c&&(s[h]=null),v.event.triggered=y,s[y](),v.event.triggered=t,c&&(s[h]=c)),n.result}return},dispatch:function(n){n=v.event.fix(n||e.event);var r,i,s,o,u,a,f,c,h,p,d=(v._data(this,"events")||{})[n.type]||[],m=d.delegateCount,g=l.call(arguments),y=!n.exclusive&&!n.namespace,b=v.event.special[n.type]||{},w=[];g[0]=n,n.delegateTarget=this;if(b.preDispatch&&b.preDispatch.call(this,n)===!1)return;if(m&&(!n.button||n.type!=="click"))for(s=n.target;s!=this;s=s.parentNode||this)if(s.disabled!==!0||n.type!=="click"){u={},f=[];for(r=0;r<m;r++)c=d[r],h=c.selector,u[h]===t&&(u[h]=c.needsContext?v(h,this).index(s)>=0:v.find(h,this,null,[s]).length),u[h]&&f.push(c);f.length&&w.push({elem:s,matches:f})}d.length>m&&w.push({elem:this,matches:d.slice(m)});for(r=0;r<w.length&&!n.isPropagationStopped();r++){a=w[r],n.currentTarget=a.elem;for(i=0;i<a.matches.length&&!n.isImmediatePropagationStopped();i++){c=a.matches[i];if(y||!n.namespace&&!c.namespace||n.namespace_re&&n.namespace_re.test(c.namespace))n.data=c.data,n.handleObj=c,o=((v.event.special[c.origType]||{}).handle||c.handler).apply(a.elem,g),o!==t&&(n.result=o,o===!1&&(n.preventDefault(),n.stopPropagation()))}}return b.postDispatch&&b.postDispatch.call(this,n),n.result},props:"attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return e.which==null&&(e.which=t.charCode!=null?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,n){var r,s,o,u=n.button,a=n.fromElement;return e.pageX==null&&n.clientX!=null&&(r=e.target.ownerDocument||i,s=r.documentElement,o=r.body,e.pageX=n.clientX+(s&&s.scrollLeft||o&&o.scrollLeft||0)-(s&&s.clientLeft||o&&o.clientLeft||0),e.pageY=n.clientY+(s&&s.scrollTop||o&&o.scrollTop||0)-(s&&s.clientTop||o&&o.clientTop||0)),!e.relatedTarget&&a&&(e.relatedTarget=a===e.target?n.toElement:a),!e.which&&u!==t&&(e.which=u&1?1:u&2?3:u&4?2:0),e}},fix:function(e){if(e[v.expando])return e;var t,n,r=e,s=v.event.fixHooks[e.type]||{},o=s.props?this.props.concat(s.props):this.props;e=v.Event(r);for(t=o.length;t;)n=o[--t],e[n]=r[n];return e.target||(e.target=r.srcElement||i),e.target.nodeType===3&&(e.target=e.target.parentNode),e.metaKey=!!e.metaKey,s.filter?s.filter(e,r):e},special:{load:{noBubble:!0},focus:{delegateType:"focusin"},blur:{delegateType:"focusout"},beforeunload:{setup:function(e,t,n){v.isWindow(this)&&(this.onbeforeunload=n)},teardown:function(e,t){this.onbeforeunload===t&&(this.onbeforeunload=null)}}},simulate:function(e,t,n,r){var i=v.extend(new v.Event,n,{type:e,isSimulated:!0,originalEvent:{}});r?v.event.trigger(i,null,t):v.event.dispatch.call(t,i),i.isDefaultPrevented()&&n.preventDefault()}},v.event.handle=v.event.dispatch,v.removeEvent=i.removeEventListener?function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)}:function(e,t,n){var r="on"+t;e.detachEvent&&(typeof e[r]=="undefined"&&(e[r]=null),e.detachEvent(r,n))},v.Event=function(e,t){if(!(this instanceof v.Event))return new v.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.returnValue===!1||e.getPreventDefault&&e.getPreventDefault()?tt:et):this.type=e,t&&v.extend(this,t),this.timeStamp=e&&e.timeStamp||v.now(),this[v.expando]=!0},v.Event.prototype={preventDefault:function(){this.isDefaultPrevented=tt;var e=this.originalEvent;if(!e)return;e.preventDefault?e.preventDefault():e.returnValue=!1},stopPropagation:function(){this.isPropagationStopped=tt;var e=this.originalEvent;if(!e)return;e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=tt,this.stopPropagation()},isDefaultPrevented:et,isPropagationStopped:et,isImmediatePropagationStopped:et},v.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){v.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,s=e.handleObj,o=s.selector;if(!i||i!==r&&!v.contains(r,i))e.type=s.origType,n=s.handler.apply(this,arguments),e.type=t;return n}}}),v.support.submitBubbles||(v.event.special.submit={setup:function(){if(v.nodeName(this,"form"))return!1;v.event.add(this,"click._submit keypress._submit",function(e){var n=e.target,r=v.nodeName(n,"input")||v.nodeName(n,"button")?n.form:t;r&&!v._data(r,"_submit_attached")&&(v.event.add(r,"submit._submit",function(e){e._submit_bubble=!0}),v._data(r,"_submit_attached",!0))})},postDispatch:function(e){e._submit_bubble&&(delete e._submit_bubble,this.parentNode&&!e.isTrigger&&v.event.simulate("submit",this.parentNode,e,!0))},teardown:function(){if(v.nodeName(this,"form"))return!1;v.event.remove(this,"._submit")}}),v.support.changeBubbles||(v.event.special.change={setup:function(){if($.test(this.nodeName)){if(this.type==="checkbox"||this.type==="radio")v.event.add(this,"propertychange._change",function(e){e.originalEvent.propertyName==="checked"&&(this._just_changed=!0)}),v.event.add(this,"click._change",function(e){this._just_changed&&!e.isTrigger&&(this._just_changed=!1),v.event.simulate("change",this,e,!0)});return!1}v.event.add(this,"beforeactivate._change",function(e){var t=e.target;$.test(t.nodeName)&&!v._data(t,"_change_attached")&&(v.event.add(t,"change._change",function(e){this.parentNode&&!e.isSimulated&&!e.isTrigger&&v.event.simulate("change",this.parentNode,e,!0)}),v._data(t,"_change_attached",!0))})},handle:function(e){var t=e.target;if(this!==t||e.isSimulated||e.isTrigger||t.type!=="radio"&&t.type!=="checkbox")return e.handleObj.handler.apply(this,arguments)},teardown:function(){return v.event.remove(this,"._change"),!$.test(this.nodeName)}}),v.support.focusinBubbles||v.each({focus:"focusin",blur:"focusout"},function(e,t){var n=0,r=function(e){v.event.simulate(t,e.target,v.event.fix(e),!0)};v.event.special[t]={setup:function(){n++===0&&i.addEventListener(e,r,!0)},teardown:function(){--n===0&&i.removeEventListener(e,r,!0)}}}),v.fn.extend({on:function(e,n,r,i,s){var o,u;if(typeof e=="object"){typeof n!="string"&&(r=r||n,n=t);for(u in e)this.on(u,n,r,e[u],s);return this}r==null&&i==null?(i=n,r=n=t):i==null&&(typeof n=="string"?(i=r,r=t):(i=r,r=n,n=t));if(i===!1)i=et;else if(!i)return this;return s===1&&(o=i,i=function(e){return v().off(e),o.apply(this,arguments)},i.guid=o.guid||(o.guid=v.guid++)),this.each(function(){v.event.add(this,e,i,r,n)})},one:function(e,t,n,r){return this.on(e,t,n,r,1)},off:function(e,n,r){var i,s;if(e&&e.preventDefault&&e.handleObj)return i=e.handleObj,v(e.delegateTarget).off(i.namespace?i.origType+"."+i.namespace:i.origType,i.selector,i.handler),this;if(typeof e=="object"){for(s in e)this.off(s,n,e[s]);return this}if(n===!1||typeof n=="function")r=n,n=t;return r===!1&&(r=et),this.each(function(){v.event.remove(this,e,r,n)})},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},live:function(e,t,n){return v(this.context).on(e,this.selector,t,n),this},die:function(e,t){return v(this.context).off(e,this.selector||"**",t),this},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return arguments.length===1?this.off(e,"**"):this.off(t,e||"**",n)},trigger:function(e,t){return this.each(function(){v.event.trigger(e,t,this)})},triggerHandler:function(e,t){if(this[0])return v.event.trigger(e,t,this[0],!0)},toggle:function(e){var t=arguments,n=e.guid||v.guid++,r=0,i=function(n){var i=(v._data(this,"lastToggle"+e.guid)||0)%r;return v._data(this,"lastToggle"+e.guid,i+1),n.preventDefault(),t[i].apply(this,arguments)||!1};i.guid=n;while(r<t.length)t[r++].guid=n;return this.click(i)},hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),v.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){v.fn[t]=function(e,n){return n==null&&(n=e,e=null),arguments.length>0?this.on(t,null,e,n):this.trigger(t)},Q.test(t)&&(v.event.fixHooks[t]=v.event.keyHooks),G.test(t)&&(v.event.fixHooks[t]=v.event.mouseHooks)}),function(e,t){function nt(e,t,n,r){n=n||[],t=t||g;var i,s,a,f,l=t.nodeType;if(!e||typeof e!="string")return n;if(l!==1&&l!==9)return[];a=o(t);if(!a&&!r)if(i=R.exec(e))if(f=i[1]){if(l===9){s=t.getElementById(f);if(!s||!s.parentNode)return n;if(s.id===f)return n.push(s),n}else if(t.ownerDocument&&(s=t.ownerDocument.getElementById(f))&&u(t,s)&&s.id===f)return n.push(s),n}else{if(i[2])return S.apply(n,x.call(t.getElementsByTagName(e),0)),n;if((f=i[3])&&Z&&t.getElementsByClassName)return S.apply(n,x.call(t.getElementsByClassName(f),0)),n}return vt(e.replace(j,"$1"),t,n,r,a)}function rt(e){return function(t){var n=t.nodeName.toLowerCase();return n==="input"&&t.type===e}}function it(e){return function(t){var n=t.nodeName.toLowerCase();return(n==="input"||n==="button")&&t.type===e}}function st(e){return N(function(t){return t=+t,N(function(n,r){var i,s=e([],n.length,t),o=s.length;while(o--)n[i=s[o]]&&(n[i]=!(r[i]=n[i]))})})}function ot(e,t,n){if(e===t)return n;var r=e.nextSibling;while(r){if(r===t)return-1;r=r.nextSibling}return 1}function ut(e,t){var n,r,s,o,u,a,f,l=L[d][e+" "];if(l)return t?0:l.slice(0);u=e,a=[],f=i.preFilter;while(u){if(!n||(r=F.exec(u)))r&&(u=u.slice(r[0].length)||u),a.push(s=[]);n=!1;if(r=I.exec(u))s.push(n=new m(r.shift())),u=u.slice(n.length),n.type=r[0].replace(j," ");for(o in i.filter)(r=J[o].exec(u))&&(!f[o]||(r=f[o](r)))&&(s.push(n=new m(r.shift())),u=u.slice(n.length),n.type=o,n.matches=r);if(!n)break}return t?u.length:u?nt.error(e):L(e,a).slice(0)}function at(e,t,r){var i=t.dir,s=r&&t.dir==="parentNode",o=w++;return t.first?function(t,n,r){while(t=t[i])if(s||t.nodeType===1)return e(t,n,r)}:function(t,r,u){if(!u){var a,f=b+" "+o+" ",l=f+n;while(t=t[i])if(s||t.nodeType===1){if((a=t[d])===l)return t.sizset;if(typeof a=="string"&&a.indexOf(f)===0){if(t.sizset)return t}else{t[d]=l;if(e(t,r,u))return t.sizset=!0,t;t.sizset=!1}}}else while(t=t[i])if(s||t.nodeType===1)if(e(t,r,u))return t}}function ft(e){return e.length>1?function(t,n,r){var i=e.length;while(i--)if(!e[i](t,n,r))return!1;return!0}:e[0]}function lt(e,t,n,r,i){var s,o=[],u=0,a=e.length,f=t!=null;for(;u<a;u++)if(s=e[u])if(!n||n(s,r,i))o.push(s),f&&t.push(u);return o}function ct(e,t,n,r,i,s){return r&&!r[d]&&(r=ct(r)),i&&!i[d]&&(i=ct(i,s)),N(function(s,o,u,a){var f,l,c,h=[],p=[],d=o.length,v=s||dt(t||"*",u.nodeType?[u]:u,[]),m=e&&(s||!t)?lt(v,h,e,u,a):v,g=n?i||(s?e:d||r)?[]:o:m;n&&n(m,g,u,a);if(r){f=lt(g,p),r(f,[],u,a),l=f.length;while(l--)if(c=f[l])g[p[l]]=!(m[p[l]]=c)}if(s){if(i||e){if(i){f=[],l=g.length;while(l--)(c=g[l])&&f.push(m[l]=c);i(null,g=[],f,a)}l=g.length;while(l--)(c=g[l])&&(f=i?T.call(s,c):h[l])>-1&&(s[f]=!(o[f]=c))}}else g=lt(g===o?g.splice(d,g.length):g),i?i(null,o,g,a):S.apply(o,g)})}function ht(e){var t,n,r,s=e.length,o=i.relative[e[0].type],u=o||i.relative[" "],a=o?1:0,f=at(function(e){return e===t},u,!0),l=at(function(e){return T.call(t,e)>-1},u,!0),h=[function(e,n,r){return!o&&(r||n!==c)||((t=n).nodeType?f(e,n,r):l(e,n,r))}];for(;a<s;a++)if(n=i.relative[e[a].type])h=[at(ft(h),n)];else{n=i.filter[e[a].type].apply(null,e[a].matches);if(n[d]){r=++a;for(;r<s;r++)if(i.relative[e[r].type])break;return ct(a>1&&ft(h),a>1&&e.slice(0,a-1).join("").replace(j,"$1"),n,a<r&&ht(e.slice(a,r)),r<s&&ht(e=e.slice(r)),r<s&&e.join(""))}h.push(n)}return ft(h)}function pt(e,t){var r=t.length>0,s=e.length>0,o=function(u,a,f,l,h){var p,d,v,m=[],y=0,w="0",x=u&&[],T=h!=null,N=c,C=u||s&&i.find.TAG("*",h&&a.parentNode||a),k=b+=N==null?1:Math.E;T&&(c=a!==g&&a,n=o.el);for(;(p=C[w])!=null;w++){if(s&&p){for(d=0;v=e[d];d++)if(v(p,a,f)){l.push(p);break}T&&(b=k,n=++o.el)}r&&((p=!v&&p)&&y--,u&&x.push(p))}y+=w;if(r&&w!==y){for(d=0;v=t[d];d++)v(x,m,a,f);if(u){if(y>0)while(w--)!x[w]&&!m[w]&&(m[w]=E.call(l));m=lt(m)}S.apply(l,m),T&&!u&&m.length>0&&y+t.length>1&&nt.uniqueSort(l)}return T&&(b=k,c=N),x};return o.el=0,r?N(o):o}function dt(e,t,n){var r=0,i=t.length;for(;r<i;r++)nt(e,t[r],n);return n}function vt(e,t,n,r,s){var o,u,f,l,c,h=ut(e),p=h.length;if(!r&&h.length===1){u=h[0]=h[0].slice(0);if(u.length>2&&(f=u[0]).type==="ID"&&t.nodeType===9&&!s&&i.relative[u[1].type]){t=i.find.ID(f.matches[0].replace($,""),t,s)[0];if(!t)return n;e=e.slice(u.shift().length)}for(o=J.POS.test(e)?-1:u.length-1;o>=0;o--){f=u[o];if(i.relative[l=f.type])break;if(c=i.find[l])if(r=c(f.matches[0].replace($,""),z.test(u[0].type)&&t.parentNode||t,s)){u.splice(o,1),e=r.length&&u.join("");if(!e)return S.apply(n,x.call(r,0)),n;break}}}return a(e,h)(r,t,s,n,z.test(e)),n}function mt(){}var n,r,i,s,o,u,a,f,l,c,h=!0,p="undefined",d=("sizcache"+Math.random()).replace(".",""),m=String,g=e.document,y=g.documentElement,b=0,w=0,E=[].pop,S=[].push,x=[].slice,T=[].indexOf||function(e){var t=0,n=this.length;for(;t<n;t++)if(this[t]===e)return t;return-1},N=function(e,t){return e[d]=t==null||t,e},C=function(){var e={},t=[];return N(function(n,r){return t.push(n)>i.cacheLength&&delete e[t.shift()],e[n+" "]=r},e)},k=C(),L=C(),A=C(),O="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[-\\w]|[^\\x00-\\xa0])+",_=M.replace("w","w#"),D="([*^$|!~]?=)",P="\\["+O+"*("+M+")"+O+"*(?:"+D+O+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+_+")|)|)"+O+"*\\]",H=":("+M+")(?:\\((?:(['\"])((?:\\\\.|[^\\\\])*?)\\2|([^()[\\]]*|(?:(?:"+P+")|[^:]|\\\\.)*|.*))\\)|)",B=":(even|odd|eq|gt|lt|nth|first|last)(?:\\("+O+"*((?:-\\d)?\\d*)"+O+"*\\)|)(?=[^-]|$)",j=new RegExp("^"+O+"+|((?:^|[^\\\\])(?:\\\\.)*)"+O+"+$","g"),F=new RegExp("^"+O+"*,"+O+"*"),I=new RegExp("^"+O+"*([\\x20\\t\\r\\n\\f>+~])"+O+"*"),q=new RegExp(H),R=/^(?:#([\w\-]+)|(\w+)|\.([\w\-]+))$/,U=/^:not/,z=/[\x20\t\r\n\f]*[+~]/,W=/:not\($/,X=/h\d/i,V=/input|select|textarea|button/i,$=/\\(?!\\)/g,J={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),NAME:new RegExp("^\\[name=['\"]?("+M+")['\"]?\\]"),TAG:new RegExp("^("+M.replace("w","w*")+")"),ATTR:new RegExp("^"+P),PSEUDO:new RegExp("^"+H),POS:new RegExp(B,"i"),CHILD:new RegExp("^:(only|nth|first|last)-child(?:\\("+O+"*(even|odd|(([+-]|)(\\d*)n|)"+O+"*(?:([+-]|)"+O+"*(\\d+)|))"+O+"*\\)|)","i"),needsContext:new RegExp("^"+O+"*[>+~]|"+B,"i")},K=function(e){var t=g.createElement("div");try{return e(t)}catch(n){return!1}finally{t=null}},Q=K(function(e){return e.appendChild(g.createComment("")),!e.getElementsByTagName("*").length}),G=K(function(e){return e.innerHTML="<a href='#'></a>",e.firstChild&&typeof e.firstChild.getAttribute!==p&&e.firstChild.getAttribute("href")==="#"}),Y=K(function(e){e.innerHTML="<select></select>";var t=typeof e.lastChild.getAttribute("multiple");return t!=="boolean"&&t!=="string"}),Z=K(function(e){return e.innerHTML="<div class='hidden e'></div><div class='hidden'></div>",!e.getElementsByClassName||!e.getElementsByClassName("e").length?!1:(e.lastChild.className="e",e.getElementsByClassName("e").length===2)}),et=K(function(e){e.id=d+0,e.innerHTML="<a name='"+d+"'></a><div name='"+d+"'></div>",y.insertBefore(e,y.firstChild);var t=g.getElementsByName&&g.getElementsByName(d).length===2+g.getElementsByName(d+0).length;return r=!g.getElementById(d),y.removeChild(e),t});try{x.call(y.childNodes,0)[0].nodeType}catch(tt){x=function(e){var t,n=[];for(;t=this[e];e++)n.push(t);return n}}nt.matches=function(e,t){return nt(e,null,null,t)},nt.matchesSelector=function(e,t){return nt(t,null,null,[e]).length>0},s=nt.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(i===1||i===9||i===11){if(typeof e.textContent=="string")return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=s(e)}else if(i===3||i===4)return e.nodeValue}else for(;t=e[r];r++)n+=s(t);return n},o=nt.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return t?t.nodeName!=="HTML":!1},u=nt.contains=y.contains?function(e,t){var n=e.nodeType===9?e.documentElement:e,r=t&&t.parentNode;return e===r||!!(r&&r.nodeType===1&&n.contains&&n.contains(r))}:y.compareDocumentPosition?function(e,t){return t&&!!(e.compareDocumentPosition(t)&16)}:function(e,t){while(t=t.parentNode)if(t===e)return!0;return!1},nt.attr=function(e,t){var n,r=o(e);return r||(t=t.toLowerCase()),(n=i.attrHandle[t])?n(e):r||Y?e.getAttribute(t):(n=e.getAttributeNode(t),n?typeof e[t]=="boolean"?e[t]?t:null:n.specified?n.value:null:null)},i=nt.selectors={cacheLength:50,createPseudo:N,match:J,attrHandle:G?{}:{href:function(e){return e.getAttribute("href",2)},type:function(e){return e.getAttribute("type")}},find:{ID:r?function(e,t,n){if(typeof t.getElementById!==p&&!n){var r=t.getElementById(e);return r&&r.parentNode?[r]:[]}}:function(e,n,r){if(typeof n.getElementById!==p&&!r){var i=n.getElementById(e);return i?i.id===e||typeof i.getAttributeNode!==p&&i.getAttributeNode("id").value===e?[i]:t:[]}},TAG:Q?function(e,t){if(typeof t.getElementsByTagName!==p)return t.getElementsByTagName(e)}:function(e,t){var n=t.getElementsByTagName(e);if(e==="*"){var r,i=[],s=0;for(;r=n[s];s++)r.nodeType===1&&i.push(r);return i}return n},NAME:et&&function(e,t){if(typeof t.getElementsByName!==p)return t.getElementsByName(name)},CLASS:Z&&function(e,t,n){if(typeof t.getElementsByClassName!==p&&!n)return t.getElementsByClassName(e)}},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace($,""),e[3]=(e[4]||e[5]||"").replace($,""),e[2]==="~="&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),e[1]==="nth"?(e[2]||nt.error(e[0]),e[3]=+(e[3]?e[4]+(e[5]||1):2*(e[2]==="even"||e[2]==="odd")),e[4]=+(e[6]+e[7]||e[2]==="odd")):e[2]&&nt.error(e[0]),e},PSEUDO:function(e){var t,n;if(J.CHILD.test(e[0]))return null;if(e[3])e[2]=e[3];else if(t=e[4])q.test(t)&&(n=ut(t,!0))&&(n=t.indexOf(")",t.length-n)-t.length)&&(t=t.slice(0,n),e[0]=e[0].slice(0,n)),e[2]=t;return e.slice(0,3)}},filter:{ID:r?function(e){return e=e.replace($,""),function(t){return t.getAttribute("id")===e}}:function(e){return e=e.replace($,""),function(t){var n=typeof t.getAttributeNode!==p&&t.getAttributeNode("id");return n&&n.value===e}},TAG:function(e){return e==="*"?function(){return!0}:(e=e.replace($,"").toLowerCase(),function(t){return t.nodeName&&t.nodeName.toLowerCase()===e})},CLASS:function(e){var t=k[d][e+" "];return t||(t=new RegExp("(^|"+O+")"+e+"("+O+"|$)"))&&k(e,function(e){return t.test(e.className||typeof e.getAttribute!==p&&e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r,i){var s=nt.attr(r,e);return s==null?t==="!=":t?(s+="",t==="="?s===n:t==="!="?s!==n:t==="^="?n&&s.indexOf(n)===0:t==="*="?n&&s.indexOf(n)>-1:t==="$="?n&&s.substr(s.length-n.length)===n:t==="~="?(" "+s+" ").indexOf(n)>-1:t==="|="?s===n||s.substr(0,n.length+1)===n+"-":!1):!0}},CHILD:function(e,t,n,r){return e==="nth"?function(e){var t,i,s=e.parentNode;if(n===1&&r===0)return!0;if(s){i=0;for(t=s.firstChild;t;t=t.nextSibling)if(t.nodeType===1){i++;if(e===t)break}}return i-=r,i===n||i%n===0&&i/n>=0}:function(t){var n=t;switch(e){case"only":case"first":while(n=n.previousSibling)if(n.nodeType===1)return!1;if(e==="first")return!0;n=t;case"last":while(n=n.nextSibling)if(n.nodeType===1)return!1;return!0}}},PSEUDO:function(e,t){var n,r=i.pseudos[e]||i.setFilters[e.toLowerCase()]||nt.error("unsupported pseudo: "+e);return r[d]?r(t):r.length>1?(n=[e,e,"",t],i.setFilters.hasOwnProperty(e.toLowerCase())?N(function(e,n){var i,s=r(e,t),o=s.length;while(o--)i=T.call(e,s[o]),e[i]=!(n[i]=s[o])}):function(e){return r(e,0,n)}):r}},pseudos:{not:N(function(e){var t=[],n=[],r=a(e.replace(j,"$1"));return r[d]?N(function(e,t,n,i){var s,o=r(e,null,i,[]),u=e.length;while(u--)if(s=o[u])e[u]=!(t[u]=s)}):function(e,i,s){return t[0]=e,r(t,null,s,n),!n.pop()}}),has:N(function(e){return function(t){return nt(e,t).length>0}}),contains:N(function(e){return function(t){return(t.textContent||t.innerText||s(t)).indexOf(e)>-1}}),enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return t==="input"&&!!e.checked||t==="option"&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},parent:function(e){return!i.pseudos.empty(e)},empty:function(e){var t;e=e.firstChild;while(e){if(e.nodeName>"@"||(t=e.nodeType)===3||t===4)return!1;e=e.nextSibling}return!0},header:function(e){return X.test(e.nodeName)},text:function(e){var t,n;return e.nodeName.toLowerCase()==="input"&&(t=e.type)==="text"&&((n=e.getAttribute("type"))==null||n.toLowerCase()===t)},radio:rt("radio"),checkbox:rt("checkbox"),file:rt("file"),password:rt("password"),image:rt("image"),submit:it("submit"),reset:it("reset"),button:function(e){var t=e.nodeName.toLowerCase();return t==="input"&&e.type==="button"||t==="button"},input:function(e){return V.test(e.nodeName)},focus:function(e){var t=e.ownerDocument;return e===t.activeElement&&(!t.hasFocus||t.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},active:function(e){return e===e.ownerDocument.activeElement},first:st(function(){return[0]}),last:st(function(e,t){return[t-1]}),eq:st(function(e,t,n){return[n<0?n+t:n]}),even:st(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:st(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:st(function(e,t,n){for(var r=n<0?n+t:n;--r>=0;)e.push(r);return e}),gt:st(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}},f=y.compareDocumentPosition?function(e,t){return e===t?(l=!0,0):(!e.compareDocumentPosition||!t.compareDocumentPosition?e.compareDocumentPosition:e.compareDocumentPosition(t)&4)?-1:1}:function(e,t){if(e===t)return l=!0,0;if(e.sourceIndex&&t.sourceIndex)return e.sourceIndex-t.sourceIndex;var n,r,i=[],s=[],o=e.parentNode,u=t.parentNode,a=o;if(o===u)return ot(e,t);if(!o)return-1;if(!u)return 1;while(a)i.unshift(a),a=a.parentNode;a=u;while(a)s.unshift(a),a=a.parentNode;n=i.length,r=s.length;for(var f=0;f<n&&f<r;f++)if(i[f]!==s[f])return ot(i[f],s[f]);return f===n?ot(e,s[f],-1):ot(i[f],t,1)},[0,0].sort(f),h=!l,nt.uniqueSort=function(e){var t,n=[],r=1,i=0;l=h,e.sort(f);if(l){for(;t=e[r];r++)t===e[r-1]&&(i=n.push(r));while(i--)e.splice(n[i],1)}return e},nt.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},a=nt.compile=function(e,t){var n,r=[],i=[],s=A[d][e+" "];if(!s){t||(t=ut(e)),n=t.length;while(n--)s=ht(t[n]),s[d]?r.push(s):i.push(s);s=A(e,pt(i,r))}return s},g.querySelectorAll&&function(){var e,t=vt,n=/'|\\/g,r=/\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g,i=[":focus"],s=[":active"],u=y.matchesSelector||y.mozMatchesSelector||y.webkitMatchesSelector||y.oMatchesSelector||y.msMatchesSelector;K(function(e){e.innerHTML="<select><option selected=''></option></select>",e.querySelectorAll("[selected]").length||i.push("\\["+O+"*(?:checked|disabled|ismap|multiple|readonly|selected|value)"),e.querySelectorAll(":checked").length||i.push(":checked")}),K(function(e){e.innerHTML="<p test=''></p>",e.querySelectorAll("[test^='']").length&&i.push("[*^$]="+O+"*(?:\"\"|'')"),e.innerHTML="<input type='hidden'/>",e.querySelectorAll(":enabled").length||i.push(":enabled",":disabled")}),i=new RegExp(i.join("|")),vt=function(e,r,s,o,u){if(!o&&!u&&!i.test(e)){var a,f,l=!0,c=d,h=r,p=r.nodeType===9&&e;if(r.nodeType===1&&r.nodeName.toLowerCase()!=="object"){a=ut(e),(l=r.getAttribute("id"))?c=l.replace(n,"\\$&"):r.setAttribute("id",c),c="[id='"+c+"'] ",f=a.length;while(f--)a[f]=c+a[f].join("");h=z.test(e)&&r.parentNode||r,p=a.join(",")}if(p)try{return S.apply(s,x.call(h.querySelectorAll(p),0)),s}catch(v){}finally{l||r.removeAttribute("id")}}return t(e,r,s,o,u)},u&&(K(function(t){e=u.call(t,"div");try{u.call(t,"[test!='']:sizzle"),s.push("!=",H)}catch(n){}}),s=new RegExp(s.join("|")),nt.matchesSelector=function(t,n){n=n.replace(r,"='$1']");if(!o(t)&&!s.test(n)&&!i.test(n))try{var a=u.call(t,n);if(a||e||t.document&&t.document.nodeType!==11)return a}catch(f){}return nt(n,null,null,[t]).length>0})}(),i.pseudos.nth=i.pseudos.eq,i.filters=mt.prototype=i.pseudos,i.setFilters=new mt,nt.attr=v.attr,v.find=nt,v.expr=nt.selectors,v.expr[":"]=v.expr.pseudos,v.unique=nt.uniqueSort,v.text=nt.getText,v.isXMLDoc=nt.isXML,v.contains=nt.contains}(e);var nt=/Until$/,rt=/^(?:parents|prev(?:Until|All))/,it=/^.[^:#\[\.,]*$/,st=v.expr.match.needsContext,ot={children:!0,contents:!0,next:!0,prev:!0};v.fn.extend({find:function(e){var t,n,r,i,s,o,u=this;if(typeof e!="string")return v(e).filter(function(){for(t=0,n=u.length;t<n;t++)if(v.contains(u[t],this))return!0});o=this.pushStack("","find",e);for(t=0,n=this.length;t<n;t++){r=o.length,v.find(e,this[t],o);if(t>0)for(i=r;i<o.length;i++)for(s=0;s<r;s++)if(o[s]===o[i]){o.splice(i--,1);break}}return o},has:function(e){var t,n=v(e,this),r=n.length;return this.filter(function(){for(t=0;t<r;t++)if(v.contains(this,n[t]))return!0})},not:function(e){return this.pushStack(ft(this,e,!1),"not",e)},filter:function(e){return this.pushStack(ft(this,e,!0),"filter",e)},is:function(e){return!!e&&(typeof e=="string"?st.test(e)?v(e,this.context).index(this[0])>=0:v.filter(e,this).length>0:this.filter(e).length>0)},closest:function(e,t){var n,r=0,i=this.length,s=[],o=st.test(e)||typeof e!="string"?v(e,t||this.context):0;for(;r<i;r++){n=this[r];while(n&&n.ownerDocument&&n!==t&&n.nodeType!==11){if(o?o.index(n)>-1:v.find.matchesSelector(n,e)){s.push(n);break}n=n.parentNode}}return s=s.length>1?v.unique(s):s,this.pushStack(s,"closest",e)},index:function(e){return e?typeof e=="string"?v.inArray(this[0],v(e)):v.inArray(e.jquery?e[0]:e,this):this[0]&&this[0].parentNode?this.prevAll().length:-1},add:function(e,t){var n=typeof e=="string"?v(e,t):v.makeArray(e&&e.nodeType?[e]:e),r=v.merge(this.get(),n);return this.pushStack(ut(n[0])||ut(r[0])?r:v.unique(r))},addBack:function(e){return this.add(e==null?this.prevObject:this.prevObject.filter(e))}}),v.fn.andSelf=v.fn.addBack,v.each({parent:function(e){var t=e.parentNode;return t&&t.nodeType!==11?t:null},parents:function(e){return v.dir(e,"parentNode")},parentsUntil:function(e,t,n){return v.dir(e,"parentNode",n)},next:function(e){return at(e,"nextSibling")},prev:function(e){return at(e,"previousSibling")},nextAll:function(e){return v.dir(e,"nextSibling")},prevAll:function(e){return v.dir(e,"previousSibling")},nextUntil:function(e,t,n){return v.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return v.dir(e,"previousSibling",n)},siblings:function(e){return v.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return v.sibling(e.firstChild)},contents:function(e){return v.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:v.merge([],e.childNodes)}},function(e,t){v.fn[e]=function(n,r){var i=v.map(this,t,n);return nt.test(e)||(r=n),r&&typeof r=="string"&&(i=v.filter(r,i)),i=this.length>1&&!ot[e]?v.unique(i):i,this.length>1&&rt.test(e)&&(i=i.reverse()),this.pushStack(i,e,l.call(arguments).join(","))}}),v.extend({filter:function(e,t,n){return n&&(e=":not("+e+")"),t.length===1?v.find.matchesSelector(t[0],e)?[t[0]]:[]:v.find.matches(e,t)},dir:function(e,n,r){var i=[],s=e[n];while(s&&s.nodeType!==9&&(r===t||s.nodeType!==1||!v(s).is(r)))s.nodeType===1&&i.push(s),s=s[n];return i},sibling:function(e,t){var n=[];for(;e;e=e.nextSibling)e.nodeType===1&&e!==t&&n.push(e);return n}});var ct="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",ht=/ jQuery\d+="(?:null|\d+)"/g,pt=/^\s+/,dt=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,vt=/<([\w:]+)/,mt=/<tbody/i,gt=/<|&#?\w+;/,yt=/<(?:script|style|link)/i,bt=/<(?:script|object|embed|option|style)/i,wt=new RegExp("<(?:"+ct+")[\\s/>]","i"),Et=/^(?:checkbox|radio)$/,St=/checked\s*(?:[^=]|=\s*.checked.)/i,xt=/\/(java|ecma)script/i,Tt=/^\s*<!(?:\[CDATA\[|\-\-)|[\]\-]{2}>\s*$/g,Nt={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]},Ct=lt(i),kt=Ct.appendChild(i.createElement("div"));Nt.optgroup=Nt.option,Nt.tbody=Nt.tfoot=Nt.colgroup=Nt.caption=Nt.thead,Nt.th=Nt.td,v.support.htmlSerialize||(Nt._default=[1,"X<div>","</div>"]),v.fn.extend({text:function(e){return v.access(this,function(e){return e===t?v.text(this):this.empty().append((this[0]&&this[0].ownerDocument||i).createTextNode(e))},null,e,arguments.length)},wrapAll:function(e){if(v.isFunction(e))return this.each(function(t){v(this).wrapAll(e.call(this,t))});if(this[0]){var t=v(e,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstChild&&e.firstChild.nodeType===1)e=e.firstChild;return e}).append(this)}return this},wrapInner:function(e){return v.isFunction(e)?this.each(function(t){v(this).wrapInner(e.call(this,t))}):this.each(function(){var t=v(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=v.isFunction(e);return this.each(function(n){v(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){v.nodeName(this,"body")||v(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(e){(this.nodeType===1||this.nodeType===11)&&this.appendChild(e)})},prepend:function(){return this.domManip(arguments,!0,function(e){(this.nodeType===1||this.nodeType===11)&&this.insertBefore(e,this.firstChild)})},before:function(){if(!ut(this[0]))return this.domManip(arguments,!1,function(e){this.parentNode.insertBefore(e,this)});if(arguments.length){var e=v.clean(arguments);return this.pushStack(v.merge(e,this),"before",this.selector)}},after:function(){if(!ut(this[0]))return this.domManip(arguments,!1,function(e){this.parentNode.insertBefore(e,this.nextSibling)});if(arguments.length){var e=v.clean(arguments);return this.pushStack(v.merge(this,e),"after",this.selector)}},remove:function(e,t){var n,r=0;for(;(n=this[r])!=null;r++)if(!e||v.filter(e,[n]).length)!t&&n.nodeType===1&&(v.cleanData(n.getElementsByTagName("*")),v.cleanData([n])),n.parentNode&&n.parentNode.removeChild(n);return this},empty:function(){var e,t=0;for(;(e=this[t])!=null;t++){e.nodeType===1&&v.cleanData(e.getElementsByTagName("*"));while(e.firstChild)e.removeChild(e.firstChild)}return this},clone:function(e,t){return e=e==null?!1:e,t=t==null?e:t,this.map(function(){return v.clone(this,e,t)})},html:function(e){return v.access(this,function(e){var n=this[0]||{},r=0,i=this.length;if(e===t)return n.nodeType===1?n.innerHTML.replace(ht,""):t;if(typeof e=="string"&&!yt.test(e)&&(v.support.htmlSerialize||!wt.test(e))&&(v.support.leadingWhitespace||!pt.test(e))&&!Nt[(vt.exec(e)||["",""])[1].toLowerCase()]){e=e.replace(dt,"<$1></$2>");try{for(;r<i;r++)n=this[r]||{},n.nodeType===1&&(v.cleanData(n.getElementsByTagName("*")),n.innerHTML=e);n=0}catch(s){}}n&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(e){return ut(this[0])?this.length?this.pushStack(v(v.isFunction(e)?e():e),"replaceWith",e):this:v.isFunction(e)?this.each(function(t){var n=v(this),r=n.html();n.replaceWith(e.call(this,t,r))}):(typeof e!="string"&&(e=v(e).detach()),this.each(function(){var t=this.nextSibling,n=this.parentNode;v(this).remove(),t?v(t).before(e):v(n).append(e)}))},detach:function(e){return this.remove(e,!0)},domManip:function(e,n,r){e=[].concat.apply([],e);var i,s,o,u,a=0,f=e[0],l=[],c=this.length;if(!v.support.checkClone&&c>1&&typeof f=="string"&&St.test(f))return this.each(function(){v(this).domManip(e,n,r)});if(v.isFunction(f))return this.each(function(i){var s=v(this);e[0]=f.call(this,i,n?s.html():t),s.domManip(e,n,r)});if(this[0]){i=v.buildFragment(e,this,l),o=i.fragment,s=o.firstChild,o.childNodes.length===1&&(o=s);if(s){n=n&&v.nodeName(s,"tr");for(u=i.cacheable||c-1;a<c;a++)r.call(n&&v.nodeName(this[a],"table")?Lt(this[a],"tbody"):this[a],a===u?o:v.clone(o,!0,!0))}o=s=null,l.length&&v.each(l,function(e,t){t.src?v.ajax?v.ajax({url:t.src,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0}):v.error("no ajax"):v.globalEval((t.text||t.textContent||t.innerHTML||"").replace(Tt,"")),t.parentNode&&t.parentNode.removeChild(t)})}return this}}),v.buildFragment=function(e,n,r){var s,o,u,a=e[0];return n=n||i,n=!n.nodeType&&n[0]||n,n=n.ownerDocument||n,e.length===1&&typeof a=="string"&&a.length<512&&n===i&&a.charAt(0)==="<"&&!bt.test(a)&&(v.support.checkClone||!St.test(a))&&(v.support.html5Clone||!wt.test(a))&&(o=!0,s=v.fragments[a],u=s!==t),s||(s=n.createDocumentFragment(),v.clean(e,n,s,r),o&&(v.fragments[a]=u&&s)),{fragment:s,cacheable:o}},v.fragments={},v.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){v.fn[e]=function(n){var r,i=0,s=[],o=v(n),u=o.length,a=this.length===1&&this[0].parentNode;if((a==null||a&&a.nodeType===11&&a.childNodes.length===1)&&u===1)return o[t](this[0]),this;for(;i<u;i++)r=(i>0?this.clone(!0):this).get(),v(o[i])[t](r),s=s.concat(r);return this.pushStack(s,e,o.selector)}}),v.extend({clone:function(e,t,n){var r,i,s,o;v.support.html5Clone||v.isXMLDoc(e)||!wt.test("<"+e.nodeName+">")?o=e.cloneNode(!0):(kt.innerHTML=e.outerHTML,kt.removeChild(o=kt.firstChild));if((!v.support.noCloneEvent||!v.support.noCloneChecked)&&(e.nodeType===1||e.nodeType===11)&&!v.isXMLDoc(e)){Ot(e,o),r=Mt(e),i=Mt(o);for(s=0;r[s];++s)i[s]&&Ot(r[s],i[s])}if(t){At(e,o);if(n){r=Mt(e),i=Mt(o);for(s=0;r[s];++s)At(r[s],i[s])}}return r=i=null,o},clean:function(e,t,n,r){var s,o,u,a,f,l,c,h,p,d,m,g,y=t===i&&Ct,b=[];if(!t||typeof t.createDocumentFragment=="undefined")t=i;for(s=0;(u=e[s])!=null;s++){typeof u=="number"&&(u+="");if(!u)continue;if(typeof u=="string")if(!gt.test(u))u=t.createTextNode(u);else{y=y||lt(t),c=t.createElement("div"),y.appendChild(c),u=u.replace(dt,"<$1></$2>"),a=(vt.exec(u)||["",""])[1].toLowerCase(),f=Nt[a]||Nt._default,l=f[0],c.innerHTML=f[1]+u+f[2];while(l--)c=c.lastChild;if(!v.support.tbody){h=mt.test(u),p=a==="table"&&!h?c.firstChild&&c.firstChild.childNodes:f[1]==="<table>"&&!h?c.childNodes:[];for(o=p.length-1;o>=0;--o)v.nodeName(p[o],"tbody")&&!p[o].childNodes.length&&p[o].parentNode.removeChild(p[o])}!v.support.leadingWhitespace&&pt.test(u)&&c.insertBefore(t.createTextNode(pt.exec(u)[0]),c.firstChild),u=c.childNodes,c.parentNode.removeChild(c)}u.nodeType?b.push(u):v.merge(b,u)}c&&(u=c=y=null);if(!v.support.appendChecked)for(s=0;(u=b[s])!=null;s++)v.nodeName(u,"input")?_t(u):typeof u.getElementsByTagName!="undefined"&&v.grep(u.getElementsByTagName("input"),_t);if(n){m=function(e){if(!e.type||xt.test(e.type))return r?r.push(e.parentNode?e.parentNode.removeChild(e):e):n.appendChild(e)};for(s=0;(u=b[s])!=null;s++)if(!v.nodeName(u,"script")||!m(u))n.appendChild(u),typeof u.getElementsByTagName!="undefined"&&(g=v.grep(v.merge([],u.getElementsByTagName("script")),m),b.splice.apply(b,[s+1,0].concat(g)),s+=g.length)}return b},cleanData:function(e,t){var n,r,i,s,o=0,u=v.expando,a=v.cache,f=v.support.deleteExpando,l=v.event.special;for(;(i=e[o])!=null;o++)if(t||v.acceptData(i)){r=i[u],n=r&&a[r];if(n){if(n.events)for(s in n.events)l[s]?v.event.remove(i,s):v.removeEvent(i,s,n.handle);a[r]&&(delete a[r],f?delete i[u]:i.removeAttribute?i.removeAttribute(u):i[u]=null,v.deletedIds.push(r))}}}}),function(){var e,t;v.uaMatch=function(e){e=e.toLowerCase();var t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:t[1]||"",version:t[2]||"0"}},e=v.uaMatch(o.userAgent),t={},e.browser&&(t[e.browser]=!0,t.version=e.version),t.chrome?t.webkit=!0:t.webkit&&(t.safari=!0),v.browser=t,v.sub=function(){function e(t,n){return new e.fn.init(t,n)}v.extend(!0,e,this),e.superclass=this,e.fn=e.prototype=this(),e.fn.constructor=e,e.sub=this.sub,e.fn.init=function(r,i){return i&&i instanceof v&&!(i instanceof e)&&(i=e(i)),v.fn.init.call(this,r,i,t)},e.fn.init.prototype=e.fn;var t=e(i);return e}}();var Dt,Pt,Ht,Bt=/alpha\([^)]*\)/i,jt=/opacity=([^)]*)/,Ft=/^(top|right|bottom|left)$/,It=/^(none|table(?!-c[ea]).+)/,qt=/^margin/,Rt=new RegExp("^("+m+")(.*)$","i"),Ut=new RegExp("^("+m+")(?!px)[a-z%]+$","i"),zt=new RegExp("^([-+])=("+m+")","i"),Wt={BODY:"block"},Xt={position:"absolute",visibility:"hidden",display:"block"},Vt={letterSpacing:0,fontWeight:400},$t=["Top","Right","Bottom","Left"],Jt=["Webkit","O","Moz","ms"],Kt=v.fn.toggle;v.fn.extend({css:function(e,n){return v.access(this,function(e,n,r){return r!==t?v.style(e,n,r):v.css(e,n)},e,n,arguments.length>1)},show:function(){return Yt(this,!0)},hide:function(){return Yt(this)},toggle:function(e,t){var n=typeof e=="boolean";return v.isFunction(e)&&v.isFunction(t)?Kt.apply(this,arguments):this.each(function(){(n?e:Gt(this))?v(this).show():v(this).hide()})}}),v.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Dt(e,"opacity");return n===""?"1":n}}}},cssNumber:{fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":v.support.cssFloat?"cssFloat":"styleFloat"},style:function(e,n,r,i){if(!e||e.nodeType===3||e.nodeType===8||!e.style)return;var s,o,u,a=v.camelCase(n),f=e.style;n=v.cssProps[a]||(v.cssProps[a]=Qt(f,a)),u=v.cssHooks[n]||v.cssHooks[a];if(r===t)return u&&"get"in u&&(s=u.get(e,!1,i))!==t?s:f[n];o=typeof r,o==="string"&&(s=zt.exec(r))&&(r=(s[1]+1)*s[2]+parseFloat(v.css(e,n)),o="number");if(r==null||o==="number"&&isNaN(r))return;o==="number"&&!v.cssNumber[a]&&(r+="px");if(!u||!("set"in u)||(r=u.set(e,r,i))!==t)try{f[n]=r}catch(l){}},css:function(e,n,r,i){var s,o,u,a=v.camelCase(n);return n=v.cssProps[a]||(v.cssProps[a]=Qt(e.style,a)),u=v.cssHooks[n]||v.cssHooks[a],u&&"get"in u&&(s=u.get(e,!0,i)),s===t&&(s=Dt(e,n)),s==="normal"&&n in Vt&&(s=Vt[n]),r||i!==t?(o=parseFloat(s),r||v.isNumeric(o)?o||0:s):s},swap:function(e,t,n){var r,i,s={};for(i in t)s[i]=e.style[i],e.style[i]=t[i];r=n.call(e);for(i in t)e.style[i]=s[i];return r}}),e.getComputedStyle?Dt=function(t,n){var r,i,s,o,u=e.getComputedStyle(t,null),a=t.style;return u&&(r=u.getPropertyValue(n)||u[n],r===""&&!v.contains(t.ownerDocument,t)&&(r=v.style(t,n)),Ut.test(r)&&qt.test(n)&&(i=a.width,s=a.minWidth,o=a.maxWidth,a.minWidth=a.maxWidth=a.width=r,r=u.width,a.width=i,a.minWidth=s,a.maxWidth=o)),r}:i.documentElement.currentStyle&&(Dt=function(e,t){var n,r,i=e.currentStyle&&e.currentStyle[t],s=e.style;return i==null&&s&&s[t]&&(i=s[t]),Ut.test(i)&&!Ft.test(t)&&(n=s.left,r=e.runtimeStyle&&e.runtimeStyle.left,r&&(e.runtimeStyle.left=e.currentStyle.left),s.left=t==="fontSize"?"1em":i,i=s.pixelLeft+"px",s.left=n,r&&(e.runtimeStyle.left=r)),i===""?"auto":i}),v.each(["height","width"],function(e,t){v.cssHooks[t]={get:function(e,n,r){if(n)return e.offsetWidth===0&&It.test(Dt(e,"display"))?v.swap(e,Xt,function(){return tn(e,t,r)}):tn(e,t,r)},set:function(e,n,r){return Zt(e,n,r?en(e,t,r,v.support.boxSizing&&v.css(e,"boxSizing")==="border-box"):0)}}}),v.support.opacity||(v.cssHooks.opacity={get:function(e,t){return jt.test((t&&e.currentStyle?e.currentStyle.filter:e.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":t?"1":""},set:function(e,t){var n=e.style,r=e.currentStyle,i=v.isNumeric(t)?"alpha(opacity="+t*100+")":"",s=r&&r.filter||n.filter||"";n.zoom=1;if(t>=1&&v.trim(s.replace(Bt,""))===""&&n.removeAttribute){n.removeAttribute("filter");if(r&&!r.filter)return}n.filter=Bt.test(s)?s.replace(Bt,i):s+" "+i}}),v(function(){v.support.reliableMarginRight||(v.cssHooks.marginRight={get:function(e,t){return v.swap(e,{display:"inline-block"},function(){if(t)return Dt(e,"marginRight")})}}),!v.support.pixelPosition&&v.fn.position&&v.each(["top","left"],function(e,t){v.cssHooks[t]={get:function(e,n){if(n){var r=Dt(e,t);return Ut.test(r)?v(e).position()[t]+"px":r}}}})}),v.expr&&v.expr.filters&&(v.expr.filters.hidden=function(e){return e.offsetWidth===0&&e.offsetHeight===0||!v.support.reliableHiddenOffsets&&(e.style&&e.style.display||Dt(e,"display"))==="none"},v.expr.filters.visible=function(e){return!v.expr.filters.hidden(e)}),v.each({margin:"",padding:"",border:"Width"},function(e,t){v.cssHooks[e+t]={expand:function(n){var r,i=typeof n=="string"?n.split(" "):[n],s={};for(r=0;r<4;r++)s[e+$t[r]+t]=i[r]||i[r-2]||i[0];return s}},qt.test(e)||(v.cssHooks[e+t].set=Zt)});var rn=/%20/g,sn=/\[\]$/,on=/\r?\n/g,un=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,an=/^(?:select|textarea)/i;v.fn.extend({serialize:function(){return v.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?v.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||an.test(this.nodeName)||un.test(this.type))}).map(function(e,t){var n=v(this).val();return n==null?null:v.isArray(n)?v.map(n,function(e,n){return{name:t.name,value:e.replace(on,"\r\n")}}):{name:t.name,value:n.replace(on,"\r\n")}}).get()}}),v.param=function(e,n){var r,i=[],s=function(e,t){t=v.isFunction(t)?t():t==null?"":t,i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};n===t&&(n=v.ajaxSettings&&v.ajaxSettings.traditional);if(v.isArray(e)||e.jquery&&!v.isPlainObject(e))v.each(e,function(){s(this.name,this.value)});else for(r in e)fn(r,e[r],n,s);return i.join("&").replace(rn,"+")};var ln,cn,hn=/#.*$/,pn=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,dn=/^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,vn=/^(?:GET|HEAD)$/,mn=/^\/\//,gn=/\?/,yn=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,bn=/([?&])_=[^&]*/,wn=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,En=v.fn.load,Sn={},xn={},Tn=["*/"]+["*"];try{cn=s.href}catch(Nn){cn=i.createElement("a"),cn.href="",cn=cn.href}ln=wn.exec(cn.toLowerCase())||[],v.fn.load=function(e,n,r){if(typeof e!="string"&&En)return En.apply(this,arguments);if(!this.length)return this;var i,s,o,u=this,a=e.indexOf(" ");return a>=0&&(i=e.slice(a,e.length),e=e.slice(0,a)),v.isFunction(n)?(r=n,n=t):n&&typeof n=="object"&&(s="POST"),v.ajax({url:e,type:s,dataType:"html",data:n,complete:function(e,t){r&&u.each(r,o||[e.responseText,t,e])}}).done(function(e){o=arguments,u.html(i?v("<div>").append(e.replace(yn,"")).find(i):e)}),this},v.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(e,t){v.fn[t]=function(e){return this.on(t,e)}}),v.each(["get","post"],function(e,n){v[n]=function(e,r,i,s){return v.isFunction(r)&&(s=s||i,i=r,r=t),v.ajax({type:n,url:e,data:r,success:i,dataType:s})}}),v.extend({getScript:function(e,n){return v.get(e,t,n,"script")},getJSON:function(e,t,n){return v.get(e,t,n,"json")},ajaxSetup:function(e,t){return t?Ln(e,v.ajaxSettings):(t=e,e=v.ajaxSettings),Ln(e,t),e},ajaxSettings:{url:cn,isLocal:dn.test(ln[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":Tn},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":e.String,"text html":!0,"text json":v.parseJSON,"text xml":v.parseXML},flatOptions:{context:!0,url:!0}},ajaxPrefilter:Cn(Sn),ajaxTransport:Cn(xn),ajax:function(e,n){function T(e,n,s,a){var l,y,b,w,S,T=n;if(E===2)return;E=2,u&&clearTimeout(u),o=t,i=a||"",x.readyState=e>0?4:0,s&&(w=An(c,x,s));if(e>=200&&e<300||e===304)c.ifModified&&(S=x.getResponseHeader("Last-Modified"),S&&(v.lastModified[r]=S),S=x.getResponseHeader("Etag"),S&&(v.etag[r]=S)),e===304?(T="notmodified",l=!0):(l=On(c,w),T=l.state,y=l.data,b=l.error,l=!b);else{b=T;if(!T||e)T="error",e<0&&(e=0)}x.status=e,x.statusText=(n||T)+"",l?d.resolveWith(h,[y,T,x]):d.rejectWith(h,[x,T,b]),x.statusCode(g),g=t,f&&p.trigger("ajax"+(l?"Success":"Error"),[x,c,l?y:b]),m.fireWith(h,[x,T]),f&&(p.trigger("ajaxComplete",[x,c]),--v.active||v.event.trigger("ajaxStop"))}typeof e=="object"&&(n=e,e=t),n=n||{};var r,i,s,o,u,a,f,l,c=v.ajaxSetup({},n),h=c.context||c,p=h!==c&&(h.nodeType||h instanceof v)?v(h):v.event,d=v.Deferred(),m=v.Callbacks("once memory"),g=c.statusCode||{},b={},w={},E=0,S="canceled",x={readyState:0,setRequestHeader:function(e,t){if(!E){var n=e.toLowerCase();e=w[n]=w[n]||e,b[e]=t}return this},getAllResponseHeaders:function(){return E===2?i:null},getResponseHeader:function(e){var n;if(E===2){if(!s){s={};while(n=pn.exec(i))s[n[1].toLowerCase()]=n[2]}n=s[e.toLowerCase()]}return n===t?null:n},overrideMimeType:function(e){return E||(c.mimeType=e),this},abort:function(e){return e=e||S,o&&o.abort(e),T(0,e),this}};d.promise(x),x.success=x.done,x.error=x.fail,x.complete=m.add,x.statusCode=function(e){if(e){var t;if(E<2)for(t in e)g[t]=[g[t],e[t]];else t=e[x.status],x.always(t)}return this},c.url=((e||c.url)+"").replace(hn,"").replace(mn,ln[1]+"//"),c.dataTypes=v.trim(c.dataType||"*").toLowerCase().split(y),c.crossDomain==null&&(a=wn.exec(c.url.toLowerCase()),c.crossDomain=!(!a||a[1]===ln[1]&&a[2]===ln[2]&&(a[3]||(a[1]==="http:"?80:443))==(ln[3]||(ln[1]==="http:"?80:443)))),c.data&&c.processData&&typeof c.data!="string"&&(c.data=v.param(c.data,c.traditional)),kn(Sn,c,n,x);if(E===2)return x;f=c.global,c.type=c.type.toUpperCase(),c.hasContent=!vn.test(c.type),f&&v.active++===0&&v.event.trigger("ajaxStart");if(!c.hasContent){c.data&&(c.url+=(gn.test(c.url)?"&":"?")+c.data,delete c.data),r=c.url;if(c.cache===!1){var N=v.now(),C=c.url.replace(bn,"$1_="+N);c.url=C+(C===c.url?(gn.test(c.url)?"&":"?")+"_="+N:"")}}(c.data&&c.hasContent&&c.contentType!==!1||n.contentType)&&x.setRequestHeader("Content-Type",c.contentType),c.ifModified&&(r=r||c.url,v.lastModified[r]&&x.setRequestHeader("If-Modified-Since",v.lastModified[r]),v.etag[r]&&x.setRequestHeader("If-None-Match",v.etag[r])),x.setRequestHeader("Accept",c.dataTypes[0]&&c.accepts[c.dataTypes[0]]?c.accepts[c.dataTypes[0]]+(c.dataTypes[0]!=="*"?", "+Tn+"; q=0.01":""):c.accepts["*"]);for(l in c.headers)x.setRequestHeader(l,c.headers[l]);if(!c.beforeSend||c.beforeSend.call(h,x,c)!==!1&&E!==2){S="abort";for(l in{success:1,error:1,complete:1})x[l](c[l]);o=kn(xn,c,n,x);if(!o)T(-1,"No Transport");else{x.readyState=1,f&&p.trigger("ajaxSend",[x,c]),c.async&&c.timeout>0&&(u=setTimeout(function(){x.abort("timeout")},c.timeout));try{E=1,o.send(b,T)}catch(k){if(!(E<2))throw k;T(-1,k)}}return x}return x.abort()},active:0,lastModified:{},etag:{}});var Mn=[],_n=/\?/,Dn=/(=)\?(?=&|$)|\?\?/,Pn=v.now();v.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Mn.pop()||v.expando+"_"+Pn++;return this[e]=!0,e}}),v.ajaxPrefilter("json jsonp",function(n,r,i){var s,o,u,a=n.data,f=n.url,l=n.jsonp!==!1,c=l&&Dn.test(f),h=l&&!c&&typeof a=="string"&&!(n.contentType||"").indexOf("application/x-www-form-urlencoded")&&Dn.test(a);if(n.dataTypes[0]==="jsonp"||c||h)return s=n.jsonpCallback=v.isFunction(n.jsonpCallback)?n.jsonpCallback():n.jsonpCallback,o=e[s],c?n.url=f.replace(Dn,"$1"+s):h?n.data=a.replace(Dn,"$1"+s):l&&(n.url+=(_n.test(f)?"&":"?")+n.jsonp+"="+s),n.converters["script json"]=function(){return u||v.error(s+" was not called"),u[0]},n.dataTypes[0]="json",e[s]=function(){u=arguments},i.always(function(){e[s]=o,n[s]&&(n.jsonpCallback=r.jsonpCallback,Mn.push(s)),u&&v.isFunction(o)&&o(u[0]),u=o=t}),"script"}),v.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(e){return v.globalEval(e),e}}}),v.ajaxPrefilter("script",function(e){e.cache===t&&(e.cache=!1),e.crossDomain&&(e.type="GET",e.global=!1)}),v.ajaxTransport("script",function(e){if(e.crossDomain){var n,r=i.head||i.getElementsByTagName("head")[0]||i.documentElement;return{send:function(s,o){n=i.createElement("script"),n.async="async",e.scriptCharset&&(n.charset=e.scriptCharset),n.src=e.url,n.onload=n.onreadystatechange=function(e,i){if(i||!n.readyState||/loaded|complete/.test(n.readyState))n.onload=n.onreadystatechange=null,r&&n.parentNode&&r.removeChild(n),n=t,i||o(200,"success")},r.insertBefore(n,r.firstChild)},abort:function(){n&&n.onload(0,1)}}}});var Hn,Bn=e.ActiveXObject?function(){for(var e in Hn)Hn[e](0,1)}:!1,jn=0;v.ajaxSettings.xhr=e.ActiveXObject?function(){return!this.isLocal&&Fn()||In()}:Fn,function(e){v.extend(v.support,{ajax:!!e,cors:!!e&&"withCredentials"in e})}(v.ajaxSettings.xhr()),v.support.ajax&&v.ajaxTransport(function(n){if(!n.crossDomain||v.support.cors){var r;return{send:function(i,s){var o,u,a=n.xhr();n.username?a.open(n.type,n.url,n.async,n.username,n.password):a.open(n.type,n.url,n.async);if(n.xhrFields)for(u in n.xhrFields)a[u]=n.xhrFields[u];n.mimeType&&a.overrideMimeType&&a.overrideMimeType(n.mimeType),!n.crossDomain&&!i["X-Requested-With"]&&(i["X-Requested-With"]="XMLHttpRequest");try{for(u in i)a.setRequestHeader(u,i[u])}catch(f){}a.send(n.hasContent&&n.data||null),r=function(e,i){var u,f,l,c,h;try{if(r&&(i||a.readyState===4)){r=t,o&&(a.onreadystatechange=v.noop,Bn&&delete Hn[o]);if(i)a.readyState!==4&&a.abort();else{u=a.status,l=a.getAllResponseHeaders(),c={},h=a.responseXML,h&&h.documentElement&&(c.xml=h);try{c.text=a.responseText}catch(p){}try{f=a.statusText}catch(p){f=""}!u&&n.isLocal&&!n.crossDomain?u=c.text?200:404:u===1223&&(u=204)}}}catch(d){i||s(-1,d)}c&&s(u,f,c,l)},n.async?a.readyState===4?setTimeout(r,0):(o=++jn,Bn&&(Hn||(Hn={},v(e).unload(Bn)),Hn[o]=r),a.onreadystatechange=r):r()},abort:function(){r&&r(0,1)}}}});var qn,Rn,Un=/^(?:toggle|show|hide)$/,zn=new RegExp("^(?:([-+])=|)("+m+")([a-z%]*)$","i"),Wn=/queueHooks$/,Xn=[Gn],Vn={"*":[function(e,t){var n,r,i=this.createTween(e,t),s=zn.exec(t),o=i.cur(),u=+o||0,a=1,f=20;if(s){n=+s[2],r=s[3]||(v.cssNumber[e]?"":"px");if(r!=="px"&&u){u=v.css(i.elem,e,!0)||n||1;do a=a||".5",u/=a,v.style(i.elem,e,u+r);while(a!==(a=i.cur()/o)&&a!==1&&--f)}i.unit=r,i.start=u,i.end=s[1]?u+(s[1]+1)*n:n}return i}]};v.Animation=v.extend(Kn,{tweener:function(e,t){v.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");var n,r=0,i=e.length;for(;r<i;r++)n=e[r],Vn[n]=Vn[n]||[],Vn[n].unshift(t)},prefilter:function(e,t){t?Xn.unshift(e):Xn.push(e)}}),v.Tween=Yn,Yn.prototype={constructor:Yn,init:function(e,t,n,r,i,s){this.elem=e,this.prop=n,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=s||(v.cssNumber[n]?"":"px")},cur:function(){var e=Yn.propHooks[this.prop];return e&&e.get?e.get(this):Yn.propHooks._default.get(this)},run:function(e){var t,n=Yn.propHooks[this.prop];return this.options.duration?this.pos=t=v.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):Yn.propHooks._default.set(this),this}},Yn.prototype.init.prototype=Yn.prototype,Yn.propHooks={_default:{get:function(e){var t;return e.elem[e.prop]==null||!!e.elem.style&&e.elem.style[e.prop]!=null?(t=v.css(e.elem,e.prop,!1,""),!t||t==="auto"?0:t):e.elem[e.prop]},set:function(e){v.fx.step[e.prop]?v.fx.step[e.prop](e):e.elem.style&&(e.elem.style[v.cssProps[e.prop]]!=null||v.cssHooks[e.prop])?v.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},Yn.propHooks.scrollTop=Yn.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},v.each(["toggle","show","hide"],function(e,t){var n=v.fn[t];v.fn[t]=function(r,i,s){return r==null||typeof r=="boolean"||!e&&v.isFunction(r)&&v.isFunction(i)?n.apply(this,arguments):this.animate(Zn(t,!0),r,i,s)}}),v.fn.extend({fadeTo:function(e,t,n,r){return this.filter(Gt).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=v.isEmptyObject(e),s=v.speed(t,n,r),o=function(){var t=Kn(this,v.extend({},e),s);i&&t.stop(!0)};return i||s.queue===!1?this.each(o):this.queue(s.queue,o)},stop:function(e,n,r){var i=function(e){var t=e.stop;delete e.stop,t(r)};return typeof e!="string"&&(r=n,n=e,e=t),n&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,n=e!=null&&e+"queueHooks",s=v.timers,o=v._data(this);if(n)o[n]&&o[n].stop&&i(o[n]);else for(n in o)o[n]&&o[n].stop&&Wn.test(n)&&i(o[n]);for(n=s.length;n--;)s[n].elem===this&&(e==null||s[n].queue===e)&&(s[n].anim.stop(r),t=!1,s.splice(n,1));(t||!r)&&v.dequeue(this,e)})}}),v.each({slideDown:Zn("show"),slideUp:Zn("hide"),slideToggle:Zn("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){v.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),v.speed=function(e,t,n){var r=e&&typeof e=="object"?v.extend({},e):{complete:n||!n&&t||v.isFunction(e)&&e,duration:e,easing:n&&t||t&&!v.isFunction(t)&&t};r.duration=v.fx.off?0:typeof r.duration=="number"?r.duration:r.duration in v.fx.speeds?v.fx.speeds[r.duration]:v.fx.speeds._default;if(r.queue==null||r.queue===!0)r.queue="fx";return r.old=r.complete,r.complete=function(){v.isFunction(r.old)&&r.old.call(this),r.queue&&v.dequeue(this,r.queue)},r},v.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},v.timers=[],v.fx=Yn.prototype.init,v.fx.tick=function(){var e,n=v.timers,r=0;qn=v.now();for(;r<n.length;r++)e=n[r],!e()&&n[r]===e&&n.splice(r--,1);n.length||v.fx.stop(),qn=t},v.fx.timer=function(e){e()&&v.timers.push(e)&&!Rn&&(Rn=setInterval(v.fx.tick,v.fx.interval))},v.fx.interval=13,v.fx.stop=function(){clearInterval(Rn),Rn=null},v.fx.speeds={slow:600,fast:200,_default:400},v.fx.step={},v.expr&&v.expr.filters&&(v.expr.filters.animated=function(e){return v.grep(v.timers,function(t){return e===t.elem}).length});var er=/^(?:body|html)$/i;v.fn.offset=function(e){if(arguments.length)return e===t?this:this.each(function(t){v.offset.setOffset(this,e,t)});var n,r,i,s,o,u,a,f={top:0,left:0},l=this[0],c=l&&l.ownerDocument;if(!c)return;return(r=c.body)===l?v.offset.bodyOffset(l):(n=c.documentElement,v.contains(n,l)?(typeof l.getBoundingClientRect!="undefined"&&(f=l.getBoundingClientRect()),i=tr(c),s=n.clientTop||r.clientTop||0,o=n.clientLeft||r.clientLeft||0,u=i.pageYOffset||n.scrollTop,a=i.pageXOffset||n.scrollLeft,{top:f.top+u-s,left:f.left+a-o}):f)},v.offset={bodyOffset:function(e){var t=e.offsetTop,n=e.offsetLeft;return v.support.doesNotIncludeMarginInBodyOffset&&(t+=parseFloat(v.css(e,"marginTop"))||0,n+=parseFloat(v.css(e,"marginLeft"))||0),{top:t,left:n}},setOffset:function(e,t,n){var r=v.css(e,"position");r==="static"&&(e.style.position="relative");var i=v(e),s=i.offset(),o=v.css(e,"top"),u=v.css(e,"left"),a=(r==="absolute"||r==="fixed")&&v.inArray("auto",[o,u])>-1,f={},l={},c,h;a?(l=i.position(),c=l.top,h=l.left):(c=parseFloat(o)||0,h=parseFloat(u)||0),v.isFunction(t)&&(t=t.call(e,n,s)),t.top!=null&&(f.top=t.top-s.top+c),t.left!=null&&(f.left=t.left-s.left+h),"using"in t?t.using.call(e,f):i.css(f)}},v.fn.extend({position:function(){if(!this[0])return;var e=this[0],t=this.offsetParent(),n=this.offset(),r=er.test(t[0].nodeName)?{top:0,left:0}:t.offset();return n.top-=parseFloat(v.css(e,"marginTop"))||0,n.left-=parseFloat(v.css(e,"marginLeft"))||0,r.top+=parseFloat(v.css(t[0],"borderTopWidth"))||0,r.left+=parseFloat(v.css(t[0],"borderLeftWidth"))||0,{top:n.top-r.top,left:n.left-r.left}},offsetParent:function(){return this.map(function(){var e=this.offsetParent||i.body;while(e&&!er.test(e.nodeName)&&v.css(e,"position")==="static")e=e.offsetParent;return e||i.body})}}),v.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,n){var r=/Y/.test(n);v.fn[e]=function(i){return v.access(this,function(e,i,s){var o=tr(e);if(s===t)return o?n in o?o[n]:o.document.documentElement[i]:e[i];o?o.scrollTo(r?v(o).scrollLeft():s,r?s:v(o).scrollTop()):e[i]=s},e,i,arguments.length,null)}}),v.each({Height:"height",Width:"width"},function(e,n){v.each({padding:"inner"+e,content:n,"":"outer"+e},function(r,i){v.fn[i]=function(i,s){var o=arguments.length&&(r||typeof i!="boolean"),u=r||(i===!0||s===!0?"margin":"border");return v.access(this,function(n,r,i){var s;return v.isWindow(n)?n.document.documentElement["client"+e]:n.nodeType===9?(s=n.documentElement,Math.max(n.body["scroll"+e],s["scroll"+e],n.body["offset"+e],s["offset"+e],s["client"+e])):i===t?v.css(n,r,i,u):v.style(n,r,i,u)},n,o?i:t,o,null)}})}),e.jQuery=e.$=v,typeof define=="function"&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return v})})(window);
//]]>
</script>
<script id="jqueryArea" type="text/javascript">
//<![CDATA[
/*
jQuery.encoding.digests.sha1.js

SHA-1 digest and associated utility functions

Copyright (c) UnaMesa Association 2009

Dual licensed under the MIT and GPL licenses:
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

if(!$.encoding)
	$.encoding = {};
	$.extend($.encoding,{
		strToBe32s: function(str) {
			// Convert a string to an array of big-endian 32-bit words
			var be=[];
			var len=Math.floor(str.length/4);
			var i, j;
			for(i=0, j=0; i<len; i++, j+=4) {
				be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
			}
			while(j<str.length) {
				be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
				j++;
			}
			return be;
		},
		be32sToStr: function(be) {
			// Convert an array of big-endian 32-bit words to a string
			var str='';
			for(var i=0;i<be.length*32;i+=8) {
				str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
			}
			return str;
		},
		be32sToHex: function(be) {
			// Convert an array of big-endian 32-bit words to a hex string
			var hex='0123456789ABCDEF';
			var str='';
			for(var i=0;i<be.length*4;i++) {
				str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
			}
			return str;
		}
	});
})(jQuery);


(function($) {

if(!$.encoding.digests)
	$.encoding.digests = {};
	$.extend($.encoding.digests,{
		hexSha1Str: function(str) {
			// Return, in hex, the SHA-1 hash of a string
			return $.encoding.be32sToHex($.encoding.digests.sha1Str(str));
		},
		sha1Str: function(str) {
			// Return the SHA-1 hash of a string
			return sha1($.encoding.strToBe32s(str),str.length);
		},
		sha1: function(x,blen) {
			// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
			return sha1($.encoding.strToBe32s(str),str.length);
		}
	});

	// Private functions.
	function sha1(x,blen) {
		// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
		function add32(a,b) {
			// Add 32-bit integers, wrapping at 32 bits
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			var lsw=(a&0xFFFF)+(b&0xFFFF);
			var msw=(a>>16)+(b>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function AA(a,b,c,d,e) {
			// Cryptographic round helper function. Add five 32-bit integers, wrapping at 32 bits, second parameter is rotated left 5 bits before the addition
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			b=(b>>>27)|(b<<5);
			var lsw=(a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
			var msw=(a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function RR(w,j) {
			// Cryptographic round helper function.
			var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];
			return (n>>>31)|(n<<1);
		}

		var len=blen*8;
		x[len>>5] |= 0x80 << (24-len%32);
		x[((len+64>>9)<<4)+15]=len;
		var w=new Array(80);

		var k1=0x5A827999;
		var k2=0x6ED9EBA1;
		var k3=0x8F1BBCDC;
		var k4=0xCA62C1D6;

		var h0=0x67452301;
		var h1=0xEFCDAB89;
		var h2=0x98BADCFE;
		var h3=0x10325476;
		var h4=0xC3D2E1F0;

		for(var i=0;i<x.length;i+=16) {
			var j=0;
			var t;
			var a=h0;
			var b=h1;
			var c=h2;
			var d=h3;
			var e=h4;
			while(j<16) {
				w[j]=x[i+j];
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<20) {
				w[j]=RR(w,j);
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<40) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k2);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<60) {
				w[j]=RR(w,j);
				t=AA(e,a,(b&c)|(d&(b|c)),w[j],k3);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<80) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k4);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			h0=add32(h0,a);
			h1=add32(h1,b);
			h2=add32(h2,c);
			h3=add32(h3,d);
			h4=add32(h4,e);
		}
		return [h0,h1,h2,h3,h4];
	}
})(jQuery);
/*
jQuery.twStylesheet.js

jQuery plugin to dynamically insert CSS rules into a document

Usage:
  jQuery.twStylesheet applies style definitions
  jQuery.twStylesheet.remove neutralizes style definitions

Copyright (c) UnaMesa Association 2009

Triple licensed under the BSD, MIT and GPL licenses:
  http://www.opensource.org/licenses/bsd-license.php
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

var defaultId = "customStyleSheet"; // XXX: rename to dynamicStyleSheet?

// Add or replace a style sheet
// css argument is a string of CSS rule sets
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
// N.B.: Uses DOM methods instead of jQuery to ensure cross-browser comaptibility.
$.twStylesheet = function(css, options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(doc.createStyleSheet) { // IE-specific handling
		if(el) {
			el.parentNode.removeChild(el);
		}
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd",
			'&nbsp;<style id="' + id + '" type="text/css">' + css + '</style>'); // fails without &nbsp;
	} else { // modern browsers
		if(el) {
			el.replaceChild(doc.createTextNode(css), el.firstChild);
		} else {
			el = doc.createElement("style");
			el.type = "text/css";
			el.id = id;
			el.appendChild(doc.createTextNode(css));
			doc.getElementsByTagName("head")[0].appendChild(el);
		}
	}
};

// Remove existing style sheet
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
$.twStylesheet.remove = function(options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(el) {
		el.parentNode.removeChild(el);
	}
};

})(jQuery);

//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
